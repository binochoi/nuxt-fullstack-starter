import{s as e,g as t,m as r,d as n,c as i,u as s,a as o,t as a}from"../../../nitro/nitro.mjs";import{EventEmitter as c}from"node:events";import{Buffer as d}from"node:buffer";import l from"node:stream";const u=(()=>{const C=function(){};return C.prototype=Object.create(null),C})();function createRouter$1(){return{root:{key:""},static:new u}}function splitPath(e){return e.split("/").filter(Boolean)}function getMatchParams(e,t){const r=new u;for(const[n,i]of t){const t=n<0?e.slice(-1*n).join("/"):e[n];if("string"==typeof i)r[i]=t;else{const e=t.match(i);if(e)for(const t in e.groups)r[t]=e.groups[t]}}return r}function addRoute(e,t="",r,n){const i=splitPath(r);let s=e.root,o=0;const a=[];for(let e=0;e<i.length;e++){const t=i[e];if(t.startsWith("**")){s.wildcard||(s.wildcard={key:"**"}),s=s.wildcard,a.push([-e,t.split(":")[1]||"_",2===t.length]);break}if("*"===t||t.includes(":")){s.param||(s.param={key:"*"}),s=s.param;const r="*"===t;a.push([e,r?"_"+o++:_getParamMatcher(t),r]);continue}const r=s.static?.[t];if(r)s=r;else{const e={key:t};s.static||(s.static=new u),s.static[t]=e,s=e}}const c=a.length>0;s.methods||(s.methods=new u),s.methods[t]||(s.methods[t]=[]),s.methods[t].push({data:n||null,paramsMap:c?a:void 0}),c||(e.static[r]=s)}function _getParamMatcher(e){if(!e.includes(":",1))return e.slice(1);const t=e.replace(/:(\w+)/g,(e,t)=>`(?<${t}>\\w+)`);return new RegExp(`^${t}$`)}function findRoute(e,t="",r,n){"/"===r[r.length-1]&&(r=r.slice(0,-1));const i=e.static[r];if(i&&i.methods){const e=i.methods[t]||i.methods[""];if(void 0!==e)return e[0]}const s=splitPath(r),o=_lookupTree(e,e.root,t,s,0)?.[0];if(void 0!==o)return{data:o.data,params:o.paramsMap?getMatchParams(s,o.paramsMap):void 0}}function _lookupTree(e,t,r,n,i){if(i===n.length){if(t.methods){const e=t.methods[r]||t.methods[""];if(e)return e}if(t.param&&t.param.methods){const e=t.param.methods[r]||t.param.methods[""];if(e){const t=e[0].paramsMap;if(t?.[t?.length-1]?.[2])return e}}if(t.wildcard&&t.wildcard.methods){const e=t.wildcard.methods[r]||t.wildcard.methods[""];if(e){const t=e[0].paramsMap;if(t?.[t?.length-1]?.[2])return e}}return}const s=n[i];if(t.static){const o=t.static[s];if(o){const t=_lookupTree(e,o,r,n,i+1);if(t)return t}}if(t.param){const s=_lookupTree(e,t.param,r,n,i+1);if(s)return s}if(t.wildcard&&t.wildcard.methods)return t.wildcard.methods[r]||t.wildcard.methods[""]}function findAllRoutes(e,t="",r,n){"/"===r[r.length-1]&&(r=r.slice(0,-1));const i=splitPath(r);return _findAll(e,e.root,t,i,0).map(e=>({data:e.data,params:e.paramsMap?getMatchParams(i,e.paramsMap):void 0}))}function _findAll(e,t,r,n,i,s=[]){const o=n[i];if(t.wildcard&&t.wildcard.methods){const e=t.wildcard.methods[r]||t.wildcard.methods[""];e&&s.push(...e)}if(t.param&&(_findAll(e,t.param,r,n,i+1,s),i===n.length&&t.param.methods)){const e=t.param.methods[r]||t.param.methods[""];e&&s.push(...e)}const a=t.static?.[o];if(a&&_findAll(e,a,r,n,i+1,s),i===n.length&&t.methods){const e=t.methods[r]||t.methods[""];e&&s.push(...e)}return s}var p={OK:200,CREATED:201,ACCEPTED:202,NO_CONTENT:204,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,TEMPORARY_REDIRECT:307,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,PAYLOAD_TOO_LARGE:413,URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,"I'M_A_TEAPOT":418,MISDIRECTED_REQUEST:421,UNPROCESSABLE_ENTITY:422,LOCKED:423,FAILED_DEPENDENCY:424,TOO_EARLY:425,UPGRADE_REQUIRED:426,PRECONDITION_REQUIRED:428,TOO_MANY_REQUESTS:429,REQUEST_HEADER_FIELDS_TOO_LARGE:431,UNAVAILABLE_FOR_LEGAL_REASONS:451,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,VARIANT_ALSO_NEGOTIATES:506,INSUFFICIENT_STORAGE:507,LOOP_DETECTED:508,NOT_EXTENDED:510,NETWORK_AUTHENTICATION_REQUIRED:511},h=class extends Error{constructor(e="INTERNAL_SERVER_ERROR",t=void 0,r={},n=("number"==typeof e?e:p[e])){super(t?.message),this.status=e,this.body=t,this.headers=r,this.statusCode=n,this.name="APIError",this.status=e,this.headers=r,this.statusCode=n,this.body=t?{code:t?.message?.toUpperCase().replace(/ /g,"_").replace(/[^A-Z0-9_]/g,""),...t}:void 0,this.stack=""}};async function getBody$1(e){const t=e.headers.get("content-type")||"";if(e.body){if(t.includes("application/json"))return await e.json();if(t.includes("application/x-www-form-urlencoded")){const t=await e.formData(),r={};return t.forEach((e,t)=>{r[t]=e.toString()}),r}if(t.includes("multipart/form-data")){const t=await e.formData(),r={};return t.forEach((e,t)=>{r[t]=e}),r}if(t.includes("text/plain"))return await e.text();if(t.includes("application/octet-stream"))return await e.arrayBuffer();if(t.includes("application/pdf")||t.includes("image/")||t.includes("video/")){return await e.blob()}return t.includes("application/stream")||e.body instanceof ReadableStream?e.body:await e.text()}}function isAPIError(e){return e instanceof h||"APIError"===e?.name}function tryDecode(e){try{return e.includes("%")?decodeURIComponent(e):e}catch{return e}}function toResponse(e,t){if(e instanceof Response)return t?.headers instanceof Headers&&t.headers.forEach((t,r)=>{e.headers.set(r,t)}),e;if("json"===e?._flag){const t=e.routerResponse;return t instanceof Response?t:toResponse(e.body,{headers:e.headers,status:e.status})}if(isAPIError(e))return toResponse(e.body,{status:e.statusCode,statusText:e.status.toString(),headers:t?.headers||e.headers});let r=e,n=new Headers(t?.headers);return e?"string"==typeof e?(r=e,n.set("Content-Type","text/plain")):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?(r=e,n.set("Content-Type","application/octet-stream")):e instanceof Blob?(r=e,n.set("Content-Type",e.type||"application/octet-stream")):e instanceof FormData?r=e:e instanceof URLSearchParams?(r=e,n.set("Content-Type","application/x-www-form-urlencoded")):e instanceof ReadableStream?(r=e,n.set("Content-Type","application/octet-stream")):function(e){if(void 0===e)return!1;const t=typeof e;return"string"===t||"number"===t||"boolean"===t||null===t||"object"===t&&(!!Array.isArray(e)||!e.buffer&&(e.constructor&&"Object"===e.constructor.name||"function"==typeof e.toJSON))}(e)&&(r=JSON.stringify(e,(e,t)=>"bigint"==typeof t?t.toString():t),n.set("Content-Type","application/json")):(null===e&&(r=JSON.stringify(null)),n.set("content-type","application/json")),new Response(r,{...t,headers:n})}function fromError(e,t){for(const t of e)t.message;return{message:`Invalid ${t} parameters`}}var f={name:"HMAC",hash:"SHA-256"},getCryptoKey$1=async t=>{const r="string"==typeof t?(new TextEncoder).encode(t):t;return await e.importKey("raw",r,f,!1,["sign","verify"])},signCookieValue=async(t,r)=>{const n=await(async(t,r)=>{const n=await getCryptoKey$1(r),i=await e.sign(f.name,n,(new TextEncoder).encode(t));return btoa(String.fromCharCode(...new Uint8Array(i)))})(t,r);return t=`${t}.${n}`,t=encodeURIComponent(t)},getCookieKey=(e,t)=>{let r=e;if(t)if("secure"===t)r="__Secure-"+e;else{if("host"!==t)return;r="__Host-"+e}return r};var _serialize=(e,t,r={})=>{let n;if(n="secure"===r?.prefix?`__Secure-${e}=${t}`:"host"===r?.prefix?`__Host-${e}=${t}`:`${e}=${t}`,e.startsWith("__Secure-")&&!r.secure&&(r.secure=!0),e.startsWith("__Host-")&&(r.secure||(r.secure=!0),"/"!==r.path&&(r.path="/"),r.domain&&(r.domain=void 0)),r&&"number"==typeof r.maxAge&&r.maxAge>=0){if(r.maxAge>3456e4)throw new Error("Cookies Max-Age SHOULD NOT be greater than 400 days (34560000 seconds) in duration.");n+=`; Max-Age=${Math.floor(r.maxAge)}`}if(r.domain&&"host"!==r.prefix&&(n+=`; Domain=${r.domain}`),r.path&&(n+=`; Path=${r.path}`),r.expires){if(r.expires.getTime()-Date.now()>3456e7)throw new Error("Cookies Expires SHOULD NOT be greater than 400 days (34560000 seconds) in the future.");n+=`; Expires=${r.expires.toUTCString()}`}return r.httpOnly&&(n+="; HttpOnly"),r.secure&&(n+="; Secure"),r.sameSite&&(n+=`; SameSite=${r.sameSite.charAt(0).toUpperCase()+r.sameSite.slice(1)}`),r.partitioned&&(r.secure||(r.secure=!0),n+="; Partitioned"),n},createInternalContext=async(t,{options:r,path:n})=>{const i=new Headers,{data:s,error:o}=await async function(e,t={}){let r={body:t.body,query:t.query};if(e.body){const n=await e.body["~standard"].validate(t.body);if(n.issues)return{data:null,error:fromError(n.issues,"body")};r.body=n.value}if(e.query){const n=await e.query["~standard"].validate(t.query);if(n.issues)return{data:null,error:fromError(n.issues,"query")};r.query=n.value}return e.requireHeaders&&!t.headers?{data:null,error:{message:"Headers is required"}}:e.requireRequest&&!t.request?{data:null,error:{message:"Request is required"}}:{data:r,error:null}}(r,t);if(o)throw new h(400,{message:o.message,code:"VALIDATION_ERROR"});const a="headers"in t?t.headers instanceof Headers?t.headers:new Headers(t.headers):"request"in t&&t.request instanceof Request?t.request.headers:null,c=a?.get("cookie"),d=c?function(e){if("string"!=typeof e)throw new TypeError("argument str must be a string");const t=new Map;let r=0;for(;r<e.length;){const n=e.indexOf("=",r);if(-1===n)break;let i=e.indexOf(";",r);if(-1===i)i=e.length;else if(i<n){r=e.lastIndexOf(";",n-1)+1;continue}const s=e.slice(r,n).trim();if(!t.has(s)){let r=e.slice(n+1,i).trim();34===r.codePointAt(0)&&(r=r.slice(1,-1)),t.set(s,tryDecode(r))}r=i+1}return t}(c):void 0,l={...t,body:s.body,query:s.query,path:t.path||n,context:"context"in t&&t.context?t.context:{},returned:void 0,headers:t?.headers,request:t?.request,params:"params"in t?t.params:void 0,method:t.method,setHeader:(e,t)=>{i.set(e,t)},getHeader:e=>a?a.get(e):null,getCookie:(e,t)=>{const r=getCookieKey(e,t);return r&&d?.get(r)||null},getSignedCookie:async(t,r,n)=>{const i=getCookieKey(t,n);if(!i)return null;const s=d?.get(i);if(!s)return null;const o=s.lastIndexOf(".");if(o<1)return null;const a=s.substring(0,o),c=s.substring(o+1);if(44!==c.length||!c.endsWith("="))return null;const l=await getCryptoKey$1(r),u=await(async(t,r,n)=>{try{const i=atob(t),s=new Uint8Array(i.length);for(let e=0,t=i.length;e<t;e++)s[e]=i.charCodeAt(e);return await e.verify(f,n,s,(new TextEncoder).encode(r))}catch(e){return!1}})(c,a,l);return!!u&&a},setCookie:(e,t,r)=>{const n=((e,t,r)=>(t=encodeURIComponent(t),_serialize(e,t,r)))(e,t,r);return i.append("set-cookie",n),n},setSignedCookie:async(e,t,r,n)=>{const s=await(async(e,t,r,n)=>(t=await signCookieValue(t,r),_serialize(e,t,n)))(e,t,r,n);return i.append("set-cookie",s),s},redirect:e=>(i.set("location",e),new h("FOUND",void 0,i)),error:(e,t,r)=>new h(e,t,r),json:(e,r)=>t.asResponse?{body:r?.body||e,routerResponse:r,_flag:"json"}:e,responseHeaders:i};for(const e of r.use||[]){const t=await e({...l,returnHeaders:!0,asResponse:!1});t.response&&Object.assign(l.context,t.response),t.headers&&t.headers.forEach((e,t)=>{l.responseHeaders.set(t,e)})}return l};function createMiddleware(e,t){const internalHandler=async r=>{const n=r,i="function"==typeof e?e:t,s="function"==typeof e?{}:e,o=await createInternalContext(n,{options:s,path:"/"});if(!i)throw new Error("handler must be defined");const a=await i(o),c=o.responseHeaders;return n.returnHeaders?{headers:c,response:a}:a};return internalHandler.options="function"==typeof e?{}:e,internalHandler}createMiddleware.create=e=>function(t,r){if("function"==typeof t)return createMiddleware({use:e?.use},t);if(!r)throw new Error("Middleware handler is required");return createMiddleware({...t,method:"*",use:[...e?.use||[],...t.use||[]]},r)};var m,g,y,createEndpoint2=(e,t,r)=>{const internalHandler=async(...n)=>{const i=n[0]||{},s=await createInternalContext(i,{options:t,path:e}),o=await r(s).catch(async e=>{if(isAPIError(e)){const r=t.onAPIError;if(r&&await r(e),i.asResponse)return e}throw e}),a=s.responseHeaders;return i.asResponse?toResponse(o,{headers:a}):i.returnHeaders?{headers:a,response:o}:o};return internalHandler.options=t,internalHandler.path=e,internalHandler};createEndpoint2.create=e=>(t,r,n)=>createEndpoint2(t,{...r,use:[...r?.use||[],...e?.use||[]]},n),(g=m||(m={})).assertEqual=e=>e,g.assertIs=function(e){},g.assertNever=function(e){throw new Error},g.arrayToEnum=e=>{const t={};for(const r of e)t[r]=r;return t},g.getValidEnumValues=e=>{const t=g.objectKeys(e).filter(t=>"number"!=typeof e[e[t]]),r={};for(const n of t)r[n]=e[n];return g.objectValues(r)},g.objectValues=e=>g.objectKeys(e).map(function(t){return e[t]}),g.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},g.find=(e,t)=>{for(const r of e)if(t(r))return r},g.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,g.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},g.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t,(y||(y={})).mergeShapes=(e,t)=>({...e,...t});var w=m.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),getParsedType=e=>{switch(typeof e){case"undefined":return w.undefined;case"string":return w.string;case"number":return isNaN(e)?w.nan:w.number;case"boolean":return w.boolean;case"function":return w.function;case"bigint":return w.bigint;case"symbol":return w.symbol;case"object":return Array.isArray(e)?w.array:null===e?w.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?w.promise:"undefined"!=typeof Map&&e instanceof Map?w.map:"undefined"!=typeof Set&&e instanceof Set?w.set:"undefined"!=typeof Date&&e instanceof Date?w.date:w.object;default:return w.unknown}},b=m.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),v=class _ZodError extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},r={_errors:[]},processError=e=>{for(const n of e.issues)if("invalid_union"===n.code)n.unionErrors.map(processError);else if("invalid_return_type"===n.code)processError(n.returnTypeError);else if("invalid_arguments"===n.code)processError(n.argumentsError);else if(0===n.path.length)r._errors.push(t(n));else{let e=r,i=0;for(;i<n.path.length;){const r=n.path[i];i===n.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(n))):e[r]=e[r]||{_errors:[]},e=e[r],i++}}};return processError(this),r}static assert(e){if(!(e instanceof _ZodError))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,m.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},r=[];for(const n of this.issues)n.path.length>0?(t[n.path[0]]=t[n.path[0]]||[],t[n.path[0]].push(e(n))):r.push(e(n));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}};v.create=e=>new v(e);var errorMap=(e,t)=>{let r;switch(e.code){case b.invalid_type:r=e.received===w.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case b.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,m.jsonStringifyReplacer)}`;break;case b.unrecognized_keys:r=`Unrecognized key(s) in object: ${m.joinValues(e.keys,", ")}`;break;case b.invalid_union:r="Invalid input";break;case b.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${m.joinValues(e.options)}`;break;case b.invalid_enum_value:r=`Invalid enum value. Expected ${m.joinValues(e.options)}, received '${e.received}'`;break;case b.invalid_arguments:r="Invalid function arguments";break;case b.invalid_return_type:r="Invalid function return type";break;case b.invalid_date:r="Invalid date";break;case b.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:m.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case b.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case b.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case b.custom:r="Invalid input";break;case b.invalid_intersection_types:r="Intersection results could not be merged";break;case b.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case b.not_finite:r="Number must be finite";break;default:r=t.defaultError,m.assertNever(e)}return{message:r}},N=errorMap;function addIssueToContext(e,t){const r=N,n=(e=>{const{data:t,path:r,errorMaps:n,issueData:i}=e,s=[...r,...i.path||[]],o={...i,path:s};if(void 0!==i.message)return{...i,path:s,message:i.message};let a="";const c=n.filter(e=>!!e).slice().reverse();for(const e of c)a=e(o,{data:t,defaultError:a}).message;return{...i,path:s,message:a}})({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===errorMap?void 0:errorMap].filter(e=>!!e)});e.common.issues.push(n)}var T,k,x,S,A=class _ParseStatus{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const n of t){if("aborted"===n.status)return I;"dirty"===n.status&&e.dirty(),r.push(n.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const e of t){const t=await e.key,n=await e.value;r.push({key:t,value:n})}return _ParseStatus.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const n of t){const{key:t,value:i}=n;if("aborted"===t.status)return I;if("aborted"===i.status)return I;"dirty"===t.status&&e.dirty(),"dirty"===i.status&&e.dirty(),"__proto__"===t.value||void 0===i.value&&!n.alwaysSet||(r[t.value]=i.value)}return{status:e.value,value:r}}},I=Object.freeze({status:"aborted"}),DIRTY=e=>({status:"dirty",value:e}),OK=e=>({status:"valid",value:e}),isAborted=e=>"aborted"===e.status,isDirty=e=>"dirty"===e.status,isValid=e=>"valid"===e.status,isAsync=e=>"undefined"!=typeof Promise&&e instanceof Promise;function __classPrivateFieldGet(e,t,r,n){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}function __classPrivateFieldSet(e,t,r,n,i){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,r),r}(k=T||(T={})).errToObj=e=>"string"==typeof e?{message:e}:e||{},k.toString=e=>"string"==typeof e?e:null==e?void 0:e.message;var E=class{constructor(e,t,r,n){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=n}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},handleResult=(e,t)=>{if(isValid(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new v(e.common.issues);return this._error=t,this._error}}};function processCreateParams(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:n,description:i}=e;if(t&&(r||n))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');if(t)return{errorMap:t,description:i};return{errorMap:(t,i)=>{var s,o;const{message:a}=e;return"invalid_enum_value"===t.code?{message:null!=a?a:i.defaultError}:void 0===i.data?{message:null!==(s=null!=a?a:n)&&void 0!==s?s:i.defaultError}:"invalid_type"!==t.code?{message:i.defaultError}:{message:null!==(o=null!=a?a:r)&&void 0!==o?o:i.defaultError}},description:i}}var O,P=class{get description(){return this._def.description}_getType(e){return getParsedType(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:getParsedType(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new A,ctx:{common:e.parent.common,data:e.data,parsedType:getParsedType(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(isAsync(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const n={common:{issues:[],async:null!==(r=null==t?void 0:t.async)&&void 0!==r&&r,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:getParsedType(e)},i=this._parseSync({data:e,path:n.path,parent:n});return handleResult(n,i)}"~validate"(e){var t,r;const n={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:getParsedType(e)};if(!this["~standard"].async)try{const t=this._parseSync({data:e,path:[],parent:n});return isValid(t)?{value:t.value}:{issues:n.common.issues}}catch(e){(null===(r=null===(t=null==e?void 0:e.message)||void 0===t?void 0:t.toLowerCase())||void 0===r?void 0:r.includes("encountered"))&&(this["~standard"].async=!0),n.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:n}).then(e=>isValid(e)?{value:e.value}:{issues:n.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:getParsedType(e)},n=this._parse({data:e,path:r.path,parent:r}),i=await(isAsync(n)?n:Promise.resolve(n));return handleResult(r,i)}refine(e,t){const getIssueProperties=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,r)=>{const n=e(t),setError=()=>r.addIssue({code:b.custom,...getIssueProperties(t)});return"undefined"!=typeof Promise&&n instanceof Promise?n.then(e=>!!e||(setError(),!1)):!!n||(setError(),!1)})}refinement(e,t){return this._refinement((r,n)=>!!e(r)||(n.addIssue("function"==typeof t?t(r,n):t),!1))}_refinement(e){return new ve({schema:this,typeName:_e.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return Ne.create(this,this._def)}nullable(){return Te.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ce.create(this)}promise(){return be.create(this,this._def)}or(e){return le.create([this,e],this._def)}and(e){return ue.create(this,e,this._def)}transform(e){return new ve({...processCreateParams(this._def),schema:this,typeName:_e.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new ke({...processCreateParams(this._def),innerType:this,defaultValue:t,typeName:_e.ZodDefault})}brand(){return new Ie({typeName:_e.ZodBranded,type:this,...processCreateParams(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new xe({...processCreateParams(this._def),innerType:this,catchValue:t,typeName:_e.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Ee.create(this,e)}readonly(){return Ce.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},R=/^c[^\s-]{8,}$/i,$=/^[0-9a-z]+$/,B=/^[0-9A-HJKMNP-TV-Z]{26}$/i,U=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,L=/^[a-z0-9_-]{21}$/i,z=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,D=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,q=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,W=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,j=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,M=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Q=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,V=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,F=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,J="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",K=new RegExp(`^${J}$`);function timeRegexSource(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function timeRegex(e){return new RegExp(`^${timeRegexSource(e)}$`)}function datetimeRegex(e){let t=`${J}T${timeRegexSource(e)}`;const r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,new RegExp(`^${t}$`)}function isValidIP$1(e,t){return!("v4"!==t&&t||!W.test(e))||!("v6"!==t&&t||!M.test(e))}function isValidJWT$1(e,t){if(!z.test(e))return!1;try{const[r]=e.split("."),n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),i=JSON.parse(atob(n));return"object"==typeof i&&null!==i&&(!(!i.typ||!i.alg)&&(!t||i.alg===t))}catch(e){return!1}}function isValidCidr(e,t){return!("v4"!==t&&t||!j.test(e))||!("v6"!==t&&t||!Q.test(e))}var H=class _ZodString extends P{_parse(e){this._def.coerce&&(e.data=String(e.data));if(this._getType(e)!==w.string){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.string,received:t.parsedType}),I}const t=new A;let r;for(const n of this._def.checks)if("min"===n.kind)e.data.length<n.value&&(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),t.dirty());else if("max"===n.kind)e.data.length>n.value&&(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),t.dirty());else if("length"===n.kind){const i=e.data.length>n.value,s=e.data.length<n.value;(i||s)&&(r=this._getOrReturnCtx(e,r),i?addIssueToContext(r,{code:b.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}):s&&addIssueToContext(r,{code:b.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}),t.dirty())}else if("email"===n.kind)q.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"email",code:b.invalid_string,message:n.message}),t.dirty());else if("emoji"===n.kind)O||(O=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),O.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"emoji",code:b.invalid_string,message:n.message}),t.dirty());else if("uuid"===n.kind)U.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"uuid",code:b.invalid_string,message:n.message}),t.dirty());else if("nanoid"===n.kind)L.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"nanoid",code:b.invalid_string,message:n.message}),t.dirty());else if("cuid"===n.kind)R.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"cuid",code:b.invalid_string,message:n.message}),t.dirty());else if("cuid2"===n.kind)$.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"cuid2",code:b.invalid_string,message:n.message}),t.dirty());else if("ulid"===n.kind)B.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"ulid",code:b.invalid_string,message:n.message}),t.dirty());else if("url"===n.kind)try{new URL(e.data)}catch(i){r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"url",code:b.invalid_string,message:n.message}),t.dirty()}else if("regex"===n.kind){n.regex.lastIndex=0;n.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"regex",code:b.invalid_string,message:n.message}),t.dirty())}else if("trim"===n.kind)e.data=e.data.trim();else if("includes"===n.kind)e.data.includes(n.value,n.position)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.invalid_string,validation:{includes:n.value,position:n.position},message:n.message}),t.dirty());else if("toLowerCase"===n.kind)e.data=e.data.toLowerCase();else if("toUpperCase"===n.kind)e.data=e.data.toUpperCase();else if("startsWith"===n.kind)e.data.startsWith(n.value)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.invalid_string,validation:{startsWith:n.value},message:n.message}),t.dirty());else if("endsWith"===n.kind)e.data.endsWith(n.value)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.invalid_string,validation:{endsWith:n.value},message:n.message}),t.dirty());else if("datetime"===n.kind){datetimeRegex(n).test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.invalid_string,validation:"datetime",message:n.message}),t.dirty())}else if("date"===n.kind){K.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.invalid_string,validation:"date",message:n.message}),t.dirty())}else if("time"===n.kind){timeRegex(n).test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.invalid_string,validation:"time",message:n.message}),t.dirty())}else"duration"===n.kind?D.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"duration",code:b.invalid_string,message:n.message}),t.dirty()):"ip"===n.kind?isValidIP$1(e.data,n.version)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"ip",code:b.invalid_string,message:n.message}),t.dirty()):"jwt"===n.kind?isValidJWT$1(e.data,n.alg)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"jwt",code:b.invalid_string,message:n.message}),t.dirty()):"cidr"===n.kind?isValidCidr(e.data,n.version)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"cidr",code:b.invalid_string,message:n.message}),t.dirty()):"base64"===n.kind?V.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"base64",code:b.invalid_string,message:n.message}),t.dirty()):"base64url"===n.kind?F.test(e.data)||(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{validation:"base64url",code:b.invalid_string,message:n.message}),t.dirty()):m.assertNever(n);return{status:t.value,value:e.data}}_regex(e,t,r){return this.refinement(t=>e.test(t),{validation:t,code:b.invalid_string,...T.errToObj(r)})}_addCheck(e){return new _ZodString({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...T.errToObj(e)})}url(e){return this._addCheck({kind:"url",...T.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...T.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...T.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...T.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...T.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...T.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...T.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...T.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...T.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...T.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...T.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...T.errToObj(e)})}datetime(e){var t,r;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(r=null==e?void 0:e.local)&&void 0!==r&&r,...T.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...T.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...T.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...T.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...T.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...T.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...T.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...T.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...T.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...T.errToObj(t)})}nonempty(e){return this.min(1,T.errToObj(e))}trim(){return new _ZodString({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new _ZodString({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new _ZodString({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}};function floatSafeRemainder$1(e,t){const r=(e.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,i=r>n?r:n;return parseInt(e.toFixed(i).replace(".",""))%parseInt(t.toFixed(i).replace(".",""))/Math.pow(10,i)}H.create=e=>{var t;return new H({checks:[],typeName:_e.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...processCreateParams(e)})};var Z=class _ZodNumber extends P{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){this._def.coerce&&(e.data=Number(e.data));if(this._getType(e)!==w.number){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.number,received:t.parsedType}),I}let t;const r=new A;for(const n of this._def.checks)if("int"===n.kind)m.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),addIssueToContext(t,{code:b.invalid_type,expected:"integer",received:"float",message:n.message}),r.dirty());else if("min"===n.kind){(n.inclusive?e.data<n.value:e.data<=n.value)&&(t=this._getOrReturnCtx(e,t),addIssueToContext(t,{code:b.too_small,minimum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),r.dirty())}else if("max"===n.kind){(n.inclusive?e.data>n.value:e.data>=n.value)&&(t=this._getOrReturnCtx(e,t),addIssueToContext(t,{code:b.too_big,maximum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),r.dirty())}else"multipleOf"===n.kind?0!==floatSafeRemainder$1(e.data,n.value)&&(t=this._getOrReturnCtx(e,t),addIssueToContext(t,{code:b.not_multiple_of,multipleOf:n.value,message:n.message}),r.dirty()):"finite"===n.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),addIssueToContext(t,{code:b.not_finite,message:n.message}),r.dirty()):m.assertNever(n);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,T.toString(t))}gt(e,t){return this.setLimit("min",e,!1,T.toString(t))}lte(e,t){return this.setLimit("max",e,!0,T.toString(t))}lt(e,t){return this.setLimit("max",e,!1,T.toString(t))}setLimit(e,t,r,n){return new _ZodNumber({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:T.toString(n)}]})}_addCheck(e){return new _ZodNumber({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:T.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:T.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:T.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:T.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:T.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:T.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:T.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:T.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:T.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&m.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}};Z.create=e=>new Z({checks:[],typeName:_e.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...processCreateParams(e)});var G=class _ZodBigInt extends P{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch(t){return this._getInvalidInput(e)}if(this._getType(e)!==w.bigint)return this._getInvalidInput(e);let t;const r=new A;for(const n of this._def.checks)if("min"===n.kind){(n.inclusive?e.data<n.value:e.data<=n.value)&&(t=this._getOrReturnCtx(e,t),addIssueToContext(t,{code:b.too_small,type:"bigint",minimum:n.value,inclusive:n.inclusive,message:n.message}),r.dirty())}else if("max"===n.kind){(n.inclusive?e.data>n.value:e.data>=n.value)&&(t=this._getOrReturnCtx(e,t),addIssueToContext(t,{code:b.too_big,type:"bigint",maximum:n.value,inclusive:n.inclusive,message:n.message}),r.dirty())}else"multipleOf"===n.kind?e.data%n.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),addIssueToContext(t,{code:b.not_multiple_of,multipleOf:n.value,message:n.message}),r.dirty()):m.assertNever(n);return{status:r.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.bigint,received:t.parsedType}),I}gte(e,t){return this.setLimit("min",e,!0,T.toString(t))}gt(e,t){return this.setLimit("min",e,!1,T.toString(t))}lte(e,t){return this.setLimit("max",e,!0,T.toString(t))}lt(e,t){return this.setLimit("max",e,!1,T.toString(t))}setLimit(e,t,r,n){return new _ZodBigInt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:T.toString(n)}]})}_addCheck(e){return new _ZodBigInt({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:T.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:T.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:T.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:T.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:T.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}};G.create=e=>{var t;return new G({checks:[],typeName:_e.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...processCreateParams(e)})};var Y=class extends P{_parse(e){this._def.coerce&&(e.data=Boolean(e.data));if(this._getType(e)!==w.boolean){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.boolean,received:t.parsedType}),I}return OK(e.data)}};Y.create=e=>new Y({typeName:_e.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...processCreateParams(e)});var X=class _ZodDate extends P{_parse(e){this._def.coerce&&(e.data=new Date(e.data));if(this._getType(e)!==w.date){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.date,received:t.parsedType}),I}if(isNaN(e.data.getTime())){return addIssueToContext(this._getOrReturnCtx(e),{code:b.invalid_date}),I}const t=new A;let r;for(const n of this._def.checks)"min"===n.kind?e.data.getTime()<n.value&&(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.too_small,message:n.message,inclusive:!0,exact:!1,minimum:n.value,type:"date"}),t.dirty()):"max"===n.kind?e.data.getTime()>n.value&&(r=this._getOrReturnCtx(e,r),addIssueToContext(r,{code:b.too_big,message:n.message,inclusive:!0,exact:!1,maximum:n.value,type:"date"}),t.dirty()):m.assertNever(n);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new _ZodDate({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:T.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:T.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}};X.create=e=>new X({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:_e.ZodDate,...processCreateParams(e)});var ee=class extends P{_parse(e){if(this._getType(e)!==w.symbol){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.symbol,received:t.parsedType}),I}return OK(e.data)}};ee.create=e=>new ee({typeName:_e.ZodSymbol,...processCreateParams(e)});var te=class extends P{_parse(e){if(this._getType(e)!==w.undefined){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.undefined,received:t.parsedType}),I}return OK(e.data)}};te.create=e=>new te({typeName:_e.ZodUndefined,...processCreateParams(e)});var re=class extends P{_parse(e){if(this._getType(e)!==w.null){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.null,received:t.parsedType}),I}return OK(e.data)}};re.create=e=>new re({typeName:_e.ZodNull,...processCreateParams(e)});var ie=class extends P{constructor(){super(...arguments),this._any=!0}_parse(e){return OK(e.data)}};ie.create=e=>new ie({typeName:_e.ZodAny,...processCreateParams(e)});var se=class extends P{constructor(){super(...arguments),this._unknown=!0}_parse(e){return OK(e.data)}};se.create=e=>new se({typeName:_e.ZodUnknown,...processCreateParams(e)});var oe=class extends P{_parse(e){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.never,received:t.parsedType}),I}};oe.create=e=>new oe({typeName:_e.ZodNever,...processCreateParams(e)});var ae=class extends P{_parse(e){if(this._getType(e)!==w.undefined){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.void,received:t.parsedType}),I}return OK(e.data)}};ae.create=e=>new ae({typeName:_e.ZodVoid,...processCreateParams(e)});var ce=class _ZodArray extends P{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),n=this._def;if(t.parsedType!==w.array)return addIssueToContext(t,{code:b.invalid_type,expected:w.array,received:t.parsedType}),I;if(null!==n.exactLength){const e=t.data.length>n.exactLength.value,i=t.data.length<n.exactLength.value;(e||i)&&(addIssueToContext(t,{code:e?b.too_big:b.too_small,minimum:i?n.exactLength.value:void 0,maximum:e?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),r.dirty())}if(null!==n.minLength&&t.data.length<n.minLength.value&&(addIssueToContext(t,{code:b.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),r.dirty()),null!==n.maxLength&&t.data.length>n.maxLength.value&&(addIssueToContext(t,{code:b.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((e,r)=>n.type._parseAsync(new E(t,e,t.path,r)))).then(e=>A.mergeArray(r,e));const i=[...t.data].map((e,r)=>n.type._parseSync(new E(t,e,t.path,r)));return A.mergeArray(r,i)}get element(){return this._def.type}min(e,t){return new _ZodArray({...this._def,minLength:{value:e,message:T.toString(t)}})}max(e,t){return new _ZodArray({...this._def,maxLength:{value:e,message:T.toString(t)}})}length(e,t){return new _ZodArray({...this._def,exactLength:{value:e,message:T.toString(t)}})}nonempty(e){return this.min(1,e)}};function deepPartialify(e){if(e instanceof de){const t={};for(const r in e.shape){const n=e.shape[r];t[r]=Ne.create(deepPartialify(n))}return new de({...e._def,shape:()=>t})}return e instanceof ce?new ce({...e._def,type:deepPartialify(e.element)}):e instanceof Ne?Ne.create(deepPartialify(e.unwrap())):e instanceof Te?Te.create(deepPartialify(e.unwrap())):e instanceof pe?pe.create(e.items.map(e=>deepPartialify(e))):e}ce.create=(e,t)=>new ce({type:e,minLength:null,maxLength:null,exactLength:null,typeName:_e.ZodArray,...processCreateParams(t)});var de=class _ZodObject extends P{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=m.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==w.object){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.object,received:t.parsedType}),I}const{status:t,ctx:r}=this._processInputParams(e),{shape:n,keys:i}=this._getCached(),s=[];if(!(this._def.catchall instanceof oe&&"strip"===this._def.unknownKeys))for(const e in r.data)i.includes(e)||s.push(e);const o=[];for(const e of i){const t=n[e],i=r.data[e];o.push({key:{status:"valid",value:e},value:t._parse(new E(r,i,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof oe){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of s)o.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)s.length>0&&(addIssueToContext(r,{code:b.unrecognized_keys,keys:s}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of s){const n=r.data[t];o.push({key:{status:"valid",value:t},value:e._parse(new E(r,n,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of o){const r=await t.key,n=await t.value;e.push({key:r,value:n,alwaysSet:t.alwaysSet})}return e}).then(e=>A.mergeObjectSync(t,e)):A.mergeObjectSync(t,o)}get shape(){return this._def.shape()}strict(e){return T.errToObj,new _ZodObject({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{var n,i,s,o;const a=null!==(s=null===(i=(n=this._def).errorMap)||void 0===i?void 0:i.call(n,t,r).message)&&void 0!==s?s:r.defaultError;return"unrecognized_keys"===t.code?{message:null!==(o=T.errToObj(e).message)&&void 0!==o?o:a}:{message:a}}}:{}})}strip(){return new _ZodObject({...this._def,unknownKeys:"strip"})}passthrough(){return new _ZodObject({...this._def,unknownKeys:"passthrough"})}extend(e){return new _ZodObject({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new _ZodObject({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:_e.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new _ZodObject({...this._def,catchall:e})}pick(e){const t={};return m.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new _ZodObject({...this._def,shape:()=>t})}omit(e){const t={};return m.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new _ZodObject({...this._def,shape:()=>t})}deepPartial(){return deepPartialify(this)}partial(e){const t={};return m.objectKeys(this.shape).forEach(r=>{const n=this.shape[r];e&&!e[r]?t[r]=n:t[r]=n.optional()}),new _ZodObject({...this._def,shape:()=>t})}required(e){const t={};return m.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof Ne;)e=e._def.innerType;t[r]=e}}),new _ZodObject({...this._def,shape:()=>t})}keyof(){return createZodEnum(m.objectKeys(this.shape))}};de.create=(e,t)=>new de({shape:()=>e,unknownKeys:"strip",catchall:oe.create(),typeName:_e.ZodObject,...processCreateParams(t)}),de.strictCreate=(e,t)=>new de({shape:()=>e,unknownKeys:"strict",catchall:oe.create(),typeName:_e.ZodObject,...processCreateParams(t)}),de.lazycreate=(e,t)=>new de({shape:e,unknownKeys:"strip",catchall:oe.create(),typeName:_e.ZodObject,...processCreateParams(t)});var le=class extends P{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map(async e=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;const r=e.map(e=>new v(e.ctx.common.issues));return addIssueToContext(t,{code:b.invalid_union,unionErrors:r}),I});{let e;const n=[];for(const i of r){const r={...t,common:{...t.common,issues:[]},parent:null},s=i._parseSync({data:t.data,path:t.path,parent:r});if("valid"===s.status)return s;"dirty"!==s.status||e||(e={result:s,ctx:r}),r.common.issues.length&&n.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const i=n.map(e=>new v(e));return addIssueToContext(t,{code:b.invalid_union,unionErrors:i}),I}}get options(){return this._def.options}};function mergeValues$1(e,t){const r=getParsedType(e),n=getParsedType(t);if(e===t)return{valid:!0,data:e};if(r===w.object&&n===w.object){const r=m.objectKeys(t),n=m.objectKeys(e).filter(e=>-1!==r.indexOf(e)),i={...e,...t};for(const r of n){const n=mergeValues$1(e[r],t[r]);if(!n.valid)return{valid:!1};i[r]=n.data}return{valid:!0,data:i}}if(r===w.array&&n===w.array){if(e.length!==t.length)return{valid:!1};const r=[];for(let n=0;n<e.length;n++){const i=mergeValues$1(e[n],t[n]);if(!i.valid)return{valid:!1};r.push(i.data)}return{valid:!0,data:r}}return r===w.date&&n===w.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}le.create=(e,t)=>new le({options:e,typeName:_e.ZodUnion,...processCreateParams(t)});var ue=class extends P{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),handleParsed=(e,n)=>{if(isAborted(e)||isAborted(n))return I;const i=mergeValues$1(e.value,n.value);return i.valid?((isDirty(e)||isDirty(n))&&t.dirty(),{status:t.value,value:i.data}):(addIssueToContext(r,{code:b.invalid_intersection_types}),I)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([e,t])=>handleParsed(e,t)):handleParsed(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};ue.create=(e,t,r)=>new ue({left:e,right:t,typeName:_e.ZodIntersection,...processCreateParams(r)});var pe=class _ZodTuple extends P{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==w.array)return addIssueToContext(r,{code:b.invalid_type,expected:w.array,received:r.parsedType}),I;if(r.data.length<this._def.items.length)return addIssueToContext(r,{code:b.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),I;!this._def.rest&&r.data.length>this._def.items.length&&(addIssueToContext(r,{code:b.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const n=[...r.data].map((e,t)=>{const n=this._def.items[t]||this._def.rest;return n?n._parse(new E(r,e,r.path,t)):null}).filter(e=>!!e);return r.common.async?Promise.all(n).then(e=>A.mergeArray(t,e)):A.mergeArray(t,n)}get items(){return this._def.items}rest(e){return new _ZodTuple({...this._def,rest:e})}};pe.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new pe({items:e,typeName:_e.ZodTuple,rest:null,...processCreateParams(t)})};var he=class extends P{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==w.map)return addIssueToContext(r,{code:b.invalid_type,expected:w.map,received:r.parsedType}),I;const n=this._def.keyType,i=this._def.valueType,s=[...r.data.entries()].map(([e,t],s)=>({key:n._parse(new E(r,e,r.path,[s,"key"])),value:i._parse(new E(r,t,r.path,[s,"value"]))}));if(r.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const r of s){const n=await r.key,i=await r.value;if("aborted"===n.status||"aborted"===i.status)return I;"dirty"!==n.status&&"dirty"!==i.status||t.dirty(),e.set(n.value,i.value)}return{status:t.value,value:e}})}{const e=new Map;for(const r of s){const n=r.key,i=r.value;if("aborted"===n.status||"aborted"===i.status)return I;"dirty"!==n.status&&"dirty"!==i.status||t.dirty(),e.set(n.value,i.value)}return{status:t.value,value:e}}}};he.create=(e,t,r)=>new he({valueType:t,keyType:e,typeName:_e.ZodMap,...processCreateParams(r)});var fe=class _ZodSet extends P{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==w.set)return addIssueToContext(r,{code:b.invalid_type,expected:w.set,received:r.parsedType}),I;const n=this._def;null!==n.minSize&&r.data.size<n.minSize.value&&(addIssueToContext(r,{code:b.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),t.dirty()),null!==n.maxSize&&r.data.size>n.maxSize.value&&(addIssueToContext(r,{code:b.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),t.dirty());const i=this._def.valueType;function finalizeSet(e){const r=new Set;for(const n of e){if("aborted"===n.status)return I;"dirty"===n.status&&t.dirty(),r.add(n.value)}return{status:t.value,value:r}}const s=[...r.data.values()].map((e,t)=>i._parse(new E(r,e,r.path,t)));return r.common.async?Promise.all(s).then(e=>finalizeSet(e)):finalizeSet(s)}min(e,t){return new _ZodSet({...this._def,minSize:{value:e,message:T.toString(t)}})}max(e,t){return new _ZodSet({...this._def,maxSize:{value:e,message:T.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};fe.create=(e,t)=>new fe({valueType:e,minSize:null,maxSize:null,typeName:_e.ZodSet,...processCreateParams(t)});var me=class extends P{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};me.create=(e,t)=>new me({getter:e,typeName:_e.ZodLazy,...processCreateParams(t)});var ge=class extends P{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{received:t.data,code:b.invalid_literal,expected:this._def.value}),I}return{status:"valid",value:e.data}}get value(){return this._def.value}};function createZodEnum(e,t){return new ye({values:e,typeName:_e.ZodEnum,...processCreateParams(t)})}ge.create=(e,t)=>new ge({value:e,typeName:_e.ZodLiteral,...processCreateParams(t)});var ye=class _ZodEnum extends P{constructor(){super(...arguments),x.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),r=this._def.values;return addIssueToContext(t,{expected:m.joinValues(r),received:t.parsedType,code:b.invalid_type}),I}if(__classPrivateFieldGet(this,x)||__classPrivateFieldSet(this,x,new Set(this._def.values)),!__classPrivateFieldGet(this,x).has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return addIssueToContext(t,{received:t.data,code:b.invalid_enum_value,options:r}),I}return OK(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return _ZodEnum.create(e,{...this._def,...t})}exclude(e,t=this._def){return _ZodEnum.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}};x=new WeakMap,ye.create=createZodEnum;var we=class extends P{constructor(){super(...arguments),S.set(this,void 0)}_parse(e){const t=m.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==w.string&&r.parsedType!==w.number){const e=m.objectValues(t);return addIssueToContext(r,{expected:m.joinValues(e),received:r.parsedType,code:b.invalid_type}),I}if(__classPrivateFieldGet(this,S)||__classPrivateFieldSet(this,S,new Set(m.getValidEnumValues(this._def.values))),!__classPrivateFieldGet(this,S).has(e.data)){const e=m.objectValues(t);return addIssueToContext(r,{received:r.data,code:b.invalid_enum_value,options:e}),I}return OK(e.data)}get enum(){return this._def.values}};S=new WeakMap,we.create=(e,t)=>new we({values:e,typeName:_e.ZodNativeEnum,...processCreateParams(t)});var be=class extends P{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==w.promise&&!1===t.common.async)return addIssueToContext(t,{code:b.invalid_type,expected:w.promise,received:t.parsedType}),I;const r=t.parsedType===w.promise?t.data:Promise.resolve(t.data);return OK(r.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}};be.create=(e,t)=>new be({type:e,typeName:_e.ZodPromise,...processCreateParams(t)});var ve=class extends P{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===_e.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),n=this._def.effect||null,i={addIssue:e=>{addIssueToContext(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(i.addIssue=i.addIssue.bind(i),"preprocess"===n.type){const e=n.transform(r.data,i);if(r.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return I;const n=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===n.status?I:"dirty"===n.status||"dirty"===t.value?DIRTY(n.value):n});{if("aborted"===t.value)return I;const n=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===n.status?I:"dirty"===n.status||"dirty"===t.value?DIRTY(n.value):n}}if("refinement"===n.type){const executeRefinement=e=>{const t=n.refinement(e,i);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===r.common.async){const e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?I:("dirty"===e.status&&t.dirty(),executeRefinement(e.value),{status:t.value,value:e.value})}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(e=>"aborted"===e.status?I:("dirty"===e.status&&t.dirty(),executeRefinement(e.value).then(()=>({status:t.value,value:e.value}))))}if("transform"===n.type){if(!1===r.common.async){const e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!isValid(e))return e;const s=n.transform(e.value,i);if(s instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:s}}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(e=>isValid(e)?Promise.resolve(n.transform(e.value,i)).then(e=>({status:t.value,value:e})):e)}m.assertNever(n)}};ve.create=(e,t,r)=>new ve({schema:e,typeName:_e.ZodEffects,effect:t,...processCreateParams(r)}),ve.createWithPreprocess=(e,t,r)=>new ve({schema:t,effect:{type:"preprocess",transform:e},typeName:_e.ZodEffects,...processCreateParams(r)});var Ne=class extends P{_parse(e){return this._getType(e)===w.undefined?OK(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Ne.create=(e,t)=>new Ne({innerType:e,typeName:_e.ZodOptional,...processCreateParams(t)});var Te=class extends P{_parse(e){return this._getType(e)===w.null?OK(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Te.create=(e,t)=>new Te({innerType:e,typeName:_e.ZodNullable,...processCreateParams(t)});var ke=class extends P{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===w.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};ke.create=(e,t)=>new ke({innerType:e,typeName:_e.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...processCreateParams(t)});var xe=class extends P{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},n=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return isAsync(n)?n.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new v(r.common.issues)},input:r.data})})):{status:"valid",value:"valid"===n.status?n.value:this._def.catchValue({get error(){return new v(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};xe.create=(e,t)=>new xe({innerType:e,typeName:_e.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...processCreateParams(t)});var Se=class extends P{_parse(e){if(this._getType(e)!==w.nan){const t=this._getOrReturnCtx(e);return addIssueToContext(t,{code:b.invalid_type,expected:w.nan,received:t.parsedType}),I}return{status:"valid",value:e.data}}};Se.create=e=>new Se({typeName:_e.ZodNaN,...processCreateParams(e)});var _e,Ae,Ie=class extends P{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}},Ee=class _ZodPipeline extends P{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async){return(async()=>{const e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?I:"dirty"===e.status?(t.dirty(),DIRTY(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})()}{const e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?I:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new _ZodPipeline({in:e,out:t,typeName:_e.ZodPipeline})}},Ce=class extends P{_parse(e){const t=this._def.innerType._parse(e),freeze=e=>(isValid(e)&&(e.value=Object.freeze(e.value)),e);return isAsync(t)?t.then(e=>freeze(e)):freeze(t)}unwrap(){return this._def.innerType}};Ce.create=(e,t)=>new Ce({innerType:e,typeName:_e.ZodReadonly,...processCreateParams(t)}),(Ae=_e||(_e={})).ZodString="ZodString",Ae.ZodNumber="ZodNumber",Ae.ZodNaN="ZodNaN",Ae.ZodBigInt="ZodBigInt",Ae.ZodBoolean="ZodBoolean",Ae.ZodDate="ZodDate",Ae.ZodSymbol="ZodSymbol",Ae.ZodUndefined="ZodUndefined",Ae.ZodNull="ZodNull",Ae.ZodAny="ZodAny",Ae.ZodUnknown="ZodUnknown",Ae.ZodNever="ZodNever",Ae.ZodVoid="ZodVoid",Ae.ZodArray="ZodArray",Ae.ZodObject="ZodObject",Ae.ZodUnion="ZodUnion",Ae.ZodDiscriminatedUnion="ZodDiscriminatedUnion",Ae.ZodIntersection="ZodIntersection",Ae.ZodTuple="ZodTuple",Ae.ZodRecord="ZodRecord",Ae.ZodMap="ZodMap",Ae.ZodSet="ZodSet",Ae.ZodFunction="ZodFunction",Ae.ZodLazy="ZodLazy",Ae.ZodLiteral="ZodLiteral",Ae.ZodEnum="ZodEnum",Ae.ZodEffects="ZodEffects",Ae.ZodNativeEnum="ZodNativeEnum",Ae.ZodOptional="ZodOptional",Ae.ZodNullable="ZodNullable",Ae.ZodDefault="ZodDefault",Ae.ZodCatch="ZodCatch",Ae.ZodPromise="ZodPromise",Ae.ZodBranded="ZodBranded",Ae.ZodPipeline="ZodPipeline",Ae.ZodReadonly="ZodReadonly",oe.create,ce.create,le.create,ue.create,pe.create,ye.create,be.create,Ne.create,Te.create;var Oe={};function getTypeFromZodType(e){switch(e.constructor.name){case"ZodString":default:return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodObject":return"object";case"ZodArray":return"array"}}function getParameters(e){const t=[];return e.metadata?.openapi?.parameters?(t.push(...e.metadata.openapi.parameters),t):(e.query instanceof de&&Object.entries(e.query.shape).forEach(([e,r])=>{r instanceof P&&t.push({name:e,in:"query",schema:{type:getTypeFromZodType(r),..."minLength"in r&&r.minLength?{minLength:r.minLength}:{},description:r.description}})}),t)}function getResponse(e){return{400:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Bad Request. Usually due to missing parameters, or invalid parameters."},401:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Unauthorized. Due to missing or invalid authentication."},403:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Forbidden. You do not have permission to access this resource or to perform this action."},404:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Not Found. The requested resource was not found."},429:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Too Many Requests. You have exceeded the rate limit. Try again later."},500:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Internal Server Error. This is a problem with the server that you cannot fix."},...e}}async function generator(e,t){Object.entries(e).forEach(([e,t])=>{const r=t.options;if(!r.metadata?.SERVER_ONLY&&("GET"===r.method&&(Oe[t.path]={get:{tags:["Default",...r.metadata?.openapi?.tags||[]],description:r.metadata?.openapi?.description,operationId:r.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:getParameters(r),responses:getResponse(r.metadata?.openapi?.responses)}}),"POST"===r.method)){const e=function(e){if(e.metadata?.openapi?.requestBody)return e.metadata.openapi.requestBody;if(e.body&&(e.body instanceof de||e.body instanceof Ne)){const t=e.body.shape;if(!t)return;const r={},n=[];return Object.entries(t).forEach(([e,t])=>{t instanceof P&&(r[e]={type:getTypeFromZodType(t),description:t.description},t instanceof Ne||n.push(e))}),{required:!(e.body instanceof Ne||!e.body),content:{"application/json":{schema:{type:"object",properties:r,required:n}}}}}}(r);Oe[t.path]={post:{tags:["Default",...r.metadata?.openapi?.tags||[]],description:r.metadata?.openapi?.description,operationId:r.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:getParameters(r),...e?{requestBody:e}:{requestBody:{content:{"application/json":{schema:{type:"object",properties:{}}}}}},responses:getResponse(r.metadata?.openapi?.responses)}}}});return{openapi:"3.1.1",info:{title:"Better Auth",description:"API Reference for your Better Auth Instance",version:"1.1.0"},components:{schemas:{}},security:[{apiKeyCookie:[]}],servers:[{url:t?.url}],tags:[{name:"Default",description:"Default endpoints that are included with Better Auth by default. These endpoints are not part of any plugin."}],paths:Oe}}var createRouter=(e,t)=>{if(!t?.openapi?.disabled){const r={path:"/api/reference",...t?.openapi};e.openapi=createEndpoint2(r.path,{method:"GET"},async t=>{const n=await generator(e);return new Response(((e,t)=>`<!doctype html>\n<html>\n  <head>\n    <title>Scalar API Reference</title>\n    <meta charset="utf-8" />\n    <meta\n      name="viewport"\n      content="width=device-width, initial-scale=1" />\n  </head>\n  <body>\n    <script\n      id="api-reference"\n      type="application/json">\n    ${JSON.stringify(e)}\n    <\/script>\n\t <script>\n      var configuration = {\n\t  \tfavicon: ${t?.logo?`data:image/svg+xml;utf8,${encodeURIComponent(t.logo)}`:void 0} ,\n\t   \ttheme: ${t?.theme||"saturn"},\n        metaData: {\n\t\t\ttitle: ${t?.title||"Open API Reference"},\n\t\t\tdescription: ${t?.description||"Better Call Open API"},\n\t\t}\n      }\n      document.getElementById('api-reference').dataset.configuration =\n        JSON.stringify(configuration)\n    <\/script>\n\t  <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference"><\/script>\n  </body>\n</html>`)(n,r.scalar),{headers:{"Content-Type":"text/html"}})})}const r=createRouter$1(),n=createRouter$1();for(const t of Object.values(e)){if(!t.options)continue;if(t.options?.metadata?.SERVER_ONLY)continue;const e=Array.isArray(t.options?.method)?t.options.method:[t.options?.method];for(const n of e)addRoute(r,n,t.path,t)}if(t?.routerMiddleware?.length)for(const{path:e,middleware:r}of t.routerMiddleware)addRoute(n,"*",e,r);return{handler:async e=>{const i=await(t?.onRequest?.(e));if(i instanceof Response)return i;const s=i instanceof Request?i:e,o=await(async e=>{const i=new URL(e.url),s=t?.basePath?i.pathname.split(t.basePath).reduce((e,r,n)=>(0!==n&&(n>1?e.push(`${t.basePath}${r}`):e.push(r)),e),[]).join(""):i.pathname;if(!s?.length)return new Response(null,{status:404,statusText:"Not Found"});const o=findRoute(r,e.method,s);if(!o?.data)return new Response(null,{status:404,statusText:"Not Found"});const a={};i.searchParams.forEach((e,t)=>{t in a?Array.isArray(a[t])?a[t].push(e):a[t]=[a[t],e]:a[t]=e});const c=o.data,d={path:s,method:e.method,headers:e.headers,params:o.params?JSON.parse(JSON.stringify(o.params)):{},request:e,body:c.options.disableBody?void 0:await getBody$1(c.options.cloneRequest?e.clone():e),query:a,_flag:"router",asResponse:!0,context:t?.routerContext};try{const e=findAllRoutes(n,"*",s);if(e?.length)for(const{data:t,params:r}of e){const e=await t({...d,params:r,asResponse:!1});if(e instanceof Response)return e}return await c(d)}catch(e){return isAPIError(e)?toResponse(e):(console.error("# SERVER_ERROR: ",e),new Response(null,{status:500,statusText:"Internal Server Error"}))}})(s),a=await(t?.onResponse?.(o));return a instanceof Response?a:o},endpoints:e}};function $constructor(e,t,r){function init(r,n){var i;Object.defineProperty(r,"_zod",{value:r._zod??{},enumerable:!1}),(i=r._zod).traits??(i.traits=new Set),r._zod.traits.add(e),t(r,n);for(const e in _.prototype)e in r||Object.defineProperty(r,e,{value:_.prototype[e].bind(r)});r._zod.constr=_,r._zod.def=n}const n=r?.Parent??Object;class Definition extends n{}function _(e){var t;const n=r?.Parent?new Definition:this;init(n,e),(t=n._zod).deferred??(t.deferred=[]);for(const e of n._zod.deferred)e();return n}return Object.defineProperty(Definition,"name",{value:e}),Object.defineProperty(_,"init",{value:init}),Object.defineProperty(_,Symbol.hasInstance,{value:t=>!!(r?.Parent&&t instanceof r.Parent)||t?._zod?.traits?.has(e)}),Object.defineProperty(_,"name",{value:e}),_}class $ZodAsyncError extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const Pe={};function config$1(e){return Pe}function jsonStringifyReplacer(e,t){return"bigint"==typeof t?t.toString():t}function cached(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function nullish(e){return null==e}function cleanRegex(e){const t=e.startsWith("^")?1:0,r=e.endsWith("$")?e.length-1:e.length;return e.slice(t,r)}function defineLazy(e,t,r){Object.defineProperty(e,t,{get(){{const n=r();return e[t]=n,n}},set(r){Object.defineProperty(e,t,{value:r})},configurable:!0})}function assignProp(e,t,r){Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!0,configurable:!0})}function esc(e){return JSON.stringify(e)}const Re=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{};function isObject$2(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}const $e=cached(()=>{if("undefined"!=typeof navigator&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{return new Function(""),!0}catch(e){return!1}});function isPlainObject(e){if(!1===isObject$2(e))return!1;const t=e.constructor;if(void 0===t)return!0;const r=t.prototype;return!1!==isObject$2(r)&&!1!==Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")}const Be=new Set(["string","number","symbol"]);function escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function clone$1(e,t,r){const n=new e._zod.constr(t??e._zod.def);return t&&!r?.parent||(n._zod.parent=e),n}function normalizeParams(e){const t=e;if(!t)return{};if("string"==typeof t)return{error:()=>t};if(void 0!==t?.message){if(void 0!==t?.error)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,"string"==typeof t.error?{...t,error:()=>t.error}:t}const Ue={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function aborted(e,t=0){for(let r=t;r<e.issues.length;r++)if(!0!==e.issues[r]?.continue)return!0;return!1}function prefixIssues(e,t){return t.map(t=>{var r;return(r=t).path??(r.path=[]),t.path.unshift(e),t})}function unwrapMessage(e){return"string"==typeof e?e:e?.message}function finalizeIssue(e,t,r){const n={...e,path:e.path??[]};if(!e.message){const i=unwrapMessage(e.inst?._zod.def?.error?.(e))??unwrapMessage(t?.error?.(e))??unwrapMessage(r.customError?.(e))??unwrapMessage(r.localeError?.(e))??"Invalid input";n.message=i}return delete n.inst,delete n.continue,t?.reportInput||delete n.input,n}function getLengthableOrigin(e){return Array.isArray(e)?"array":"string"==typeof e?"string":"unknown"}function issue(...e){const[t,r,n]=e;return"string"==typeof t?{message:t,code:"custom",input:r,inst:n}:{...t}}const initializer$1=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get:()=>JSON.stringify(t,jsonStringifyReplacer,2),enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},Le=$constructor("$ZodError",initializer$1),ze=$constructor("$ZodError",initializer$1,{Parent:Error});const _parse=e=>(t,r,n,i)=>{const s=n?Object.assign(n,{async:!1}):{async:!1},o=t._zod.run({value:r,issues:[]},s);if(o instanceof Promise)throw new $ZodAsyncError;if(o.issues.length){const t=new(i?.Err??e)(o.issues.map(e=>finalizeIssue(e,s,config$1())));throw Re(t,i?.callee),t}return o.value},_parseAsync=e=>async(t,r,n,i)=>{const s=n?Object.assign(n,{async:!0}):{async:!0};let o=t._zod.run({value:r,issues:[]},s);if(o instanceof Promise&&(o=await o),o.issues.length){const t=new(i?.Err??e)(o.issues.map(e=>finalizeIssue(e,s,config$1())));throw Re(t,i?.callee),t}return o.value},_safeParse=e=>(t,r,n)=>{const i=n?{...n,async:!1}:{async:!1},s=t._zod.run({value:r,issues:[]},i);if(s instanceof Promise)throw new $ZodAsyncError;return s.issues.length?{success:!1,error:new(e??Le)(s.issues.map(e=>finalizeIssue(e,i,config$1())))}:{success:!0,data:s.value}},De=_safeParse(ze),_safeParseAsync=e=>async(t,r,n)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let s=t._zod.run({value:r,issues:[]},i);return s instanceof Promise&&(s=await s),s.issues.length?{success:!1,error:new e(s.issues.map(e=>finalizeIssue(e,i,config$1())))}:{success:!0,data:s.value}},qe=_safeParseAsync(ze),We=/^[cC][^\s-]{8,}$/,je=/^[0-9a-z]+$/,Me=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,Qe=/^[0-9a-vA-V]{20}$/,Ve=/^[A-Za-z0-9]{27}$/,Fe=/^[a-zA-Z0-9_-]{21}$/,Je=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,Ke=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,uuid$1=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000)$/,He=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/;const Ze=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Ge=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})$/,Ye=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,Xe=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,et=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,tt=/^[A-Za-z0-9_-]*$/,rt=/^([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+$/,nt=/^\+(?:[0-9]){6,14}[0-9]$/,it="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",st=new RegExp(`^${it}$`);function timeSource(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return"number"==typeof e.precision?-1===e.precision?`${t}`:0===e.precision?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}const ot=/^\d+$/,at=/^-?\d+(?:\.\d+)?/i,ct=/true|false/i,dt=/^[^A-Z]*$/,ut=/^[^a-z]*$/,pt=$constructor("$ZodCheck",(e,t)=>{var r;e._zod??(e._zod={}),e._zod.def=t,(r=e._zod).onattach??(r.onattach=[])}),ht={number:"number",bigint:"bigint",object:"date"},ft=$constructor("$ZodCheckLessThan",(e,t)=>{pt.init(e,t);const r=ht[typeof t.value];e._zod.onattach.push(e=>{const r=e._zod.bag,n=(t.inclusive?r.maximum:r.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<n&&(t.inclusive?r.maximum=t.value:r.exclusiveMaximum=t.value)}),e._zod.check=n=>{(t.inclusive?n.value<=t.value:n.value<t.value)||n.issues.push({origin:r,code:"too_big",maximum:t.value,input:n.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),mt=$constructor("$ZodCheckGreaterThan",(e,t)=>{pt.init(e,t);const r=ht[typeof t.value];e._zod.onattach.push(e=>{const r=e._zod.bag,n=(t.inclusive?r.minimum:r.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>n&&(t.inclusive?r.minimum=t.value:r.exclusiveMinimum=t.value)}),e._zod.check=n=>{(t.inclusive?n.value>=t.value:n.value>t.value)||n.issues.push({origin:r,code:"too_small",minimum:t.value,input:n.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),yt=$constructor("$ZodCheckMultipleOf",(e,t)=>{pt.init(e,t),e._zod.onattach.push(e=>{var r;(r=e._zod.bag).multipleOf??(r.multipleOf=t.value)}),e._zod.check=r=>{if(typeof r.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");("bigint"==typeof r.value?r.value%t.value===BigInt(0):0===function(e,t){const r=(e.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,i=r>n?r:n;return Number.parseInt(e.toFixed(i).replace(".",""))%Number.parseInt(t.toFixed(i).replace(".",""))/10**i}(r.value,t.value))||r.issues.push({origin:typeof r.value,code:"not_multiple_of",divisor:t.value,input:r.value,inst:e,continue:!t.abort})}}),wt=$constructor("$ZodCheckNumberFormat",(e,t)=>{pt.init(e,t),t.format=t.format||"float64";const r=t.format?.includes("int"),n=r?"int":"number",[i,s]=Ue[t.format];e._zod.onattach.push(e=>{const n=e._zod.bag;n.format=t.format,n.minimum=i,n.maximum=s,r&&(n.pattern=ot)}),e._zod.check=o=>{const a=o.value;if(r){if(!Number.isInteger(a))return void o.issues.push({expected:n,format:t.format,code:"invalid_type",input:a,inst:e});if(!Number.isSafeInteger(a))return void(a>0?o.issues.push({input:a,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:n,continue:!t.abort}):o.issues.push({input:a,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:n,continue:!t.abort}))}a<i&&o.issues.push({origin:"number",input:a,code:"too_small",minimum:i,inclusive:!0,inst:e,continue:!t.abort}),a>s&&o.issues.push({origin:"number",input:a,code:"too_big",maximum:s,inst:e})}}),bt=$constructor("$ZodCheckMaxLength",(e,t)=>{var r;pt.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<r&&(e._zod.bag.maximum=t.maximum)}),e._zod.check=r=>{const n=r.value;if(n.length<=t.maximum)return;const i=getLengthableOrigin(n);r.issues.push({origin:i,code:"too_big",maximum:t.maximum,inclusive:!0,input:n,inst:e,continue:!t.abort})}}),vt=$constructor("$ZodCheckMinLength",(e,t)=>{var r;pt.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>r&&(e._zod.bag.minimum=t.minimum)}),e._zod.check=r=>{const n=r.value;if(n.length>=t.minimum)return;const i=getLengthableOrigin(n);r.issues.push({origin:i,code:"too_small",minimum:t.minimum,inclusive:!0,input:n,inst:e,continue:!t.abort})}}),Nt=$constructor("$ZodCheckLengthEquals",(e,t)=>{var r;pt.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag;r.minimum=t.length,r.maximum=t.length,r.length=t.length}),e._zod.check=r=>{const n=r.value,i=n.length;if(i===t.length)return;const s=getLengthableOrigin(n),o=i>t.length;r.issues.push({origin:s,...o?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:r.value,inst:e,continue:!t.abort})}}),Tt=$constructor("$ZodCheckStringFormat",(e,t)=>{var r,n;pt.init(e,t),e._zod.onattach.push(e=>{const r=e._zod.bag;r.format=t.format,t.pattern&&(r.patterns??(r.patterns=new Set),r.patterns.add(t.pattern))}),t.pattern?(r=e._zod).check??(r.check=r=>{t.pattern.lastIndex=0,t.pattern.test(r.value)||r.issues.push({origin:"string",code:"invalid_format",format:t.format,input:r.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(n=e._zod).check??(n.check=()=>{})}),kt=$constructor("$ZodCheckRegex",(e,t)=>{Tt.init(e,t),e._zod.check=r=>{t.pattern.lastIndex=0,t.pattern.test(r.value)||r.issues.push({origin:"string",code:"invalid_format",format:"regex",input:r.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),xt=$constructor("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=dt),Tt.init(e,t)}),St=$constructor("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=ut),Tt.init(e,t)}),_t=$constructor("$ZodCheckIncludes",(e,t)=>{pt.init(e,t);const r=escapeRegex(t.includes),n=new RegExp("number"==typeof t.position?`^.{${t.position}}${r}`:r);t.pattern=n,e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(n)}),e._zod.check=r=>{r.value.includes(t.includes,t.position)||r.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:r.value,inst:e,continue:!t.abort})}}),At=$constructor("$ZodCheckStartsWith",(e,t)=>{pt.init(e,t);const r=new RegExp(`^${escapeRegex(t.prefix)}.*`);t.pattern??(t.pattern=r),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(r)}),e._zod.check=r=>{r.value.startsWith(t.prefix)||r.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:r.value,inst:e,continue:!t.abort})}}),It=$constructor("$ZodCheckEndsWith",(e,t)=>{pt.init(e,t);const r=new RegExp(`.*${escapeRegex(t.suffix)}$`);t.pattern??(t.pattern=r),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(r)}),e._zod.check=r=>{r.value.endsWith(t.suffix)||r.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:r.value,inst:e,continue:!t.abort})}}),Et=$constructor("$ZodCheckOverwrite",(e,t)=>{pt.init(e,t),e._zod.check=e=>{e.value=t.tx(e.value)}});class Doc{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if("function"==typeof e)return e(this,{execution:"sync"}),void e(this,{execution:"async"});const t=e.split("\n").filter(e=>e),r=Math.min(...t.map(e=>e.length-e.trimStart().length)),n=t.map(e=>e.slice(r)).map(e=>" ".repeat(2*this.indent)+e);for(const e of n)this.content.push(e)}compile(){const e=Function,t=this?.args;return new e(...t,[...(this?.content??[""]).map(e=>`  ${e}`)].join("\n"))}}const Ct={major:4,minor:0,patch:5},Ot=$constructor("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Ct;const n=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&n.unshift(e);for(const t of n)for(const r of t._zod.onattach)r(e);if(0===n.length)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const runChecks=(e,t,r)=>{let n,i=aborted(e);for(const s of t){if(s._zod.def.when){if(!s._zod.def.when(e))continue}else if(i)continue;const t=e.issues.length,o=s._zod.check(e);if(o instanceof Promise&&!1===r?.async)throw new $ZodAsyncError;if(n||o instanceof Promise)n=(n??Promise.resolve()).then(async()=>{await o;e.issues.length!==t&&(i||(i=aborted(e,t)))});else{if(e.issues.length===t)continue;i||(i=aborted(e,t))}}return n?n.then(()=>e):e};e._zod.run=(t,r)=>{const i=e._zod.parse(t,r);if(i instanceof Promise){if(!1===r.async)throw new $ZodAsyncError;return i.then(e=>runChecks(e,n,r))}return runChecks(i,n,r)}}e["~standard"]={validate:t=>{try{const r=De(e,t);return r.success?{value:r.data}:{issues:r.error?.issues}}catch(r){return qe(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),Pt=$constructor("$ZodString",(e,t)=>{var r;Ot.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??(r=e._zod.bag,new RegExp(`^${r?`[\\s\\S]{${r?.minimum??0},${r?.maximum??""}}`:"[\\s\\S]*"}$`)),e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=String(r.value)}catch(n){}return"string"==typeof r.value||r.issues.push({expected:"string",code:"invalid_type",input:r.value,inst:e}),r}}),Rt=$constructor("$ZodStringFormat",(e,t)=>{Tt.init(e,t),Pt.init(e,t)}),$t=$constructor("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=Ke),Rt.init(e,t)}),Bt=$constructor("$ZodUUID",(e,t)=>{if(t.version){const e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(void 0===e)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=uuid$1(e))}else t.pattern??(t.pattern=uuid$1());Rt.init(e,t)}),Ut=$constructor("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=He),Rt.init(e,t)}),Lt=$constructor("$ZodURL",(e,t)=>{Rt.init(e,t),e._zod.check=r=>{try{const n=r.value,i=new URL(n),s=i.href;return t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(i.hostname)||r.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:rt.source,input:r.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(i.protocol.endsWith(":")?i.protocol.slice(0,-1):i.protocol)||r.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:r.value,inst:e,continue:!t.abort})),void(!n.endsWith("/")&&s.endsWith("/")?r.value=s.slice(0,-1):r.value=s)}catch(n){r.issues.push({code:"invalid_format",format:"url",input:r.value,inst:e,continue:!t.abort})}}}),zt=$constructor("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Rt.init(e,t)}),Dt=$constructor("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=Fe),Rt.init(e,t)}),qt=$constructor("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=We),Rt.init(e,t)}),Wt=$constructor("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=je),Rt.init(e,t)}),jt=$constructor("$ZodULID",(e,t)=>{t.pattern??(t.pattern=Me),Rt.init(e,t)}),Mt=$constructor("$ZodXID",(e,t)=>{t.pattern??(t.pattern=Qe),Rt.init(e,t)}),Qt=$constructor("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=Ve),Rt.init(e,t)}),Vt=$constructor("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=function(e){const t=timeSource({precision:e.precision}),r=["Z"];e.local&&r.push(""),e.offset&&r.push("([+-]\\d{2}:\\d{2})");const n=`${t}(?:${r.join("|")})`;return new RegExp(`^${it}T(?:${n})$`)}(t)),Rt.init(e,t)}),Ft=$constructor("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=st),Rt.init(e,t)}),Jt=$constructor("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=new RegExp(`^${timeSource(t)}$`)),Rt.init(e,t)}),Kt=$constructor("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=Je),Rt.init(e,t)}),Ht=$constructor("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=Ze),Rt.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv4"})}),Zt=$constructor("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=Ge),Rt.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv6"}),e._zod.check=r=>{try{new URL(`http://[${r.value}]`)}catch{r.issues.push({code:"invalid_format",format:"ipv6",input:r.value,inst:e,continue:!t.abort})}}}),Gt=$constructor("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=Ye),Rt.init(e,t)}),Yt=$constructor("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=Xe),Rt.init(e,t),e._zod.check=r=>{const[n,i]=r.value.split("/");try{if(!i)throw new Error;const e=Number(i);if(`${e}`!==i)throw new Error;if(e<0||e>128)throw new Error;new URL(`http://[${n}]`)}catch{r.issues.push({code:"invalid_format",format:"cidrv6",input:r.value,inst:e,continue:!t.abort})}}});function isValidBase64(e){if(""===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}const Xt=$constructor("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=et),Rt.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64"}),e._zod.check=r=>{isValidBase64(r.value)||r.issues.push({code:"invalid_format",format:"base64",input:r.value,inst:e,continue:!t.abort})}});const er=$constructor("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=tt),Rt.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64url"}),e._zod.check=r=>{(function(e){if(!tt.test(e))return!1;const t=e.replace(/[-_]/g,e=>"-"===e?"+":"/");return isValidBase64(t.padEnd(4*Math.ceil(t.length/4),"="))})(r.value)||r.issues.push({code:"invalid_format",format:"base64url",input:r.value,inst:e,continue:!t.abort})}}),tr=$constructor("$ZodE164",(e,t)=>{t.pattern??(t.pattern=nt),Rt.init(e,t)});const rr=$constructor("$ZodJWT",(e,t)=>{Rt.init(e,t),e._zod.check=r=>{(function(e,t=null){try{const r=e.split(".");if(3!==r.length)return!1;const[n]=r;if(!n)return!1;const i=JSON.parse(atob(n));return!("typ"in i&&"JWT"!==i?.typ||!i.alg||t&&(!("alg"in i)||i.alg!==t))}catch{return!1}})(r.value,t.alg)||r.issues.push({code:"invalid_format",format:"jwt",input:r.value,inst:e,continue:!t.abort})}}),nr=$constructor("$ZodNumber",(e,t)=>{Ot.init(e,t),e._zod.pattern=e._zod.bag.pattern??at,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=Number(r.value)}catch(e){}const i=r.value;if("number"==typeof i&&!Number.isNaN(i)&&Number.isFinite(i))return r;const s="number"==typeof i?Number.isNaN(i)?"NaN":Number.isFinite(i)?void 0:"Infinity":void 0;return r.issues.push({expected:"number",code:"invalid_type",input:i,inst:e,...s?{received:s}:{}}),r}}),ir=$constructor("$ZodNumber",(e,t)=>{wt.init(e,t),nr.init(e,t)}),sr=$constructor("$ZodBoolean",(e,t)=>{Ot.init(e,t),e._zod.pattern=ct,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=Boolean(r.value)}catch(e){}const i=r.value;return"boolean"==typeof i||r.issues.push({expected:"boolean",code:"invalid_type",input:i,inst:e}),r}}),ar=$constructor("$ZodAny",(e,t)=>{Ot.init(e,t),e._zod.parse=e=>e}),cr=$constructor("$ZodUnknown",(e,t)=>{Ot.init(e,t),e._zod.parse=e=>e}),dr=$constructor("$ZodNever",(e,t)=>{Ot.init(e,t),e._zod.parse=(t,r)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)}),lr=$constructor("$ZodDate",(e,t)=>{Ot.init(e,t),e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=new Date(r.value)}catch(e){}const i=r.value,s=i instanceof Date;return s&&!Number.isNaN(i.getTime())||r.issues.push({expected:"date",code:"invalid_type",input:i,...s?{received:"Invalid Date"}:{},inst:e}),r}});function handleArrayResult(e,t,r){e.issues.length&&t.issues.push(...prefixIssues(r,e.issues)),t.value[r]=e.value}const ur=$constructor("$ZodArray",(e,t)=>{Ot.init(e,t),e._zod.parse=(r,n)=>{const i=r.value;if(!Array.isArray(i))return r.issues.push({expected:"array",code:"invalid_type",input:i,inst:e}),r;r.value=Array(i.length);const s=[];for(let e=0;e<i.length;e++){const o=i[e],a=t.element._zod.run({value:o,issues:[]},n);a instanceof Promise?s.push(a.then(t=>handleArrayResult(t,r,e))):handleArrayResult(a,r,e)}return s.length?Promise.all(s).then(()=>r):r}});function handleObjectResult(e,t,r){e.issues.length&&t.issues.push(...prefixIssues(r,e.issues)),t.value[r]=e.value}function handleOptionalObjectResult(e,t,r,n){e.issues.length?void 0===n[r]?t.value[r]=r in n?void 0:e.value:t.issues.push(...prefixIssues(r,e.issues)):void 0===e.value?r in n&&(t.value[r]=void 0):t.value[r]=e.value}const pr=$constructor("$ZodObject",(e,t)=>{Ot.init(e,t);const r=cached(()=>{const e=Object.keys(t.shape);for(const r of e)if(!(t.shape[r]instanceof Ot))throw new Error(`Invalid element at key "${r}": expected a Zod schema`);const r=(n=t.shape,Object.keys(n).filter(e=>"optional"===n[e]._zod.optin&&"optional"===n[e]._zod.optout));var n;return{shape:t.shape,keys:e,keySet:new Set(e),numKeys:e.length,optionalKeys:new Set(r)}});defineLazy(e._zod,"propValues",()=>{const e=t.shape,r={};for(const t in e){const n=e[t]._zod;if(n.values){r[t]??(r[t]=new Set);for(const e of n.values)r[t].add(e)}}return r});let n;const i=isObject$2,s=!Pe.jitless,o=s&&$e.value,a=t.catchall;let c;e._zod.parse=(d,l)=>{c??(c=r.value);const u=d.value;if(!i(u))return d.issues.push({expected:"object",code:"invalid_type",input:u,inst:e}),d;const p=[];if(s&&o&&!1===l?.async&&!0!==l.jitless)n||(n=(e=>{const t=new Doc(["shape","payload","ctx"]),n=r.value,parseStr=e=>{const t=esc(e);return`shape[${t}]._zod.run({ value: input[${t}], issues: [] }, ctx)`};t.write("const input = payload.value;");const i=Object.create(null);let s=0;for(const e of n.keys)i[e]="key_"+s++;t.write("const newResult = {}");for(const e of n.keys)if(n.optionalKeys.has(e)){const r=i[e];t.write(`const ${r} = ${parseStr(e)};`);const n=esc(e);t.write(`\n        if (${r}.issues.length) {\n          if (input[${n}] === undefined) {\n            if (${n} in input) {\n              newResult[${n}] = undefined;\n            }\n          } else {\n            payload.issues = payload.issues.concat(\n              ${r}.issues.map((iss) => ({\n                ...iss,\n                path: iss.path ? [${n}, ...iss.path] : [${n}],\n              }))\n            );\n          }\n        } else if (${r}.value === undefined) {\n          if (${n} in input) newResult[${n}] = undefined;\n        } else {\n          newResult[${n}] = ${r}.value;\n        }\n        `)}else{const r=i[e];t.write(`const ${r} = ${parseStr(e)};`),t.write(`\n          if (${r}.issues.length) payload.issues = payload.issues.concat(${r}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${esc(e)}, ...iss.path] : [${esc(e)}]\n          })));`),t.write(`newResult[${esc(e)}] = ${r}.value`)}t.write("payload.value = newResult;"),t.write("return payload;");const o=t.compile();return(t,r)=>o(e,t,r)})(t.shape)),d=n(d,l);else{d.value={};const e=c.shape;for(const t of c.keys){const r=e[t],n=r._zod.run({value:u[t],issues:[]},l),i="optional"===r._zod.optin&&"optional"===r._zod.optout;n instanceof Promise?p.push(n.then(e=>i?handleOptionalObjectResult(e,d,t,u):handleObjectResult(e,d,t))):i?handleOptionalObjectResult(n,d,t,u):handleObjectResult(n,d,t)}}if(!a)return p.length?Promise.all(p).then(()=>d):d;const h=[],f=c.keySet,m=a._zod,g=m.def.type;for(const e of Object.keys(u)){if(f.has(e))continue;if("never"===g){h.push(e);continue}const t=m.run({value:u[e],issues:[]},l);t instanceof Promise?p.push(t.then(t=>handleObjectResult(t,d,e))):handleObjectResult(t,d,e)}return h.length&&d.issues.push({code:"unrecognized_keys",keys:h,input:u,inst:e}),p.length?Promise.all(p).then(()=>d):d}});function handleUnionResults(e,t,r,n){for(const r of e)if(0===r.issues.length)return t.value=r.value,t;return t.issues.push({code:"invalid_union",input:t.value,inst:r,errors:e.map(e=>e.issues.map(e=>finalizeIssue(e,n,config$1())))}),t}const hr=$constructor("$ZodUnion",(e,t)=>{Ot.init(e,t),defineLazy(e._zod,"optin",()=>t.options.some(e=>"optional"===e._zod.optin)?"optional":void 0),defineLazy(e._zod,"optout",()=>t.options.some(e=>"optional"===e._zod.optout)?"optional":void 0),defineLazy(e._zod,"values",()=>{if(t.options.every(e=>e._zod.values))return new Set(t.options.flatMap(e=>Array.from(e._zod.values)))}),defineLazy(e._zod,"pattern",()=>{if(t.options.every(e=>e._zod.pattern)){const e=t.options.map(e=>e._zod.pattern);return new RegExp(`^(${e.map(e=>cleanRegex(e.source)).join("|")})$`)}}),e._zod.parse=(r,n)=>{let i=!1;const s=[];for(const e of t.options){const t=e._zod.run({value:r.value,issues:[]},n);if(t instanceof Promise)s.push(t),i=!0;else{if(0===t.issues.length)return t;s.push(t)}}return i?Promise.all(s).then(t=>handleUnionResults(t,r,e,n)):handleUnionResults(s,r,e,n)}}),fr=$constructor("$ZodIntersection",(e,t)=>{Ot.init(e,t),e._zod.parse=(e,r)=>{const n=e.value,i=t.left._zod.run({value:n,issues:[]},r),s=t.right._zod.run({value:n,issues:[]},r);return i instanceof Promise||s instanceof Promise?Promise.all([i,s]).then(([t,r])=>handleIntersectionResults(e,t,r)):handleIntersectionResults(e,i,s)}});function mergeValues(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e===+t)return{valid:!0,data:e};if(isPlainObject(e)&&isPlainObject(t)){const r=Object.keys(t),n=Object.keys(e).filter(e=>-1!==r.indexOf(e)),i={...e,...t};for(const r of n){const n=mergeValues(e[r],t[r]);if(!n.valid)return{valid:!1,mergeErrorPath:[r,...n.mergeErrorPath]};i[r]=n.data}return{valid:!0,data:i}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const r=[];for(let n=0;n<e.length;n++){const i=mergeValues(e[n],t[n]);if(!i.valid)return{valid:!1,mergeErrorPath:[n,...i.mergeErrorPath]};r.push(i.data)}return{valid:!0,data:r}}return{valid:!1,mergeErrorPath:[]}}function handleIntersectionResults(e,t,r){if(t.issues.length&&e.issues.push(...t.issues),r.issues.length&&e.issues.push(...r.issues),aborted(e))return e;const n=mergeValues(t.value,r.value);if(!n.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(n.mergeErrorPath)}`);return e.value=n.data,e}const mr=$constructor("$ZodRecord",(e,t)=>{Ot.init(e,t),e._zod.parse=(r,n)=>{const i=r.value;if(!isPlainObject(i))return r.issues.push({expected:"record",code:"invalid_type",input:i,inst:e}),r;const s=[];if(t.keyType._zod.values){const o=t.keyType._zod.values;r.value={};for(const e of o)if("string"==typeof e||"number"==typeof e||"symbol"==typeof e){const o=t.valueType._zod.run({value:i[e],issues:[]},n);o instanceof Promise?s.push(o.then(t=>{t.issues.length&&r.issues.push(...prefixIssues(e,t.issues)),r.value[e]=t.value})):(o.issues.length&&r.issues.push(...prefixIssues(e,o.issues)),r.value[e]=o.value)}let a;for(const e in i)o.has(e)||(a=a??[],a.push(e));a&&a.length>0&&r.issues.push({code:"unrecognized_keys",input:i,inst:e,keys:a})}else{r.value={};for(const o of Reflect.ownKeys(i)){if("__proto__"===o)continue;const a=t.keyType._zod.run({value:o,issues:[]},n);if(a instanceof Promise)throw new Error("Async schemas not supported in object keys currently");if(a.issues.length){r.issues.push({origin:"record",code:"invalid_key",issues:a.issues.map(e=>finalizeIssue(e,n,config$1())),input:o,path:[o],inst:e}),r.value[a.value]=a.value;continue}const c=t.valueType._zod.run({value:i[o],issues:[]},n);c instanceof Promise?s.push(c.then(e=>{e.issues.length&&r.issues.push(...prefixIssues(o,e.issues)),r.value[a.value]=e.value})):(c.issues.length&&r.issues.push(...prefixIssues(o,c.issues)),r.value[a.value]=c.value)}}return s.length?Promise.all(s).then(()=>r):r}}),gr=$constructor("$ZodEnum",(e,t)=>{Ot.init(e,t);const r=function(e){const t=Object.values(e).filter(e=>"number"==typeof e);return Object.entries(e).filter(([e,r])=>-1===t.indexOf(+e)).map(([e,t])=>t)}(t.entries);e._zod.values=new Set(r),e._zod.pattern=new RegExp(`^(${r.filter(e=>Be.has(typeof e)).map(e=>"string"==typeof e?escapeRegex(e):e.toString()).join("|")})$`),e._zod.parse=(t,n)=>{const i=t.value;return e._zod.values.has(i)||t.issues.push({code:"invalid_value",values:r,input:i,inst:e}),t}}),yr=$constructor("$ZodTransform",(e,t)=>{Ot.init(e,t),e._zod.parse=(e,r)=>{const n=t.transform(e.value,e);if(r.async){return(n instanceof Promise?n:Promise.resolve(n)).then(t=>(e.value=t,e))}if(n instanceof Promise)throw new $ZodAsyncError;return e.value=n,e}}),wr=$constructor("$ZodOptional",(e,t)=>{Ot.init(e,t),e._zod.optin="optional",e._zod.optout="optional",defineLazy(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),defineLazy(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${cleanRegex(e.source)})?$`):void 0}),e._zod.parse=(e,r)=>"optional"===t.innerType._zod.optin?t.innerType._zod.run(e,r):void 0===e.value?e:t.innerType._zod.run(e,r)}),br=$constructor("$ZodNullable",(e,t)=>{Ot.init(e,t),defineLazy(e._zod,"optin",()=>t.innerType._zod.optin),defineLazy(e._zod,"optout",()=>t.innerType._zod.optout),defineLazy(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${cleanRegex(e.source)}|null)$`):void 0}),defineLazy(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(e,r)=>null===e.value?e:t.innerType._zod.run(e,r)}),vr=$constructor("$ZodDefault",(e,t)=>{Ot.init(e,t),e._zod.optin="optional",defineLazy(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>{if(void 0===e.value)return e.value=t.defaultValue,e;const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(e=>handleDefaultResult(e,t)):handleDefaultResult(n,t)}});function handleDefaultResult(e,t){return void 0===e.value&&(e.value=t.defaultValue),e}const Nr=$constructor("$ZodPrefault",(e,t)=>{Ot.init(e,t),e._zod.optin="optional",defineLazy(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>(void 0===e.value&&(e.value=t.defaultValue),t.innerType._zod.run(e,r))}),Tr=$constructor("$ZodNonOptional",(e,t)=>{Ot.init(e,t),defineLazy(e._zod,"values",()=>{const e=t.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(r,n)=>{const i=t.innerType._zod.run(r,n);return i instanceof Promise?i.then(t=>handleNonOptionalResult(t,e)):handleNonOptionalResult(i,e)}});function handleNonOptionalResult(e,t){return e.issues.length||void 0!==e.value||e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const kr=$constructor("$ZodCatch",(e,t)=>{Ot.init(e,t),e._zod.optin="optional",defineLazy(e._zod,"optout",()=>t.innerType._zod.optout),defineLazy(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>{const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(n=>(e.value=n.value,n.issues.length&&(e.value=t.catchValue({...e,error:{issues:n.issues.map(e=>finalizeIssue(e,r,config$1()))},input:e.value}),e.issues=[]),e)):(e.value=n.value,n.issues.length&&(e.value=t.catchValue({...e,error:{issues:n.issues.map(e=>finalizeIssue(e,r,config$1()))},input:e.value}),e.issues=[]),e)}}),xr=$constructor("$ZodPipe",(e,t)=>{Ot.init(e,t),defineLazy(e._zod,"values",()=>t.in._zod.values),defineLazy(e._zod,"optin",()=>t.in._zod.optin),defineLazy(e._zod,"optout",()=>t.out._zod.optout),defineLazy(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(e,r)=>{const n=t.in._zod.run(e,r);return n instanceof Promise?n.then(e=>handlePipeResult(e,t,r)):handlePipeResult(n,t,r)}});function handlePipeResult(e,t,r){return aborted(e)?e:t.out._zod.run({value:e.value,issues:e.issues},r)}const Sr=$constructor("$ZodReadonly",(e,t)=>{Ot.init(e,t),defineLazy(e._zod,"propValues",()=>t.innerType._zod.propValues),defineLazy(e._zod,"values",()=>t.innerType._zod.values),defineLazy(e._zod,"optin",()=>t.innerType._zod.optin),defineLazy(e._zod,"optout",()=>t.innerType._zod.optout),e._zod.parse=(e,r)=>{const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(handleReadonlyResult):handleReadonlyResult(n)}});function handleReadonlyResult(e){return e.value=Object.freeze(e.value),e}const _r=$constructor("$ZodCustom",(e,t)=>{pt.init(e,t),Ot.init(e,t),e._zod.parse=(e,t)=>e,e._zod.check=r=>{const n=r.value,i=t.fn(n);if(i instanceof Promise)return i.then(t=>handleRefineResult(t,r,n,e));handleRefineResult(i,r,n,e)}});function handleRefineResult(e,t,r,n){if(!e){const e={code:"custom",input:r,inst:n,path:[...n._zod.def.path??[]],continue:!n._zod.def.abort};n._zod.def.params&&(e.params=n._zod.def.params),t.issues.push(issue(e))}}class $ZodRegistry{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const r=t[0];if(this._map.set(e,r),r&&"object"==typeof r&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const r={...this.get(t)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function registry(){return new $ZodRegistry}const Ar=registry();function _email(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,...normalizeParams(t)})}function _guid(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...normalizeParams(t)})}function _lt(e,t){return new ft({check:"less_than",...normalizeParams(t),value:e,inclusive:!1})}function _lte(e,t){return new ft({check:"less_than",...normalizeParams(t),value:e,inclusive:!0})}function _gt(e,t){return new mt({check:"greater_than",...normalizeParams(t),value:e,inclusive:!1})}function _gte(e,t){return new mt({check:"greater_than",...normalizeParams(t),value:e,inclusive:!0})}function _multipleOf(e,t){return new yt({check:"multiple_of",...normalizeParams(t),value:e})}function _maxLength(e,t){return new bt({check:"max_length",...normalizeParams(t),maximum:e})}function _minLength(e,t){return new vt({check:"min_length",...normalizeParams(t),minimum:e})}function _length(e,t){return new Nt({check:"length_equals",...normalizeParams(t),length:e})}function _overwrite(e){return new Et({check:"overwrite",tx:e})}const Ir=$constructor("ZodISODateTime",(e,t)=>{Vt.init(e,t),qr.init(e,t)});function datetime(e){return function(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...normalizeParams(t)})}(Ir,e)}const Er=$constructor("ZodISODate",(e,t)=>{Ft.init(e,t),qr.init(e,t)});function date$2(e){return function(e,t){return new e({type:"string",format:"date",check:"string_format",...normalizeParams(t)})}(Er,e)}const Cr=$constructor("ZodISOTime",(e,t)=>{Jt.init(e,t),qr.init(e,t)});function time$1(e){return function(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,...normalizeParams(t)})}(Cr,e)}const Or=$constructor("ZodISODuration",(e,t)=>{Kt.init(e,t),qr.init(e,t)});function duration(e){return function(e,t){return new e({type:"string",format:"duration",check:"string_format",...normalizeParams(t)})}(Or,e)}const Pr=$constructor("ZodError",(e,t)=>{Le.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:t=>function(e,t){const r=t||function(e){return e.message},n={_errors:[]},processError=e=>{for(const t of e.issues)if("invalid_union"===t.code&&t.errors.length)t.errors.map(e=>processError({issues:e}));else if("invalid_key"===t.code)processError({issues:t.issues});else if("invalid_element"===t.code)processError({issues:t.issues});else if(0===t.path.length)n._errors.push(r(t));else{let e=n,i=0;for(;i<t.path.length;){const n=t.path[i];i===t.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(r(t))):e[n]=e[n]||{_errors:[]},e=e[n],i++}}};return processError(e),n}(e,t)},flatten:{value:t=>function(e,t=e=>e.message){const r={},n=[];for(const i of e.issues)i.path.length>0?(r[i.path[0]]=r[i.path[0]]||[],r[i.path[0]].push(t(i))):n.push(t(i));return{formErrors:n,fieldErrors:r}}(e,t)},addIssue:{value:t=>e.issues.push(t)},addIssues:{value:t=>e.issues.push(...t)},isEmpty:{get:()=>0===e.issues.length}})},{Parent:Error}),Rr=_parse(Pr),$r=_parseAsync(Pr),Br=_safeParse(Pr),Ur=_safeParseAsync(Pr),Lr=$constructor("ZodType",(e,t)=>(Ot.init(e,t),e.def=t,Object.defineProperty(e,"_def",{value:t}),e.check=(...r)=>e.clone({...t,checks:[...t.checks??[],...r.map(e=>"function"==typeof e?{_zod:{check:e,def:{check:"custom"},onattach:[]}}:e)]}),e.clone=(t,r)=>clone$1(e,t,r),e.brand=()=>e,e.register=(t,r)=>(t.add(e,r),e),e.parse=(t,r)=>Rr(e,t,r,{callee:e.parse}),e.safeParse=(t,r)=>Br(e,t,r),e.parseAsync=async(t,r)=>$r(e,t,r,{callee:e.parseAsync}),e.safeParseAsync=async(t,r)=>Ur(e,t,r),e.spa=e.safeParseAsync,e.refine=(t,r)=>e.check(function(e,t={}){return function(e,t,r){return new e({type:"custom",check:"custom",fn:t,...normalizeParams(r)})}(Cn,e,t)}(t,r)),e.superRefine=t=>e.check(function(e){const t=function(e){const t=new pt({check:"custom"});return t._zod.check=e,t}(r=>(r.addIssue=e=>{if("string"==typeof e)r.issues.push(issue(e,r.value,t._zod.def));else{const n=e;n.fatal&&(n.continue=!1),n.code??(n.code="custom"),n.input??(n.input=r.value),n.inst??(n.inst=t),n.continue??(n.continue=!t._zod.def.abort),r.issues.push(issue(n))}},e(r.value,r)));return t}(t)),e.overwrite=t=>e.check(_overwrite(t)),e.optional=()=>optional(e),e.nullable=()=>nullable(e),e.nullish=()=>optional(nullable(e)),e.nonoptional=t=>function(e,t){return new _n({type:"nonoptional",innerType:e,...normalizeParams(t)})}(e,t),e.array=()=>array(e),e.or=t=>{return new yn({type:"union",options:[e,t],...normalizeParams(r)});var r},e.and=t=>new wn({type:"intersection",left:e,right:t}),e.transform=t=>pipe(e,new Nn({type:"transform",transform:t})),e.default=t=>{return r=t,new xn({type:"default",innerType:e,get defaultValue(){return"function"==typeof r?r():r}});var r},e.prefault=t=>{return r=t,new Sn({type:"prefault",innerType:e,get defaultValue(){return"function"==typeof r?r():r}});var r},e.catch=t=>{return new An({type:"catch",innerType:e,catchValue:"function"==typeof(r=t)?r:()=>r});var r},e.pipe=t=>pipe(e,t),e.readonly=()=>new En({type:"readonly",innerType:e}),e.describe=t=>{const r=e.clone();return Ar.add(r,{description:t}),r},Object.defineProperty(e,"description",{get:()=>Ar.get(e)?.description,configurable:!0}),e.meta=(...t)=>{if(0===t.length)return Ar.get(e);const r=e.clone();return Ar.add(r,t[0]),r},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),zr=$constructor("_ZodString",(e,t)=>{Pt.init(e,t),Lr.init(e,t);const r=e._zod.bag;e.format=r.format??null,e.minLength=r.minimum??null,e.maxLength=r.maximum??null,e.regex=(...t)=>e.check(function(e,t){return new kt({check:"string_format",format:"regex",...normalizeParams(t),pattern:e})}(...t)),e.includes=(...t)=>e.check(function(e,t){return new _t({check:"string_format",format:"includes",...normalizeParams(t),includes:e})}(...t)),e.startsWith=(...t)=>e.check(function(e,t){return new At({check:"string_format",format:"starts_with",...normalizeParams(t),prefix:e})}(...t)),e.endsWith=(...t)=>e.check(function(e,t){return new It({check:"string_format",format:"ends_with",...normalizeParams(t),suffix:e})}(...t)),e.min=(...t)=>e.check(_minLength(...t)),e.max=(...t)=>e.check(_maxLength(...t)),e.length=(...t)=>e.check(_length(...t)),e.nonempty=(...t)=>e.check(_minLength(1,...t)),e.lowercase=t=>e.check(function(e){return new xt({check:"string_format",format:"lowercase",...normalizeParams(e)})}(t)),e.uppercase=t=>e.check(function(e){return new St({check:"string_format",format:"uppercase",...normalizeParams(e)})}(t)),e.trim=()=>e.check(_overwrite(e=>e.trim())),e.normalize=(...t)=>e.check(function(e){return _overwrite(t=>t.normalize(e))}(...t)),e.toLowerCase=()=>e.check(_overwrite(e=>e.toLowerCase())),e.toUpperCase=()=>e.check(_overwrite(e=>e.toUpperCase()))}),Dr=$constructor("ZodString",(e,t)=>{Pt.init(e,t),zr.init(e,t),e.email=t=>e.check(_email(Wr,t)),e.url=t=>e.check(function(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,...normalizeParams(t)})}(Qr,t)),e.jwt=t=>e.check(function(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...normalizeParams(t)})}(on,t)),e.emoji=t=>e.check(function(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...normalizeParams(t)})}(Vr,t)),e.guid=t=>e.check(_guid(jr,t)),e.uuid=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...normalizeParams(t)})}(Mr,t)),e.uuidv4=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...normalizeParams(t)})}(Mr,t)),e.uuidv6=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...normalizeParams(t)})}(Mr,t)),e.uuidv7=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...normalizeParams(t)})}(Mr,t)),e.nanoid=t=>e.check(function(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...normalizeParams(t)})}(Fr,t)),e.guid=t=>e.check(_guid(jr,t)),e.cuid=t=>e.check(function(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...normalizeParams(t)})}(Jr,t)),e.cuid2=t=>e.check(function(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...normalizeParams(t)})}(Kr,t)),e.ulid=t=>e.check(function(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...normalizeParams(t)})}(Hr,t)),e.base64=t=>e.check(function(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...normalizeParams(t)})}(rn,t)),e.base64url=t=>e.check(function(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...normalizeParams(t)})}(nn,t)),e.xid=t=>e.check(function(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...normalizeParams(t)})}(Zr,t)),e.ksuid=t=>e.check(function(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...normalizeParams(t)})}(Gr,t)),e.ipv4=t=>e.check(function(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...normalizeParams(t)})}(Yr,t)),e.ipv6=t=>e.check(function(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...normalizeParams(t)})}(Xr,t)),e.cidrv4=t=>e.check(function(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...normalizeParams(t)})}(en,t)),e.cidrv6=t=>e.check(function(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...normalizeParams(t)})}(tn,t)),e.e164=t=>e.check(function(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...normalizeParams(t)})}(sn,t)),e.datetime=t=>e.check(datetime(t)),e.date=t=>e.check(date$2(t)),e.time=t=>e.check(time$1(t)),e.duration=t=>e.check(duration(t))});function string$1(e){return function(e,t){return new e({type:"string",...normalizeParams(t)})}(Dr,e)}const qr=$constructor("ZodStringFormat",(e,t)=>{Rt.init(e,t),zr.init(e,t)}),Wr=$constructor("ZodEmail",(e,t)=>{Ut.init(e,t),qr.init(e,t)});function email(e){return _email(Wr,e)}const jr=$constructor("ZodGUID",(e,t)=>{$t.init(e,t),qr.init(e,t)}),Mr=$constructor("ZodUUID",(e,t)=>{Bt.init(e,t),qr.init(e,t)}),Qr=$constructor("ZodURL",(e,t)=>{Lt.init(e,t),qr.init(e,t)}),Vr=$constructor("ZodEmoji",(e,t)=>{zt.init(e,t),qr.init(e,t)}),Fr=$constructor("ZodNanoID",(e,t)=>{Dt.init(e,t),qr.init(e,t)}),Jr=$constructor("ZodCUID",(e,t)=>{qt.init(e,t),qr.init(e,t)}),Kr=$constructor("ZodCUID2",(e,t)=>{Wt.init(e,t),qr.init(e,t)}),Hr=$constructor("ZodULID",(e,t)=>{jt.init(e,t),qr.init(e,t)}),Zr=$constructor("ZodXID",(e,t)=>{Mt.init(e,t),qr.init(e,t)}),Gr=$constructor("ZodKSUID",(e,t)=>{Qt.init(e,t),qr.init(e,t)}),Yr=$constructor("ZodIPv4",(e,t)=>{Ht.init(e,t),qr.init(e,t)}),Xr=$constructor("ZodIPv6",(e,t)=>{Zt.init(e,t),qr.init(e,t)}),en=$constructor("ZodCIDRv4",(e,t)=>{Gt.init(e,t),qr.init(e,t)}),tn=$constructor("ZodCIDRv6",(e,t)=>{Yt.init(e,t),qr.init(e,t)}),rn=$constructor("ZodBase64",(e,t)=>{Xt.init(e,t),qr.init(e,t)}),nn=$constructor("ZodBase64URL",(e,t)=>{er.init(e,t),qr.init(e,t)}),sn=$constructor("ZodE164",(e,t)=>{tr.init(e,t),qr.init(e,t)}),on=$constructor("ZodJWT",(e,t)=>{rr.init(e,t),qr.init(e,t)}),an=$constructor("ZodNumber",(e,t)=>{nr.init(e,t),Lr.init(e,t),e.gt=(t,r)=>e.check(_gt(t,r)),e.gte=(t,r)=>e.check(_gte(t,r)),e.min=(t,r)=>e.check(_gte(t,r)),e.lt=(t,r)=>e.check(_lt(t,r)),e.lte=(t,r)=>e.check(_lte(t,r)),e.max=(t,r)=>e.check(_lte(t,r)),e.int=t=>e.check(int(t)),e.safe=t=>e.check(int(t)),e.positive=t=>e.check(_gt(0,t)),e.nonnegative=t=>e.check(_gte(0,t)),e.negative=t=>e.check(_lt(0,t)),e.nonpositive=t=>e.check(_lte(0,t)),e.multipleOf=(t,r)=>e.check(_multipleOf(t,r)),e.step=(t,r)=>e.check(_multipleOf(t,r)),e.finite=()=>e;const r=e._zod.bag;e.minValue=Math.max(r.minimum??Number.NEGATIVE_INFINITY,r.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(r.maximum??Number.POSITIVE_INFINITY,r.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(r.format??"").includes("int")||Number.isSafeInteger(r.multipleOf??.5),e.isFinite=!0,e.format=r.format??null});function number$1(e){return function(e,t){return new e({type:"number",checks:[],...normalizeParams(t)})}(an,e)}const cn=$constructor("ZodNumberFormat",(e,t)=>{ir.init(e,t),an.init(e,t)});function int(e){return function(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...normalizeParams(t)})}(cn,e)}const dn=$constructor("ZodBoolean",(e,t)=>{sr.init(e,t),Lr.init(e,t)});function boolean$2(e){return function(e,t){return new e({type:"boolean",...normalizeParams(t)})}(dn,e)}const ln=$constructor("ZodAny",(e,t)=>{ar.init(e,t),Lr.init(e,t)});function any(){return new ln({type:"any"})}const un=$constructor("ZodUnknown",(e,t)=>{cr.init(e,t),Lr.init(e,t)});function unknown(){return new un({type:"unknown"})}const pn=$constructor("ZodNever",(e,t)=>{dr.init(e,t),Lr.init(e,t)});function never(e){return function(e,t){return new e({type:"never",...normalizeParams(t)})}(pn,e)}const hn=$constructor("ZodDate",(e,t)=>{lr.init(e,t),Lr.init(e,t),e.min=(t,r)=>e.check(_gte(t,r)),e.max=(t,r)=>e.check(_lte(t,r));const r=e._zod.bag;e.minDate=r.minimum?new Date(r.minimum):null,e.maxDate=r.maximum?new Date(r.maximum):null});function date$1(e){return function(e,t){return new e({type:"date",...normalizeParams(t)})}(hn,e)}const mn=$constructor("ZodArray",(e,t)=>{ur.init(e,t),Lr.init(e,t),e.element=t.element,e.min=(t,r)=>e.check(_minLength(t,r)),e.nonempty=t=>e.check(_minLength(1,t)),e.max=(t,r)=>e.check(_maxLength(t,r)),e.length=(t,r)=>e.check(_length(t,r)),e.unwrap=()=>e.element});function array(e,t){return function(e,t,r){return new e({type:"array",element:t,...normalizeParams(r)})}(mn,e,t)}const gn=$constructor("ZodObject",(e,t)=>{pr.init(e,t),Lr.init(e,t),defineLazy(e,"shape",()=>t.shape),e.keyof=()=>_enum(Object.keys(e._zod.def.shape)),e.catchall=t=>e.clone({...e._zod.def,catchall:t}),e.passthrough=()=>e.clone({...e._zod.def,catchall:unknown()}),e.loose=()=>e.clone({...e._zod.def,catchall:unknown()}),e.strict=()=>e.clone({...e._zod.def,catchall:never()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=t=>function(e,t){if(!isPlainObject(t))throw new Error("Invalid input to extend: expected a plain object");const r={...e._zod.def,get shape(){const r={...e._zod.def.shape,...t};return assignProp(this,"shape",r),r},checks:[]};return clone$1(e,r)}(e,t),e.merge=t=>function(e,t){return clone$1(e,{...e._zod.def,get shape(){const r={...e._zod.def.shape,...t._zod.def.shape};return assignProp(this,"shape",r),r},catchall:t._zod.def.catchall,checks:[]})}(e,t),e.pick=t=>function(e,t){const r={},n=e._zod.def;for(const e in t){if(!(e in n.shape))throw new Error(`Unrecognized key: "${e}"`);t[e]&&(r[e]=n.shape[e])}return clone$1(e,{...e._zod.def,shape:r,checks:[]})}(e,t),e.omit=t=>function(e,t){const r={...e._zod.def.shape},n=e._zod.def;for(const e in t){if(!(e in n.shape))throw new Error(`Unrecognized key: "${e}"`);t[e]&&delete r[e]}return clone$1(e,{...e._zod.def,shape:r,checks:[]})}(e,t),e.partial=(...t)=>function(e,t,r){const n=t._zod.def.shape,i={...n};if(r)for(const t in r){if(!(t in n))throw new Error(`Unrecognized key: "${t}"`);r[t]&&(i[t]=e?new e({type:"optional",innerType:n[t]}):n[t])}else for(const t in n)i[t]=e?new e({type:"optional",innerType:n[t]}):n[t];return clone$1(t,{...t._zod.def,shape:i,checks:[]})}(Tn,e,t[0]),e.required=(...t)=>function(e,t,r){const n=t._zod.def.shape,i={...n};if(r)for(const t in r){if(!(t in i))throw new Error(`Unrecognized key: "${t}"`);r[t]&&(i[t]=new e({type:"nonoptional",innerType:n[t]}))}else for(const t in n)i[t]=new e({type:"nonoptional",innerType:n[t]});return clone$1(t,{...t._zod.def,shape:i,checks:[]})}(_n,e,t[0])});function object(e,t){const r={type:"object",get shape(){return assignProp(this,"shape",{...e}),this.shape},...normalizeParams(t)};return new gn(r)}const yn=$constructor("ZodUnion",(e,t)=>{hr.init(e,t),Lr.init(e,t),e.options=t.options});const wn=$constructor("ZodIntersection",(e,t)=>{fr.init(e,t),Lr.init(e,t)});const bn=$constructor("ZodRecord",(e,t)=>{mr.init(e,t),Lr.init(e,t),e.keyType=t.keyType,e.valueType=t.valueType});function record(e,t,r){return new bn({type:"record",keyType:e,valueType:t,...normalizeParams(r)})}const vn=$constructor("ZodEnum",(e,t)=>{gr.init(e,t),Lr.init(e,t),e.enum=t.entries,e.options=Object.values(t.entries);const r=new Set(Object.keys(t.entries));e.extract=(e,n)=>{const i={};for(const n of e){if(!r.has(n))throw new Error(`Key ${n} not found in enum`);i[n]=t.entries[n]}return new vn({...t,checks:[],...normalizeParams(n),entries:i})},e.exclude=(e,n)=>{const i={...t.entries};for(const t of e){if(!r.has(t))throw new Error(`Key ${t} not found in enum`);delete i[t]}return new vn({...t,checks:[],...normalizeParams(n),entries:i})}});function _enum(e,t){const r=Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e;return new vn({type:"enum",entries:r,...normalizeParams(t)})}const Nn=$constructor("ZodTransform",(e,t)=>{yr.init(e,t),Lr.init(e,t),e._zod.parse=(r,n)=>{r.addIssue=n=>{if("string"==typeof n)r.issues.push(issue(n,r.value,t));else{const t=n;t.fatal&&(t.continue=!1),t.code??(t.code="custom"),t.input??(t.input=r.value),t.inst??(t.inst=e),t.continue??(t.continue=!0),r.issues.push(issue(t))}};const i=t.transform(r.value,r);return i instanceof Promise?i.then(e=>(r.value=e,r)):(r.value=i,r)}});const Tn=$constructor("ZodOptional",(e,t)=>{wr.init(e,t),Lr.init(e,t),e.unwrap=()=>e._zod.def.innerType});function optional(e){return new Tn({type:"optional",innerType:e})}const kn=$constructor("ZodNullable",(e,t)=>{br.init(e,t),Lr.init(e,t),e.unwrap=()=>e._zod.def.innerType});function nullable(e){return new kn({type:"nullable",innerType:e})}const xn=$constructor("ZodDefault",(e,t)=>{vr.init(e,t),Lr.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});const Sn=$constructor("ZodPrefault",(e,t)=>{Nr.init(e,t),Lr.init(e,t),e.unwrap=()=>e._zod.def.innerType});const _n=$constructor("ZodNonOptional",(e,t)=>{Tr.init(e,t),Lr.init(e,t),e.unwrap=()=>e._zod.def.innerType});const An=$constructor("ZodCatch",(e,t)=>{kr.init(e,t),Lr.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});const In=$constructor("ZodPipe",(e,t)=>{xr.init(e,t),Lr.init(e,t),e.in=t.in,e.out=t.out});function pipe(e,t){return new In({type:"pipe",in:e,out:t})}const En=$constructor("ZodReadonly",(e,t)=>{Sr.init(e,t),Lr.init(e,t)});const Cn=$constructor("ZodCustom",(e,t)=>{_r.init(e,t),Lr.init(e,t)});function string(e){return function(e,t){return new e({type:"string",coerce:!0,...normalizeParams(t)})}(Dr,e)}function boolean$1(e){return function(e,t){return new e({type:"boolean",coerce:!0,...normalizeParams(t)})}(dn,e)}const getDate=(e,t="ms")=>new Date(Date.now()+("sec"===t?1e3*e:e));function getAlphabet(e){return e?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"}function base64Encode(e,t,r){let n="",i=0,s=0;for(const r of e)for(i=i<<8|r,s+=8;s>=6;)s-=6,n+=t[i>>s&63];if(s>0&&(n+=t[i<<6-s&63]),r){const e=(4-n.length%4)%4;n+="=".repeat(e)}return n}function base64Decode(e,t){const r=new Map;for(let e=0;e<t.length;e++)r.set(t[e],e);const n=[];let i=0,s=0;for(const t of e){if("="===t)break;const e=r.get(t);if(void 0===e)throw new Error(`Invalid Base64 character: ${t}`);i=i<<6|e,s+=6,s>=8&&(s-=8,n.push(i>>s&255))}return Uint8Array.from(n)}const On={encode(e,t={}){const r=getAlphabet(!1);return base64Encode("string"==typeof e?(new TextEncoder).encode(e):new Uint8Array(e),r,t.padding??!0)},decode(e){"string"!=typeof e&&(e=(new TextDecoder).decode(e));const t=e.includes("-")||e.includes("_");return base64Decode(e,getAlphabet(t))}},Pn={encode(e,t={}){const r=getAlphabet(!0);return base64Encode("string"==typeof e?(new TextEncoder).encode(e):new Uint8Array(e),r,t.padding??!0)},decode(e){const t=e.includes("-")||e.includes("_");return base64Decode(e,getAlphabet(t))}};function createHash(t,r){return{digest:async r=>{const n=new TextEncoder,i="string"==typeof r?n.encode(r):r;return await e.digest(t,i)}}}function number(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function bool(e){if("boolean"!=typeof e)throw new Error(`boolean expected, not ${e}`)}function isBytes$1(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}function bytes(e,...t){if(!isBytes$1(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function exists$1(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}const u32$1=e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4));if(!(68===new Uint8Array(new Uint32Array([287454020]).buffer)[0]))throw new Error("Non little-endian hardware is not supported");const Rn=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));const $n=48,Bn=57,Un=65,Ln=70,zn=97,Dn=102;function asciiToBase16$1(e){return e>=$n&&e<=Bn?e-$n:e>=Un&&e<=Ln?e-(Un-10):e>=zn&&e<=Dn?e-(zn-10):void 0}function utf8ToBytes$1(e){if("string"!=typeof e)throw new Error("string expected, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}function toBytes$1(e){if("string"==typeof e)e=utf8ToBytes$1(e);else{if(!isBytes$1(e))throw new Error("Uint8Array expected, got "+typeof e);e=copyBytes(e)}return e}const wrapCipher=(e,t)=>(Object.assign(t,e),t);function setBigUint64$1(e,t,r,n){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,r,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(r>>i&s),a=Number(r&s);e.setUint32(t+4,o,n),e.setUint32(t+0,a,n)}function copyBytes(e){return Uint8Array.from(e)}function clean$1(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}const _utf8ToBytes=e=>Uint8Array.from(e.split("").map(e=>e.charCodeAt(0))),qn=_utf8ToBytes("expand 16-byte k"),Wn=_utf8ToBytes("expand 32-byte k"),jn=u32$1(qn),Mn=u32$1(Wn);function rotl$1(e,t){return e<<t|e>>>32-t}function isAligned32(e){return e.byteOffset%4==0}Mn.slice();const Qn=2**32-1,Vn=new Uint32Array;function createCipher(e,t){const{allowShortKeys:r,extendNonceFn:n,counterLength:i,counterRight:s,rounds:o}=function(e,t){if(null==t||"object"!=typeof t)throw new Error("options must be defined");return Object.assign(e,t)}({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if("function"!=typeof e)throw new Error("core must be a function");return number(i),number(o),bool(s),bool(r),(t,a,c,d,l=0)=>{bytes(t),bytes(a),bytes(c);const u=c.length;if(void 0===d&&(d=new Uint8Array(u)),bytes(d),number(l),l<0||l>=Qn)throw new Error("arx: counter overflow");if(d.length<u)throw new Error(`arx: output (${d.length}) is shorter than data (${u})`);const p=[];let h,f,m=t.length;if(32===m)p.push(h=copyBytes(t)),f=Mn;else{if(16!==m||!r)throw new Error(`arx: invalid 32-byte key, got length=${m}`);h=new Uint8Array(32),h.set(t),h.set(t,16),f=jn,p.push(h)}isAligned32(a)||p.push(a=copyBytes(a));const g=u32$1(h);if(n){if(24!==a.length)throw new Error("arx: extended nonce must be 24 bytes");n(f,g,u32$1(a.subarray(0,16)),g),a=a.subarray(16)}const y=16-i;if(y!==a.length)throw new Error(`arx: nonce must be ${y} or 16 bytes`);if(12!==y){const e=new Uint8Array(12);e.set(a,s?0:12-a.length),a=e,p.push(a)}const w=u32$1(a);return function(e,t,r,n,i,s,o,a){const c=i.length,d=new Uint8Array(64),l=u32$1(d),u=isAligned32(i)&&isAligned32(s),p=u?u32$1(i):Vn,h=u?u32$1(s):Vn;for(let f=0;f<c;o++){if(e(t,r,n,l,o,a),o>=Qn)throw new Error("arx: counter overflow");const m=Math.min(64,c-f);if(u&&64===m){const e=f/4;if(f%4!=0)throw new Error("arx: invalid block position");for(let t,r=0;r<16;r++)t=e+r,h[t]=p[t]^l[r];f+=64;continue}for(let e,t=0;t<m;t++)e=f+t,s[e]=i[e]^d[t];f+=m}}(e,f,g,w,c,d,l,o),clean$1(...p),d}}const u8to16=(e,t)=>255&e[t++]|(255&e[t++])<<8;class Poly1305{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,bytes(e=toBytes$1(e),32);const t=u8to16(e,0),r=u8to16(e,2),n=u8to16(e,4),i=u8to16(e,6),s=u8to16(e,8),o=u8to16(e,10),a=u8to16(e,12),c=u8to16(e,14);this.r[0]=8191&t,this.r[1]=8191&(t>>>13|r<<3),this.r[2]=7939&(r>>>10|n<<6),this.r[3]=8191&(n>>>7|i<<9),this.r[4]=255&(i>>>4|s<<12),this.r[5]=s>>>1&8190,this.r[6]=8191&(s>>>14|o<<2),this.r[7]=8065&(o>>>11|a<<5),this.r[8]=8191&(a>>>8|c<<8),this.r[9]=c>>>5&127;for(let t=0;t<8;t++)this.pad[t]=u8to16(e,16+2*t)}process(e,t,r=!1){const n=r?0:2048,{h:i,r:s}=this,o=s[0],a=s[1],c=s[2],d=s[3],l=s[4],u=s[5],p=s[6],h=s[7],f=s[8],m=s[9],g=u8to16(e,t+0),y=u8to16(e,t+2),w=u8to16(e,t+4),b=u8to16(e,t+6),v=u8to16(e,t+8),N=u8to16(e,t+10),T=u8to16(e,t+12),k=u8to16(e,t+14);let x=i[0]+(8191&g),S=i[1]+(8191&(g>>>13|y<<3)),A=i[2]+(8191&(y>>>10|w<<6)),I=i[3]+(8191&(w>>>7|b<<9)),E=i[4]+(8191&(b>>>4|v<<12)),O=i[5]+(v>>>1&8191),P=i[6]+(8191&(v>>>14|N<<2)),R=i[7]+(8191&(N>>>11|T<<5)),$=i[8]+(8191&(T>>>8|k<<8)),B=i[9]+(k>>>5|n),U=0,L=U+x*o+S*(5*m)+A*(5*f)+I*(5*h)+E*(5*p);U=L>>>13,L&=8191,L+=O*(5*u)+P*(5*l)+R*(5*d)+$*(5*c)+B*(5*a),U+=L>>>13,L&=8191;let z=U+x*a+S*o+A*(5*m)+I*(5*f)+E*(5*h);U=z>>>13,z&=8191,z+=O*(5*p)+P*(5*u)+R*(5*l)+$*(5*d)+B*(5*c),U+=z>>>13,z&=8191;let D=U+x*c+S*a+A*o+I*(5*m)+E*(5*f);U=D>>>13,D&=8191,D+=O*(5*h)+P*(5*p)+R*(5*u)+$*(5*l)+B*(5*d),U+=D>>>13,D&=8191;let q=U+x*d+S*c+A*a+I*o+E*(5*m);U=q>>>13,q&=8191,q+=O*(5*f)+P*(5*h)+R*(5*p)+$*(5*u)+B*(5*l),U+=q>>>13,q&=8191;let W=U+x*l+S*d+A*c+I*a+E*o;U=W>>>13,W&=8191,W+=O*(5*m)+P*(5*f)+R*(5*h)+$*(5*p)+B*(5*u),U+=W>>>13,W&=8191;let j=U+x*u+S*l+A*d+I*c+E*a;U=j>>>13,j&=8191,j+=O*o+P*(5*m)+R*(5*f)+$*(5*h)+B*(5*p),U+=j>>>13,j&=8191;let M=U+x*p+S*u+A*l+I*d+E*c;U=M>>>13,M&=8191,M+=O*a+P*o+R*(5*m)+$*(5*f)+B*(5*h),U+=M>>>13,M&=8191;let Q=U+x*h+S*p+A*u+I*l+E*d;U=Q>>>13,Q&=8191,Q+=O*c+P*a+R*o+$*(5*m)+B*(5*f),U+=Q>>>13,Q&=8191;let V=U+x*f+S*h+A*p+I*u+E*l;U=V>>>13,V&=8191,V+=O*d+P*c+R*a+$*o+B*(5*m),U+=V>>>13,V&=8191;let F=U+x*m+S*f+A*h+I*p+E*u;U=F>>>13,F&=8191,F+=O*l+P*d+R*c+$*a+B*o,U+=F>>>13,F&=8191,U=(U<<2)+U|0,U=U+L|0,L=8191&U,U>>>=13,z+=U,i[0]=L,i[1]=z,i[2]=D,i[3]=q,i[4]=W,i[5]=j,i[6]=M,i[7]=Q,i[8]=V,i[9]=F}finalize(){const{h:e,pad:t}=this,r=new Uint16Array(10);let n=e[1]>>>13;e[1]&=8191;for(let t=2;t<10;t++)e[t]+=n,n=e[t]>>>13,e[t]&=8191;e[0]+=5*n,n=e[0]>>>13,e[0]&=8191,e[1]+=n,n=e[1]>>>13,e[1]&=8191,e[2]+=n,r[0]=e[0]+5,n=r[0]>>>13,r[0]&=8191;for(let t=1;t<10;t++)r[t]=e[t]+n,n=r[t]>>>13,r[t]&=8191;r[9]-=8192;let i=(1^n)-1;for(let e=0;e<10;e++)r[e]&=i;i=~i;for(let t=0;t<10;t++)e[t]=e[t]&i|r[t];e[0]=65535&(e[0]|e[1]<<13),e[1]=65535&(e[1]>>>3|e[2]<<10),e[2]=65535&(e[2]>>>6|e[3]<<7),e[3]=65535&(e[3]>>>9|e[4]<<4),e[4]=65535&(e[4]>>>12|e[5]<<1|e[6]<<14),e[5]=65535&(e[6]>>>2|e[7]<<11),e[6]=65535&(e[7]>>>5|e[8]<<8),e[7]=65535&(e[8]>>>8|e[9]<<5);let s=e[0]+t[0];e[0]=65535&s;for(let r=1;r<8;r++)s=(e[r]+t[r]|0)+(s>>>16)|0,e[r]=65535&s;clean$1(r)}update(e){exists$1(this);const{buffer:t,blockLen:r}=this,n=(e=toBytes$1(e)).length;for(let i=0;i<n;){const s=Math.min(r-this.pos,n-i);if(s!==r)t.set(e.subarray(i,i+s),this.pos),this.pos+=s,i+=s,this.pos===r&&(this.process(t,0,!1),this.pos=0);else for(;r<=n-i;i+=r)this.process(e,i)}return this}destroy(){clean$1(this.h,this.r,this.buffer,this.pad)}digestInto(e){exists$1(this),function(e,t){bytes(e);const r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}(e,this),this.finished=!0;const{buffer:t,h:r}=this;let{pos:n}=this;if(n){for(t[n++]=1;n<16;n++)t[n]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let t=0;t<8;t++)e[i++]=r[t]>>>0,e[i++]=r[t]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}}const Fn=function(e){const hashC=(t,r)=>e(r).update(toBytes$1(t)).digest(),t=e(new Uint8Array(32));return hashC.outputLen=t.outputLen,hashC.blockLen=t.blockLen,hashC.create=t=>e(t),hashC}(e=>new Poly1305(e));function chachaCore(e,t,r,n,i,s=20){let o=e[0],a=e[1],c=e[2],d=e[3],l=t[0],u=t[1],p=t[2],h=t[3],f=t[4],m=t[5],g=t[6],y=t[7],w=i,b=r[0],v=r[1],N=r[2],T=o,k=a,x=c,S=d,A=l,I=u,E=p,O=h,P=f,R=m,$=g,B=y,U=w,L=b,z=v,D=N;for(let e=0;e<s;e+=2)T=T+A|0,U=rotl$1(U^T,16),P=P+U|0,A=rotl$1(A^P,12),T=T+A|0,U=rotl$1(U^T,8),P=P+U|0,A=rotl$1(A^P,7),k=k+I|0,L=rotl$1(L^k,16),R=R+L|0,I=rotl$1(I^R,12),k=k+I|0,L=rotl$1(L^k,8),R=R+L|0,I=rotl$1(I^R,7),x=x+E|0,z=rotl$1(z^x,16),$=$+z|0,E=rotl$1(E^$,12),x=x+E|0,z=rotl$1(z^x,8),$=$+z|0,E=rotl$1(E^$,7),S=S+O|0,D=rotl$1(D^S,16),B=B+D|0,O=rotl$1(O^B,12),S=S+O|0,D=rotl$1(D^S,8),B=B+D|0,O=rotl$1(O^B,7),T=T+I|0,D=rotl$1(D^T,16),$=$+D|0,I=rotl$1(I^$,12),T=T+I|0,D=rotl$1(D^T,8),$=$+D|0,I=rotl$1(I^$,7),k=k+E|0,U=rotl$1(U^k,16),B=B+U|0,E=rotl$1(E^B,12),k=k+E|0,U=rotl$1(U^k,8),B=B+U|0,E=rotl$1(E^B,7),x=x+O|0,L=rotl$1(L^x,16),P=P+L|0,O=rotl$1(O^P,12),x=x+O|0,L=rotl$1(L^x,8),P=P+L|0,O=rotl$1(O^P,7),S=S+A|0,z=rotl$1(z^S,16),R=R+z|0,A=rotl$1(A^R,12),S=S+A|0,z=rotl$1(z^S,8),R=R+z|0,A=rotl$1(A^R,7);let q=0;n[q++]=o+T|0,n[q++]=a+k|0,n[q++]=c+x|0,n[q++]=d+S|0,n[q++]=l+A|0,n[q++]=u+I|0,n[q++]=p+E|0,n[q++]=h+O|0,n[q++]=f+P|0,n[q++]=m+R|0,n[q++]=g+$|0,n[q++]=y+B|0,n[q++]=w+U|0,n[q++]=b+L|0,n[q++]=v+z|0,n[q++]=N+D|0}const Jn=createCipher(chachaCore,{counterRight:!1,counterLength:8,extendNonceFn:function(e,t,r,n){let i=e[0],s=e[1],o=e[2],a=e[3],c=t[0],d=t[1],l=t[2],u=t[3],p=t[4],h=t[5],f=t[6],m=t[7],g=r[0],y=r[1],w=r[2],b=r[3];for(let e=0;e<20;e+=2)i=i+c|0,g=rotl$1(g^i,16),p=p+g|0,c=rotl$1(c^p,12),i=i+c|0,g=rotl$1(g^i,8),p=p+g|0,c=rotl$1(c^p,7),s=s+d|0,y=rotl$1(y^s,16),h=h+y|0,d=rotl$1(d^h,12),s=s+d|0,y=rotl$1(y^s,8),h=h+y|0,d=rotl$1(d^h,7),o=o+l|0,w=rotl$1(w^o,16),f=f+w|0,l=rotl$1(l^f,12),o=o+l|0,w=rotl$1(w^o,8),f=f+w|0,l=rotl$1(l^f,7),a=a+u|0,b=rotl$1(b^a,16),m=m+b|0,u=rotl$1(u^m,12),a=a+u|0,b=rotl$1(b^a,8),m=m+b|0,u=rotl$1(u^m,7),i=i+d|0,b=rotl$1(b^i,16),f=f+b|0,d=rotl$1(d^f,12),i=i+d|0,b=rotl$1(b^i,8),f=f+b|0,d=rotl$1(d^f,7),s=s+l|0,g=rotl$1(g^s,16),m=m+g|0,l=rotl$1(l^m,12),s=s+l|0,g=rotl$1(g^s,8),m=m+g|0,l=rotl$1(l^m,7),o=o+u|0,y=rotl$1(y^o,16),p=p+y|0,u=rotl$1(u^p,12),o=o+u|0,y=rotl$1(y^o,8),p=p+y|0,u=rotl$1(u^p,7),a=a+c|0,w=rotl$1(w^a,16),h=h+w|0,c=rotl$1(c^h,12),a=a+c|0,w=rotl$1(w^a,8),h=h+w|0,c=rotl$1(c^h,7);let v=0;n[v++]=i,n[v++]=s,n[v++]=o,n[v++]=a,n[v++]=g,n[v++]=y,n[v++]=w,n[v++]=b},allowShortKeys:!1}),Kn=new Uint8Array(16),updatePadded=(e,t)=>{e.update(t);const r=t.length%16;r&&e.update(Kn.subarray(r))},Hn=new Uint8Array(32);function computeTag(e,t,r,n,i){const s=e(t,r,Hn),o=Fn.create(s);i&&updatePadded(o,i),updatePadded(o,n);const a=new Uint8Array(16),c=(d=a,new DataView(d.buffer,d.byteOffset,d.byteLength));var d;setBigUint64$1(c,0,BigInt(i?i.length:0),!0),setBigUint64$1(c,8,BigInt(n.length),!0),o.update(a);const l=o.digest();return clean$1(s,a),l}const Zn=wrapCipher({blockSize:64,nonceLength:24,tagLength:16},(Gn=Jn,(e,t,r)=>{const n=16;return bytes(e,32),bytes(t),{encrypt(i,s){const o=i.length,a=o+n;s?bytes(s,a):s=new Uint8Array(a),Gn(e,t,i,s,1);const c=computeTag(Gn,e,t,s.subarray(0,-16),r);return s.set(c,o),clean$1(c),s},decrypt(i,s){const o=i.length,a=o-n;if(o<n)throw new Error("encrypted data must be at least 16 bytes");s?bytes(s,a):s=new Uint8Array(a);const c=i.subarray(0,-16),d=i.subarray(-16),l=computeTag(Gn,e,t,c,r);if(!function(e,t){if(e.length!==t.length)return!1;let r=0;for(let n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r}(d,l))throw new Error("invalid tag");return Gn(e,t,c,s,1),clean$1(l),s}}}));var Gn;const Yn="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0;function managedNonce(e){return number(e.nonceLength),(t,...r)=>({encrypt(n,...i){const{nonceLength:s}=e,o=function(e=32){if(Yn&&"function"==typeof Yn.getRandomValues)return Yn.getRandomValues(new Uint8Array(e));throw new Error("crypto.getRandomValues must be defined")}(s),a=e(t,o,...r).encrypt(n,...i),c=function(...e){let t=0;for(let r=0;r<e.length;r++){const n=e[r];bytes(n),t+=n.length}const r=new Uint8Array(t);for(let t=0,n=0;t<e.length;t++){const i=e[t];r.set(i,n),n+=i.length}return r}(o,a);return a.fill(0),c},decrypt(n,...i){const{nonceLength:s}=e,o=n.subarray(0,s),a=n.subarray(s);return e(t,o,...r).decrypt(a,...i)}})}const Xn=crypto,isCryptoKey=e=>e instanceof CryptoKey,ei=new TextEncoder,ti=new TextDecoder;function concat(...e){const t=e.reduce((e,{length:t})=>e+t,0),r=new Uint8Array(t);let n=0;for(const t of e)r.set(t,n),n+=t.length;return r}const encode=e=>(e=>{let t=e;"string"==typeof t&&(t=ei.encode(t));const r=[];for(let e=0;e<t.length;e+=32768)r.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return btoa(r.join(""))})(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),decode$1=e=>{let t=e;t instanceof Uint8Array&&(t=ti.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return(e=>{const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r})(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};class JOSEError extends Error{constructor(e,t){super(e,t),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}JOSEError.code="ERR_JOSE_GENERIC";class JWTClaimValidationFailed extends JOSEError{constructor(e,t,r="unspecified",n="unspecified"){super(e,{cause:{claim:r,reason:n,payload:t}}),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=r,this.reason=n,this.payload=t}}JWTClaimValidationFailed.code="ERR_JWT_CLAIM_VALIDATION_FAILED";class JWTExpired extends JOSEError{constructor(e,t,r="unspecified",n="unspecified"){super(e,{cause:{claim:r,reason:n,payload:t}}),this.code="ERR_JWT_EXPIRED",this.claim=r,this.reason=n,this.payload=t}}JWTExpired.code="ERR_JWT_EXPIRED";class JOSEAlgNotAllowed extends JOSEError{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}}JOSEAlgNotAllowed.code="ERR_JOSE_ALG_NOT_ALLOWED";class JOSENotSupported extends JOSEError{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}}JOSENotSupported.code="ERR_JOSE_NOT_SUPPORTED";(class extends JOSEError{constructor(e="decryption operation failed",t){super(e,t),this.code="ERR_JWE_DECRYPTION_FAILED"}}).code="ERR_JWE_DECRYPTION_FAILED";(class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}}).code="ERR_JWE_INVALID";class JWSInvalid extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}}JWSInvalid.code="ERR_JWS_INVALID";class JWTInvalid extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}}JWTInvalid.code="ERR_JWT_INVALID";(class extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}}).code="ERR_JWK_INVALID";class JWKSInvalid extends JOSEError{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}}JWKSInvalid.code="ERR_JWKS_INVALID";class JWKSNoMatchingKey extends JOSEError{constructor(e="no applicable key found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_NO_MATCHING_KEY"}}JWKSNoMatchingKey.code="ERR_JWKS_NO_MATCHING_KEY";class JWKSMultipleMatchingKeys extends JOSEError{constructor(e="multiple matching keys found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}JWKSMultipleMatchingKeys.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";class JWKSTimeout extends JOSEError{constructor(e="request timed out",t){super(e,t),this.code="ERR_JWKS_TIMEOUT"}}JWKSTimeout.code="ERR_JWKS_TIMEOUT";class JWSSignatureVerificationFailed extends JOSEError{constructor(e="signature verification failed",t){super(e,t),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}function unusable(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function isAlgorithm(e,t){return e.name===t}function getHashLength(e){return parseInt(e.name.slice(4),10)}function checkSigCryptoKey(e,t,...r){switch(t){case"HS256":case"HS384":case"HS512":{if(!isAlgorithm(e.algorithm,"HMAC"))throw unusable("HMAC");const r=parseInt(t.slice(2),10);if(getHashLength(e.algorithm.hash)!==r)throw unusable(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!isAlgorithm(e.algorithm,"RSASSA-PKCS1-v1_5"))throw unusable("RSASSA-PKCS1-v1_5");const r=parseInt(t.slice(2),10);if(getHashLength(e.algorithm.hash)!==r)throw unusable(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!isAlgorithm(e.algorithm,"RSA-PSS"))throw unusable("RSA-PSS");const r=parseInt(t.slice(2),10);if(getHashLength(e.algorithm.hash)!==r)throw unusable(`SHA-${r}`,"algorithm.hash");break}case"EdDSA":if("Ed25519"!==e.algorithm.name&&"Ed448"!==e.algorithm.name)throw unusable("Ed25519 or Ed448");break;case"Ed25519":if(!isAlgorithm(e.algorithm,"Ed25519"))throw unusable("Ed25519");break;case"ES256":case"ES384":case"ES512":{if(!isAlgorithm(e.algorithm,"ECDSA"))throw unusable("ECDSA");const r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw unusable(r,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}!function(e,t){if(t.length&&!t.some(t=>e.usages.includes(t))){let e="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const r=t.pop();e+=`one of ${t.join(", ")}, or ${r}.`}else 2===t.length?e+=`one of ${t[0]} or ${t[1]}.`:e+=`${t[0]}.`;throw new TypeError(e)}}(e,r)}function message(e,t,...r){if((r=r.filter(Boolean)).length>2){const t=r.pop();e+=`one of type ${r.join(", ")}, or ${t}.`}else 2===r.length?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}JWSSignatureVerificationFailed.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";const invalidKeyInput=(e,...t)=>message("Key must be ",e,...t);function withAlg(e,t,...r){return message(`Key for the ${e} algorithm must be `,t,...r)}const isKeyLike=e=>!!isCryptoKey(e)||"KeyObject"===e?.[Symbol.toStringTag],ri=["CryptoKey"],isDisjoint=(...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let r;for(const e of t){const t=Object.keys(e);if(r&&0!==r.size)for(const e of t){if(r.has(e))return!1;r.add(e)}else r=new Set(t)}return!0};function isObject$1(e){if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}const checkKeyLength=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};function isJWK(e){return isObject$1(e)&&"string"==typeof e.kty}const parse$1=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:r}=function(e){let t,r;switch(e.kty){case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"Ed25519":t={name:"Ed25519"},r=e.d?["sign"]:["verify"];break;case"EdDSA":t={name:e.crv},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new JOSENotSupported('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),n=[t,e.ext??!1,e.key_ops??r],i={...e};return delete i.alg,delete i.use,Xn.subtle.importKey("jwk",i,...n)},exportKeyValue=e=>decode$1(e);let ni,ii;const isKeyObject=e=>"KeyObject"===e?.[Symbol.toStringTag],importAndCache=async(e,t,r,n,i=!1)=>{let s=e.get(t);if(s?.[n])return s[n];const o=await parse$1({...r,alg:n});return i&&Object.freeze(t),s?s[n]=o:e.set(t,{[n]:o}),o},normalize_normalizePublicKey=(e,t)=>{if(isKeyObject(e)){let r=e.export({format:"jwk"});return delete r.d,delete r.dp,delete r.dq,delete r.p,delete r.q,delete r.qi,r.k?exportKeyValue(r.k):(ii||(ii=new WeakMap),importAndCache(ii,e,r,t))}if(isJWK(e)){if(e.k)return decode$1(e.k);ii||(ii=new WeakMap);return importAndCache(ii,e,e,t,!0)}return e},normalize_normalizePrivateKey=(e,t)=>{if(isKeyObject(e)){let r=e.export({format:"jwk"});return r.k?exportKeyValue(r.k):(ni||(ni=new WeakMap),importAndCache(ni,e,r,t))}if(isJWK(e)){if(e.k)return decode$1(e.k);ni||(ni=new WeakMap);return importAndCache(ni,e,e,t,!0)}return e};async function importJWK(e,t){if(!isObject$1(e))throw new TypeError("JWK must be an object");switch(t||(t=e.alg),e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return decode$1(e.k);case"RSA":if("oth"in e&&void 0!==e.oth)throw new JOSENotSupported('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return parse$1({...e,alg:t});default:throw new JOSENotSupported('Unsupported "kty" (Key Type) Parameter value')}}const tag=e=>e?.[Symbol.toStringTag],jwkMatchesOp=(e,t,r)=>{if(void 0!==t.use&&"sig"!==t.use)throw new TypeError("Invalid key for this operation, when present its use must be sig");if(void 0!==t.key_ops&&!0!==t.key_ops.includes?.(r))throw new TypeError(`Invalid key for this operation, when present its key_ops must include ${r}`);if(void 0!==t.alg&&t.alg!==e)throw new TypeError(`Invalid key for this operation, when present its alg must be ${e}`);return!0},symmetricTypeCheck=(e,t,r,n)=>{if(!(t instanceof Uint8Array)){if(n&&isJWK(t)){if(function(e){return isJWK(e)&&"oct"===e.kty&&"string"==typeof e.k}(t)&&jwkMatchesOp(e,t,r))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!isKeyLike(t))throw new TypeError(withAlg(e,t,...ri,"Uint8Array",n?"JSON Web Key":null));if("secret"!==t.type)throw new TypeError(`${tag(t)} instances for symmetric algorithms must be of type "secret"`)}};function checkKeyType(e,t,r,n){t.startsWith("HS")||"dir"===t||t.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(t)?symmetricTypeCheck(t,r,n,e):((e,t,r,n)=>{if(n&&isJWK(t))switch(r){case"sign":if(function(e){return"oct"!==e.kty&&"string"==typeof e.d}(t)&&jwkMatchesOp(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"verify":if(function(e){return"oct"!==e.kty&&void 0===e.d}(t)&&jwkMatchesOp(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!isKeyLike(t))throw new TypeError(withAlg(e,t,...ri,n?"JSON Web Key":null));if("secret"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithms must not be of type "secret"`);if("sign"===r&&"public"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithm signing must be of type "private"`);if("decrypt"===r&&"public"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithm decryption must be of type "private"`);if(t.algorithm&&"verify"===r&&"private"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithm verifying must be of type "public"`);if(t.algorithm&&"encrypt"===r&&"private"===t.type)throw new TypeError(`${tag(t)} instances for asymmetric algorithm encryption must be of type "public"`)})(t,r,n,e)}checkKeyType.bind(void 0,!1);const si=checkKeyType.bind(void 0,!0);function validateCrit(e,t,r,n,i){if(void 0!==i.crit&&void 0===n?.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!n||void 0===n.crit)return new Set;if(!Array.isArray(n.crit)||0===n.crit.length||n.crit.some(e=>"string"!=typeof e||0===e.length))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let s;s=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t;for(const t of n.crit){if(!s.has(t))throw new JOSENotSupported(`Extension Header Parameter "${t}" is not recognized`);if(void 0===i[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(s.get(t)&&void 0===n[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(n.crit)}function subtleDsa(e,t){const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"Ed25519":return{name:"Ed25519"};case"EdDSA":return{name:t.name};default:throw new JOSENotSupported(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}async function getCryptoKey(e,t,r){if("sign"===r&&(t=await normalize_normalizePrivateKey(t,e)),"verify"===r&&(t=await normalize_normalizePublicKey(t,e)),isCryptoKey(t))return checkSigCryptoKey(t,e,r),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(invalidKeyInput(t,...ri));return Xn.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}throw new TypeError(invalidKeyInput(t,...ri,"Uint8Array","JSON Web Key"))}async function flattenedVerify(e,t,r){if(!isObject$1(e))throw new JWSInvalid("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new JWSInvalid('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new JWSInvalid("JWS Protected Header incorrect type");if(void 0===e.payload)throw new JWSInvalid("JWS Payload missing");if("string"!=typeof e.signature)throw new JWSInvalid("JWS Signature missing or incorrect type");if(void 0!==e.header&&!isObject$1(e.header))throw new JWSInvalid("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{const t=decode$1(e.protected);n=JSON.parse(ti.decode(t))}catch{throw new JWSInvalid("JWS Protected Header is invalid")}if(!isDisjoint(n,e.header))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const i={...n,...e.header};let s=!0;if(validateCrit(JWSInvalid,new Map([["b64",!0]]),r?.crit,n,i).has("b64")&&(s=n.b64,"boolean"!=typeof s))throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:o}=i;if("string"!=typeof o||!o)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');const a=r&&((e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)})("algorithms",r.algorithms);if(a&&!a.has(o))throw new JOSEAlgNotAllowed('"alg" (Algorithm) Header Parameter value not allowed');if(s){if("string"!=typeof e.payload)throw new JWSInvalid("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new JWSInvalid("JWS Payload must be a string or an Uint8Array instance");let c=!1;"function"==typeof t?(t=await t(n,e),c=!0,si(o,t,"verify"),isJWK(t)&&(t=await importJWK(t,o))):si(o,t,"verify");const d=concat(ei.encode(e.protected??""),ei.encode("."),"string"==typeof e.payload?ei.encode(e.payload):e.payload);let l;try{l=decode$1(e.signature)}catch{throw new JWSInvalid("Failed to base64url decode the signature")}const u=await(async(e,t,r,n)=>{const i=await getCryptoKey(e,t,"verify");checkKeyLength(e,i);const s=subtleDsa(e,i.algorithm);try{return await Xn.subtle.verify(s,i,r,n)}catch{return!1}})(o,t,l,d);if(!u)throw new JWSSignatureVerificationFailed;let p;if(s)try{p=decode$1(e.payload)}catch{throw new JWSInvalid("Failed to base64url decode the payload")}else p="string"==typeof e.payload?ei.encode(e.payload):e.payload;const h={payload:p};return void 0!==e.protected&&(h.protectedHeader=n),void 0!==e.header&&(h.unprotectedHeader=e.header),c?{...h,key:t}:h}const epoch=e=>Math.floor(e.getTime()/1e3),oi=86400,ai=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,secs=e=>{const t=ai.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const r=parseFloat(t[2]);let n;switch(t[3].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":n=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":n=Math.round(60*r);break;case"hour":case"hours":case"hr":case"hrs":case"h":n=Math.round(3600*r);break;case"day":case"days":case"d":n=Math.round(r*oi);break;case"week":case"weeks":case"w":n=Math.round(604800*r);break;default:n=Math.round(31557600*r)}return"-"===t[1]||"ago"===t[4]?-n:n},normalizeTyp=e=>e.toLowerCase().replace(/^application\//,""),jwtPayload=(e,t,r={})=>{let n;try{n=JSON.parse(ti.decode(t))}catch{}if(!isObject$1(n))throw new JWTInvalid("JWT Claims Set must be a top-level JSON object");const{typ:i}=r;if(i&&("string"!=typeof e.typ||normalizeTyp(e.typ)!==normalizeTyp(i)))throw new JWTClaimValidationFailed('unexpected "typ" JWT header value',n,"typ","check_failed");const{requiredClaims:s=[],issuer:o,subject:a,audience:c,maxTokenAge:d}=r,l=[...s];void 0!==d&&l.push("iat"),void 0!==c&&l.push("aud"),void 0!==a&&l.push("sub"),void 0!==o&&l.push("iss");for(const e of new Set(l.reverse()))if(!(e in n))throw new JWTClaimValidationFailed(`missing required "${e}" claim`,n,e,"missing");if(o&&!(Array.isArray(o)?o:[o]).includes(n.iss))throw new JWTClaimValidationFailed('unexpected "iss" claim value',n,"iss","check_failed");if(a&&n.sub!==a)throw new JWTClaimValidationFailed('unexpected "sub" claim value',n,"sub","check_failed");if(c&&(u=n.aud,p="string"==typeof c?[c]:c,!("string"==typeof u?p.includes(u):Array.isArray(u)&&p.some(Set.prototype.has.bind(new Set(u))))))throw new JWTClaimValidationFailed('unexpected "aud" claim value',n,"aud","check_failed");var u,p;let h;switch(typeof r.clockTolerance){case"string":h=secs(r.clockTolerance);break;case"number":h=r.clockTolerance;break;case"undefined":h=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:f}=r,m=epoch(f||new Date);if((void 0!==n.iat||d)&&"number"!=typeof n.iat)throw new JWTClaimValidationFailed('"iat" claim must be a number',n,"iat","invalid");if(void 0!==n.nbf){if("number"!=typeof n.nbf)throw new JWTClaimValidationFailed('"nbf" claim must be a number',n,"nbf","invalid");if(n.nbf>m+h)throw new JWTClaimValidationFailed('"nbf" claim timestamp check failed',n,"nbf","check_failed")}if(void 0!==n.exp){if("number"!=typeof n.exp)throw new JWTClaimValidationFailed('"exp" claim must be a number',n,"exp","invalid");if(n.exp<=m-h)throw new JWTExpired('"exp" claim timestamp check failed',n,"exp","check_failed")}if(d){const e=m-n.iat;if(e-h>("number"==typeof d?d:secs(d)))throw new JWTExpired('"iat" claim timestamp check failed (too far in the past)',n,"iat","check_failed");if(e<0-h)throw new JWTClaimValidationFailed('"iat" claim timestamp check failed (it should be in the past)',n,"iat","check_failed")}return n};async function jwtVerify(e,t,r){const n=await async function(e,t,r){if(e instanceof Uint8Array&&(e=ti.decode(e)),"string"!=typeof e)throw new JWSInvalid("Compact JWS must be a string or Uint8Array");const{0:n,1:i,2:s,length:o}=e.split(".");if(3!==o)throw new JWSInvalid("Invalid Compact JWS");const a=await flattenedVerify({payload:i,protected:n,signature:s},t,r),c={payload:a.payload,protectedHeader:a.protectedHeader};return"function"==typeof t?{...c,key:a.key}:c}(e,t,r);if(n.protectedHeader.crit?.includes("b64")&&!1===n.protectedHeader.b64)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");const i={payload:jwtPayload(n.protectedHeader,n.payload,r),protectedHeader:n.protectedHeader};return"function"==typeof t?{...i,key:n.key}:i}class FlattenedSign{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){if(!this._protectedHeader&&!this._unprotectedHeader)throw new JWSInvalid("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!isDisjoint(this._protectedHeader,this._unprotectedHeader))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader};let n=!0;if(validateCrit(JWSInvalid,new Map([["b64",!0]]),t?.crit,this._protectedHeader,r).has("b64")&&(n=this._protectedHeader.b64,"boolean"!=typeof n))throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:i}=r;if("string"!=typeof i||!i)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');si(i,e,"sign");let s,o=this._payload;n&&(o=ei.encode(encode(o))),s=this._protectedHeader?ei.encode(encode(JSON.stringify(this._protectedHeader))):ei.encode("");const a=concat(s,ei.encode("."),o),c=await(async(e,t,r)=>{const n=await getCryptoKey(e,t,"sign");checkKeyLength(e,n);const i=await Xn.subtle.sign(subtleDsa(e,n.algorithm),n,r);return new Uint8Array(i)})(i,e,a),d={signature:encode(c),payload:""};return n&&(d.payload=ti.decode(o)),this._unprotectedHeader&&(d.header=this._unprotectedHeader),this._protectedHeader&&(d.protected=ti.decode(s)),d}}class CompactSign{constructor(e){this._flattened=new FlattenedSign(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){const r=await this._flattened.sign(e,t);if(void 0===r.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}function validateInput(e,t){if(!Number.isFinite(t))throw new TypeError(`Invalid ${e} input`);return t}class ProduceJWT{constructor(e={}){if(!isObject$1(e))throw new TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return"number"==typeof e?this._payload={...this._payload,nbf:validateInput("setNotBefore",e)}:e instanceof Date?this._payload={...this._payload,nbf:validateInput("setNotBefore",epoch(e))}:this._payload={...this._payload,nbf:epoch(new Date)+secs(e)},this}setExpirationTime(e){return"number"==typeof e?this._payload={...this._payload,exp:validateInput("setExpirationTime",e)}:e instanceof Date?this._payload={...this._payload,exp:validateInput("setExpirationTime",epoch(e))}:this._payload={...this._payload,exp:epoch(new Date)+secs(e)},this}setIssuedAt(e){return void 0===e?this._payload={...this._payload,iat:epoch(new Date)}:e instanceof Date?this._payload={...this._payload,iat:validateInput("setIssuedAt",epoch(e))}:this._payload="string"==typeof e?{...this._payload,iat:validateInput("setIssuedAt",epoch(new Date)+secs(e))}:{...this._payload,iat:validateInput("setIssuedAt",e)},this}}class SignJWT extends ProduceJWT{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){const r=new CompactSign(ei.encode(JSON.stringify(this._payload)));if(r.setProtectedHeader(this._protectedHeader),Array.isArray(this._protectedHeader?.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}function isJWKLike(e){return isObject$1(e)}function clone(e){return"function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))}class LocalJWKSet{constructor(e){if(this._cached=new WeakMap,!function(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(isJWKLike)}(e))throw new JWKSInvalid("JSON Web Key Set malformed");this._jwks=clone(e)}async getKey(e,t){const{alg:r,kid:n}={...e,...t?.header},i=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new JOSENotSupported('Unsupported "alg" value for a JSON Web Key Set')}}(r),s=this._jwks.keys.filter(e=>{let t=i===e.kty;if(t&&"string"==typeof n&&(t=n===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES256K":t="secp256k1"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv;break;case"Ed25519":t="Ed25519"===e.crv;break;case"EdDSA":t="Ed25519"===e.crv||"Ed448"===e.crv}return t}),{0:o,length:a}=s;if(0===a)throw new JWKSNoMatchingKey;if(1!==a){const e=new JWKSMultipleMatchingKeys,{_cached:t}=this;throw e[Symbol.asyncIterator]=async function*(){for(const e of s)try{yield await importWithAlgCache(t,e,r)}catch{}},e}return importWithAlgCache(this._cached,o,r)}}async function importWithAlgCache(e,t,r){const n=e.get(t)||e.set(t,{}).get(t);if(void 0===n[r]){const e=await importJWK({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new JWKSInvalid("JSON Web Key Set members must be public keys");n[r]=e}return n[r]}function createLocalJWKSet(e){const t=new LocalJWKSet(e),localJWKSet=async(e,r)=>t.getKey(e,r);return Object.defineProperties(localJWKSet,{jwks:{value:()=>clone(t._jwks),enumerable:!0,configurable:!1,writable:!1}}),localJWKSet}let ci;if("undefined"==typeof navigator||!navigator.userAgent?.startsWith?.("Mozilla/5.0 ")){ci=`${"jose"}/${"v5.10.0"}`}const di=Symbol();class RemoteJWKSet{constructor(e,t){if(!(e instanceof URL))throw new TypeError("url must be an instance of URL");var r,n;this._url=new URL(e.href),this._options={agent:t?.agent,headers:t?.headers},this._timeoutDuration="number"==typeof t?.timeoutDuration?t?.timeoutDuration:5e3,this._cooldownDuration="number"==typeof t?.cooldownDuration?t?.cooldownDuration:3e4,this._cacheMaxAge="number"==typeof t?.cacheMaxAge?t?.cacheMaxAge:6e5,void 0!==t?.[di]&&(this._cache=t?.[di],r=t?.[di],n=this._cacheMaxAge,"object"==typeof r&&null!==r&&"uat"in r&&"number"==typeof r.uat&&!(Date.now()-r.uat>=n)&&"jwks"in r&&isObject$1(r.jwks)&&Array.isArray(r.jwks.keys)&&Array.prototype.every.call(r.jwks.keys,isObject$1)&&(this._jwksTimestamp=this._cache.uat,this._local=createLocalJWKSet(this._cache.jwks)))}coolingDown(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cooldownDuration}fresh(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cacheMaxAge}async getKey(e,t){this._local&&this.fresh()||await this.reload();try{return await this._local(e,t)}catch(r){if(r instanceof JWKSNoMatchingKey&&!1===this.coolingDown())return await this.reload(),this._local(e,t);throw r}}async reload(){this._pendingFetch&&("undefined"!=typeof WebSocketPair||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"undefined"!=typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this._pendingFetch=void 0);const e=new Headers(this._options.headers);ci&&!e.has("User-Agent")&&(e.set("User-Agent",ci),this._options.headers=Object.fromEntries(e.entries())),this._pendingFetch||(this._pendingFetch=(async(e,t,r)=>{let n,i,s=!1;"function"==typeof AbortController&&(n=new AbortController,i=setTimeout(()=>{s=!0,n.abort()},t));const o=await fetch(e.href,{signal:n?n.signal:void 0,redirect:"manual",headers:r.headers}).catch(e=>{if(s)throw new JWKSTimeout;throw e});if(void 0!==i&&clearTimeout(i),200!==o.status)throw new JOSEError("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await o.json()}catch{throw new JOSEError("Failed to parse the JSON Web Key Set HTTP response as JSON")}})(this._url,this._timeoutDuration,this._options).then(e=>{this._local=createLocalJWKSet(e),this._cache&&(this._cache.uat=Date.now(),this._cache.jwks=e),this._jwksTimestamp=Date.now(),this._pendingFetch=void 0}).catch(e=>{throw this._pendingFetch=void 0,e})),await this._pendingFetch}}const li=decode$1;function decodeJwt(e){if("string"!=typeof e)throw new JWTInvalid("JWTs must use Compact JWS serialization, JWT must be a string");const{1:t,length:r}=e.split(".");if(5===r)throw new JWTInvalid("Only JWTs using Compact JWS serialization can be decoded");if(3!==r)throw new JWTInvalid("Invalid JWT");if(!t)throw new JWTInvalid("JWTs must contain a payload");let n,i;try{n=li(t)}catch{throw new JWTInvalid("Failed to base64url decode the payload")}try{i=JSON.parse(ti.decode(n))}catch{throw new JWTInvalid("Failed to parse the decoded payload as JSON")}if(!isObject$1(i))throw new JWTInvalid("Invalid JWT Claims Set");return i}function anumber(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function abytes(e,...t){if(!((r=e)instanceof Uint8Array||ArrayBuffer.isView(r)&&"Uint8Array"===r.constructor.name))throw new Error("Uint8Array expected");var r;if(t.length>0&&!t.includes(e.length))throw new Error("Uint8Array expected of length "+t+", got length="+e.length)}function ahash(e){if("function"!=typeof e||"function"!=typeof e.create)throw new Error("Hash should be wrapped by utils.createHasher");anumber(e.outputLen),anumber(e.blockLen)}function aexists(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function u32(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function clean(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function createView(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function rotr(e,t){return e<<32-t|e>>>t}function rotl(e,t){return e<<t|e>>>32-t>>>0}function byteSwap(e){return e<<24&4278190080|e<<8&16711680|e>>>8&65280|e>>>24&255}const ui=(()=>68===new Uint8Array(new Uint32Array([287454020]).buffer)[0])()?e=>e:function(e){for(let t=0;t<e.length;t++)e[t]=byteSwap(e[t]);return e},pi=(()=>"function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex)(),hi=48,fi=57,mi=65,gi=70,yi=97,wi=102;function asciiToBase16(e){return e>=hi&&e<=fi?e-hi:e>=mi&&e<=gi?e-(mi-10):e>=yi&&e<=wi?e-(yi-10):void 0}const nextTick=async()=>{};async function asyncLoop(e,t,r){let n=Date.now();for(let i=0;i<e;i++){r(i);const e=Date.now()-n;e>=0&&e<t||(await nextTick(),n+=e)}}function utf8ToBytes(e){if("string"!=typeof e)throw new Error("string expected");return new Uint8Array((new TextEncoder).encode(e))}function toBytes(e){return"string"==typeof e&&(e=utf8ToBytes(e)),abytes(e),e}function kdfInputToBytes(e){return"string"==typeof e&&(e=utf8ToBytes(e)),abytes(e),e}function checkOpts(e,t){if(void 0!==t&&"[object Object]"!=={}.toString.call(t))throw new Error("options should be object or undefined");return Object.assign(e,t)}class Hash{}function createHasher(e){const hashC=t=>e().update(toBytes(t)).digest(),t=e();return hashC.outputLen=t.outputLen,hashC.blockLen=t.blockLen,hashC.create=()=>e(),hashC}class HMAC extends Hash{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,ahash(e);const r=toBytes(t);if(this.iHash=e.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,i=new Uint8Array(n);i.set(r.length>n?e.create().update(r).digest():r);for(let e=0;e<i.length;e++)i[e]^=54;this.iHash.update(i),this.oHash=e.create();for(let e=0;e<i.length;e++)i[e]^=106;this.oHash.update(i),clean(i)}update(e){return aexists(this),this.iHash.update(e),this}digestInto(e){aexists(this),abytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:r,finished:n,destroyed:i,blockLen:s,outputLen:o}=this;return e.finished=n,e.destroyed=i,e.blockLen=s,e.outputLen=o,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const hmac$1=(e,t,r)=>new HMAC(e,t).update(r).digest();function pbkdf2(e,t,r,n){const{c:i,dkLen:s,DK:o,PRF:a,PRFSalt:c}=function(e,t,r,n){ahash(e);const i=checkOpts({dkLen:32,asyncTick:10},n),{c:s,dkLen:o,asyncTick:a}=i;if(anumber(s),anumber(o),anumber(a),s<1)throw new Error("iterations (c) should be >= 1");const c=kdfInputToBytes(t),d=kdfInputToBytes(r),l=new Uint8Array(o),u=hmac$1.create(e,c),p=u._cloneInto().update(d);return{c:s,dkLen:o,asyncTick:a,DK:l,PRF:u,PRFSalt:p}}(e,t,r,n);let d;const l=new Uint8Array(4),u=createView(l),p=new Uint8Array(a.outputLen);for(let e=1,t=0;t<s;e++,t+=a.outputLen){const r=o.subarray(t,t+a.outputLen);u.setInt32(0,e,!1),(d=c._cloneInto(d)).update(l).digestInto(p),r.set(p.subarray(0,r.length));for(let e=1;e<i;e++){a._cloneInto(d).update(p).digestInto(p);for(let e=0;e<r.length;e++)r[e]^=p[e]}}return function(e,t,r,n,i){return e.destroy(),t.destroy(),n&&n.destroy(),clean(i),r}(a,c,o,d,p)}function Chi(e,t,r){return e&t^~e&r}function Maj(e,t,r){return e&t^e&r^t&r}hmac$1.create=(e,t)=>new HMAC(e,t);class HashMD extends Hash{constructor(e,t,r,n){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=n,this.buffer=new Uint8Array(e),this.view=createView(this.buffer)}update(e){aexists(this),abytes(e=toBytes(e));const{view:t,buffer:r,blockLen:n}=this,i=e.length;for(let s=0;s<i;){const o=Math.min(n-this.pos,i-s);if(o===n){const t=createView(e);for(;n<=i-s;s+=n)this.process(t,s);continue}r.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===n&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){aexists(this),function(e,t){abytes(e);const r=t.outputLen;if(e.length<r)throw new Error("digestInto() expects output buffer of length at least "+r)}(e,this),this.finished=!0;const{buffer:t,view:r,blockLen:n,isLE:i}=this;let{pos:s}=this;t[s++]=128,clean(this.buffer.subarray(s)),this.padOffset>n-s&&(this.process(r,0),s=0);for(let e=s;e<n;e++)t[e]=0;!function(e,t,r,n){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,r,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(r>>i&s),a=Number(r&s),c=n?4:0,d=n?0:4;e.setUint32(t+c,o,n),e.setUint32(t+d,a,n)}(r,n-8,BigInt(8*this.length),i),this.process(r,0);const o=createView(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const c=a/4,d=this.get();if(c>d.length)throw new Error("_sha2: outputLen bigger than state");for(let e=0;e<c;e++)o.setUint32(4*e,d[e],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:r,length:n,finished:i,destroyed:s,pos:o}=this;return e.destroyed=s,e.finished=i,e.length=n,e.pos=o,n%t&&e.buffer.set(r),e}clone(){return this._cloneInto()}}const bi=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),vi=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ni=new Uint32Array(64);class SHA256 extends HashMD{constructor(e=32){super(64,e,8,!1),this.A=0|bi[0],this.B=0|bi[1],this.C=0|bi[2],this.D=0|bi[3],this.E=0|bi[4],this.F=0|bi[5],this.G=0|bi[6],this.H=0|bi[7]}get(){const{A:e,B:t,C:r,D:n,E:i,F:s,G:o,H:a}=this;return[e,t,r,n,i,s,o,a]}set(e,t,r,n,i,s,o,a){this.A=0|e,this.B=0|t,this.C=0|r,this.D=0|n,this.E=0|i,this.F=0|s,this.G=0|o,this.H=0|a}process(e,t){for(let r=0;r<16;r++,t+=4)Ni[r]=e.getUint32(t,!1);for(let e=16;e<64;e++){const t=Ni[e-15],r=Ni[e-2],n=rotr(t,7)^rotr(t,18)^t>>>3,i=rotr(r,17)^rotr(r,19)^r>>>10;Ni[e]=i+Ni[e-7]+n+Ni[e-16]|0}let{A:r,B:n,C:i,D:s,E:o,F:a,G:c,H:d}=this;for(let e=0;e<64;e++){const t=d+(rotr(o,6)^rotr(o,11)^rotr(o,25))+Chi(o,a,c)+vi[e]+Ni[e]|0,l=(rotr(r,2)^rotr(r,13)^rotr(r,22))+Maj(r,n,i)|0;d=c,c=a,a=o,o=s+t|0,s=i,i=n,n=r,r=t+l|0}r=r+this.A|0,n=n+this.B|0,i=i+this.C|0,s=s+this.D|0,o=o+this.E|0,a=a+this.F|0,c=c+this.G|0,d=d+this.H|0,this.set(r,n,i,s,o,a,c,d)}roundClean(){clean(Ni)}destroy(){this.set(0,0,0,0,0,0,0,0),clean(this.buffer)}}const Ti=createHasher(()=>new SHA256);function XorAndSalsa(e,t,r,n,i,s){let o=e[t++]^r[n++],a=e[t++]^r[n++],c=e[t++]^r[n++],d=e[t++]^r[n++],l=e[t++]^r[n++],u=e[t++]^r[n++],p=e[t++]^r[n++],h=e[t++]^r[n++],f=e[t++]^r[n++],m=e[t++]^r[n++],g=e[t++]^r[n++],y=e[t++]^r[n++],w=e[t++]^r[n++],b=e[t++]^r[n++],v=e[t++]^r[n++],N=e[t++]^r[n++],T=o,k=a,x=c,S=d,A=l,I=u,E=p,O=h,P=f,R=m,$=g,B=y,U=w,L=b,z=v,D=N;for(let e=0;e<8;e+=2)A^=rotl(T+U|0,7),P^=rotl(A+T|0,9),U^=rotl(P+A|0,13),T^=rotl(U+P|0,18),R^=rotl(I+k|0,7),L^=rotl(R+I|0,9),k^=rotl(L+R|0,13),I^=rotl(k+L|0,18),z^=rotl($+E|0,7),x^=rotl(z+$|0,9),E^=rotl(x+z|0,13),$^=rotl(E+x|0,18),S^=rotl(D+B|0,7),O^=rotl(S+D|0,9),B^=rotl(O+S|0,13),D^=rotl(B+O|0,18),k^=rotl(T+S|0,7),x^=rotl(k+T|0,9),S^=rotl(x+k|0,13),T^=rotl(S+x|0,18),E^=rotl(I+A|0,7),O^=rotl(E+I|0,9),A^=rotl(O+E|0,13),I^=rotl(A+O|0,18),B^=rotl($+R|0,7),P^=rotl(B+$|0,9),R^=rotl(P+B|0,13),$^=rotl(R+P|0,18),U^=rotl(D+z|0,7),L^=rotl(U+D|0,9),z^=rotl(L+U|0,13),D^=rotl(z+L|0,18);i[s++]=o+T|0,i[s++]=a+k|0,i[s++]=c+x|0,i[s++]=d+S|0,i[s++]=l+A|0,i[s++]=u+I|0,i[s++]=p+E|0,i[s++]=h+O|0,i[s++]=f+P|0,i[s++]=m+R|0,i[s++]=g+$|0,i[s++]=y+B|0,i[s++]=w+U|0,i[s++]=b+L|0,i[s++]=v+z|0,i[s++]=N+D|0}function BlockMix(e,t,r,n,i){let s=n+0,o=n+16*i;for(let n=0;n<16;n++)r[o+n]=e[t+16*(2*i-1)+n];for(let n=0;n<i;n++,s+=16,t+=16)XorAndSalsa(r,o,e,t,r,s),n>0&&(o+=16),XorAndSalsa(r,s,e,t+=16,r,o)}async function scryptAsync(e,t,r){const{N:n,r:i,p:s,dkLen:o,blockSize32:a,V:c,B32:d,B:l,tmp:u,blockMixCb:p,asyncTick:h}=function(e,t,r){const n=checkOpts({dkLen:32,asyncTick:10,maxmem:1073742848},r),{N:i,r:s,p:o,dkLen:a,asyncTick:c,maxmem:d,onProgress:l}=n;if(anumber(i),anumber(s),anumber(o),anumber(a),anumber(c),anumber(d),void 0!==l&&"function"!=typeof l)throw new Error("progressCb should be function");const u=128*s,p=u/4,h=Math.pow(2,32);if(i<=1||i&i-1||i>h)throw new Error("Scrypt: N must be larger than 1, a power of 2, and less than 2^32");if(o<0||o>32*(h-1)/u)throw new Error("Scrypt: p must be a positive integer less than or equal to ((2^32 - 1) * 32) / (128 * r)");if(a<0||a>32*(h-1))throw new Error("Scrypt: dkLen should be positive integer less than or equal to (2^32 - 1) * 32");if(u*(i+o)>d)throw new Error("Scrypt: memused is bigger than maxMem. Expected 128 * r * (N + p) > maxmem of "+d);const f=pbkdf2(Ti,e,t,{c:1,dkLen:u*o}),m=u32(f),g=u32(new Uint8Array(u*i)),y=u32(new Uint8Array(u));let blockMixCb=()=>{};if(l){const e=2*i*o,t=Math.max(Math.floor(e/1e4),1);let r=0;blockMixCb=()=>{r++,!l||r%t&&r!==e||l(r/e)}}return{N:i,r:s,p:o,dkLen:a,blockSize32:p,V:g,B32:m,B:f,tmp:y,blockMixCb:blockMixCb,asyncTick:c}}(e,t,r);ui(d);for(let e=0;e<s;e++){const t=a*e;for(let e=0;e<a;e++)c[e]=d[t+e];let r=0;await asyncLoop(n-1,h,()=>{BlockMix(c,r,c,r+=a,i),p()}),BlockMix(c,(n-1)*a,d,t,i),p(),await asyncLoop(n,h,()=>{const e=d[t+a-16]%n;for(let r=0;r<a;r++)u[r]=d[t+r]^c[e*a+r];BlockMix(u,0,d,t,i),p()})}return ui(d),function(e,t,r,n,i){const s=pbkdf2(Ti,e,r,{c:1,dkLen:t});return clean(r,n,i),s}(e,o,l,c,u)}const hex_encode=e=>{if("string"==typeof e&&(e=(new TextEncoder).encode(e)),0===e.byteLength)return"";const t=new Uint8Array(e);let r="";for(const e of t)r+=e.toString(16).padStart(2,"0");return r},hex_decode=e=>{if(!e)return"";if("string"==typeof e){if(e.length%2!=0)throw new Error("Invalid hexadecimal string");if(!new RegExp("^[0123456789abcdef]+$").test(e))throw new Error("Invalid hexadecimal string");const t=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)t[r/2]=parseInt(e.slice(r,r+2),16);return(new TextDecoder).decode(t)}return(new TextDecoder).decode(e)};function expandAlphabet(e){switch(e){case"a-z":return"abcdefghijklmnopqrstuvwxyz";case"A-Z":return"ABCDEFGHIJKLMNOPQRSTUVWXYZ";case"0-9":return"0123456789";case"-_":return"-_";default:throw new Error(`Unsupported alphabet: ${e}`)}}function createRandomStringGenerator(...e){const r=e.map(expandAlphabet).join("");if(0===r.length)throw new Error("No valid characters provided for random string generation.");const n=r.length;return(e,...i)=>{if(e<=0)throw new Error("Length must be a positive integer.");let s=r,o=n;i.length>0&&(s=i.map(expandAlphabet).join(""),o=s.length);const a=Math.floor(256/o)*o,c=new Uint8Array(2*e),d=c.length;let l,u="",p=d;for(;u.length<e;)p>=d&&(t(c),p=0),l=c[p++],l<a&&(u+=s[l%o]);return u}}const ki=createRandomStringGenerator("a-z","0-9","A-Z","-_");const xi=16384,Si=16,_i=1,Ai=64;async function generateKey(e,t){return await scryptAsync(e.normalize("NFKC"),t,{N:xi,p:_i,r:Si,dkLen:Ai,maxmem:128*xi*Si*2})}const hashPassword=async e=>{const r=hex_encode(t(new Uint8Array(16))),n=await generateKey(e,r);return`${r}:${hex_encode(n)}`},verifyPassword=async({hash:e,password:t})=>{const[r,n]=e.split(":");return function(e,t){const r=new Uint8Array(e),n=new Uint8Array(t);if(r.length!==n.length)return!1;let i=0;for(let e=0;e<r.length;e++)i|=r[e]^n[e];return 0===i}(await generateKey(t,r),function(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);if(pi)return Uint8Array.fromHex(e);const t=e.length,r=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(r);for(let t=0,i=0;t<r;t++,i+=2){const r=asciiToBase16(e.charCodeAt(i)),s=asciiToBase16(e.charCodeAt(i+1));if(void 0===r||void 0===s){const t=e[i]+e[i+1];throw new Error('hex string expected, got non-hex character "'+t+'" at index '+i)}n[t]=16*r+s}return n}(n))},symmetricEncrypt=async({key:e,data:t})=>{const r=await createHash("SHA-256").digest(e),n=utf8ToBytes$1(t);return function(e){bytes(e);let t="";for(let r=0;r<e.length;r++)t+=Rn[e[r]];return t}(managedNonce(Zn)(new Uint8Array(r)).encrypt(n))},symmetricDecrypt=async({key:e,data:t})=>{const r=await createHash("SHA-256").digest(e),n=function(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);const t=e.length,r=t/2;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(r);for(let t=0,i=0;t<r;t++,i+=2){const r=asciiToBase16$1(e.charCodeAt(i)),s=asciiToBase16$1(e.charCodeAt(i+1));if(void 0===r||void 0===s){const t=e[i]+e[i+1];throw new Error('hex string expected, got non-hex character "'+t+'" at index '+i)}n[t]=16*r+s}return n}(t),i=managedNonce(Zn)(new Uint8Array(r));return(new TextDecoder).decode(i.decrypt(n))};var Ii=Object.defineProperty,Ei=Object.defineProperties,Ci=Object.getOwnPropertyDescriptors,Oi=Object.getOwnPropertySymbols,Pi=Object.prototype.hasOwnProperty,Ri=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,r)=>t in e?Ii(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,__spreadValues=(e,t)=>{for(var r in t||(t={}))Pi.call(t,r)&&__defNormalProp(e,r,t[r]);if(Oi)for(var r of Oi(t))Ri.call(t,r)&&__defNormalProp(e,r,t[r]);return e},__spreadProps=(e,t)=>Ei(e,Ci(t)),$i=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r}},Bi=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},Ui=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}};var Li=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function isJSONSerializable(e){if(void 0===e)return!1;const t=typeof e;return"string"===t||"number"===t||"boolean"===t||null===t||"object"===t&&(!!Array.isArray(e)||!e.buffer&&(e.constructor&&"Object"===e.constructor.name||"function"==typeof e.toJSON))}function jsonParse(e){try{return JSON.parse(e)}catch(t){return e}}async function getHeaders(e){const t=new Headers(null==e?void 0:e.headers),r=await(async e=>{const t={},getValue=async e=>"function"==typeof e?await e():e;if(null==e?void 0:e.auth)if("Bearer"===e.auth.type){const r=await getValue(e.auth.token);if(!r)return t;t.authorization=`Bearer ${r}`}else if("Basic"===e.auth.type){const r=getValue(e.auth.username),n=getValue(e.auth.password);if(!r||!n)return t;t.authorization=`Basic ${btoa(`${r}:${n}`)}`}else if("Custom"===e.auth.type){const r=getValue(e.auth.value);if(!r)return t;t.authorization=`${getValue(e.auth.prefix)} ${r}`}return t})(e);for(const[e,n]of Object.entries(r||{}))t.set(e,n);if(!t.has("content-type")){const r=function(e){if(isJSONSerializable(e))return"application/json";return null}(null==e?void 0:e.body);r&&t.set("content-type",r)}return t}var zi=class _ValidationError extends Error{constructor(e,t){super(t||JSON.stringify(e,null,2)),this.issues=e,Object.setPrototypeOf(this,_ValidationError.prototype)}};var Di=["get","post","put","patch","delete"];var betterFetch=async(e,t)=>{var r,n,i,s,o,a,c,d;const{hooks:l,url:u,options:p}=await(async(e,t)=>{var r,n,i,s,o,a;let c=t||{};const d={onRequest:[null==t?void 0:t.onRequest],onResponse:[null==t?void 0:t.onResponse],onSuccess:[null==t?void 0:t.onSuccess],onError:[null==t?void 0:t.onError],onRetry:[null==t?void 0:t.onRetry]};if(!t||!(null==t?void 0:t.plugins))return{url:e,options:c,hooks:d};for(const l of(null==t?void 0:t.plugins)||[]){if(l.init){const n=await(null==(r=l.init)?void 0:r.call(l,e.toString(),t));c=n.options||c,e=n.url}d.onRequest.push(null==(n=l.hooks)?void 0:n.onRequest),d.onResponse.push(null==(i=l.hooks)?void 0:i.onResponse),d.onSuccess.push(null==(s=l.hooks)?void 0:s.onSuccess),d.onError.push(null==(o=l.hooks)?void 0:o.onError),d.onRetry.push(null==(a=l.hooks)?void 0:a.onRetry)}return{url:e,options:c,hooks:d}})(e,t),h=function(e){if(null==e?void 0:e.customFetchImpl)return e.customFetchImpl;if("undefined"!=typeof globalThis&&"function"==typeof globalThis.fetch)return globalThis.fetch;throw new Error("No fetch implementation found")}(p),f=new AbortController,m=null!=(r=p.signal)?r:f.signal,g=function(e,t){let{baseURL:r,params:n,query:i}=t||{query:{},params:{},baseURL:""},s=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r||"";if(e.startsWith("@")){const t=e.toString().split("@")[1].split("/")[0];Di.includes(t)&&(e=e.replace(`@${t}/`,"/"))}s.endsWith("/")||(s+="/");let[o,a]=e.replace(s,"").split("?");const c=new URLSearchParams(a);for(const[e,t]of Object.entries(i||{}))null!=t&&c.set(e,String(t));if(n)if(Array.isArray(n)){const e=o.split("/").filter(e=>e.startsWith(":"));for(const[t,r]of e.entries()){const e=n[t];o=o.replace(r,e)}}else for(const[e,t]of Object.entries(n))o=o.replace(`:${e}`,String(t));o=o.split("/").map(encodeURIComponent).join("/"),o.startsWith("/")&&(o=o.slice(1));let d=c.toString();return d=d.length>0?`?${d}`.replace(/\+/g,"%20"):"",s.startsWith("http")?new URL(`${o}${d}`,s):`${s}${o}${d}`}(u,p),y=function(e){if(!(null==e?void 0:e.body))return null;const t=new Headers(null==e?void 0:e.headers);if(isJSONSerializable(e.body)&&!t.has("content-type")){for(const[t,r]of Object.entries(null==e?void 0:e.body))r instanceof Date&&(e.body[t]=r.toISOString());return JSON.stringify(e.body)}return e.body}(p),w=await getHeaders(p),b=function(e,t){var r;if(null==t?void 0:t.method)return t.method.toUpperCase();if(e.startsWith("@")){const n=null==(r=e.split("@")[1])?void 0:r.split("/")[0];return Di.includes(n)?n.toUpperCase():(null==t?void 0:t.body)?"POST":"GET"}return(null==t?void 0:t.body)?"POST":"GET"}(u,p);let v=__spreadProps(__spreadValues({},p),{url:g,headers:w,body:y,method:b,signal:m});for(const e of l.onRequest)if(e){const t=await e(v);t instanceof Object&&(v=t)}("pipeTo"in v&&"function"==typeof v.pipeTo||"function"==typeof(null==(n=null==t?void 0:t.body)?void 0:n.pipe))&&("duplex"in v||(v.duplex="half"));const{clearTimeout:N}=function(e,t){let r;return!(null==e?void 0:e.signal)&&(null==e?void 0:e.timeout)&&(r=setTimeout(()=>null==t?void 0:t.abort(),null==e?void 0:e.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}(p,f);let T=await h(v.url,v);N();const k={response:T,request:v};for(const e of l.onResponse)if(e){const r=await e(__spreadProps(__spreadValues({},k),{response:(null==(i=null==t?void 0:t.hookOptions)?void 0:i.cloneResponse)?T.clone():T}));r instanceof Response?T=r:r instanceof Object&&(T=r.response)}if(T.ok){if(!("HEAD"!==v.method))return{data:"",error:null};const e=function(e){const t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";const n=t.split(";").shift()||"";return Li.test(n)?"json":r.has(n)||n.startsWith("text/")?"text":"blob"}(T),r={data:"",response:T,request:v};if("json"===e||"text"===e){const e=await T.text(),t=null!=(s=v.jsonParser)?s:jsonParse,n=await t(e);r.data=n}else r.data=await T[e]();(null==v?void 0:v.output)&&v.output&&!v.disableValidation&&(r.data=await async function(e,t){let r=await e["~standard"].validate(t);if(r.issues)throw new zi(r.issues);return r.value}(v.output,r.data));for(const e of l.onSuccess)e&&await e(__spreadProps(__spreadValues({},r),{response:(null==(o=null==t?void 0:t.hookOptions)?void 0:o.cloneResponse)?T.clone():T}));return(null==t?void 0:t.throw)?r.data:{data:r.data,error:null}}const x=null!=(a=null==t?void 0:t.jsonParser)?a:jsonParse,S=await T.text(),A=function(e){try{return JSON.parse(e),!0}catch(e){return!1}}(S),I=A?await x(S):null,E={response:T,responseText:S,request:v,error:__spreadProps(__spreadValues({},I),{status:T.status,statusText:T.statusText})};for(const e of l.onError)e&&await e(__spreadProps(__spreadValues({},E),{response:(null==(c=null==t?void 0:t.hookOptions)?void 0:c.cloneResponse)?T.clone():T}));if(null==t?void 0:t.retry){const r=function(e){if("number"==typeof e)return new Bi({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new Bi(e);case"exponential":return new Ui(e);default:throw new Error("Invalid retry strategy")}}(t.retry),n=null!=(d=t.retryAttempt)?d:0;if(await r.shouldAttemptRetry(n,T)){for(const e of l.onRetry)e&&await e(k);const i=r.getDelay(n);return await new Promise(e=>setTimeout(e,i)),await betterFetch(e,__spreadProps(__spreadValues({},t),{retryAttempt:n+1}))}}if(null==t?void 0:t.throw)throw new $i(T.status,T.statusText,A?I:S);return{data:null,error:__spreadProps(__spreadValues({},I),{status:T.status,statusText:T.statusText})}};const qi=Object.create(null),_getEnv=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?qi:globalThis),Wi=new Proxy(qi,{get:(e,t)=>_getEnv()[t]??qi[t],has:(e,t)=>t in _getEnv()||t in qi,set:(e,t,r)=>(_getEnv(!0)[t]=r,!0),deleteProperty(e,t){if(!t)return!1;return delete _getEnv(!0)[t],!0},ownKeys(){const e=_getEnv(!0);return Object.keys(e)}});const ji=void 0!==r&&r.env?"production":"",Mi="production"===ji,Qi="dev"===ji||"development"===ji,Vi="test"===ji||!!(Fi=Wi.TEST)&&"false"!==Fi;var Fi;class BetterAuthError extends Error{constructor(e,t){super(e),this.name="BetterAuthError",this.message=e,this.cause=t,this.stack=""}}function withPath(e,t="/api/auth"){const r=function(e){try{return"/"!==new URL(e).pathname}catch(t){throw new BetterAuthError(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}(e);return r?e:(t=t.startsWith("/")?t:`/${t}`,`${e.replace(/\/+$/,"")}${t}`)}function getBaseURL(e,t,r){if(e)return withPath(e,t);const n=Wi.BETTER_AUTH_URL||Wi.NEXT_PUBLIC_BETTER_AUTH_URL||Wi.PUBLIC_BETTER_AUTH_URL||Wi.NUXT_PUBLIC_BETTER_AUTH_URL||Wi.NUXT_PUBLIC_AUTH_URL||("/"!==Wi.BASE_URL?Wi.BASE_URL:void 0);if(n)return withPath(n,t);const i=r?.headers.get("x-forwarded-host"),s=r?.headers.get("x-forwarded-proto");if(i&&s)return withPath(`${s}://${i}`,t);if(r){const e=getOrigin(r.url);if(!e)throw new BetterAuthError("Could not get origin from request. Please provide a valid base URL.");return withPath(e,t)}}function getOrigin(e){try{return new URL(e).origin}catch(e){return null}}function getProtocol(e){try{return new URL(e).protocol}catch(e){return null}}function getHost(e){try{return new URL(e).host}catch(t){return e}}const createHMAC=(t="SHA-256",r="none")=>{const n={importKey:async(r,n)=>e.importKey("raw","string"==typeof r?(new TextEncoder).encode(r):r,{name:"HMAC",hash:{name:t}},!1,[n]),sign:async(t,i)=>{"string"==typeof t&&(t=await n.importKey(t,"sign"));const s=await e.sign("HMAC",t,"string"==typeof i?(new TextEncoder).encode(i):i);return"hex"===r?hex_encode(s):"base64"===r||"base64url"===r||"base64urlnopad"===r?Pn.encode(s,{padding:"base64urlnopad"!==r}):s},verify:async(t,i,s)=>("string"==typeof t&&(t=await n.importKey(t,"verify")),"hex"===r&&(s=hex_decode(s)),"base64"!==r&&"base64url"!==r&&"base64urlnopad"!==r||(s=await On.decode(s)),e.verify("HMAC",t,"string"==typeof s?(new TextEncoder).encode(s):s,"string"==typeof i?(new TextEncoder).encode(i):i))};return n};function safeJSONParse(e){try{return JSON.parse(e,function(e,t){if("string"==typeof t&&/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(t)){const e=new Date(t);if(!isNaN(e.getTime()))return e}return t})}catch{return null}}const Ji=new Map,Ki=new TextEncoder,binary_decode=(e,t="utf-8")=>{Ji.has(t)||Ji.set(t,new TextDecoder(t));return Ji.get(t).decode(e)},Hi=(Ki.encode,(e,t)=>{const r={t:`${e}${t}`,value:e,tFormat:t,toMilliseconds:()=>{switch(t){case"ms":return e;case"s":return 1e3*e;case"m":return 1e3*e*60;case"h":return 1e3*e*60*60;case"d":return 1e3*e*60*60*24;case"w":return 1e3*e*60*60*24*7;case"y":return 1e3*e*60*60*24*365}},toSeconds:()=>r.toMilliseconds()/1e3,toMinutes:()=>r.toSeconds()/60,toHours:()=>r.toMinutes()/60,toDays:()=>r.toHours()/24,toWeeks:()=>r.toDays()/7,toYears:()=>r.toDays()/365,getDate:()=>new Date(Date.now()+r.toMilliseconds()),add:e=>{const t="string"==typeof e?parseTime(e).toMilliseconds():e.toMilliseconds();return Hi(r.toMilliseconds()+t,"ms")},subtract:e=>{const t="string"==typeof e?parseTime(e).toMilliseconds():e.toMilliseconds();return Hi(r.toMilliseconds()-t,"ms")},multiply:e=>Hi(r.toMilliseconds()*e,"ms"),divide:e=>Hi(r.toMilliseconds()/e,"ms"),equals:e=>{const t="string"==typeof e?parseTime(e).toMilliseconds():e.toMilliseconds();return r.toMilliseconds()===t},lessThan:e=>{const t="string"==typeof e?parseTime(e).toMilliseconds():e.toMilliseconds();return r.toMilliseconds()<t},greaterThan:e=>{const t="string"==typeof e?parseTime(e).toMilliseconds():e.toMilliseconds();return r.toMilliseconds()>t},format:e=>{const t=r.getDate();return e.replace(/YYYY|MM|DD|HH|mm|ss/g,e=>{switch(e){case"YYYY":return t.getFullYear().toString();case"MM":return(t.getMonth()+1).toString().padStart(2,"0");case"DD":return t.getDate().toString().padStart(2,"0");case"HH":return t.getHours().toString().padStart(2,"0");case"mm":return t.getMinutes().toString().padStart(2,"0");case"ss":return t.getSeconds().toString().padStart(2,"0");default:return e}})},fromNow:()=>{const e=r.toMilliseconds();return e<0?r.ago():e<1e3?"in a few seconds":e<6e4?`in ${Math.round(e/1e3)} seconds`:e<36e5?`in ${Math.round(e/6e4)} minutes`:e<864e5?`in ${Math.round(e/36e5)} hours`:e<6048e5?`in ${Math.round(e/864e5)} days`:e<26298e5?`in ${Math.round(e/6048e5)} weeks`:e<315576e5?`in ${Math.round(e/26298e5)} months`:`in ${Math.round(e/315576e5)} years`},ago:()=>{const e=-r.toMilliseconds();return e<0?r.fromNow():e<1e3?"a few seconds ago":e<6e4?`${Math.round(e/1e3)} seconds ago`:e<36e5?`${Math.round(e/6e4)} minutes ago`:e<864e5?`${Math.round(e/36e5)} hours ago`:e<6048e5?`${Math.round(e/864e5)} days ago`:e<26298e5?`${Math.round(e/6048e5)} weeks ago`:e<315576e5?`${Math.round(e/26298e5)} months ago`:`${Math.round(e/315576e5)} years ago`}};return r}),parseTime=e=>{const t=e.match(/^(\d+)(ms|s|m|h|d|w|y)$/);if(!t)throw new Error("Invalid time format");return Hi(parseInt(t[1]),t[2])};function createCookieGetter(e){const t=(void 0!==e.advanced?.useSecureCookies?e.advanced?.useSecureCookies:void 0!==e.baseURL?!!e.baseURL.startsWith("https://"):Mi)?"__Secure-":"",r=!!e.advanced?.crossSubDomainCookies?.enabled,n=r?e.advanced?.crossSubDomainCookies?.domain||(e.baseURL?new URL(e.baseURL).hostname:void 0):void 0;if(r&&!n)throw new BetterAuthError("baseURL is required when crossSubdomainCookies are enabled");return function(i,s={}){const o=e.advanced?.cookiePrefix||"better-auth",a=e.advanced?.cookies?.[i]?.name||`${o}.${i}`,c=e.advanced?.cookies?.[i]?.attributes;return{name:`${t}${a}`,attributes:{secure:!!t,sameSite:"lax",path:"/",httpOnly:!0,...r?{domain:n}:{},...e.advanced?.defaultCookieAttributes,...s,...c}}}}async function setCookieCache(e,t){const r=e.context.options.session?.cookieCache?.enabled;if(r){const r={session:Object.entries(t.session).reduce((t,[r,n])=>{const i=e.context.options.session?.additionalFields?.[r];return i&&!1===i.returned||(t[r]=n),t},{}),user:t.user},n=Pn.encode(JSON.stringify({session:r,expiresAt:getDate(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime(),signature:await createHMAC("SHA-256","base64urlnopad").sign(e.context.secret,JSON.stringify({...r,expiresAt:getDate(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime()}))}),{padding:!1});if(n.length>4093)throw new BetterAuthError("Session data is too large to store in the cookie. Please disable session cookie caching or reduce the size of the session data");e.setCookie(e.context.authCookies.sessionData.name,n,e.context.authCookies.sessionData.options)}}async function setSessionCookie(e,t,r,n){const i=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);r=void 0!==r?r:!!i;const s=e.context.authCookies.sessionToken.options,o=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,t.session.token,e.context.secret,{...s,maxAge:o,...n}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),await setCookieCache(e,t),e.context.setNewSession(t),e.context.options.secondaryStorage&&await(e.context.secondaryStorage?.set(t.session.token,JSON.stringify({user:t.user,session:t.session}),Math.floor((new Date(t.session.expiresAt).getTime()-Date.now())/1e3)))}function deleteSessionCookie(e,t){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0}),e.setCookie(e.context.authCookies.sessionData.name,"",{...e.context.authCookies.sessionData.options,maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}const generateId=e=>createRandomStringGenerator("a-z","A-Z","0-9")(e||32),Zi=["info","success","warn","error","debug"];const Gi="[0m",Yi="[1m",Xi="[2m",es={red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m"},ts={info:es.blue,success:es.green,warn:es.yellow,error:es.red,debug:es.magenta},createLogger=e=>{const t=!0!==e?.disabled,r=e?.level??"error",LogFunc=(n,i,s=[])=>{if(!t||!function(e,t){return Zi.indexOf(t)<=Zi.indexOf(e)}(r,n))return;const o=((e,t)=>{const r=(new Date).toISOString();return`${Xi}${r}${Gi} ${ts[e]}${e.toUpperCase()}${Gi} ${Yi}[Better Auth]:${Gi} ${t}`})(n,i);e&&"function"==typeof e.log?e.log("success"===n?"info":n,i,...s):"error"===n?console.error(o,...s):"warn"===n?console.warn(o,...s):console.log(o,...s)};return Object.fromEntries(Zi.map(e=>[e,(...[t,...r])=>LogFunc(e,t,r)]))},rs=createLogger();function parseOutputData(e,t){const r=t.fields,n={};for(const t in e){const i=r[t];i?!1!==i.returned&&(n[t]=e[t]):n[t]=e[t]}return n}function getAllFields(e,t){let r={..."user"===t?e.user?.additionalFields:{},..."session"===t?e.session?.additionalFields:{}};for(const n of e.plugins||[])n.schema&&n.schema[t]&&(r={...r,...n.schema[t].fields});return r}function parseUserOutput(e,t){return parseOutputData(t,{fields:getAllFields(e,"user")})}function parseSessionOutput(e,t){return parseOutputData(t,{fields:getAllFields(e,"session")})}function parseUserInput(e,t,r){return function(e,t){const r=t.action||"create",n=t.fields,i={};for(const t in n)if(t in e){if(!1===n[t].input){if(n[t].defaultValue){i[t]=n[t].defaultValue;continue}continue}if(n[t].validator?.input&&void 0!==e[t]){i[t]=n[t].validator.input.parse(e[t]);continue}if(n[t].transform?.input&&void 0!==e[t]){i[t]=n[t].transform?.input(e[t]);continue}i[t]=e[t]}else if(n[t].defaultValue&&"create"===r)i[t]=n[t].defaultValue;else if(n[t].required&&"create"===r)throw new h("BAD_REQUEST",{message:`${t} is required`});return i}(t||{},{fields:getAllFields(e,"user"),action:r})}object({id:string$1(),providerId:string$1(),accountId:string$1(),userId:string(),accessToken:string$1().nullish(),refreshToken:string$1().nullish(),idToken:string$1().nullish(),accessTokenExpiresAt:date$1().nullish(),refreshTokenExpiresAt:date$1().nullish(),scope:string$1().nullish(),password:string$1().nullish(),createdAt:date$1().default(()=>new Date),updatedAt:date$1().default(()=>new Date)}),object({id:string$1(),email:string$1().transform(e=>e.toLowerCase()),emailVerified:boolean$2().default(!1),name:string$1(),image:string$1().nullish(),createdAt:date$1().default(()=>new Date),updatedAt:date$1().default(()=>new Date)}),object({id:string$1(),userId:string(),expiresAt:date$1(),createdAt:date$1().default(()=>new Date),updatedAt:date$1().default(()=>new Date),token:string$1(),ipAddress:string$1().nullish(),userAgent:string$1().nullish()}),object({id:string$1(),value:string$1(),createdAt:date$1().default(()=>new Date),updatedAt:date$1().default(()=>new Date),expiresAt:date$1(),identifier:string$1()});const ns=createMiddleware(async()=>({})),ss=createMiddleware.create({use:[ns,createMiddleware(async()=>({}))]}),os=createEndpoint2.create({use:[ns]});function escapeRegExpChar(e){return"-"===e||"^"===e||"$"===e||"+"===e||"."===e||"("===e||")"===e||"|"===e||"["===e||"]"===e||"{"===e||"}"===e||"*"===e||"?"===e||"\\"===e?`\\${e}`:e}function transform(e,t=!0){if(Array.isArray(e)){return`(?:${e.map(e=>`^${transform(e,t)}$`).join("|")})`}let r="",n="",i=".";!0===t?(r="/",n="[/\\\\]",i="[^/\\\\]"):t&&(r=t,n=function(e){let t="";for(let r=0;r<e.length;r++)t+=escapeRegExpChar(e[r]);return t}(r),n.length>1?(n=`(?:${n})`,i=`((?!${n}).)`):i=`[^${n}]`);let s=t?`${n}+?`:"",o=t?`${n}*?`:"",a=t?e.split(r):[e],c="";for(let e=0;e<a.length;e++){let r=a[e],n=a[e+1],d="";if(r||!(e>0))if(t&&(d=e===a.length-1?o:"**"!==n?s:""),t&&"**"===r)d&&(c+=0===e?"":d,c+=`(?:${i}*?${d})*?`);else{for(let e=0;e<r.length;e++){let t=r[e];"\\"===t?e<r.length-1&&(c+=escapeRegExpChar(r[e+1]),e++):c+="?"===t?i:"*"===t?`${i}*?`:escapeRegExpChar(t)}c+=d}}return c}function isMatch(e,t){if("string"!=typeof t)throw new TypeError(`Sample must be a string, but ${typeof t} given`);return e.test(t)}function wildcardMatch(e,t){if("string"!=typeof e&&!Array.isArray(e))throw new TypeError(`The first argument must be a single pattern string or an array of patterns, but ${typeof e} given`);if("string"!=typeof t&&"boolean"!=typeof t||(t={separator:t}),2===arguments.length&&void 0!==t&&("object"!=typeof t||null===t||Array.isArray(t)))throw new TypeError(`The second argument must be an options object or a string/boolean separator, but ${typeof t} given`);if("\\"===(t=t||{}).separator)throw new Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");let r=transform(e,t.separator),n=new RegExp(`^${r}$`,t.flags),i=isMatch.bind(null,n);return i.options=t,i.pattern=e,i.regexp=n,i}const as=ss(async e=>{if("POST"!==e.request?.method||!e.request)return;const{body:t,query:r,context:n}=e,i=e.headers?.get("origin")||e.headers?.get("referer")||"",s=t?.callbackURL||r?.callbackURL,o=t?.redirectTo,a=t?.errorCallbackURL,c=t?.newUserCallbackURL,d=Array.isArray(n.options.trustedOrigins)?n.trustedOrigins:[...n.trustedOrigins,...await(n.options.trustedOrigins?.(e.request))||[]],l=e.headers?.has("cookie"),validateURL=(t,r)=>{if(!t)return;const n=d.some(e=>((e,t)=>{if(e.startsWith("/"))return!1;if(t.includes("*"))return t.includes("://")?wildcardMatch(t)(getOrigin(e)||e):wildcardMatch(t)(getHost(e));const r=getProtocol(e);return"http:"!==r&&"https:"!==r&&r?e.startsWith(t):t===getOrigin(e)})(t,e)||t?.startsWith("/")&&"origin"!==r&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(t));if(!n)throw e.context.logger.error(`Invalid ${r}: ${t}`),e.context.logger.info(`If it's a valid URL, please add ${t} to trustedOrigins in your auth config\n`,`Current list of trustedOrigins: ${d}`),new h("FORBIDDEN",{message:`Invalid ${r}`})};l&&!e.context.options.advanced?.disableCSRFCheck&&validateURL(i,"origin"),s&&validateURL(s,"callbackURL"),o&&validateURL(o,"redirectURL"),a&&validateURL(a,"errorCallbackURL"),c&&validateURL(c,"newUserCallbackURL")}),originCheck=e=>ss(async t=>{if(!t.request)return;const{context:r}=t,n=e(t),i=Array.isArray(r.options.trustedOrigins)?r.trustedOrigins:[...r.trustedOrigins,...await(r.options.trustedOrigins?.(t.request))||[]],validateURL=(e,r)=>{if(!e)return;const n=i.some(t=>((e,t)=>{if(e.startsWith("/"))return!1;if(t.includes("*"))return t.includes("://")?wildcardMatch(t)(getOrigin(e)||e):wildcardMatch(t)(getHost(e));const r=getProtocol(e);return"http:"!==r&&"https:"!==r&&r?e.startsWith(t):t===getOrigin(e)})(e,t)||e?.startsWith("/")&&"origin"!==r&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(e));if(!n)throw t.context.logger.error(`Invalid ${r}: ${e}`),t.context.logger.info(`If it's a valid URL, please add ${e} to trustedOrigins in your auth config\n`,`Current list of trustedOrigins: ${i}`),new h("FORBIDDEN",{message:`Invalid ${r}`})},s=Array.isArray(n)?n:[n];for(const e of s)validateURL(e,"callbackURL")}),cs={USER_NOT_FOUND:"User not found",FAILED_TO_CREATE_USER:"Failed to create user",FAILED_TO_CREATE_SESSION:"Failed to create session",FAILED_TO_UPDATE_USER:"Failed to update user",FAILED_TO_GET_SESSION:"Failed to get session",INVALID_PASSWORD:"Invalid password",INVALID_EMAIL:"Invalid email",INVALID_EMAIL_OR_PASSWORD:"Invalid email or password",SOCIAL_ACCOUNT_ALREADY_LINKED:"Social account already linked",PROVIDER_NOT_FOUND:"Provider not found",INVALID_TOKEN:"invalid token",ID_TOKEN_NOT_SUPPORTED:"id_token not supported",FAILED_TO_GET_USER_INFO:"Failed to get user info",USER_EMAIL_NOT_FOUND:"User email not found",EMAIL_NOT_VERIFIED:"Email not verified",PASSWORD_TOO_SHORT:"Password too short",PASSWORD_TOO_LONG:"Password too long",USER_ALREADY_EXISTS:"User already exists",EMAIL_CAN_NOT_BE_UPDATED:"Email can not be updated",CREDENTIAL_ACCOUNT_NOT_FOUND:"Credential account not found",SESSION_EXPIRED:"Session expired. Re-authenticate to perform this action.",FAILED_TO_UNLINK_LAST_ACCOUNT:"You can't unlink your last account",ACCOUNT_NOT_FOUND:"Account not found",USER_ALREADY_HAS_PASSWORD:"User already has a password. Provide that to delete the account."},getSession=()=>os("/get-session",{method:"GET",query:optional(object({disableCookieCache:boolean$1().meta({description:"Disable cookie cache and fetch session from database"}).optional(),disableRefresh:boolean$1().meta({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()})),requireHeaders:!0,metadata:{openapi:{description:"Get the current session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}},required:["session","user"]}}}}}}}},async e=>{try{const t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)return null;const r=e.getCookie(e.context.authCookies.sessionData.name),n=r?safeJSONParse(binary_decode(On.decode(r))):null;if(n){if(!await createHMAC("SHA-256","base64urlnopad").verify(e.context.secret,JSON.stringify({...n.session,expiresAt:n.expiresAt}),n.signature)){const t=e.context.authCookies.sessionData.name;return e.setCookie(t,"",{maxAge:0}),e.json(null)}}const i=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(n?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){const t=n.session;if(!(n.expiresAt<Date.now()||t.session.expiresAt<new Date))return e.json(t);{const t=e.context.authCookies.sessionData.name;e.setCookie(t,"",{maxAge:0})}}const s=await e.context.internalAdapter.findSession(t);if(e.context.session=s,!s||s.session.expiresAt<new Date)return deleteSessionCookie(e),s&&await e.context.internalAdapter.deleteSession(s.session.token),e.json(null);if(i||e.query?.disableRefresh)return e.json(s);const o=e.context.sessionConfig.expiresIn,a=e.context.sessionConfig.updateAge,c=s.session.expiresAt.valueOf()-1e3*o+1e3*a;if(c<=Date.now()&&(!e.query?.disableRefresh||!e.context.options.session?.disableSessionRefresh)){const t=await e.context.internalAdapter.updateSession(s.session.token,{expiresAt:getDate(e.context.sessionConfig.expiresIn,"sec"),updatedAt:new Date});if(!t)return deleteSessionCookie(e),e.json(null,{status:401});const r=(t.expiresAt.valueOf()-Date.now())/1e3;return await setSessionCookie(e,{session:t,user:s.user},!1,{maxAge:r}),e.json({session:t,user:s.user})}return await setCookieCache(e,s),e.json(s)}catch(t){throw e.context.logger.error("INTERNAL_SERVER_ERROR",t),new h("INTERNAL_SERVER_ERROR",{message:cs.FAILED_TO_GET_SESSION})}}),getSessionFromCtx=async(e,t)=>{if(e.context.session)return e.context.session;const r=await getSession()({...e,asResponse:!1,headers:e.headers,returnHeaders:!1,query:{...t,...e.query}}).catch(e=>null);return e.context.session=r,r},ds=ss(async e=>{const t=await getSessionFromCtx(e);if(!t?.session)throw new h("UNAUTHORIZED");return{session:t}});ss(async e=>{const t=await getSessionFromCtx(e);if(!t?.session&&(e.request||e.headers))throw new h("UNAUTHORIZED");return{session:t}});const ls=ss(async e=>{const t=await getSessionFromCtx(e);if(!t?.session)throw new h("UNAUTHORIZED");if(0===e.context.sessionConfig.freshAge)return{session:t};const r=e.context.sessionConfig.freshAge,n=t.session.updatedAt?.valueOf()||t.session.createdAt.valueOf();if(!(Date.now()-n<1e3*r))throw new h("FORBIDDEN",{message:"Session is not fresh"});return{session:t}}),us=os("/revoke-session",{method:"POST",body:object({token:string$1().meta({description:"The token to revoke"})}),use:[ds],requireHeaders:!0,metadata:{openapi:{description:"Revoke a single session",requestBody:{content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",description:"The token to revoke"}},required:["token"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the session was revoked successfully"}},required:["status"]}}}}}}}},async e=>{const t=e.body.token,r=await e.context.internalAdapter.findSession(t);if(!r)throw new h("BAD_REQUEST",{message:"Session not found"});if(r.session.userId!==e.context.session.user.id)throw new h("UNAUTHORIZED");try{await e.context.internalAdapter.deleteSession(t)}catch(t){throw e.context.logger.error(t&&"object"==typeof t&&"name"in t?t.name:"",t),new h("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),ps=os("/revoke-sessions",{method:"POST",use:[ds],requireHeaders:!0,metadata:{openapi:{description:"Revoke all sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(t){throw e.context.logger.error(t&&"object"==typeof t&&"name"in t?t.name:"",t),new h("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),hs=os("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[ds],metadata:{openapi:{description:"Revoke all other sessions for the user except the current one",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all other sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{const t=e.context.session;if(!t.user)throw new h("UNAUTHORIZED");const r=(await e.context.internalAdapter.listSessions(t.user.id)).filter(e=>e.expiresAt>new Date).filter(t=>t.token!==e.context.session.session.token);return await Promise.all(r.map(t=>e.context.internalAdapter.deleteSession(t.token))),e.json({status:!0})});async function createEmailVerificationToken(e,t,r,n=3600){const i=await async function(e,t,r=3600){return await new SignJWT(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r).sign((new TextEncoder).encode(t))}({email:t.toLowerCase(),updateTo:r},e,n);return i}async function sendVerificationEmailFn(e,t){if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new h("BAD_REQUEST",{message:"Verification email isn't enabled"});const r=await createEmailVerificationToken(e.context.secret,t.email,void 0,e.context.options.emailVerification?.expiresIn),n=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:t,url:n,token:r},e.request)}const fs=os("/send-verification-email",{method:"POST",body:object({email:email().meta({description:"The email to send the verification email to"}),callbackURL:string$1().meta({description:"The URL to use for email verification callback"}).optional()}),metadata:{openapi:{description:"Send a verification email to the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{email:{type:"string",description:"The email to send the verification email to",example:"user@example.com"},callbackURL:{type:"string",description:"The URL to use for email verification callback",example:"https://example.com/callback",nullable:!0}},required:["email"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the email was sent successfully",example:!0}}}}}},400:{description:"Bad Request",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Error message",example:"Verification email isn't enabled"}}}}}}}}}},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new h("BAD_REQUEST",{message:"Verification email isn't enabled"});const{email:t}=e.body,r=await getSessionFromCtx(e);if(!r){const r=await e.context.internalAdapter.findUserByEmail(t);return r?(await sendVerificationEmailFn(e,r.user),e.json({status:!0})):e.json({status:!0})}if(r?.user.emailVerified)throw new h("BAD_REQUEST",{message:"You can only send a verification email to an unverified email"});if(r?.user.email!==t)throw new h("BAD_REQUEST",{message:"You can only send a verification email to your own email"});return await sendVerificationEmailFn(e,r.user),e.json({status:!0})}),ms=os("/verify-email",{method:"GET",query:object({token:string$1().meta({description:"The token to verify the email"}),callbackURL:string$1().meta({description:"The URL to redirect to after email verification"}).optional()}),use:[originCheck(e=>e.query.callbackURL)],metadata:{openapi:{description:"Verify the email of the user",parameters:[{name:"token",in:"query",description:"The token to verify the email",required:!0,schema:{type:"string"}},{name:"callbackURL",in:"query",description:"The URL to redirect to after email verification",required:!1,schema:{type:"string"}}],responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",properties:{id:{type:"string",description:"User ID"},email:{type:"string",description:"User email"},name:{type:"string",description:"User name"},image:{type:"string",description:"User image URL"},emailVerified:{type:"boolean",description:"Indicates if the user email is verified"},createdAt:{type:"string",description:"User creation date"},updatedAt:{type:"string",description:"User update date"}},required:["id","email","name","image","emailVerified","createdAt","updatedAt"]},status:{type:"boolean",description:"Indicates if the email was verified successfully"}},required:["user","status"]}}}}}}}},async e=>{function redirectOnError(t){if(e.query.callbackURL){if(e.query.callbackURL.includes("?"))throw e.redirect(`${e.query.callbackURL}&error=${t}`);throw e.redirect(`${e.query.callbackURL}?error=${t}`)}throw new h("UNAUTHORIZED",{message:t})}const{token:t}=e.query;let r;try{r=await jwtVerify(t,(new TextEncoder).encode(e.context.secret),{algorithms:["HS256"]})}catch(e){return redirectOnError(e instanceof JWTExpired?"token_expired":"invalid_token")}const n=object({email:string$1().email(),updateTo:string$1().optional()}).parse(r.payload),i=await e.context.internalAdapter.findUserByEmail(n.email);if(!i)return redirectOnError("user_not_found");if(n.updateTo){const t=await getSessionFromCtx(e);if(!t){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return redirectOnError("unauthorized")}if(t.user.email!==n.email){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return redirectOnError("unauthorized")}const r=await e.context.internalAdapter.updateUserByEmail(n.email,{email:n.updateTo,emailVerified:!1},e),i=await createEmailVerificationToken(e.context.secret,n.updateTo);if(await(e.context.options.emailVerification?.sendVerificationEmail?.({user:r,url:`${e.context.baseURL}/verify-email?token=${i}&callbackURL=${e.query.callbackURL||"/"}`,token:i},e.request)),await setSessionCookie(e,{session:t.session,user:{...t.user,email:n.updateTo,emailVerified:!1}}),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:{id:r.id,email:r.email,name:r.name,image:r.image,emailVerified:r.emailVerified,createdAt:r.createdAt,updatedAt:r.updatedAt}})}e.context.options.emailVerification?.onEmailVerification&&await e.context.options.emailVerification.onEmailVerification(i.user,e.request);const s=await e.context.internalAdapter.updateUserByEmail(n.email,{emailVerified:!0},e);if(e.context.options.emailVerification?.afterEmailVerification&&await e.context.options.emailVerification.afterEmailVerification(s,e.request),e.context.options.emailVerification?.autoSignInAfterVerification){const t=await getSessionFromCtx(e);if(t&&t.user.email===n.email)await setSessionCookie(e,{session:t.session,user:{...t.user,emailVerified:!0}});else{const t=await e.context.internalAdapter.createSession(i.user.id,e);if(!t)throw new h("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await setSessionCookie(e,{session:t,user:{...i.user,emailVerified:!0}})}}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:null})}),gs={isAction:!1};async function generateState(e,t){const r=e.body?.callbackURL||e.context.options.baseURL;if(!r)throw new h("BAD_REQUEST",{message:"callbackURL is required"});const n=ki(128),i=ki(32),s=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL,newUserURL:e.body?.newUserCallbackURL,link:t,expiresAt:Date.now()+6e5,requestSignUp:e.body?.requestSignUp}),o=new Date;o.setMinutes(o.getMinutes()+10);const a=await e.context.internalAdapter.createVerificationValue({value:s,identifier:i,expiresAt:o},e);if(!a)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new h("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:a.identifier,codeVerifier:n}}async function parseState(e){const t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r){e.context.logger.error("State Mismatch. Verification not found",{state:t});const r=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${r}?error=please_restart_the_process`)}const n=object({callbackURL:string$1(),codeVerifier:string$1(),errorURL:string$1().optional(),newUserURL:string$1().optional(),expiresAt:number$1(),link:object({email:string$1(),userId:string()}).optional(),requestSignUp:boolean$2().optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now()){await e.context.internalAdapter.deleteVerificationValue(r.id);const t=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${t}?error=please_restart_the_process`)}return await e.context.internalAdapter.deleteVerificationValue(r.id),n}async function generateCodeChallenge(e){const t=await createHash("SHA-256").digest(e);return Pn.encode(new Uint8Array(t),{padding:!1})}function getOAuth2Tokens(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?getDate(e.expires_in,"sec"):void 0,refreshTokenExpiresAt:e.refresh_token_expires_in?getDate(e.refresh_token_expires_in,"sec"):void 0,scopes:e?.scope?"string"==typeof e.scope?e.scope.split(" "):e.scope:[],idToken:e.id_token}}function getAccessTokenUtil(e,t){return t.options.account?.encryptOAuthTokens?symmetricDecrypt({key:t.secret,data:e}):e}function setTokenUtil(e,t){return t.options.account?.encryptOAuthTokens&&e?symmetricEncrypt({key:t.secret,data:e}):e??null}async function handleOAuthUserInfo(e,{userInfo:t,account:r,callbackURL:n,disableSignUp:i,overrideUserInfo:s}){const o=await e.context.internalAdapter.findOAuthUser(t.email.toLowerCase(),r.accountId,r.providerId).catch(t=>{rs.error("Better auth was unable to query your database.\nError: ",t);const r=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${r}?error=internal_server_error`)});let a=o?.user,c=!a;if(o){const n=o.accounts.find(e=>e.providerId===r.providerId&&e.accountId===r.accountId);if(n){if(!1!==e.context.options.account?.updateAccountOnSignIn){const t=Object.fromEntries(Object.entries({idToken:r.idToken,accessToken:await setTokenUtil(r.accessToken,e.context),refreshToken:await setTokenUtil(r.refreshToken,e.context),accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope}).filter(([e,t])=>void 0!==t));Object.keys(t).length>0&&await e.context.internalAdapter.updateAccount(n.id,t,e)}}else{const n=e.context.options.account?.accountLinking?.trustedProviders,i=n?.includes(r.providerId);if(!i&&!t.emailVerified||!1===e.context.options.account?.accountLinking?.enabled)return Qi&&rs.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:t.id.toString(),userId:o.user.id,accessToken:await setTokenUtil(r.accessToken,e.context),refreshToken:await setTokenUtil(r.refreshToken,e.context),idToken:r.idToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope},e)}catch(e){return rs.error("Unable to link account",e),{error:"unable to link account",data:null}}}if(s){const{id:r,...n}=t;await e.context.internalAdapter.updateUser(o.user.id,{...n,email:t.email.toLowerCase(),emailVerified:t.email.toLowerCase()===o.user.email&&o.user.emailVerified||t.emailVerified})}}else{if(i)return{error:"signup disabled",data:null,isRegister:!1};try{const{id:i,...s}=t;if(a=await e.context.internalAdapter.createOAuthUser({...s,email:t.email.toLowerCase()},{accessToken:await setTokenUtil(r.accessToken,e.context),refreshToken:await setTokenUtil(r.refreshToken,e.context),idToken:r.idToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope,providerId:r.providerId,accountId:t.id.toString()},e).then(e=>e?.user),!t.emailVerified&&a&&e.context.options.emailVerification?.sendOnSignUp){const t=await createEmailVerificationToken(e.context.secret,a.email,void 0,e.context.options.emailVerification?.expiresIn),r=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${n}`;await(e.context.options.emailVerification?.sendVerificationEmail?.({user:a,url:r,token:t},e.request))}}catch(e){return rs.error(e),e instanceof h?{error:e.message,data:null,isRegister:!1}:{error:"unable to create user",data:null,isRegister:!1}}}if(!a)return{error:"unable to create user",data:null,isRegister:!1};const d=await e.context.internalAdapter.createSession(a.id,e);return d?{data:{session:d,user:a},error:null,isRegister:c}:{error:"unable to create session",data:null,isRegister:!1}}async function createAuthorizationURL({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:i,scopes:s,claims:o,redirectURI:a,duration:c,prompt:d,accessType:l,responseType:u,display:p,loginHint:h,hd:f,responseMode:m,additionalParams:g,scopeJoiner:y}){const w=new URL(r);if(w.searchParams.set("response_type",u||"code"),w.searchParams.set("client_id",t.clientId),w.searchParams.set("state",n),w.searchParams.set("scope",s.join(y||" ")),w.searchParams.set("redirect_uri",t.redirectURI||a),c&&w.searchParams.set("duration",c),p&&w.searchParams.set("display",p),h&&w.searchParams.set("login_hint",h),d&&w.searchParams.set("prompt",d),f&&w.searchParams.set("hd",f),l&&w.searchParams.set("access_type",l),m&&w.searchParams.set("response_mode",m),i){const e=await generateCodeChallenge(i);w.searchParams.set("code_challenge_method","S256"),w.searchParams.set("code_challenge",e)}if(o){const e=o.reduce((e,t)=>(e[t]=null,e),{});w.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...e}}))}return g&&Object.entries(g).forEach(([e,t])=>{w.searchParams.set(e,t)}),w}async function validateAuthorizationCode({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:i,authentication:s,deviceId:o,headers:a,additionalParams:c={}}){const d=new URLSearchParams,l={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth",...a};if(d.set("grant_type","authorization_code"),d.set("code",e),t&&d.set("code_verifier",t),n.clientKey&&d.set("client_key",n.clientKey),o&&d.set("device_id",o),d.set("redirect_uri",n.redirectURI||r),d.set("client_id",n.clientId),"basic"===s){const e=On.encode(`${n.clientId}:${n.clientSecret}`);l.authorization=`Basic ${e}`}else d.set("client_secret",n.clientSecret);for(const[e,t]of Object.entries(c))d.has(e)||d.append(e,t);const{data:u,error:p}=await betterFetch(i,{method:"POST",body:d,headers:l});if(p)throw p;return getOAuth2Tokens(u)}async function refreshAccessToken({refreshToken:e,options:t,tokenEndpoint:r,authentication:n,extraParams:i,grantType:s="refresh_token"}){const o=new URLSearchParams,a={"content-type":"application/x-www-form-urlencoded",accept:"application/json"};if(o.set("grant_type",s),o.set("refresh_token",e),"basic"===n?a.authorization=On.encode(`${t.clientId}:${t.clientSecret}`):(o.set("client_id",t.clientId),o.set("client_secret",t.clientSecret)),i)for(const[e,t]of Object.entries(i))o.set(e,t);const{data:c,error:d}=await betterFetch(r,{method:"POST",body:o,headers:a});if(d)throw d;const l={accessToken:c.access_token,refreshToken:c.refresh_token,tokenType:c.token_type,scopes:c.scope?.split(" "),idToken:c.id_token};if(c.expires_in){const e=new Date;l.accessTokenExpiresAt=new Date(e.getTime()+1e3*c.expires_in)}return l}const getApplePublicKey=async e=>{const{data:t}=await betterFetch("https://appleid.apple.com/auth/keys");if(!t?.keys)throw new h("BAD_REQUEST",{message:"Keys not found"});const r=t.keys.find(t=>t.kid===e);if(!r)throw new Error(`JWK with kid ${e} not found`);return await importJWK(r,r.alg)},cleanDoubleSlashes=(e="")=>e.split("://").map(e=>e.replace(/\/{2,}/g,"/")).join("://"),ys={apple:e=>({id:"apple",name:"Apple",async createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["email","name"];e.scope&&i.push(...e.scope),r&&i.push(...r);return await createAuthorizationURL({id:"apple",options:e,authorizationEndpoint:"https://appleid.apple.com/auth/authorize",scopes:i,state:t,redirectURI:n,responseMode:"form_post",responseType:"code id_token"})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>validateAuthorizationCode({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://appleid.apple.com/auth/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);const n=function(e){let t;if("string"==typeof e){const r=e.split(".");3!==r.length&&5!==r.length||([t]=r)}else if("object"==typeof e&&e){if(!("protected"in e))throw new TypeError("Token does not contain a Protected Header");t=e.protected}try{if("string"!=typeof t||!t)throw new Error;const e=JSON.parse(ti.decode(li(t)));if(!isObject$1(e))throw new Error;return e}catch{throw new TypeError("Invalid Token or Protected Header formatting")}}(t),{kid:i,alg:s}=n;if(!i||!s)return!1;const o=await getApplePublicKey(i),{payload:a}=await jwtVerify(t,o,{algorithms:[s],issuer:"https://appleid.apple.com",audience:e.appBundleIdentifier||e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(e=>{void 0!==a[e]&&(a[e]=Boolean(a[e]))}),(!r||a.nonce===r)&&!!a},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://appleid.apple.com/auth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;const r=decodeJwt(t.idToken);if(!r)return null;const n=t.user?`${t.user.name?.firstName} ${t.user.name?.lastName}`:r.name||r.email,i="boolean"==typeof r.email_verified?r.email_verified:"true"===r.email_verified,s=await(e.mapProfileToUser?.(r));return{user:{id:r.sub,name:n,emailVerified:i,email:r.email,...s},data:r}},options:e}),discord:e=>({id:"discord",name:"Discord",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["identify","email"];return r&&i.push(...r),e.scope&&i.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${i.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}&prompt=${e.prompt||"none"}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>validateAuthorizationCode({code:t,redirectURI:r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${t.accessToken}`}});if(n)return null;if(null===r.avatar){const e="0"===r.discriminator?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${e}.png`}else{const e=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${e}`}const i=await(e.mapProfileToUser?.(r));return{user:{id:r.id,name:r.global_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url,...i},data:r}},options:e}),facebook:e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:t,scopes:r,redirectURI:n,loginHint:i}){const s=e.disableDefaultScope?[]:["email","public_profile"];return e.scope&&s.push(...e.scope),r&&s.push(...r),await createAuthorizationURL({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:s,state:t,redirectURI:n,loginHint:i,additionalParams:e.configId?{config_id:e.configId}:{}})},validateAuthorizationCode:async({code:t,redirectURI:r})=>validateAuthorizationCode({code:t,redirectURI:r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);if(3===t.split(".").length)try{const{payload:n}=await jwtVerify(t,function(e,t){const r=new RemoteJWKSet(e,t),remoteJWKSet=async(e,t)=>r.getKey(e,t);return Object.defineProperties(remoteJWKSet,{coolingDown:{get:()=>r.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>r.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>r.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>!!r._pendingFetch,enumerable:!0,configurable:!1},jwks:{value:()=>r._local?.jwks(),enumerable:!0,configurable:!1,writable:!1}}),remoteJWKSet}(new URL("https://limited.facebook.com/.well-known/oauth/openid/jwks/")),{algorithms:["RS256"],audience:e.clientId,issuer:"https://www.facebook.com"});return(!r||n.nonce===r)&&!!n}catch(e){return!1}return!0},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://graph.facebook.com/v18.0/oauth/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(t.idToken&&3===t.idToken.split(".").length){const r=decodeJwt(t.idToken),n={id:r.sub,name:r.name,email:r.email,picture:{data:{url:r.picture,height:100,width:100,is_silhouette:!1}}},i=await(e.mapProfileToUser?.({...n,email_verified:!0}));return{user:{...n,emailVerified:!0,...i},data:r}}const r=["id","name","email","picture",...e?.fields||[]],{data:n,error:i}=await betterFetch("https://graph.facebook.com/me?fields="+r.join(","),{auth:{type:"Bearer",token:t.accessToken}});if(i)return null;const s=await(e.mapProfileToUser?.(n));return{user:{id:n.id,name:n.name,email:n.email,image:n.picture.data.url,emailVerified:n.email_verified,...s},data:n}},options:e}),github:e=>({id:"github",name:"GitHub",createAuthorizationURL({state:t,scopes:r,loginHint:n,redirectURI:i}){const s=e.disableDefaultScope?[]:["read:user","user:email"];return e.scope&&s.push(...e.scope),r&&s.push(...r),createAuthorizationURL({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:s,state:t,redirectURI:i,loginHint:n,prompt:e.prompt})},validateAuthorizationCode:async({code:t,redirectURI:r})=>validateAuthorizationCode({code:t,redirectURI:r,options:e,tokenEndpoint:"https://github.com/login/oauth/access_token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://github.com/login/oauth/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${t.accessToken}`}});if(n)return null;const{data:i}=await betterFetch("https://api.github.com/user/emails",{headers:{Authorization:`Bearer ${t.accessToken}`,"User-Agent":"better-auth"}});!r.email&&i&&(r.email=(i.find(e=>e.primary)??i[0])?.email);const s=i?.find(e=>e.email===r.email)?.verified??!1,o=await(e.mapProfileToUser?.(r));return{user:{id:r.id.toString(),name:r.name||r.login,email:r.email,image:r.avatar_url,emailVerified:s,...o},data:r}},options:e}),microsoft:e=>{const t=e.tenantId||"common",r=`https://login.microsoftonline.com/${t}/oauth2/v2.0/authorize`,n=`https://login.microsoftonline.com/${t}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(t){const n=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&n.push(...e.scope),t.scopes&&n.push(...t.scopes),createAuthorizationURL({id:"microsoft",options:e,authorizationEndpoint:r,state:t.state,codeVerifier:t.codeVerifier,scopes:n,redirectURI:t.redirectURI,prompt:e.prompt})},validateAuthorizationCode:({code:t,codeVerifier:r,redirectURI:i})=>validateAuthorizationCode({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:n}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;const r=decodeJwt(t.idToken),n=e.profilePhotoSize||48;await betterFetch(`https://graph.microsoft.com/v1.0/me/photos/${n}x${n}/$value`,{headers:{Authorization:`Bearer ${t.accessToken}`},async onResponse(t){if(!e.disableProfilePhoto&&t.response.ok)try{const e=t.response.clone(),n=await e.arrayBuffer(),i=On.encode(n);r.picture=`data:image/jpeg;base64, ${i}`}catch(e){rs.error(e&&"object"==typeof e&&"name"in e?e.name:"",e)}}});const i=await(e.mapProfileToUser?.(r));return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:!0,...i},data:r}},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>{const r=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&r.push(...e.scope),refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},extraParams:{scope:r.join(" ")},tokenEndpoint:n})},options:e}},google:e=>({id:"google",name:"Google",async createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:i,loginHint:s,display:o}){if(!e.clientId||!e.clientSecret)throw rs.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new BetterAuthError("CLIENT_ID_AND_SECRET_REQUIRED");if(!n)throw new BetterAuthError("codeVerifier is required for Google");const a=e.disableDefaultScope?[]:["email","profile","openid"];e.scope&&a.push(...e.scope),r&&a.push(...r),"select_account+consent"===e.prompt&&(e.prompt="select_account consent");return await createAuthorizationURL({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:a,state:t,codeVerifier:n,redirectURI:i,prompt:e.prompt,accessType:e.accessType,display:o||e.display,loginHint:s,hd:e.hd,additionalParams:{include_granted_scopes:"true"}})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>validateAuthorizationCode({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);const n=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${t}`,{data:i}=await betterFetch(n);if(!i)return!1;return i.aud===e.clientId&&("https://accounts.google.com"===i.iss||"accounts.google.com"===i.iss)},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;const r=decodeJwt(t.idToken),n=await(e.mapProfileToUser?.(r));return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...n},data:r}},options:e}),huggingface:e=>({id:"huggingface",name:"Hugging Face",createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:i}){const s=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&s.push(...e.scope),r&&s.push(...r),createAuthorizationURL({id:"huggingface",options:e,authorizationEndpoint:"https://huggingface.co/oauth/authorize",scopes:s,state:t,codeVerifier:n,redirectURI:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>validateAuthorizationCode({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://huggingface.co/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://huggingface.co/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://huggingface.co/oauth/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await(e.mapProfileToUser?.(r));return{user:{id:r.sub,name:r.name||r.preferred_username,email:r.email,image:r.picture,emailVerified:r.email_verified??!1,...i},data:r}},options:e}),slack:e=>({id:"slack",name:"Slack",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["openid","profile","email"];r&&i.push(...r),e.scope&&i.push(...e.scope);const s=new URL("https://slack.com/openid/connect/authorize");return s.searchParams.set("scope",i.join(" ")),s.searchParams.set("response_type","code"),s.searchParams.set("client_id",e.clientId),s.searchParams.set("redirect_uri",e.redirectURI||n),s.searchParams.set("state",t),s},validateAuthorizationCode:async({code:t,redirectURI:r})=>validateAuthorizationCode({code:t,redirectURI:r,options:e,tokenEndpoint:"https://slack.com/api/openid.connect.token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://slack.com/api/openid.connect.token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://slack.com/api/openid.connect.userInfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await(e.mapProfileToUser?.(r));return{user:{id:r["https://slack.com/user_id"],name:r.name||"",email:r.email,emailVerified:r.email_verified,image:r.picture||r["https://slack.com/user_image_512"],...i},data:r}},options:e}),spotify:e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:i}){const s=e.disableDefaultScope?[]:["user-read-email"];return e.scope&&s.push(...e.scope),r&&s.push(...r),createAuthorizationURL({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:s,state:t,codeVerifier:n,redirectURI:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>validateAuthorizationCode({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await(e.mapProfileToUser?.(r));return{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1,...i},data:r}},options:e}),twitch:e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["user:read:email","openid"];return e.scope&&i.push(...e.scope),r&&i.push(...r),createAuthorizationURL({id:"twitch",redirectURI:n,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:i,state:t,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:t,redirectURI:r})=>validateAuthorizationCode({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const r=t.idToken;if(!r)return rs.error("No idToken found in token"),null;const n=decodeJwt(r),i=await(e.mapProfileToUser?.(n));return{user:{id:n.sub,name:n.preferred_username,email:n.email,image:n.picture,emailVerified:n.email_verified,...i},data:n}},options:e}),twitter:e=>({id:"twitter",name:"Twitter",createAuthorizationURL(t){const r=e.disableDefaultScope?[]:["users.read","tweet.read","offline.access","users.email"];return e.scope&&r.push(...e.scope),t.scopes&&r.push(...t.scopes),createAuthorizationURL({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:t.state,codeVerifier:t.codeVerifier,redirectURI:t.redirectURI})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>validateAuthorizationCode({code:t,codeVerifier:r,authentication:"basic",redirectURI:n,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const{data:i,error:s}=await betterFetch("https://api.x.com/2/users/me?user.fields=confirmed_email",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});let o=!1;!s&&i?.data?.confirmed_email&&(r.data.email=i.data.confirmed_email,o=!0);const a=await(e.mapProfileToUser?.(r));return{user:{id:r.data.id,name:r.data.name,email:r.data.email||r.data.username||null,image:r.data.profile_image_url,emailVerified:o,...a},data:r}},options:e}),dropbox:e=>({id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:t,scopes:r,codeVerifier:n,redirectURI:i})=>{const s=e.disableDefaultScope?[]:["account_info.read"];e.scope&&s.push(...e.scope),r&&s.push(...r);const o={};return e.accessType&&(o.token_access_type=e.accessType),await createAuthorizationURL({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:s,state:t,redirectURI:i,codeVerifier:n,additionalParams:o})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>await validateAuthorizationCode({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:"https://api.dropboxapi.com/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.dropbox.com/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await(e.mapProfileToUser?.(r));return{user:{id:r.account_id,name:r.name?.display_name,email:r.email,emailVerified:r.email_verified||!1,image:r.profile_photo_url,...i},data:r}},options:e}),kick:e=>({id:"kick",name:"Kick",createAuthorizationURL({state:t,scopes:r,redirectURI:n,codeVerifier:i}){const s=e.disableDefaultScope?[]:["user:read"];return e.scope&&s.push(...e.scope),r&&s.push(...r),createAuthorizationURL({id:"kick",redirectURI:n,options:e,authorizationEndpoint:"https://id.kick.com/oauth/authorize",scopes:s,codeVerifier:i,state:t})},validateAuthorizationCode:async({code:t,redirectURI:r,codeVerifier:n})=>validateAuthorizationCode({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.kick.com/oauth/token",codeVerifier:n}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://api.kick.com/public/v1/users",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=r.data[0],s=await(e.mapProfileToUser?.(i));return{user:{id:i.user_id,name:i.name,email:i.email,image:i.profile_picture,emailVerified:!0,...s},data:i}},options:e}),linear:e=>{const t="https://api.linear.app/oauth/token";return{id:"linear",name:"Linear",createAuthorizationURL({state:t,scopes:r,loginHint:n,redirectURI:i}){const s=e.disableDefaultScope?[]:["read"];return e.scope&&s.push(...e.scope),r&&s.push(...r),createAuthorizationURL({id:"linear",options:e,authorizationEndpoint:"https://linear.app/oauth/authorize",scopes:s,state:t,redirectURI:i,loginHint:n})},validateAuthorizationCode:async({code:r,redirectURI:n})=>validateAuthorizationCode({code:r,redirectURI:n,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>refreshAccessToken({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://api.linear.app/graphql",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.accessToken}`},body:JSON.stringify({query:"\n\t\t\t\t\t\t\tquery {\n\t\t\t\t\t\t\t\tviewer {\n\t\t\t\t\t\t\t\t\tid\n\t\t\t\t\t\t\t\t\tname\n\t\t\t\t\t\t\t\t\temail\n\t\t\t\t\t\t\t\t\tavatarUrl\n\t\t\t\t\t\t\t\t\tactive\n\t\t\t\t\t\t\t\t\tcreatedAt\n\t\t\t\t\t\t\t\t\tupdatedAt\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t"})});if(n||!r?.data?.viewer)return null;const i=r.data.viewer,s=await(e.mapProfileToUser?.(i));return{user:{id:r.data.viewer.id,name:r.data.viewer.name,email:r.data.viewer.email,image:r.data.viewer.avatarUrl,emailVerified:!0,...s},data:i}},options:e}},linkedin:e=>{const t="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:t,scopes:r,redirectURI:n,loginHint:i})=>{const s=e.disableDefaultScope?[]:["profile","email","openid"];return e.scope&&s.push(...e.scope),r&&s.push(...r),await createAuthorizationURL({id:"linkedin",options:e,authorizationEndpoint:"https://www.linkedin.com/oauth/v2/authorization",scopes:s,state:t,loginHint:i,redirectURI:n})},validateAuthorizationCode:async({code:r,redirectURI:n})=>await validateAuthorizationCode({code:r,redirectURI:n,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>refreshAccessToken({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await(e.mapProfileToUser?.(r));return{user:{id:r.sub,name:r.name,email:r.email,emailVerified:r.email_verified||!1,image:r.picture,...i},data:r}},options:e}},gitlab:e=>{const{authorizationEndpoint:t,tokenEndpoint:r,userinfoEndpoint:n}=(e=>{let t=e||"https://gitlab.com";return{authorizationEndpoint:cleanDoubleSlashes(`${t}/oauth/authorize`),tokenEndpoint:cleanDoubleSlashes(`${t}/oauth/token`),userinfoEndpoint:cleanDoubleSlashes(`${t}/api/v4/user`)}})(e.issuer),i="gitlab";return{id:i,name:"Gitlab",createAuthorizationURL:async({state:r,scopes:n,codeVerifier:s,loginHint:o,redirectURI:a})=>{const c=e.disableDefaultScope?[]:["read_user"];return e.scope&&c.push(...e.scope),n&&c.push(...n),await createAuthorizationURL({id:i,options:e,authorizationEndpoint:t,scopes:c,state:r,redirectURI:a,codeVerifier:s,loginHint:o})},validateAuthorizationCode:async({code:t,redirectURI:n,codeVerifier:i})=>validateAuthorizationCode({code:t,redirectURI:n,options:e,codeVerifier:i,tokenEndpoint:r}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://gitlab.com/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:i}=await betterFetch(n,{headers:{authorization:`Bearer ${t.accessToken}`}});if(i||"active"!==r.state||r.locked)return null;const s=await(e.mapProfileToUser?.(r));return{user:{id:r.id.toString(),name:r.name??r.username,email:r.email,image:r.avatar_url,emailVerified:!0,...s},data:r}},options:e}},tiktok:e=>({id:"tiktok",name:"TikTok",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["user.info.profile"];return e.scope&&i.push(...e.scope),r&&i.push(...r),new URL(`https://www.tiktok.com/v2/auth/authorize?scope=${i.join(",")}&response_type=code&client_key=${e.clientKey}&client_secret=${e.clientSecret}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>validateAuthorizationCode({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch(`https://open.tiktokapis.com/v2/user/info/?fields=${["open_id","avatar_large_url","display_name","username"].join(",")}`,{headers:{authorization:`Bearer ${t.accessToken}`}});return n?null:{user:{email:r.data.user.email||r.data.user.username,id:r.data.user.open_id,name:r.data.user.display_name||r.data.user.username,image:r.data.user.avatar_large_url,emailVerified:!!r.data.user.email},data:r}},options:e}),reddit:e=>({id:"reddit",name:"Reddit",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["identity"];return e.scope&&i.push(...e.scope),r&&i.push(...r),createAuthorizationURL({id:"reddit",options:e,authorizationEndpoint:"https://www.reddit.com/api/v1/authorize",scopes:i,state:t,redirectURI:n,duration:e.duration})},validateAuthorizationCode:async({code:t,redirectURI:r})=>{const n=new URLSearchParams({grant_type:"authorization_code",code:t,redirect_uri:e.redirectURI||r}),i={"content-type":"application/x-www-form-urlencoded",accept:"text/plain","user-agent":"better-auth",Authorization:`Basic ${On.encode(`${e.clientId}:${e.clientSecret}`)}`},{data:s,error:o}=await betterFetch("https://www.reddit.com/api/v1/access_token",{method:"POST",headers:i,body:n.toString()});if(o)throw o;return getOAuth2Tokens(s)},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.reddit.com/api/v1/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://oauth.reddit.com/api/v1/me",{headers:{Authorization:`Bearer ${t.accessToken}`,"User-Agent":"better-auth"}});if(n)return null;const i=await(e.mapProfileToUser?.(r));return{user:{id:r.id,name:r.name,email:r.oauth_client_id,emailVerified:r.has_verified_email,image:r.icon_img?.split("?")[0],...i},data:r}},options:e}),roblox:e=>({id:"roblox",name:"Roblox",createAuthorizationURL({state:t,scopes:r,redirectURI:n}){const i=e.disableDefaultScope?[]:["openid","profile"];return e.scope&&i.push(...e.scope),r&&i.push(...r),new URL(`https://apis.roblox.com/oauth/v1/authorize?scope=${i.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||n)}&state=${t}&prompt=${e.prompt||"select_account+consent"}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>validateAuthorizationCode({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://apis.roblox.com/oauth/v1/token",authentication:"post"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://apis.roblox.com/oauth/v1/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://apis.roblox.com/oauth/v1/userinfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(n)return null;const i=await(e.mapProfileToUser?.(r));return{user:{id:r.sub,name:r.nickname||r.preferred_username||"",image:r.picture,email:r.preferred_username||null,emailVerified:!0,...i},data:{...r}}},options:e}),vk:e=>({id:"vk",name:"VK",async createAuthorizationURL({state:t,scopes:r,codeVerifier:n,redirectURI:i}){const s=e.disableDefaultScope?[]:["email","phone"];e.scope&&s.push(...e.scope),r&&s.push(...r);return createAuthorizationURL({id:"vk",options:e,authorizationEndpoint:"https://id.vk.com/authorize",scopes:s,state:t,redirectURI:i,codeVerifier:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n,deviceId:i})=>validateAuthorizationCode({code:t,codeVerifier:r,redirectURI:e.redirectURI||n,options:e,deviceId:i,tokenEndpoint:"https://id.vk.com/oauth2/auth"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.vk.com/oauth2/auth"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return null;const r=new URLSearchParams({access_token:t.accessToken,client_id:e.clientId}).toString(),{data:n,error:i}=await betterFetch("https://id.vk.com/oauth2/user_info",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});if(i)return null;if(!n.user.email)return null;const s=await(e.mapProfileToUser?.(n));return{user:{id:n.user.user_id,first_name:n.user.first_name,last_name:n.user.last_name,email:n.user.email,image:n.user.avatar,emailVerified:!!n.user.email,birthday:n.user.birthday,sex:n.user.sex,...s},data:n}},options:e}),zoom:e=>{const t={pkce:!0,...e};return{id:"zoom",name:"Zoom",createAuthorizationURL:async({state:e,redirectURI:r,codeVerifier:n})=>{const i=new URLSearchParams({response_type:"code",redirect_uri:t.redirectURI?t.redirectURI:r,client_id:t.clientId,state:e});if(t.pkce){const e=await generateCodeChallenge(n);i.set("code_challenge_method","S256"),i.set("code_challenge",e)}const s=new URL("https://zoom.us/oauth/authorize");return s.search=i.toString(),s},validateAuthorizationCode:async({code:e,redirectURI:r,codeVerifier:n})=>validateAuthorizationCode({code:e,redirectURI:t.redirectURI||r,codeVerifier:n,options:t,tokenEndpoint:"https://zoom.us/oauth/token",authentication:"post"}),async getUserInfo(e){if(t.getUserInfo)return t.getUserInfo(e);const{data:r,error:n}=await betterFetch("https://api.zoom.us/v2/users/me",{headers:{authorization:`Bearer ${e.accessToken}`}});if(n)return null;const i=await(t.mapProfileToUser?.(r));return{user:{id:r.id,name:r.display_name,image:r.pic_url,email:r.email,emailVerified:Boolean(r.verified),...i},data:{...r}}}}},notion:e=>{const t="https://api.notion.com/v1/oauth/token";return{id:"notion",name:"Notion",createAuthorizationURL({state:t,scopes:r,loginHint:n,redirectURI:i}){const s=(e.disableDefaultScope,[]);return e.scope&&s.push(...e.scope),r&&s.push(...r),createAuthorizationURL({id:"notion",options:e,authorizationEndpoint:"https://api.notion.com/v1/oauth/authorize",scopes:s,state:t,redirectURI:i,loginHint:n,additionalParams:{owner:"user"}})},validateAuthorizationCode:async({code:r,redirectURI:n})=>validateAuthorizationCode({code:r,redirectURI:n,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>refreshAccessToken({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);const{data:r,error:n}=await betterFetch("https://api.notion.com/v1/users/me",{headers:{Authorization:`Bearer ${t.accessToken}`,"Notion-Version":"2022-06-28"}});if(n)return null;const i=await(e.mapProfileToUser?.(r));return{user:{id:r.id,name:r.name||"Notion User",email:r.person?.email||null,image:r.avatar_url,emailVerified:!!r.person?.email,...i},data:r}},options:e}}},ws=_enum(Object.keys(ys)).or(string$1()),bs=os("/sign-in/social",{method:"POST",body:object({callbackURL:string$1().meta({description:"Callback URL to redirect to after the user has signed in"}).optional(),newUserCallbackURL:string$1().optional(),errorCallbackURL:string$1().meta({description:"Callback URL to redirect to if an error happens"}).optional(),provider:ws,disableRedirect:boolean$2().meta({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),idToken:optional(object({token:string$1().meta({description:"ID token from the provider"}),nonce:string$1().meta({description:"Nonce used to generate the token"}).optional(),accessToken:string$1().meta({description:"Access token from the provider"}).optional(),refreshToken:string$1().meta({description:"Refresh token from the provider"}).optional(),expiresAt:number$1().meta({description:"Expiry date of the token"}).optional()})),scopes:array(string$1()).meta({description:"Array of scopes to request from the provider. This will override the default scopes passed."}).optional(),requestSignUp:boolean$2().meta({description:"Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider"}).optional(),loginHint:string$1().meta({description:"The login hint to use for the authorization code request"}).optional()}),metadata:{openapi:{description:"Sign in with a social provider",operationId:"socialSignIn",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{redirect:{type:"boolean",enum:[!1]},token:{type:"string",description:"Session token",url:{type:"null",nullable:!0},user:{type:"object",properties:{id:{type:"string"},email:{type:"string"},name:{type:"string",nullable:!0},image:{type:"string",nullable:!0},emailVerified:{type:"boolean"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}},required:["id","email","emailVerified","createdAt","updatedAt"]}}},required:["redirect","token","user"]}}}}}}}},async e=>{const t=e.context.socialProviders.find(t=>t.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new h("NOT_FOUND",{message:cs.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!t.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new h("NOT_FOUND",{message:cs.ID_TOKEN_NOT_SUPPORTED});const{token:r,nonce:n}=e.body.idToken;if(!await t.verifyIdToken(r,n))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new h("UNAUTHORIZED",{message:cs.INVALID_TOKEN});const i=await t.getUserInfo({idToken:r,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!i||!i?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new h("UNAUTHORIZED",{message:cs.FAILED_TO_GET_USER_INFO});if(!i.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new h("UNAUTHORIZED",{message:cs.USER_EMAIL_NOT_FOUND});const s=await handleOAuthUserInfo(e,{userInfo:{...i.user,email:i.user.email,id:i.user.id,name:i.user.name||"",image:i.user.image,emailVerified:i.user.emailVerified||!1},account:{providerId:t.id,accountId:i.user.id,accessToken:e.body.idToken.accessToken},callbackURL:e.body.callbackURL,disableSignUp:t.disableImplicitSignUp&&!e.body.requestSignUp||t.disableSignUp});if(s.error)throw new h("UNAUTHORIZED",{message:s.error});return await setSessionCookie(e,s.data),e.json({redirect:!1,token:s.data.session.token,url:void 0,user:{id:s.data.user.id,email:s.data.user.email,name:s.data.user.name,image:s.data.user.image,emailVerified:s.data.user.emailVerified,createdAt:s.data.user.createdAt,updatedAt:s.data.user.updatedAt}})}const{codeVerifier:r,state:n}=await generateState(e),i=await t.createAuthorizationURL({state:n,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${t.id}`,scopes:e.body.scopes,loginHint:e.body.loginHint});return e.json({url:i.toString(),redirect:!e.body.disableRedirect})}),vs=os("/sign-in/email",{method:"POST",body:object({email:string$1().meta({description:"Email of the user"}),password:string$1().meta({description:"Password of the user"}),callbackURL:string$1().meta({description:"Callback URL to use as a redirect for email verification"}).optional(),rememberMe:boolean$2().meta({description:"If this is false, the session will not be remembered. Default is `true`."}).default(!0).optional()}),metadata:{openapi:{description:"Sign in with email and password",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{redirect:{type:"boolean",enum:[!1]},token:{type:"string",description:"Session token"},url:{type:"null",nullable:!0},user:{type:"object",properties:{id:{type:"string"},email:{type:"string"},name:{type:"string",nullable:!0},image:{type:"string",nullable:!0},emailVerified:{type:"boolean"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}},required:["id","email","emailVerified","createdAt","updatedAt"]}},required:["redirect","token","user"]}}}}}}}},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new h("BAD_REQUEST",{message:"Email and password is not enabled"});const{email:t,password:r}=e.body;if(!string$1().email().safeParse(t).success)throw new h("BAD_REQUEST",{message:cs.INVALID_EMAIL});const n=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:t}),new h("UNAUTHORIZED",{message:cs.INVALID_EMAIL_OR_PASSWORD});const i=n.accounts.find(e=>"credential"===e.providerId);if(!i)throw e.context.logger.error("Credential account not found",{email:t}),new h("UNAUTHORIZED",{message:cs.INVALID_EMAIL_OR_PASSWORD});const s=i?.password;if(!s)throw e.context.logger.error("Password not found",{email:t}),new h("UNAUTHORIZED",{message:cs.INVALID_EMAIL_OR_PASSWORD});if(!await e.context.password.verify({hash:s,password:r}))throw e.context.logger.error("Invalid password"),new h("UNAUTHORIZED",{message:cs.INVALID_EMAIL_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!n.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new h("FORBIDDEN",{message:cs.EMAIL_NOT_VERIFIED});if(e.context.options?.emailVerification?.sendOnSignIn){const t=await createEmailVerificationToken(e.context.secret,n.user.email,void 0,e.context.options.emailVerification?.expiresIn),r=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:n.user,url:r,token:t},e.request)}throw new h("FORBIDDEN",{message:cs.EMAIL_NOT_VERIFIED})}const o=await e.context.internalAdapter.createSession(n.user.id,e,!1===e.body.rememberMe);if(!o)throw e.context.logger.error("Failed to create session"),new h("UNAUTHORIZED",{message:cs.FAILED_TO_CREATE_SESSION});return await setSessionCookie(e,{session:o,user:n.user},!1===e.body.rememberMe),e.json({redirect:!!e.body.callbackURL,token:o.token,url:e.body.callbackURL,user:{id:n.user.id,email:n.user.email,name:n.user.name,image:n.user.image,emailVerified:n.user.emailVerified,createdAt:n.user.createdAt,updatedAt:n.user.updatedAt}})}),Ns=object({code:string$1().optional(),error:string$1().optional(),device_id:string$1().optional(),error_description:string$1().optional(),state:string$1().optional(),user:string$1().optional()}),Ts=os("/callback/:id",{method:["GET","POST"],body:Ns.optional(),query:Ns.optional(),metadata:gs},async e=>{let t;const r=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;try{if("GET"===e.method)t=Ns.parse(e.query);else{if("POST"!==e.method)throw new Error("Unsupported method");t=Ns.parse(e.body)}}catch(t){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",t),e.redirect(`${r}?error=invalid_callback_request`)}const{code:n,error:i,state:s,error_description:o,device_id:a}=t;if(i)throw e.redirect(`${r}?error=${i}&error_description=${o}`);if(!s)throw e.context.logger.error("State not found",i),e.redirect(`${r}?error=state_not_found`);const{codeVerifier:c,callbackURL:d,link:l,errorURL:u,newUserURL:p,requestSignUp:h}=await parseState(e);function redirectOnError(t){let n=u||r;throw n=n.includes("?")?`${n}&error=${t}`:`${n}?error=${t}`,e.redirect(n)}if(!n)throw e.context.logger.error("Code not found"),redirectOnError("no_code");const f=e.context.socialProviders.find(t=>t.id===e.params.id);if(!f)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),redirectOnError("oauth_provider_not_found");let m;try{m=await f.validateAuthorizationCode({code:n,codeVerifier:c,deviceId:a,redirectURI:`${e.context.baseURL}/callback/${f.id}`})}catch(t){throw e.context.logger.error("",t),redirectOnError("invalid_code")}const g=await f.getUserInfo({...m,user:e.body?.user?safeJSONParse(e.body.user):void 0}).then(e=>e?.user);if(!g)return e.context.logger.error("Unable to get user info"),redirectOnError("unable_to_get_user_info");if(!d)throw e.context.logger.error("No callback URL found"),redirectOnError("no_callback_url");if(l){const t=e.context.options.account?.accountLinking?.trustedProviders,r=t?.includes(f.id);if(!r&&!g.emailVerified||!1===e.context.options.account?.accountLinking?.enabled)return e.context.logger.error("Unable to link account - untrusted provider"),redirectOnError("unable_to_link_account");const n=await e.context.internalAdapter.findAccount(g.id);if(n){if(n.userId.toString()!==l.userId.toString())return redirectOnError("account_already_linked_to_different_user");const t=Object.fromEntries(Object.entries({accessToken:await setTokenUtil(m.accessToken,e.context),refreshToken:await setTokenUtil(m.refreshToken,e.context),idToken:m.idToken,accessTokenExpiresAt:m.accessTokenExpiresAt,refreshTokenExpiresAt:m.refreshTokenExpiresAt,scope:m.scopes?.join(",")}).filter(([e,t])=>void 0!==t));await e.context.internalAdapter.updateAccount(n.id,t)}else{if(!await e.context.internalAdapter.createAccount({userId:l.userId,providerId:f.id,accountId:g.id,...m,accessToken:await setTokenUtil(m.accessToken,e.context),refreshToken:await setTokenUtil(m.refreshToken,e.context),scope:m.scopes?.join(",")},e))return redirectOnError("unable_to_link_account")}let i;try{i=d.toString()}catch{i=d}throw e.redirect(i)}if(!g.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),redirectOnError("email_not_found");const y=await handleOAuthUserInfo(e,{userInfo:{...g,email:g.email,name:g.name||g.email},account:{providerId:f.id,accountId:g.id,...m,scope:m.scopes?.join(",")},callbackURL:d,disableSignUp:f.disableImplicitSignUp&&!h||f.options?.disableSignUp,overrideUserInfo:f.options?.overrideUserInfoOnSignIn});if(y.error)return e.context.logger.error(y.error.split(" ").join("_")),redirectOnError(y.error.split(" ").join("_"));const{session:w,user:b}=y.data;let v;await setSessionCookie(e,{session:w,user:b});try{v=(y.isRegister&&p||d).toString()}catch{v=y.isRegister&&p||d}throw e.redirect(v)}),ks=os("/sign-out",{method:"POST",requireHeaders:!0,metadata:{openapi:{description:"Sign out the current user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{const t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)throw deleteSessionCookie(e),new h("BAD_REQUEST",{message:cs.FAILED_TO_GET_SESSION});return await e.context.internalAdapter.deleteSession(t),deleteSessionCookie(e),e.json({success:!0})});function redirectError(e,t,r){const n=t?new URL(t,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([e,t])=>n.searchParams.set(e,t)),n.href}const xs=os("/request-password-reset",{method:"POST",body:object({email:email().meta({description:"The email address of the user to send a password reset email to"}),redirectTo:string$1().meta({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"},message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!"),new h("BAD_REQUEST",{message:"Reset password isn't enabled"});const{email:t,redirectTo:r}=e.body,n=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)return e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"});const i=getDate(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||3600,"sec"),s=generateId(24);await e.context.internalAdapter.createVerificationValue({value:n.user.id,identifier:`reset-password:${s}`,expiresAt:i},e);const o=r?encodeURIComponent(r):"",a=`${e.context.baseURL}/reset-password/${s}?callbackURL=${o}`;return await e.context.options.emailAndPassword.sendResetPassword({user:n.user,url:a,token:s},e.request),e.json({status:!0})}),Ss=os("/forget-password",{method:"POST",body:object({email:string$1().email().meta({description:"The email address of the user to send a password reset email to"}),redirectTo:string$1().meta({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"},message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!"),new h("BAD_REQUEST",{message:"Reset password isn't enabled"});const{email:t,redirectTo:r}=e.body,n=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!n)return e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"});const i=getDate(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||3600,"sec"),s=generateId(24);await e.context.internalAdapter.createVerificationValue({value:n.user.id,identifier:`reset-password:${s}`,expiresAt:i},e);const o=r?encodeURIComponent(r):"",a=`${e.context.baseURL}/reset-password/${s}?callbackURL=${o}`;return await e.context.options.emailAndPassword.sendResetPassword({user:n.user,url:a,token:s},e.request),e.json({status:!0})}),_s=os("/reset-password/:token",{method:"GET",query:object({callbackURL:string$1().meta({description:"The URL to redirect the user to reset their password"})}),use:[originCheck(e=>e.query.callbackURL)],metadata:{openapi:{description:"Redirects the user to the callback URL with the token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async e=>{const{token:t}=e.params,{callbackURL:r}=e.query;if(!t||!r)throw e.redirect(redirectError(e.context,r,{error:"INVALID_TOKEN"}));const n=await e.context.internalAdapter.findVerificationValue(`reset-password:${t}`);if(!n||n.expiresAt<new Date)throw e.redirect(redirectError(e.context,r,{error:"INVALID_TOKEN"}));throw e.redirect(function(e,t,r){const n=new URL(t,e.baseURL);return r&&Object.entries(r).forEach(([e,t])=>n.searchParams.set(e,t)),n.href}(e.context,r,{token:t}))}),As=_s,Is=os("/reset-password",{method:"POST",query:object({token:string$1().optional()}).optional(),body:object({newPassword:string$1().meta({description:"The new password to set"}),token:string$1().meta({description:"The token to reset the password"}).optional()}),metadata:{openapi:{description:"Reset the password for a user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{const t=e.body.token||e.query?.token;if(!t)throw new h("BAD_REQUEST",{message:cs.INVALID_TOKEN});const{newPassword:r}=e.body,n=e.context.password?.config.minPasswordLength,i=e.context.password?.config.maxPasswordLength;if(r.length<n)throw new h("BAD_REQUEST",{message:cs.PASSWORD_TOO_SHORT});if(r.length>i)throw new h("BAD_REQUEST",{message:cs.PASSWORD_TOO_LONG});const s=`reset-password:${t}`,o=await e.context.internalAdapter.findVerificationValue(s);if(!o||o.expiresAt<new Date)throw new h("BAD_REQUEST",{message:cs.INVALID_TOKEN});const a=o.value,c=await e.context.password.hash(r);if((await e.context.internalAdapter.findAccounts(a)).find(e=>"credential"===e.providerId)?await e.context.internalAdapter.updatePassword(a,c,e):await e.context.internalAdapter.createAccount({userId:a,providerId:"credential",password:c,accountId:a},e),await e.context.internalAdapter.deleteVerificationValue(o.id),e.context.options.emailAndPassword?.onPasswordReset){const t=await e.context.internalAdapter.findUserById(a);t&&await e.context.options.emailAndPassword.onPasswordReset({user:t},e.request)}return e.context.options.emailAndPassword?.revokeSessionsOnPasswordReset&&await e.context.internalAdapter.deleteSessions(a),e.json({status:!0})}),Es=os("/change-password",{method:"POST",body:object({newPassword:string$1().meta({description:"The new password to set"}),currentPassword:string$1().meta({description:"The current password is required"}),revokeOtherSessions:boolean$2().meta({description:"Must be a boolean value"}).optional()}),use:[ds],metadata:{openapi:{description:"Change the password of the user",responses:{200:{description:"Password successfully changed",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"New session token if other sessions were revoked"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}}}}}},async e=>{const{newPassword:t,currentPassword:r,revokeOtherSessions:n}=e.body,i=e.context.session,s=e.context.password.config.minPasswordLength;if(t.length<s)throw e.context.logger.error("Password is too short"),new h("BAD_REQUEST",{message:cs.PASSWORD_TOO_SHORT});const o=e.context.password.config.maxPasswordLength;if(t.length>o)throw e.context.logger.error("Password is too long"),new h("BAD_REQUEST",{message:cs.PASSWORD_TOO_LONG});const a=(await e.context.internalAdapter.findAccounts(i.user.id)).find(e=>"credential"===e.providerId&&e.password);if(!a||!a.password)throw new h("BAD_REQUEST",{message:cs.CREDENTIAL_ACCOUNT_NOT_FOUND});const c=await e.context.password.hash(t);if(!await e.context.password.verify({hash:a.password,password:r}))throw new h("BAD_REQUEST",{message:cs.INVALID_PASSWORD});await e.context.internalAdapter.updateAccount(a.id,{password:c});let d=null;if(n){await e.context.internalAdapter.deleteSessions(i.user.id);const t=await e.context.internalAdapter.createSession(i.user.id,e);if(!t)throw new h("INTERNAL_SERVER_ERROR",{message:cs.FAILED_TO_GET_SESSION});await setSessionCookie(e,{session:t,user:i.user}),d=t.token}return e.json({token:d,user:{id:i.user.id,email:i.user.email,name:i.user.name,image:i.user.image,emailVerified:i.user.emailVerified,createdAt:i.user.createdAt,updatedAt:i.user.updatedAt}})}),Cs=os("/set-password",{method:"POST",body:object({newPassword:string$1().meta({description:"The new password to set is required"})}),metadata:{SERVER_ONLY:!0},use:[ds]},async e=>{const{newPassword:t}=e.body,r=e.context.session,n=e.context.password.config.minPasswordLength;if(t.length<n)throw e.context.logger.error("Password is too short"),new h("BAD_REQUEST",{message:cs.PASSWORD_TOO_SHORT});const i=e.context.password.config.maxPasswordLength;if(t.length>i)throw e.context.logger.error("Password is too long"),new h("BAD_REQUEST",{message:cs.PASSWORD_TOO_LONG});const s=(await e.context.internalAdapter.findAccounts(r.user.id)).find(e=>"credential"===e.providerId&&e.password),o=await e.context.password.hash(t);if(!s)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:o},e),e.json({status:!0});throw new h("BAD_REQUEST",{message:"user already has a password"})}),Os=os("/delete-user",{method:"POST",use:[ds],body:object({callbackURL:string$1().meta({description:"The callback URL to redirect to after the user is deleted"}).optional(),password:string$1().meta({description:"The password of the user is required to delete the user"}).optional(),token:string$1().meta({description:"The token to delete the user is required"}).optional()}),metadata:{openapi:{description:"Delete the user",responses:{200:{description:"User deletion processed successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the operation was successful"},message:{type:"string",enum:["User deleted","Verification email sent"],description:"Status message of the deletion process"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options",{session:e.context.session}),new h("NOT_FOUND");const t=e.context.session;if(e.body.password){const r=(await e.context.internalAdapter.findAccounts(t.user.id)).find(e=>"credential"===e.providerId&&e.password);if(!r||!r.password)throw new h("BAD_REQUEST",{message:cs.CREDENTIAL_ACCOUNT_NOT_FOUND});if(!await e.context.password.verify({hash:r.password,password:e.body.password}))throw new h("BAD_REQUEST",{message:cs.INVALID_PASSWORD})}if(e.body.token)return await Ps({...e,query:{token:e.body.token}}),e.json({success:!0,message:"User deleted"});if(e.context.options.user.deleteUser?.sendDeleteAccountVerification){const r=ki(32,"0-9","a-z");await e.context.internalAdapter.createVerificationValue({value:t.user.id,identifier:`delete-account-${r}`,expiresAt:new Date(Date.now()+1e3*(e.context.options.user.deleteUser?.deleteTokenExpiresIn||86400))},e);const n=`${e.context.baseURL}/delete-user/callback?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.deleteUser.sendDeleteAccountVerification({user:t.user,url:n,token:r},e.request),e.json({success:!0,message:"Verification email sent"})}if(!e.body.password&&0!==e.context.sessionConfig.freshAge){const r=t.session.createdAt.getTime(),n=1e3*e.context.sessionConfig.freshAge;if(Date.now()-r>1e3*n)throw new h("BAD_REQUEST",{message:cs.SESSION_EXPIRED})}const r=e.context.options.user.deleteUser?.beforeDelete;r&&await r(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),await e.context.internalAdapter.deleteAccounts(t.user.id),deleteSessionCookie(e);const n=e.context.options.user.deleteUser?.afterDelete;return n&&await n(t.user,e.request),e.json({success:!0,message:"User deleted"})}),Ps=os("/delete-user/callback",{method:"GET",query:object({token:string$1().meta({description:"The token to verify the deletion request"}),callbackURL:string$1().meta({description:"The URL to redirect to after deletion"}).optional()}),use:[originCheck(e=>e.query.callbackURL)],metadata:{openapi:{description:"Callback to complete user deletion with verification token",responses:{200:{description:"User successfully deleted",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the deletion was successful"},message:{type:"string",enum:["User deleted"],description:"Confirmation message"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new h("NOT_FOUND");const t=await getSessionFromCtx(e);if(!t)throw new h("NOT_FOUND",{message:cs.FAILED_TO_GET_USER_INFO});const r=await e.context.internalAdapter.findVerificationValue(`delete-account-${e.query.token}`);if(!r||r.expiresAt<new Date)throw new h("NOT_FOUND",{message:cs.INVALID_TOKEN});if(r.value!==t.user.id)throw new h("NOT_FOUND",{message:cs.INVALID_TOKEN});const n=e.context.options.user.deleteUser?.beforeDelete;n&&await n(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),await e.context.internalAdapter.deleteAccounts(t.user.id),await e.context.internalAdapter.deleteVerificationValue(r.id),deleteSessionCookie(e);const i=e.context.options.user.deleteUser?.afterDelete;if(i&&await i(t.user,e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL||"/");return e.json({success:!0,message:"User deleted"})}),Rs=os("/change-email",{method:"POST",body:object({newEmail:email().meta({description:"The new email address to set must be a valid email address"}),callbackURL:string$1().meta({description:"The URL to redirect to after email verification"}).optional()}),use:[ds],metadata:{openapi:{responses:{200:{description:"Email change request processed successfully",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the request was successful"},message:{type:"string",enum:["Email updated","Verification email sent"],description:"Status message of the email change process",nullable:!0}},required:["status"]}}}}}}}},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new h("BAD_REQUEST",{message:"Change email is disabled"});const t=e.body.newEmail.toLowerCase();if(t===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new h("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(t))throw e.context.logger.error("Email already exists"),new h("BAD_REQUEST",{message:"Couldn't update your email"});if(!0!==e.context.session.user.emailVerified){if(await e.context.internalAdapter.findUserByEmail(t))throw new h("UNPROCESSABLE_ENTITY",{message:cs.USER_ALREADY_EXISTS});if(await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:t},e),await setSessionCookie(e,{session:e.context.session.session,user:{...e.context.session.user,email:t}}),e.context.options.emailVerification?.sendVerificationEmail){const r=await createEmailVerificationToken(e.context.secret,t,void 0,e.context.options.emailVerification?.expiresIn),n=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:{...e.context.session.user,email:t},url:n,token:r},e.request)}return e.json({status:!0})}if(!e.context.options.user.changeEmail.sendChangeEmailVerification)throw e.context.logger.error("Verification email isn't enabled."),new h("BAD_REQUEST",{message:"Verification email isn't enabled"});const r=await createEmailVerificationToken(e.context.secret,e.context.session.user.email,t,e.context.options.emailVerification?.expiresIn),n=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.changeEmail.sendChangeEmailVerification({user:e.context.session.user,newEmail:t,url:n,token:r},e.request),e.json({status:!0})});const $s=os("/error",{method:"GET",metadata:{...gs,openapi:{description:"Displays an error page",responses:{200:{description:"Success",content:{"text/html":{schema:{type:"string",description:"The HTML content of the error page"}}}}}}}},async e=>{const t=new URL(e.request?.url||"").searchParams.get("error")||"Unknown";return new Response(((e="Unknown")=>{return`<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Authentication Error</title>\n    <style>\n        :root {\n            --bg-color: #f8f9fa;\n            --text-color: #212529;\n            --accent-color: #000000;\n            --error-color: #dc3545;\n            --border-color: #e9ecef;\n        }\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n            background-color: var(--bg-color);\n            color: var(--text-color);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            height: 100vh;\n            margin: 0;\n            line-height: 1.5;\n        }\n        .error-container {\n            background-color: #ffffff;\n            border-radius: 12px;\n            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);\n            padding: 2.5rem;\n            text-align: center;\n            max-width: 90%;\n            width: 400px;\n        }\n        h1 {\n            color: var(--error-color);\n            font-size: 1.75rem;\n            margin-bottom: 1rem;\n            font-weight: 600;\n        }\n        p {\n            margin-bottom: 1.5rem;\n            color: #495057;\n        }\n        .btn {\n            background-color: var(--accent-color);\n            color: #ffffff;\n            text-decoration: none;\n            padding: 0.75rem 1.5rem;\n            border-radius: 6px;\n            transition: all 0.3s ease;\n            display: inline-block;\n            font-weight: 500;\n            border: 2px solid var(--accent-color);\n        }\n        .btn:hover {\n            background-color: #131721;\n        }\n        .error-code {\n            font-size: 0.875rem;\n            color: #6c757d;\n            margin-top: 1.5rem;\n            padding-top: 1.5rem;\n            border-top: 1px solid var(--border-color);\n        }\n        .icon {\n            font-size: 3rem;\n            margin-bottom: 1rem;\n        }\n    </style>\n</head>\n<body>\n    <div class="error-container">\n        <div class="icon">⚠️</div>\n        <h1>Better Auth Error</h1>\n        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>\n        <a href="/" id="returnLink" class="btn">Return to Application</a>\n        <div class="error-code">Error Code: <span id="errorCode">${t=e,t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}</span></div>\n    </div>\n</body>\n</html>`;var t})(t),{headers:{"Content-Type":"text/html"}})}),Bs=os("/ok",{method:"GET",metadata:{...gs,openapi:{description:"Check if the API is working",responses:{200:{description:"API is working",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean",description:"Indicates if the API is working"}},required:["ok"]}}}}}}}},async e=>e.json({ok:!0})),Us=os("/list-accounts",{method:"GET",use:[ds],metadata:{openapi:{description:"List all accounts linked to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string"},provider:{type:"string"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}},accountId:{type:"string"},scopes:{type:"array",items:{type:"string"}}},required:["id","provider","createdAt","updatedAt","accountId","scopes"]}}}}}}}},async e=>{const t=e.context.session,r=await e.context.internalAdapter.findAccounts(t.user.id);return e.json(r.map(e=>({id:e.id,provider:e.providerId,createdAt:e.createdAt,updatedAt:e.updatedAt,accountId:e.accountId,scopes:e.scope?.split(",")||[]})))}),Ls=os("/link-social",{method:"POST",requireHeaders:!0,body:object({callbackURL:string$1().meta({description:"The URL to redirect to after the user has signed in"}).optional(),provider:ws,idToken:object({token:string$1(),nonce:string$1().optional(),accessToken:string$1().optional(),refreshToken:string$1().optional(),scopes:array(string$1()).optional()}).optional(),requestSignUp:boolean$2().optional(),scopes:array(string$1()).meta({description:"Additional scopes to request from the provider"}).optional(),errorCallbackURL:string$1().meta({description:"The URL to redirect to if there is an error during the link process"}).optional()}),use:[ds],metadata:{openapi:{description:"Link a social account to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string",description:"The authorization URL to redirect the user to"},redirect:{type:"boolean",description:"Indicates if the user should be redirected to the authorization URL"},status:{type:"boolean"}},required:["redirect"]}}}}}}}},async e=>{const t=e.context.session,r=e.context.socialProviders.find(t=>t.id===e.body.provider);if(!r)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new h("NOT_FOUND",{message:cs.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!r.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new h("NOT_FOUND",{message:cs.ID_TOKEN_NOT_SUPPORTED});const{token:n,nonce:i}=e.body.idToken;if(!await r.verifyIdToken(n,i))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new h("UNAUTHORIZED",{message:cs.INVALID_TOKEN});const s=await r.getUserInfo({idToken:n,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!s||!s?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new h("UNAUTHORIZED",{message:cs.FAILED_TO_GET_USER_INFO});if(!s.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new h("UNAUTHORIZED",{message:cs.USER_EMAIL_NOT_FOUND});if((await e.context.internalAdapter.findAccounts(t.user.id)).find(e=>e.providerId===r.id&&e.accountId===s.user.id))return e.json({redirect:!1,url:"",status:!0});const o=e.context.options.account?.accountLinking?.trustedProviders,a=o?.includes(r.id);if(!a&&!s.user.emailVerified||!1===e.context.options.account?.accountLinking?.enabled)throw new h("UNAUTHORIZED",{message:"Account not linked - linking not allowed"});if(s.user.email!==t.user.email&&!0!==e.context.options.account?.accountLinking?.allowDifferentEmails)throw new h("UNAUTHORIZED",{message:"Account not linked - different emails not allowed"});try{await e.context.internalAdapter.createAccount({userId:t.user.id,providerId:r.id,accountId:s.user.id.toString(),accessToken:e.body.idToken.accessToken,idToken:n,refreshToken:e.body.idToken.refreshToken,scope:e.body.idToken.scopes?.join(",")},e)}catch(e){throw new h("EXPECTATION_FAILED",{message:"Account not linked - unable to create account"})}if(!0===e.context.options.account?.accountLinking?.updateUserInfoOnLink)try{await e.context.internalAdapter.updateUser(t.user.id,{name:s.user?.name,image:s.user?.image})}catch(e){console.warn("Could not update user - "+e.toString())}return e.json({redirect:!1,url:"",status:!0})}const n=await generateState(e,{userId:t.user.id,email:t.user.email}),i=await r.createAuthorizationURL({state:n.state,codeVerifier:n.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${r.id}`,scopes:e.body.scopes});return e.json({url:i.toString(),redirect:!0})}),zs=os("/unlink-account",{method:"POST",body:object({providerId:string$1(),accountId:string$1().optional()}),use:[ls],metadata:{openapi:{description:"Unlink an account",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{const{providerId:t,accountId:r}=e.body,n=await e.context.internalAdapter.findAccounts(e.context.session.user.id);if(1===n.length&&!e.context.options.account?.accountLinking?.allowUnlinkingAll)throw new h("BAD_REQUEST",{message:cs.FAILED_TO_UNLINK_LAST_ACCOUNT});const i=n.find(e=>r?e.accountId===r&&e.providerId===t:e.providerId===t);if(!i)throw new h("BAD_REQUEST",{message:cs.ACCOUNT_NOT_FOUND});return await e.context.internalAdapter.deleteAccount(i.id),e.json({status:!0})}),Ds=os("/get-access-token",{method:"POST",body:object({providerId:string$1().meta({description:"The provider ID for the OAuth provider"}),accountId:string$1().meta({description:"The account ID associated with the refresh token"}).optional(),userId:string$1().meta({description:"The user ID associated with the account"}).optional()}),metadata:{openapi:{description:"Get a valid access token, doing a refresh if needed",responses:{200:{description:"A Valid access token",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{const{providerId:t,accountId:r,userId:n}=e.body,i=e.request,s=await getSessionFromCtx(e);if(i&&!s)throw e.error("UNAUTHORIZED");let o=s?.user?.id||n;if(!o)throw new h("BAD_REQUEST",{message:"Either userId or session is required"});if(!e.context.socialProviders.find(e=>e.id===t))throw new h("BAD_REQUEST",{message:`Provider ${t} is not supported.`});const a=(await e.context.internalAdapter.findAccounts(o)).find(e=>r?e.id===r&&e.providerId===t:e.providerId===t);if(!a)throw new h("BAD_REQUEST",{message:"Account not found"});const c=e.context.socialProviders.find(e=>e.id===t);if(!c)throw new h("BAD_REQUEST",{message:`Provider ${t} not found.`});try{let t=null;a.refreshToken&&(!a.accessTokenExpiresAt||a.accessTokenExpiresAt.getTime()-Date.now()<5e3)&&c.refreshAccessToken&&(t=await c.refreshAccessToken(a.refreshToken),await e.context.internalAdapter.updateAccount(a.id,{accessToken:await setTokenUtil(t.accessToken,e.context),accessTokenExpiresAt:t.accessTokenExpiresAt,refreshToken:await setTokenUtil(t.refreshToken,e.context),refreshTokenExpiresAt:t.refreshTokenExpiresAt}));const r={accessToken:await getAccessTokenUtil(t?.accessToken??a.accessToken??"",e.context),accessTokenExpiresAt:t?.accessTokenExpiresAt??a.accessTokenExpiresAt??void 0,scopes:a.scope?.split(",")??[],idToken:t?.idToken??a.idToken??void 0};return e.json(r)}catch(e){throw new h("BAD_REQUEST",{message:"Failed to get a valid access token",cause:e})}}),qs=os("/refresh-token",{method:"POST",body:object({providerId:string$1().meta({description:"The provider ID for the OAuth provider"}),accountId:string$1().meta({description:"The account ID associated with the refresh token"}).optional(),userId:string$1().meta({description:"The user ID associated with the account"}).optional()}),metadata:{openapi:{description:"Refresh the access token using a refresh token",responses:{200:{description:"Access token refreshed successfully",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{const{providerId:t,accountId:r,userId:n}=e.body,i=e.request,s=await getSessionFromCtx(e);if(i&&!s)throw e.error("UNAUTHORIZED");let o=s?.user?.id||n;if(!o)throw new h("BAD_REQUEST",{message:"Either userId or session is required"});const a=(await e.context.internalAdapter.findAccounts(o)).find(e=>r?e.id===r&&e.providerId===t:e.providerId===t);if(!a)throw new h("BAD_REQUEST",{message:"Account not found"});const c=e.context.socialProviders.find(e=>e.id===t);if(!c)throw new h("BAD_REQUEST",{message:`Provider ${t} not found.`});if(!c.refreshAccessToken)throw new h("BAD_REQUEST",{message:`Provider ${t} does not support token refreshing.`});try{const t=await c.refreshAccessToken(a.refreshToken);return await e.context.internalAdapter.updateAccount(a.id,{accessToken:await setTokenUtil(t.accessToken,e.context),refreshToken:await setTokenUtil(t.refreshToken,e.context),accessTokenExpiresAt:t.accessTokenExpiresAt,refreshTokenExpiresAt:t.refreshTokenExpiresAt}),e.json(t)}catch(e){throw new h("BAD_REQUEST",{message:"Failed to refresh access token",cause:e})}}),Ws=os("/account-info",{method:"POST",use:[ds],metadata:{openapi:{description:"Get the account info provided by the provider",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",properties:{id:{type:"string"},name:{type:"string"},email:{type:"string"},image:{type:"string"},emailVerified:{type:"boolean"}},required:["id","emailVerified"]},data:{type:"object",properties:{},additionalProperties:!0}},required:["user","data"],additionalProperties:!1}}}}}}},body:object({accountId:string$1().meta({description:"The provider given account id for which to get the account info"})})},async e=>{const t=await e.context.internalAdapter.findAccount(e.body.accountId);if(!t||t.userId!==e.context.session.user.id)throw new h("BAD_REQUEST",{message:"Account not found"});const r=e.context.socialProviders.find(e=>e.id===t.providerId);if(!r)throw new h("INTERNAL_SERVER_ERROR",{message:`Provider account provider is ${t.providerId} but it is not configured`});const n=await Ds({...e,body:{accountId:t.id,providerId:t.providerId},returnHeaders:!1}),i=await r.getUserInfo(n);return e.json(i)});function getIp(e,t){if(t.advanced?.ipAddress?.disableIpTracking)return null;if(Vi)return"127.0.0.1";const r="headers"in e?e.headers:e,n=t.advanced?.ipAddress?.ipAddressHeaders||["x-forwarded-for"];for(const e of n){const t="get"in r?r.get(e):r[e];if("string"==typeof t){const e=t.split(",")[0].trim();if(isValidIP(e))return e}}return null}function isValidIP(e){if(/^(\d{1,3}\.){3}\d{1,3}$/.test(e)){return e.split(".").map(Number).every(e=>e>=0&&e<=255)}return/^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(e)}const js=new Map;function getRateLimitStorage(e){if(e.options.rateLimit?.customStorage)return e.options.rateLimit.customStorage;if("secondary-storage"===e.rateLimit.storage)return{get:async t=>{const r=await(e.options.secondaryStorage?.get(t));return r?JSON.parse(r):void 0},set:async(t,r)=>{await(e.options.secondaryStorage?.set?.(t,JSON.stringify(r)))}};return"memory"===e.rateLimit.storage?{get:async e=>js.get(e),async set(e,t,r){js.set(e,t)}}:function(e){const t=e.options.rateLimit?.modelName||"rateLimit",r=e.adapter;return{get:async e=>{const n=(await r.findMany({model:t,where:[{field:"key",value:e}]}))[0];return"bigint"==typeof n?.lastRequest&&(n.lastRequest=Number(n.lastRequest)),n},set:async(t,n,i)=>{try{i?await r.updateMany({model:"rateLimit",where:[{field:"key",value:t}],update:{count:n.count,lastRequest:n.lastRequest}}):await r.create({model:"rateLimit",data:{key:t,count:n.count,lastRequest:n.lastRequest}})}catch(t){e.logger.error("Error setting rate limit",t)}}}}(e)}async function onRequestRateLimit(e,t){if(!t.rateLimit.enabled)return;const r=new URL(e.url).pathname.replace(t.options.basePath||"/api/auth","");let n=t.rateLimit.window,i=t.rateLimit.max;const s=getIp(e,t.options);if(!s)return void console.warn("No IP address found for rate limiting");const o=s+r,a=function(){const e=[{pathMatcher:e=>e.startsWith("/sign-in")||e.startsWith("/sign-up")||e.startsWith("/change-password")||e.startsWith("/change-email"),window:10,max:3}];return e}(),c=a.find(e=>e.pathMatcher(r));c&&(n=c.window,i=c.max);for(const e of t.options.plugins||[])if(e.rateLimit){const t=e.rateLimit.find(e=>e.pathMatcher(r));if(t){n=t.window,i=t.max;break}}if(t.rateLimit.customRules){const s=Object.keys(t.rateLimit.customRules).find(e=>{if(e.includes("*")){return wildcardMatch(e)(r)}return e===r});if(s){const r=t.rateLimit.customRules[s],o="function"==typeof r?await r(e):r;o&&(n=o.window,i=o.max)}}const d=getRateLimitStorage(t),l=await d.get(o),u=Date.now();if(l){const e=u-l.lastRequest;if(function(e,t,r){const n=1e3*t;return Date.now()-r.lastRequest<n&&r.count>=e}(i,n,l)){const e=function(e,t){const r=Date.now(),n=1e3*t;return Math.ceil((e+n-r)/1e3)}(l.lastRequest,n);return function(e){return new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests",headers:{"X-Retry-After":e.toString()}})}(e)}e>1e3*n?await d.set(o,{...l,count:1,lastRequest:u},!0):await d.set(o,{...l,count:l.count+1,lastRequest:u},!0)}else await d.set(o,{key:o,count:1,lastRequest:u})}async function runBeforeHooks(e,t){let r={};for(const i of t)if(i.matcher(e)){const t=await i.handler({...e,returnHeaders:!1});if(t&&"object"==typeof t){if("context"in t&&"object"==typeof t.context){const{headers:e,...i}=t.context;e instanceof Headers&&(r.headers?e.forEach((e,t)=>{r.headers?.set(t,e)}):r.headers=e),r=n(i,r);continue}return t}}return{context:r}}async function runAfterHooks(e,t){for(const r of t)if(r.matcher(e)){const t=await r.handler(e).catch(e=>{if(e instanceof h)return{response:e,headers:e.headers?new Headers(e.headers):null};throw e});t.headers&&t.headers.forEach((t,r)=>{e.context.responseHeaders?"set-cookie"===r.toLowerCase()?e.context.responseHeaders.append(r,t):e.context.responseHeaders.set(r,t):e.context.responseHeaders=new Headers({[r]:t})}),t.response&&(e.context.returned=t.response)}return{response:e.context.returned,headers:e.context.responseHeaders}}function getHooks(e){const t=e.options.plugins||[],r=[],n=[];e.options.hooks?.before&&r.push({matcher:()=>!0,handler:e.options.hooks.before}),e.options.hooks?.after&&n.push({matcher:()=>!0,handler:e.options.hooks.after});const i=t.map(e=>{if(e.hooks?.before)return e.hooks.before}).filter(e=>void 0!==e).flat(),s=t.map(e=>{if(e.hooks?.after)return e.hooks.after}).filter(e=>void 0!==e).flat();return i.length&&r.push(...i),s.length&&n.push(...s),{beforeHooks:r,afterHooks:n}}function getEndpoints(e,t){const r=t.plugins?.reduce((e,t)=>({...e,...t.endpoints}),{}),i=t.plugins?.map(t=>t.middlewares?.map(t=>{const middleware=async r=>t.middleware({...r,context:{...e,...r.context}});return middleware.options=t.middleware.options,{path:t.path,middleware:middleware}})).filter(e=>void 0!==e).flat()||[],s={signInSocial:bs,callbackOAuth:Ts,getSession:getSession(),signOut:ks,signUpEmail:os("/sign-up/email",{method:"POST",body:record(string$1(),any()),metadata:{$Infer:{body:{}},openapi:{description:"Sign up a user using email and password",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},email:{type:"string",description:"The email of the user"},password:{type:"string",description:"The password of the user"},image:{type:"string",description:"The profile image URL of the user"},callbackURL:{type:"string",description:"The URL to use for email verification callback"},rememberMe:{type:"boolean",description:"If this is false, the session will not be remembered. Default is `true`."}},required:["name","email","password"]}}}},responses:{200:{description:"Successfully created user",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"Authentication token for the session"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.enabled||e.context.options.emailAndPassword?.disableSignUp)throw new h("BAD_REQUEST",{message:"Email and password sign up is not enabled"});const t=e.body,{name:r,email:n,password:i,image:s,callbackURL:o,rememberMe:a,...c}=t;if(!email().safeParse(n).success)throw new h("BAD_REQUEST",{message:cs.INVALID_EMAIL});const d=e.context.password.config.minPasswordLength;if(i.length<d)throw e.context.logger.error("Password is too short"),new h("BAD_REQUEST",{message:cs.PASSWORD_TOO_SHORT});const l=e.context.password.config.maxPasswordLength;if(i.length>l)throw e.context.logger.error("Password is too long"),new h("BAD_REQUEST",{message:cs.PASSWORD_TOO_LONG});const u=await e.context.internalAdapter.findUserByEmail(n);if(u?.user)throw e.context.logger.info(`Sign-up attempt for existing email: ${n}`),new h("UNPROCESSABLE_ENTITY",{message:cs.USER_ALREADY_EXISTS});const p=parseUserInput(e.context.options,c),f=await e.context.password.hash(i);let m;try{if(m=await e.context.internalAdapter.createUser({email:n.toLowerCase(),name:r,image:s,...p,emailVerified:!1},e),!m)throw new h("BAD_REQUEST",{message:cs.FAILED_TO_CREATE_USER})}catch(t){if(Qi&&e.context.logger.error("Failed to create user",t),t instanceof h)throw t;throw new h("UNPROCESSABLE_ENTITY",{message:cs.FAILED_TO_CREATE_USER,details:t})}if(!m)throw new h("UNPROCESSABLE_ENTITY",{message:cs.FAILED_TO_CREATE_USER});if(await e.context.internalAdapter.linkAccount({userId:m.id,providerId:"credential",accountId:m.id,password:f},e),e.context.options.emailVerification?.sendOnSignUp||e.context.options.emailAndPassword.requireEmailVerification){const r=await createEmailVerificationToken(e.context.secret,m.email,void 0,e.context.options.emailVerification?.expiresIn),n=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${t.callbackURL||"/"}`;await(e.context.options.emailVerification?.sendVerificationEmail?.({user:m,url:n,token:r},e.request))}if(!1===e.context.options.emailAndPassword.autoSignIn||e.context.options.emailAndPassword.requireEmailVerification)return e.json({token:null,user:{id:m.id,email:m.email,name:m.name,image:m.image,emailVerified:m.emailVerified,createdAt:m.createdAt,updatedAt:m.updatedAt}});const g=await e.context.internalAdapter.createSession(m.id,e,!1===a);if(!g)throw new h("BAD_REQUEST",{message:cs.FAILED_TO_CREATE_SESSION});return await setSessionCookie(e,{session:g,user:m},!1===a),e.json({token:g.token,user:{id:m.id,email:m.email,name:m.name,image:m.image,emailVerified:m.emailVerified,createdAt:m.createdAt,updatedAt:m.updatedAt}})}),signInEmail:vs,forgetPassword:Ss,resetPassword:Is,verifyEmail:ms,sendVerificationEmail:fs,changeEmail:Rs,changePassword:Es,setPassword:Cs,updateUser:os("/update-user",{method:"POST",body:record(string$1().meta({description:"Field name must be a string"}),any()),use:[ds],metadata:{$Infer:{body:{}},openapi:{description:"Update the current user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user"}}}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the update was successful"}}}}}}}}}},async e=>{const t=e.body;if(t.email)throw new h("BAD_REQUEST",{message:cs.EMAIL_CAN_NOT_BE_UPDATED});const{name:r,image:n,...i}=t,s=e.context.session;if(void 0===n&&void 0===r&&0===Object.keys(i).length)return e.json({status:!0});const o=parseUserInput(e.context.options,i,"update"),a=await e.context.internalAdapter.updateUser(s.user.id,{name:r,image:n,...o},e);return await setSessionCookie(e,{session:s.session,user:a}),e.json({status:!0})}),deleteUser:Os,forgetPasswordCallback:As,requestPasswordReset:xs,requestPasswordResetCallback:_s,listSessions:os("/list-sessions",{method:"GET",use:[ds],requireHeaders:!0,metadata:{openapi:{description:"List all active sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}}}}}},async e=>{try{const t=(await e.context.internalAdapter.listSessions(e.context.session.user.id)).filter(e=>e.expiresAt>new Date);return e.json(t)}catch(t){throw e.context.logger.error(t),e.error("INTERNAL_SERVER_ERROR")}}),revokeSession:us,revokeSessions:ps,revokeOtherSessions:hs,linkSocialAccount:Ls,listUserAccounts:Us,deleteUserCallback:Ps,unlinkAccount:zs,refreshToken:qs,getAccessToken:Ds,accountInfo:Ws},o=function(e,t){const r={};for(const[i,s]of Object.entries(e))r[i]=async e=>{const r=await t;let i={...e,context:{...r,returned:void 0,responseHeaders:void 0,session:null},path:s.path,headers:e?.headers?new Headers(e?.headers):void 0};const{beforeHooks:o,afterHooks:a}=getHooks(r),c=await runBeforeHooks(i,o);if("context"in c&&c.context&&"object"==typeof c.context){const{headers:e,...t}=c.context;e&&e.forEach((e,t)=>{i.headers.set(t,e)}),i=n(t,i)}else if(c)return c;i.asResponse=!1,i.returnHeaders=!0;const d=await s(i).catch(e=>{if(e instanceof h)return{response:e,headers:e.headers?new Headers(e.headers):null};throw e});i.context.returned=d.response,i.context.responseHeaders=d.headers;const l=await runAfterHooks(i,a);if(l.response&&(d.response=l.response),d.response instanceof h&&!e?.asResponse)throw d.response;return e?.asResponse?toResponse(d.response,{headers:d.headers}):e?.returnHeaders?{headers:d.headers,response:d.response}:d.response},r[i].path=s.path,r[i].options=s.options;return r}({...s,...r,ok:Bs,error:$s},e);return{api:o,middlewares:i}}const getAuthTables=e=>{const t=e.plugins?.reduce((e,t)=>{const r=t.schema;if(!r)return e;for(const[t,n]of Object.entries(r))e[t]={fields:{...e[t]?.fields,...n.fields},modelName:n.modelName||t};return e},{}),r="database"===e.rateLimit?.storage,n={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",bigint:!0,fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:i,session:s,account:o,...a}=t||{},c={session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...s?.fields,...e.session?.additionalFields},order:2}};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name",sortable:!0},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email",sortable:!0},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...i?.fields,...e.user?.additionalFields},order:1},...!e.secondaryStorage||e.session?.storeSessionInDatabase?c:{},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...o?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...a,...r?n:{}}};function isUndefined(e){return void 0===e||void 0===e}function isString(e){return"string"==typeof e}function isNumber(e){return"number"==typeof e}function isBoolean(e){return"boolean"==typeof e}function isNull$1(e){return null===e}function isDate(e){return e instanceof Date}function isBigInt(e){return"bigint"==typeof e}function isFunction(e){return"function"==typeof e}function isObject(e){return"object"==typeof e&&null!==e}function freeze(e){return Object.freeze(e)}function asArray(e){return isReadonlyArray(e)?e:[e]}function isReadonlyArray(e){return Array.isArray(e)}function noop$2(e){return e}const Ms=freeze({is:e=>"AlterTableNode"===e.kind,create:e=>freeze({kind:"AlterTableNode",table:e}),cloneWithTableProps:(e,t)=>freeze({...e,...t}),cloneWithColumnAlteration:(e,t)=>freeze({...e,columnAlterations:e.columnAlterations?[...e.columnAlterations,t]:[t]})}),Qs=freeze({is:e=>"IdentifierNode"===e.kind,create:e=>freeze({kind:"IdentifierNode",name:e})}),Vs=freeze({is:e=>"CreateIndexNode"===e.kind,create:e=>freeze({kind:"CreateIndexNode",name:Qs.create(e)}),cloneWith:(e,t)=>freeze({...e,...t}),cloneWithColumns:(e,t)=>freeze({...e,columns:[...e.columns||[],...t]})}),Fs=freeze({is:e=>"CreateSchemaNode"===e.kind,create:(e,t)=>freeze({kind:"CreateSchemaNode",schema:Qs.create(e),...t}),cloneWith:(e,t)=>freeze({...e,...t})}),Js=["preserve rows","delete rows","drop"],Ks=freeze({is:e=>"CreateTableNode"===e.kind,create:e=>freeze({kind:"CreateTableNode",table:e,columns:freeze([])}),cloneWithColumn:(e,t)=>freeze({...e,columns:freeze([...e.columns,t])}),cloneWithConstraint:(e,t)=>freeze({...e,constraints:e.constraints?freeze([...e.constraints,t]):freeze([t])}),cloneWithFrontModifier:(e,t)=>freeze({...e,frontModifiers:e.frontModifiers?freeze([...e.frontModifiers,t]):freeze([t])}),cloneWithEndModifier:(e,t)=>freeze({...e,endModifiers:e.endModifiers?freeze([...e.endModifiers,t]):freeze([t])}),cloneWith:(e,t)=>freeze({...e,...t})}),Hs=freeze({is:e=>"SchemableIdentifierNode"===e.kind,create:e=>freeze({kind:"SchemableIdentifierNode",identifier:Qs.create(e)}),createWithSchema:(e,t)=>freeze({kind:"SchemableIdentifierNode",schema:Qs.create(e),identifier:Qs.create(t)})}),Zs=freeze({is:e=>"DropIndexNode"===e.kind,create:(e,t)=>freeze({kind:"DropIndexNode",name:Hs.create(e),...t}),cloneWith:(e,t)=>freeze({...e,...t})}),Gs=freeze({is:e=>"DropSchemaNode"===e.kind,create:(e,t)=>freeze({kind:"DropSchemaNode",schema:Qs.create(e),...t}),cloneWith:(e,t)=>freeze({...e,...t})}),Ys=freeze({is:e=>"DropTableNode"===e.kind,create:(e,t)=>freeze({kind:"DropTableNode",table:e,...t}),cloneWith:(e,t)=>freeze({...e,...t})}),Xs=freeze({is:e=>"AliasNode"===e.kind,create:(e,t)=>freeze({kind:"AliasNode",node:e,alias:t})}),eo=freeze({is:e=>"TableNode"===e.kind,create:e=>freeze({kind:"TableNode",table:Hs.create(e)}),createWithSchema:(e,t)=>freeze({kind:"TableNode",table:Hs.createWithSchema(e,t)})});function isOperationNodeSource(e){return isObject(e)&&isFunction(e.toOperationNode)}function isExpression(e){return isObject(e)&&"expressionType"in e&&isOperationNodeSource(e)}const to=freeze({is:e=>"SelectModifierNode"===e.kind,create:(e,t)=>freeze({kind:"SelectModifierNode",modifier:e,of:t}),createWithExpression:e=>freeze({kind:"SelectModifierNode",rawModifier:e})}),ro=freeze({is:e=>"AndNode"===e.kind,create:(e,t)=>freeze({kind:"AndNode",left:e,right:t})}),no=freeze({is:e=>"OrNode"===e.kind,create:(e,t)=>freeze({kind:"OrNode",left:e,right:t})}),io=freeze({is:e=>"OnNode"===e.kind,create:e=>freeze({kind:"OnNode",on:e}),cloneWithOperation:(e,t,r)=>freeze({...e,on:"And"===t?ro.create(e.on,r):no.create(e.on,r)})}),so=freeze({is:e=>"JoinNode"===e.kind,create:(e,t)=>freeze({kind:"JoinNode",joinType:e,table:t,on:void 0}),createWithOn:(e,t,r)=>freeze({kind:"JoinNode",joinType:e,table:t,on:io.create(r)}),cloneWithOn:(e,t)=>freeze({...e,on:e.on?io.cloneWithOperation(e.on,"And",t):io.create(t)})}),oo=freeze({is:e=>"BinaryOperationNode"===e.kind,create:(e,t,r)=>freeze({kind:"BinaryOperationNode",leftOperand:e,operator:t,rightOperand:r})}),ao=["->","->>"],co=["not","-","exists","not exists"],lo=[...["=","==","!=","<>",">",">=","<","<=","in","not in","is","is not","like","not like","match","ilike","not ilike","@>","<@","^@","&&","?","?&","?|","!<","!>","<=>","!~","~","~*","!~*","@@","@@@","!!","<->","regexp","is distinct from","is not distinct from","+","-","*","/","%","^","&","|","#","<<",">>","&&","||"],...ao,...co,"between","between symmetric"],uo=freeze({is:e=>"OperatorNode"===e.kind,create:e=>freeze({kind:"OperatorNode",operator:e})});function isJSONOperator(e){return isString(e)&&ao.includes(e)}const po=freeze({is:e=>"ColumnNode"===e.kind,create:e=>freeze({kind:"ColumnNode",column:Qs.create(e)})}),ho=freeze({is:e=>"SelectAllNode"===e.kind,create:()=>freeze({kind:"SelectAllNode"})}),fo=freeze({is:e=>"ReferenceNode"===e.kind,create:(e,t)=>freeze({kind:"ReferenceNode",table:t,column:e}),createSelectAll:e=>freeze({kind:"ReferenceNode",table:e,column:ho.create()})});class DynamicReferenceBuilder{#e;get dynamicReference(){return this.#e}get refType(){}constructor(e){this.#e=e}toOperationNode(){return parseSimpleReferenceExpression(this.#e)}}function isDynamicReferenceBuilder(e){return isObject(e)&&isOperationNodeSource(e)&&isString(e.dynamicReference)}const mo=freeze({is:e=>"OrderByItemNode"===e.kind,create:(e,t)=>freeze({kind:"OrderByItemNode",orderBy:e,direction:t}),cloneWith:(e,t)=>freeze({...e,...t})}),yo=freeze({is:e=>"RawNode"===e.kind,create:(e,t)=>freeze({kind:"RawNode",sqlFragments:freeze(e),parameters:freeze(t)}),createWithSql:e=>yo.create([e],[]),createWithChild:e=>yo.create(["",""],[e]),createWithChildren:e=>yo.create(new Array(e.length+1).fill(""),e)}),wo={is:e=>"CollateNode"===e.kind,create:e=>freeze({kind:"CollateNode",collation:Qs.create(e)})};class OrderByItemBuilder{#t;constructor(e){this.#t=freeze(e)}desc(){return new OrderByItemBuilder({node:mo.cloneWith(this.#t.node,{direction:yo.createWithSql("desc")})})}asc(){return new OrderByItemBuilder({node:mo.cloneWith(this.#t.node,{direction:yo.createWithSql("asc")})})}nullsLast(){return new OrderByItemBuilder({node:mo.cloneWith(this.#t.node,{nulls:"last"})})}nullsFirst(){return new OrderByItemBuilder({node:mo.cloneWith(this.#t.node,{nulls:"first"})})}collate(e){return new OrderByItemBuilder({node:mo.cloneWith(this.#t.node,{collation:wo.create(e)})})}toOperationNode(){return this.#t.node}}const bo=new Set;function logOnce(e){bo.has(e)||(bo.add(e),console.log(e))}function isOrderByDirection(e){return"asc"===e||"desc"===e}function parseOrderBy(e){if(2===e.length)return[parseOrderByItem(e[0],e[1])];if(1===e.length){const[t]=e;return Array.isArray(t)?(logOnce("orderBy(array) is deprecated, use multiple orderBy calls instead."),t.map(e=>parseOrderByItem(e))):[parseOrderByItem(t)]}throw new Error(`Invalid number of arguments at order by! expected 1-2, received ${e.length}`)}function parseOrderByItem(e,t){const r=function(e){if(isExpressionOrFactory(e))return parseExpression(e);if(isDynamicReferenceBuilder(e))return e.toOperationNode();const[t,r]=e.split(" ");if(r)return logOnce("`orderBy('column asc')` is deprecated. Use `orderBy('column', 'asc')` instead."),parseOrderByWithModifiers(parseStringReference(t),r);return parseStringReference(e)}(e);if(mo.is(r)){if(t)throw new Error("Cannot specify direction twice!");return r}return parseOrderByWithModifiers(r,t)}function parseOrderByWithModifiers(e,t){if("string"==typeof t){if(!isOrderByDirection(t))throw new Error(`Invalid order by direction: ${t}`);return mo.create(e,yo.createWithSql(t))}if(isExpression(t))return logOnce("`orderBy(..., expr)` is deprecated. Use `orderBy(..., 'asc')` or `orderBy(..., (ob) => ...)` instead."),mo.create(e,t.toOperationNode());const r=mo.create(e);return t?t(new OrderByItemBuilder({node:r})).toOperationNode():r}const vo=freeze({is:e=>"JSONReferenceNode"===e.kind,create:(e,t)=>freeze({kind:"JSONReferenceNode",reference:e,traversal:t}),cloneWithTraversal:(e,t)=>freeze({...e,traversal:t})}),No=freeze({is:e=>"JSONOperatorChainNode"===e.kind,create:e=>freeze({kind:"JSONOperatorChainNode",operator:e,values:freeze([])}),cloneWithValue:(e,t)=>freeze({...e,values:freeze([...e.values,t])})}),To=freeze({is:e=>"JSONPathNode"===e.kind,create:e=>freeze({kind:"JSONPathNode",inOperator:e,pathLegs:freeze([])}),cloneWithLeg:(e,t)=>freeze({...e,pathLegs:freeze([...e.pathLegs,t])})});function parseSimpleReferenceExpression(e){return isString(e)?parseStringReference(e):e.toOperationNode()}function parseReferenceExpressionOrList(e){return isReadonlyArray(e)?e.map(e=>parseReferenceExpression(e)):[parseReferenceExpression(e)]}function parseReferenceExpression(e){return isExpressionOrFactory(e)?parseExpression(e):parseSimpleReferenceExpression(e)}function parseStringReference(e){if(!e.includes("."))return fo.create(po.create(e));const t=e.split(".").map(trim$2);if(3===t.length)return function(e){const[t,r,n]=e;return fo.create(po.create(n),eo.createWithSchema(t,r))}(t);if(2===t.length)return function(e){const[t,r]=e;return fo.create(po.create(r),eo.create(t))}(t);throw new Error(`invalid column reference ${e}`)}function parseColumnName(e){return po.create(e)}function parseOrderedColumnName(e){if(e.includes(" ")){const[t,r]=e.split(" ").map(trim$2);if(!isOrderByDirection(r))throw new Error(`invalid order direction "${r}" next to "${t}"`);return parseOrderBy([t,r])[0]}return parseColumnName(e)}function trim$2(e){return e.trim()}const ko=freeze({is:e=>"PrimitiveValueListNode"===e.kind,create:e=>freeze({kind:"PrimitiveValueListNode",values:freeze([...e])})}),xo=freeze({is:e=>"ValueListNode"===e.kind,create:e=>freeze({kind:"ValueListNode",values:freeze(e)})}),So=freeze({is:e=>"ValueNode"===e.kind,create:e=>freeze({kind:"ValueNode",value:e}),createImmediate:e=>freeze({kind:"ValueNode",value:e,immediate:!0})});function parseValueExpressionOrList(e){return isReadonlyArray(e)?function(e){if(e.some(isExpressionOrFactory))return xo.create(e.map(e=>parseValueExpression(e)));return ko.create(e)}(e):parseValueExpression(e)}function parseValueExpression(e){return isExpressionOrFactory(e)?parseExpression(e):So.create(e)}function isSafeImmediateValue(e){return isNumber(e)||isBoolean(e)||isNull$1(e)}function parseSafeImmediateValue(e){if(!isSafeImmediateValue(e))throw new Error(`unsafe immediate value ${JSON.stringify(e)}`);return So.createImmediate(e)}const _o=freeze({is:e=>"ParensNode"===e.kind,create:e=>freeze({kind:"ParensNode",node:e})});function parseValueBinaryOperationOrExpression(e){if(3===e.length)return parseValueBinaryOperation(e[0],e[1],e[2]);if(1===e.length)return parseValueExpression(e[0]);throw new Error(`invalid arguments: ${JSON.stringify(e)}`)}function parseValueBinaryOperation(e,t,r){return function(e){return"is"===e||"is not"===e}(t)&&needsIsOperator(r)?oo.create(parseReferenceExpression(e),parseOperator(t),So.createImmediate(r)):oo.create(parseReferenceExpression(e),parseOperator(t),parseValueExpressionOrList(r))}function parseReferentialBinaryOperation(e,t,r){return oo.create(parseReferenceExpression(e),parseOperator(t),parseReferenceExpression(r))}function parseFilterObject(e,t){return parseFilterList(Object.entries(e).filter(([,e])=>!isUndefined(e)).map(([e,t])=>parseValueBinaryOperation(e,needsIsOperator(t)?"is":"=",t)),t)}function parseFilterList(e,t,r=!0){const n="and"===t?ro.create:no.create;if(0===e.length)return oo.create(So.createImmediate(1),uo.create("="),So.createImmediate("and"===t?1:0));let i=toOperationNode(e[0]);for(let t=1;t<e.length;++t)i=n(i,toOperationNode(e[t]));return e.length>1&&r?_o.create(i):i}function needsIsOperator(e){return isNull$1(e)||isBoolean(e)}function parseOperator(e){if(isString(e)&&lo.includes(e))return uo.create(e);if(isOperationNodeSource(e))return e.toOperationNode();throw new Error(`invalid operator ${JSON.stringify(e)}`)}function toOperationNode(e){return isOperationNodeSource(e)?e.toOperationNode():e}const Ao=freeze({is:e=>"OrderByNode"===e.kind,create:e=>freeze({kind:"OrderByNode",items:freeze([...e])}),cloneWithItems:(e,t)=>freeze({...e,items:freeze([...e.items,...t])})}),Io=freeze({is:e=>"PartitionByNode"===e.kind,create:e=>freeze({kind:"PartitionByNode",items:freeze(e)}),cloneWithItems:(e,t)=>freeze({...e,items:freeze([...e.items,...t])})}),Eo=freeze({is:e=>"OverNode"===e.kind,create:()=>freeze({kind:"OverNode"}),cloneWithOrderByItems:(e,t)=>freeze({...e,orderBy:e.orderBy?Ao.cloneWithItems(e.orderBy,t):Ao.create(t)}),cloneWithPartitionByItems:(e,t)=>freeze({...e,partitionBy:e.partitionBy?Io.cloneWithItems(e.partitionBy,t):Io.create(t)})}),Co=freeze({is:e=>"FromNode"===e.kind,create:e=>freeze({kind:"FromNode",froms:freeze(e)}),cloneWithFroms:(e,t)=>freeze({...e,froms:freeze([...e.froms,...t])})}),Oo=freeze({is:e=>"GroupByNode"===e.kind,create:e=>freeze({kind:"GroupByNode",items:freeze(e)}),cloneWithItems:(e,t)=>freeze({...e,items:freeze([...e.items,...t])})}),Po=freeze({is:e=>"HavingNode"===e.kind,create:e=>freeze({kind:"HavingNode",having:e}),cloneWithOperation:(e,t,r)=>freeze({...e,having:"And"===t?ro.create(e.having,r):no.create(e.having,r)})}),Ro=freeze({is:e=>"InsertQueryNode"===e.kind,create:(e,t,r)=>freeze({kind:"InsertQueryNode",into:e,...t&&{with:t},replace:r}),createWithoutInto:()=>freeze({kind:"InsertQueryNode"}),cloneWith:(e,t)=>freeze({...e,...t})}),$o=freeze({is:e=>"ListNode"===e.kind,create:e=>freeze({kind:"ListNode",items:freeze(e)})}),Bo=freeze({is:e=>"UpdateQueryNode"===e.kind,create:(e,t)=>freeze({kind:"UpdateQueryNode",table:1===e.length?e[0]:$o.create(e),...t&&{with:t}}),createWithoutTable:()=>freeze({kind:"UpdateQueryNode"}),cloneWithFromItems:(e,t)=>freeze({...e,from:e.from?Co.cloneWithFroms(e.from,t):Co.create(t)}),cloneWithUpdates:(e,t)=>freeze({...e,updates:e.updates?freeze([...e.updates,...t]):t}),cloneWithLimit:(e,t)=>freeze({...e,limit:t})}),Uo=freeze({is:e=>"UsingNode"===e.kind,create:e=>freeze({kind:"UsingNode",tables:freeze(e)}),cloneWithTables:(e,t)=>freeze({...e,tables:freeze([...e.tables,...t])})}),Lo=freeze({is:e=>"DeleteQueryNode"===e.kind,create:(e,t)=>freeze({kind:"DeleteQueryNode",from:Co.create(e),...t&&{with:t}}),cloneWithOrderByItems:(e,t)=>Qo.cloneWithOrderByItems(e,t),cloneWithoutOrderBy:e=>Qo.cloneWithoutOrderBy(e),cloneWithLimit:(e,t)=>freeze({...e,limit:t}),cloneWithoutLimit:e=>freeze({...e,limit:void 0}),cloneWithUsing:(e,t)=>freeze({...e,using:void 0!==e.using?Uo.cloneWithTables(e.using,t):Uo.create(t)})}),zo=freeze({is:e=>"WhereNode"===e.kind,create:e=>freeze({kind:"WhereNode",where:e}),cloneWithOperation:(e,t,r)=>freeze({...e,where:"And"===t?ro.create(e.where,r):no.create(e.where,r)})}),Do=freeze({is:e=>"ReturningNode"===e.kind,create:e=>freeze({kind:"ReturningNode",selections:freeze(e)}),cloneWithSelections:(e,t)=>freeze({...e,selections:e.selections?freeze([...e.selections,...t]):freeze(t)})}),qo=freeze({is:e=>"ExplainNode"===e.kind,create:(e,t)=>freeze({kind:"ExplainNode",format:e,options:t})}),Wo=freeze({is:e=>"WhenNode"===e.kind,create:e=>freeze({kind:"WhenNode",condition:e}),cloneWithResult:(e,t)=>freeze({...e,result:t})}),jo=freeze({is:e=>"MergeQueryNode"===e.kind,create:(e,t)=>freeze({kind:"MergeQueryNode",into:e,...t&&{with:t}}),cloneWithUsing:(e,t)=>freeze({...e,using:t}),cloneWithWhen:(e,t)=>freeze({...e,whens:e.whens?freeze([...e.whens,t]):freeze([t])}),cloneWithThen:(e,t)=>freeze({...e,whens:e.whens?freeze([...e.whens.slice(0,-1),Wo.cloneWithResult(e.whens[e.whens.length-1],t)]):void 0})}),Mo=freeze({is:e=>"OutputNode"===e.kind,create:e=>freeze({kind:"OutputNode",selections:freeze(e)}),cloneWithSelections:(e,t)=>freeze({...e,selections:e.selections?freeze([...e.selections,...t]):freeze(t)})}),Qo=freeze({is:e=>Vo.is(e)||Ro.is(e)||Bo.is(e)||Lo.is(e)||jo.is(e),cloneWithEndModifier:(e,t)=>freeze({...e,endModifiers:e.endModifiers?freeze([...e.endModifiers,t]):freeze([t])}),cloneWithWhere:(e,t)=>freeze({...e,where:e.where?zo.cloneWithOperation(e.where,"And",t):zo.create(t)}),cloneWithJoin:(e,t)=>freeze({...e,joins:e.joins?freeze([...e.joins,t]):freeze([t])}),cloneWithReturning:(e,t)=>freeze({...e,returning:e.returning?Do.cloneWithSelections(e.returning,t):Do.create(t)}),cloneWithoutReturning:e=>freeze({...e,returning:void 0}),cloneWithoutWhere:e=>freeze({...e,where:void 0}),cloneWithExplain:(e,t,r)=>freeze({...e,explain:qo.create(t,r?.toOperationNode())}),cloneWithTop:(e,t)=>freeze({...e,top:t}),cloneWithOutput:(e,t)=>freeze({...e,output:e.output?Mo.cloneWithSelections(e.output,t):Mo.create(t)}),cloneWithOrderByItems:(e,t)=>freeze({...e,orderBy:e.orderBy?Ao.cloneWithItems(e.orderBy,t):Ao.create(t)}),cloneWithoutOrderBy:e=>freeze({...e,orderBy:void 0})}),Vo=freeze({is:e=>"SelectQueryNode"===e.kind,create:e=>freeze({kind:"SelectQueryNode",...e&&{with:e}}),createFrom:(e,t)=>freeze({kind:"SelectQueryNode",from:Co.create(e),...t&&{with:t}}),cloneWithSelections:(e,t)=>freeze({...e,selections:e.selections?freeze([...e.selections,...t]):freeze(t)}),cloneWithDistinctOn:(e,t)=>freeze({...e,distinctOn:e.distinctOn?freeze([...e.distinctOn,...t]):freeze(t)}),cloneWithFrontModifier:(e,t)=>freeze({...e,frontModifiers:e.frontModifiers?freeze([...e.frontModifiers,t]):freeze([t])}),cloneWithOrderByItems:(e,t)=>Qo.cloneWithOrderByItems(e,t),cloneWithGroupByItems:(e,t)=>freeze({...e,groupBy:e.groupBy?Oo.cloneWithItems(e.groupBy,t):Oo.create(t)}),cloneWithLimit:(e,t)=>freeze({...e,limit:t}),cloneWithOffset:(e,t)=>freeze({...e,offset:t}),cloneWithFetch:(e,t)=>freeze({...e,fetch:t}),cloneWithHaving:(e,t)=>freeze({...e,having:e.having?Po.cloneWithOperation(e.having,"And",t):Po.create(t)}),cloneWithSetOperations:(e,t)=>freeze({...e,setOperations:e.setOperations?freeze([...e.setOperations,...t]):freeze([...t])}),cloneWithoutSelections:e=>freeze({...e,selections:[]}),cloneWithoutLimit:e=>freeze({...e,limit:void 0}),cloneWithoutOffset:e=>freeze({...e,offset:void 0}),cloneWithoutOrderBy:e=>Qo.cloneWithoutOrderBy(e),cloneWithoutGroupBy:e=>freeze({...e,groupBy:void 0})});class JoinBuilder{#t;constructor(e){this.#t=freeze(e)}on(...e){return new JoinBuilder({...this.#t,joinNode:so.cloneWithOn(this.#t.joinNode,parseValueBinaryOperationOrExpression(e))})}onRef(e,t,r){return new JoinBuilder({...this.#t,joinNode:so.cloneWithOn(this.#t.joinNode,parseReferentialBinaryOperation(e,t,r))})}onTrue(){return new JoinBuilder({...this.#t,joinNode:so.cloneWithOn(this.#t.joinNode,yo.createWithSql("true"))})}$call(e){return e(this)}toOperationNode(){return this.#t.joinNode}}const Fo=freeze({is:e=>"PartitionByItemNode"===e.kind,create:e=>freeze({kind:"PartitionByItemNode",partitionBy:e})});function parsePartitionBy(e){return parseReferenceExpressionOrList(e).map(Fo.create)}class OverBuilder{#t;constructor(e){this.#t=freeze(e)}orderBy(...e){return new OverBuilder({overNode:Eo.cloneWithOrderByItems(this.#t.overNode,parseOrderBy(e))})}clearOrderBy(){return new OverBuilder({overNode:Qo.cloneWithoutOrderBy(this.#t.overNode)})}partitionBy(e){return new OverBuilder({overNode:Eo.cloneWithPartitionByItems(this.#t.overNode,parsePartitionBy(e))})}$call(e){return e(this)}toOperationNode(){return this.#t.overNode}}const Jo=freeze({is:e=>"SelectionNode"===e.kind,create:e=>freeze({kind:"SelectionNode",selection:e}),createSelectAll:()=>freeze({kind:"SelectionNode",selection:ho.create()}),createSelectAllFromTable:e=>freeze({kind:"SelectionNode",selection:fo.createSelectAll(e)})});function parseSelectArg(e){return isFunction(e)?parseSelectArg(e(expressionBuilder())):isReadonlyArray(e)?e.map(e=>parseSelectExpression(e)):[parseSelectExpression(e)]}function parseSelectExpression(e){return isString(e)?Jo.create(function(e){const t=" as ";if(e.includes(t)){const[r,n]=e.split(t).map(trim$2);return Xs.create(parseStringReference(r),Qs.create(n))}return parseStringReference(e)}(e)):isDynamicReferenceBuilder(e)?Jo.create(e.toOperationNode()):Jo.create(parseAliasedExpression(e))}function parseSelectAll(e){return e?Array.isArray(e)?e.map(parseSelectAllArg):[parseSelectAllArg(e)]:[Jo.createSelectAll()]}function parseSelectAllArg(e){if(isString(e))return Jo.createSelectAllFromTable(parseTable(e));throw new Error(`invalid value selectAll expression: ${JSON.stringify(e)}`)}const Ko=freeze({is:e=>"ValuesNode"===e.kind,create:e=>freeze({kind:"ValuesNode",values:freeze(e)})}),Ho=freeze({is:e=>"DefaultInsertValueNode"===e.kind,create:()=>freeze({kind:"DefaultInsertValueNode"})});function parseInsertExpression(e){const t=isFunction(e)?e(expressionBuilder()):e;return function(e){const t=function(e){const t=new Map;for(const r of e){const e=Object.keys(r);for(const n of e)t.has(n)||void 0===r[n]||t.set(n,t.size)}return t}(e);return[freeze([...t.keys()].map(po.create)),Ko.create(e.map(e=>function(e,t){const r=Object.keys(e),n=Array.from({length:t.size});let i=!1,s=r.length;for(const o of r){const r=t.get(o);if(isUndefined(r)){s--;continue}const a=e[o];(isUndefined(a)||isExpressionOrFactory(a))&&(i=!0),n[r]=a}const o=s<t.size;if(o||i){const e=Ho.create();return xo.create(n.map(t=>isUndefined(t)?e:parseValueExpression(t)))}return ko.create(n)}(e,t)))]}(isReadonlyArray(t)?t:freeze([t]))}const Zo=freeze({is:e=>"ColumnUpdateNode"===e.kind,create:(e,t)=>freeze({kind:"ColumnUpdateNode",column:e,value:t})});function parseUpdate(...e){return 2===e.length?[Zo.create(parseReferenceExpression(e[0]),parseValueExpression(e[1]))]:parseUpdateObjectExpression(e[0])}function parseUpdateObjectExpression(e){const t=isFunction(e)?e(expressionBuilder()):e;return Object.entries(t).filter(([e,t])=>void 0!==t).map(([e,t])=>Zo.create(po.create(e),parseValueExpression(t)))}const Go=freeze({is:e=>"OnDuplicateKeyNode"===e.kind,create:e=>freeze({kind:"OnDuplicateKeyNode",updates:e})});class InsertResult{insertId;numInsertedOrUpdatedRows;constructor(e,t){this.insertId=e,this.numInsertedOrUpdatedRows=t}}class NoResultError extends Error{node;constructor(e){super("no result"),this.node=e}}function isNoResultErrorConstructor(e){return Object.prototype.hasOwnProperty.call(e,"prototype")}const Yo=freeze({is:e=>"OnConflictNode"===e.kind,create:()=>freeze({kind:"OnConflictNode"}),cloneWith:(e,t)=>freeze({...e,...t}),cloneWithIndexWhere:(e,t)=>freeze({...e,indexWhere:e.indexWhere?zo.cloneWithOperation(e.indexWhere,"And",t):zo.create(t)}),cloneWithIndexOrWhere:(e,t)=>freeze({...e,indexWhere:e.indexWhere?zo.cloneWithOperation(e.indexWhere,"Or",t):zo.create(t)}),cloneWithUpdateWhere:(e,t)=>freeze({...e,updateWhere:e.updateWhere?zo.cloneWithOperation(e.updateWhere,"And",t):zo.create(t)}),cloneWithUpdateOrWhere:(e,t)=>freeze({...e,updateWhere:e.updateWhere?zo.cloneWithOperation(e.updateWhere,"Or",t):zo.create(t)}),cloneWithoutIndexWhere:e=>freeze({...e,indexWhere:void 0}),cloneWithoutUpdateWhere:e=>freeze({...e,updateWhere:void 0})});class OnConflictBuilder{#t;constructor(e){this.#t=freeze(e)}column(e){const t=po.create(e);return new OnConflictBuilder({...this.#t,onConflictNode:Yo.cloneWith(this.#t.onConflictNode,{columns:this.#t.onConflictNode.columns?freeze([...this.#t.onConflictNode.columns,t]):freeze([t])})})}columns(e){const t=e.map(po.create);return new OnConflictBuilder({...this.#t,onConflictNode:Yo.cloneWith(this.#t.onConflictNode,{columns:this.#t.onConflictNode.columns?freeze([...this.#t.onConflictNode.columns,...t]):freeze(t)})})}constraint(e){return new OnConflictBuilder({...this.#t,onConflictNode:Yo.cloneWith(this.#t.onConflictNode,{constraint:Qs.create(e)})})}expression(e){return new OnConflictBuilder({...this.#t,onConflictNode:Yo.cloneWith(this.#t.onConflictNode,{indexExpression:e.toOperationNode()})})}where(...e){return new OnConflictBuilder({...this.#t,onConflictNode:Yo.cloneWithIndexWhere(this.#t.onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,r){return new OnConflictBuilder({...this.#t,onConflictNode:Yo.cloneWithIndexWhere(this.#t.onConflictNode,parseReferentialBinaryOperation(e,t,r))})}clearWhere(){return new OnConflictBuilder({...this.#t,onConflictNode:Yo.cloneWithoutIndexWhere(this.#t.onConflictNode)})}doNothing(){return new OnConflictDoNothingBuilder({...this.#t,onConflictNode:Yo.cloneWith(this.#t.onConflictNode,{doNothing:!0})})}doUpdateSet(e){return new OnConflictUpdateBuilder({...this.#t,onConflictNode:Yo.cloneWith(this.#t.onConflictNode,{updates:parseUpdateObjectExpression(e)})})}$call(e){return e(this)}}class OnConflictDoNothingBuilder{#t;constructor(e){this.#t=freeze(e)}toOperationNode(){return this.#t.onConflictNode}}class OnConflictUpdateBuilder{#t;constructor(e){this.#t=freeze(e)}where(...e){return new OnConflictUpdateBuilder({...this.#t,onConflictNode:Yo.cloneWithUpdateWhere(this.#t.onConflictNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,r){return new OnConflictUpdateBuilder({...this.#t,onConflictNode:Yo.cloneWithUpdateWhere(this.#t.onConflictNode,parseReferentialBinaryOperation(e,t,r))})}clearWhere(){return new OnConflictUpdateBuilder({...this.#t,onConflictNode:Yo.cloneWithoutUpdateWhere(this.#t.onConflictNode)})}$call(e){return e(this)}toOperationNode(){return this.#t.onConflictNode}}const Xo=freeze({is:e=>"TopNode"===e.kind,create:(e,t)=>freeze({kind:"TopNode",expression:e,modifiers:t})});function parseTop(e,t){if(!isNumber(e)&&!isBigInt(e))throw new Error(`Invalid top expression: ${e}`);if(!isUndefined(t)&&!function(e){return"percent"===e||"with ties"===e||"percent with ties"===e}(t))throw new Error(`Invalid top modifiers: ${t}`);return Xo.create(e,t)}const ea=freeze({is:e=>"OrActionNode"===e.kind,create:e=>freeze({kind:"OrActionNode",action:e})});class InsertQueryBuilder{#t;constructor(e){this.#t=freeze(e)}values(e){const[t,r]=parseInsertExpression(e);return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{columns:t,values:r})})}columns(e){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{columns:freeze(e.map(po.create))})})}expression(e){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{values:parseExpression(e)})})}defaultValues(){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{defaultValues:!0})})}modifyEnd(e){return new InsertQueryBuilder({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,e.toOperationNode())})}ignore(){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{orAction:ea.create("ignore")})})}orIgnore(){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{orAction:ea.create("ignore")})})}orAbort(){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{orAction:ea.create("abort")})})}orFail(){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{orAction:ea.create("fail")})})}orReplace(){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{orAction:ea.create("replace")})})}orRollback(){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{orAction:ea.create("rollback")})})}top(e,t){return new InsertQueryBuilder({...this.#t,queryNode:Qo.cloneWithTop(this.#t.queryNode,parseTop(e,t))})}onConflict(e){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{onConflict:e(new OnConflictBuilder({onConflictNode:Yo.create()})).toOperationNode()})})}onDuplicateKeyUpdate(e){return new InsertQueryBuilder({...this.#t,queryNode:Ro.cloneWith(this.#t.queryNode,{onDuplicateKey:Go.create(parseUpdateObjectExpression(e))})})}returning(e){return new InsertQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectArg(e))})}returningAll(){return new InsertQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectAll())})}output(e){return new InsertQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectArg(e))})}outputAll(e){return new InsertQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectAll(e))})}clearReturning(){return new InsertQueryBuilder({...this.#t,queryNode:Qo.cloneWithoutReturning(this.#t.queryNode)})}$call(e){return e(this)}$if(e,t){return e?t(this):new InsertQueryBuilder({...this.#t})}$castTo(){return new InsertQueryBuilder(this.#t)}$narrowType(){return new InsertQueryBuilder(this.#t)}$assertType(){return new InsertQueryBuilder(this.#t)}withPlugin(e){return new InsertQueryBuilder({...this.#t,executor:this.#t.executor.withPlugin(e)})}toOperationNode(){return this.#t.executor.transformQuery(this.#t.queryNode,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){const e=this.compile(),t=await this.#t.executor.executeQuery(e),{adapter:r}=this.#t.executor,n=e.query;return n.returning&&r.supportsReturning||n.output&&r.supportsOutput?t.rows:[new InsertResult(t.insertId,t.numAffectedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(void 0===t){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return t}async*stream(e=100){const t=this.compile(),r=this.#t.executor.stream(t,e);for await(const e of r)yield*e.rows}async explain(e,t){const r=new InsertQueryBuilder({...this.#t,queryNode:Qo.cloneWithExplain(this.#t.queryNode,e,t)});return await r.execute()}}class DeleteResult{numDeletedRows;constructor(e){this.numDeletedRows=e}}const ta=freeze({is:e=>"LimitNode"===e.kind,create:e=>freeze({kind:"LimitNode",limit:e})});class DeleteQueryBuilder{#t;constructor(e){this.#t=freeze(e)}where(...e){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithWhere(this.#t.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,r){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithWhere(this.#t.queryNode,parseReferentialBinaryOperation(e,t,r))})}clearWhere(){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithoutWhere(this.#t.queryNode)})}top(e,t){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithTop(this.#t.queryNode,parseTop(e,t))})}using(e){return new DeleteQueryBuilder({...this.#t,queryNode:Lo.cloneWithUsing(this.#t.queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return this.#r("InnerJoin",e)}leftJoin(...e){return this.#r("LeftJoin",e)}rightJoin(...e){return this.#r("RightJoin",e)}fullJoin(...e){return this.#r("FullJoin",e)}#r(e,t){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithJoin(this.#t.queryNode,parseJoin(e,t))})}returning(e){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectArg(e))})}returningAll(e){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectAll(e))})}output(e){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectArg(e))})}outputAll(e){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectAll(e))})}clearReturning(){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithoutReturning(this.#t.queryNode)})}clearLimit(){return new DeleteQueryBuilder({...this.#t,queryNode:Lo.cloneWithoutLimit(this.#t.queryNode)})}orderBy(...e){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithOrderByItems(this.#t.queryNode,parseOrderBy(e))})}clearOrderBy(){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithoutOrderBy(this.#t.queryNode)})}limit(e){return new DeleteQueryBuilder({...this.#t,queryNode:Lo.cloneWithLimit(this.#t.queryNode,ta.create(parseValueExpression(e)))})}modifyEnd(e){return new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,e.toOperationNode())})}$call(e){return e(this)}$if(e,t){return e?t(this):new DeleteQueryBuilder({...this.#t})}$castTo(){return new DeleteQueryBuilder(this.#t)}$narrowType(){return new DeleteQueryBuilder(this.#t)}$assertType(){return new DeleteQueryBuilder(this.#t)}withPlugin(e){return new DeleteQueryBuilder({...this.#t,executor:this.#t.executor.withPlugin(e)})}toOperationNode(){return this.#t.executor.transformQuery(this.#t.queryNode,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){const e=this.compile(),t=await this.#t.executor.executeQuery(e),{adapter:r}=this.#t.executor,n=e.query;return n.returning&&r.supportsReturning||n.output&&r.supportsOutput?t.rows:[new DeleteResult(t.numAffectedRows??BigInt(0))]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(void 0===t){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return t}async*stream(e=100){const t=this.compile(),r=this.#t.executor.stream(t,e);for await(const e of r)yield*e.rows}async explain(e,t){const r=new DeleteQueryBuilder({...this.#t,queryNode:Qo.cloneWithExplain(this.#t.queryNode,e,t)});return await r.execute()}}class UpdateResult{numUpdatedRows;numChangedRows;constructor(e,t){this.numUpdatedRows=e,this.numChangedRows=t}}class UpdateQueryBuilder{#t;constructor(e){this.#t=freeze(e)}where(...e){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithWhere(this.#t.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,r){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithWhere(this.#t.queryNode,parseReferentialBinaryOperation(e,t,r))})}clearWhere(){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithoutWhere(this.#t.queryNode)})}top(e,t){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithTop(this.#t.queryNode,parseTop(e,t))})}from(e){return new UpdateQueryBuilder({...this.#t,queryNode:Bo.cloneWithFromItems(this.#t.queryNode,parseTableExpressionOrList(e))})}innerJoin(...e){return this.#r("InnerJoin",e)}leftJoin(...e){return this.#r("LeftJoin",e)}rightJoin(...e){return this.#r("RightJoin",e)}fullJoin(...e){return this.#r("FullJoin",e)}#r(e,t){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithJoin(this.#t.queryNode,parseJoin(e,t))})}orderBy(...e){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithOrderByItems(this.#t.queryNode,parseOrderBy(e))})}clearOrderBy(){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithoutOrderBy(this.#t.queryNode)})}limit(e){return new UpdateQueryBuilder({...this.#t,queryNode:Bo.cloneWithLimit(this.#t.queryNode,ta.create(parseValueExpression(e)))})}set(...e){return new UpdateQueryBuilder({...this.#t,queryNode:Bo.cloneWithUpdates(this.#t.queryNode,parseUpdate(...e))})}returning(e){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectArg(e))})}returningAll(e){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectAll(e))})}output(e){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectArg(e))})}outputAll(e){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectAll(e))})}modifyEnd(e){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,e.toOperationNode())})}clearReturning(){return new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithoutReturning(this.#t.queryNode)})}$call(e){return e(this)}$if(e,t){return e?t(this):new UpdateQueryBuilder({...this.#t})}$castTo(){return new UpdateQueryBuilder(this.#t)}$narrowType(){return new UpdateQueryBuilder(this.#t)}$assertType(){return new UpdateQueryBuilder(this.#t)}withPlugin(e){return new UpdateQueryBuilder({...this.#t,executor:this.#t.executor.withPlugin(e)})}toOperationNode(){return this.#t.executor.transformQuery(this.#t.queryNode,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){const e=this.compile(),t=await this.#t.executor.executeQuery(e),{adapter:r}=this.#t.executor,n=e.query;return n.returning&&r.supportsReturning||n.output&&r.supportsOutput?t.rows:[new UpdateResult(t.numAffectedRows??BigInt(0),t.numChangedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(void 0===t){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return t}async*stream(e=100){const t=this.compile(),r=this.#t.executor.stream(t,e);for await(const e of r)yield*e.rows}async explain(e,t){const r=new UpdateQueryBuilder({...this.#t,queryNode:Qo.cloneWithExplain(this.#t.queryNode,e,t)});return await r.execute()}}const ra=freeze({is:e=>"CommonTableExpressionNameNode"===e.kind,create:(e,t)=>freeze({kind:"CommonTableExpressionNameNode",table:eo.create(e),columns:t?freeze(t.map(po.create)):void 0})}),na=freeze({is:e=>"CommonTableExpressionNode"===e.kind,create:(e,t)=>freeze({kind:"CommonTableExpressionNode",name:e,expression:t}),cloneWith:(e,t)=>freeze({...e,...t})});class CTEBuilder{#t;constructor(e){this.#t=freeze(e)}materialized(){return new CTEBuilder({...this.#t,node:na.cloneWith(this.#t.node,{materialized:!0})})}notMaterialized(){return new CTEBuilder({...this.#t,node:na.cloneWith(this.#t.node,{materialized:!1})})}toOperationNode(){return this.#t.node}}function parseCommonTableExpression(e,t){const r=t(new QueryCreator({executor:la})).toOperationNode();return isFunction(e)?e(function(e){return t=>new CTEBuilder({node:na.create(parseCommonTableExpressionName(t),e)})}(r)).toOperationNode():na.create(parseCommonTableExpressionName(e),r)}function parseCommonTableExpressionName(e){if(e.includes("(")){const t=e.split(/[\(\)]/),r=t[0],n=t[1].split(",").map(e=>e.trim());return ra.create(r,n)}return ra.create(e)}const ia=freeze({is:e=>"WithNode"===e.kind,create:(e,t)=>freeze({kind:"WithNode",expressions:freeze([e]),...t}),cloneWithExpression:(e,t)=>freeze({...e,expressions:freeze([...e.expressions,t])})}),sa=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];function randomString(e){let t="";for(let r=0;r<e;++r)t+=randomChar();return t}function randomChar(){return sa[~~(Math.random()*sa.length)]}function createQueryId(){return new LazyQueryId}class LazyQueryId{#n;get queryId(){return void 0===this.#n&&(this.#n=randomString(8)),this.#n}}class OperationNodeTransformer{nodeStack=[];#i=freeze({AliasNode:this.transformAlias.bind(this),ColumnNode:this.transformColumn.bind(this),IdentifierNode:this.transformIdentifier.bind(this),SchemableIdentifierNode:this.transformSchemableIdentifier.bind(this),RawNode:this.transformRaw.bind(this),ReferenceNode:this.transformReference.bind(this),SelectQueryNode:this.transformSelectQuery.bind(this),SelectionNode:this.transformSelection.bind(this),TableNode:this.transformTable.bind(this),FromNode:this.transformFrom.bind(this),SelectAllNode:this.transformSelectAll.bind(this),AndNode:this.transformAnd.bind(this),OrNode:this.transformOr.bind(this),ValueNode:this.transformValue.bind(this),ValueListNode:this.transformValueList.bind(this),PrimitiveValueListNode:this.transformPrimitiveValueList.bind(this),ParensNode:this.transformParens.bind(this),JoinNode:this.transformJoin.bind(this),OperatorNode:this.transformOperator.bind(this),WhereNode:this.transformWhere.bind(this),InsertQueryNode:this.transformInsertQuery.bind(this),DeleteQueryNode:this.transformDeleteQuery.bind(this),ReturningNode:this.transformReturning.bind(this),CreateTableNode:this.transformCreateTable.bind(this),AddColumnNode:this.transformAddColumn.bind(this),ColumnDefinitionNode:this.transformColumnDefinition.bind(this),DropTableNode:this.transformDropTable.bind(this),DataTypeNode:this.transformDataType.bind(this),OrderByNode:this.transformOrderBy.bind(this),OrderByItemNode:this.transformOrderByItem.bind(this),GroupByNode:this.transformGroupBy.bind(this),GroupByItemNode:this.transformGroupByItem.bind(this),UpdateQueryNode:this.transformUpdateQuery.bind(this),ColumnUpdateNode:this.transformColumnUpdate.bind(this),LimitNode:this.transformLimit.bind(this),OffsetNode:this.transformOffset.bind(this),OnConflictNode:this.transformOnConflict.bind(this),OnDuplicateKeyNode:this.transformOnDuplicateKey.bind(this),CreateIndexNode:this.transformCreateIndex.bind(this),DropIndexNode:this.transformDropIndex.bind(this),ListNode:this.transformList.bind(this),PrimaryKeyConstraintNode:this.transformPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.transformUniqueConstraint.bind(this),ReferencesNode:this.transformReferences.bind(this),CheckConstraintNode:this.transformCheckConstraint.bind(this),WithNode:this.transformWith.bind(this),CommonTableExpressionNode:this.transformCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.transformCommonTableExpressionName.bind(this),HavingNode:this.transformHaving.bind(this),CreateSchemaNode:this.transformCreateSchema.bind(this),DropSchemaNode:this.transformDropSchema.bind(this),AlterTableNode:this.transformAlterTable.bind(this),DropColumnNode:this.transformDropColumn.bind(this),RenameColumnNode:this.transformRenameColumn.bind(this),AlterColumnNode:this.transformAlterColumn.bind(this),ModifyColumnNode:this.transformModifyColumn.bind(this),AddConstraintNode:this.transformAddConstraint.bind(this),DropConstraintNode:this.transformDropConstraint.bind(this),RenameConstraintNode:this.transformRenameConstraint.bind(this),ForeignKeyConstraintNode:this.transformForeignKeyConstraint.bind(this),CreateViewNode:this.transformCreateView.bind(this),RefreshMaterializedViewNode:this.transformRefreshMaterializedView.bind(this),DropViewNode:this.transformDropView.bind(this),GeneratedNode:this.transformGenerated.bind(this),DefaultValueNode:this.transformDefaultValue.bind(this),OnNode:this.transformOn.bind(this),ValuesNode:this.transformValues.bind(this),SelectModifierNode:this.transformSelectModifier.bind(this),CreateTypeNode:this.transformCreateType.bind(this),DropTypeNode:this.transformDropType.bind(this),ExplainNode:this.transformExplain.bind(this),DefaultInsertValueNode:this.transformDefaultInsertValue.bind(this),AggregateFunctionNode:this.transformAggregateFunction.bind(this),OverNode:this.transformOver.bind(this),PartitionByNode:this.transformPartitionBy.bind(this),PartitionByItemNode:this.transformPartitionByItem.bind(this),SetOperationNode:this.transformSetOperation.bind(this),BinaryOperationNode:this.transformBinaryOperation.bind(this),UnaryOperationNode:this.transformUnaryOperation.bind(this),UsingNode:this.transformUsing.bind(this),FunctionNode:this.transformFunction.bind(this),CaseNode:this.transformCase.bind(this),WhenNode:this.transformWhen.bind(this),JSONReferenceNode:this.transformJSONReference.bind(this),JSONPathNode:this.transformJSONPath.bind(this),JSONPathLegNode:this.transformJSONPathLeg.bind(this),JSONOperatorChainNode:this.transformJSONOperatorChain.bind(this),TupleNode:this.transformTuple.bind(this),MergeQueryNode:this.transformMergeQuery.bind(this),MatchedNode:this.transformMatched.bind(this),AddIndexNode:this.transformAddIndex.bind(this),CastNode:this.transformCast.bind(this),FetchNode:this.transformFetch.bind(this),TopNode:this.transformTop.bind(this),OutputNode:this.transformOutput.bind(this),OrActionNode:this.transformOrAction.bind(this),CollateNode:this.transformCollate.bind(this)});transformNode(e,t){if(!e)return e;this.nodeStack.push(e);const r=this.transformNodeImpl(e,t);return this.nodeStack.pop(),freeze(r)}transformNodeImpl(e,t){return this.#i[e.kind](e,t)}transformNodeList(e,t){return e?freeze(e.map(e=>this.transformNode(e,t))):e}transformSelectQuery(e,t){return{kind:"SelectQueryNode",from:this.transformNode(e.from,t),selections:this.transformNodeList(e.selections,t),distinctOn:this.transformNodeList(e.distinctOn,t),joins:this.transformNodeList(e.joins,t),groupBy:this.transformNode(e.groupBy,t),orderBy:this.transformNode(e.orderBy,t),where:this.transformNode(e.where,t),frontModifiers:this.transformNodeList(e.frontModifiers,t),endModifiers:this.transformNodeList(e.endModifiers,t),limit:this.transformNode(e.limit,t),offset:this.transformNode(e.offset,t),with:this.transformNode(e.with,t),having:this.transformNode(e.having,t),explain:this.transformNode(e.explain,t),setOperations:this.transformNodeList(e.setOperations,t),fetch:this.transformNode(e.fetch,t),top:this.transformNode(e.top,t)}}transformSelection(e,t){return{kind:"SelectionNode",selection:this.transformNode(e.selection,t)}}transformColumn(e,t){return{kind:"ColumnNode",column:this.transformNode(e.column,t)}}transformAlias(e,t){return{kind:"AliasNode",node:this.transformNode(e.node,t),alias:this.transformNode(e.alias,t)}}transformTable(e,t){return{kind:"TableNode",table:this.transformNode(e.table,t)}}transformFrom(e,t){return{kind:"FromNode",froms:this.transformNodeList(e.froms,t)}}transformReference(e,t){return{kind:"ReferenceNode",column:this.transformNode(e.column,t),table:this.transformNode(e.table,t)}}transformAnd(e,t){return{kind:"AndNode",left:this.transformNode(e.left,t),right:this.transformNode(e.right,t)}}transformOr(e,t){return{kind:"OrNode",left:this.transformNode(e.left,t),right:this.transformNode(e.right,t)}}transformValueList(e,t){return{kind:"ValueListNode",values:this.transformNodeList(e.values,t)}}transformParens(e,t){return{kind:"ParensNode",node:this.transformNode(e.node,t)}}transformJoin(e,t){return{kind:"JoinNode",joinType:e.joinType,table:this.transformNode(e.table,t),on:this.transformNode(e.on,t)}}transformRaw(e,t){return{kind:"RawNode",sqlFragments:freeze([...e.sqlFragments]),parameters:this.transformNodeList(e.parameters,t)}}transformWhere(e,t){return{kind:"WhereNode",where:this.transformNode(e.where,t)}}transformInsertQuery(e,t){return{kind:"InsertQueryNode",into:this.transformNode(e.into,t),columns:this.transformNodeList(e.columns,t),values:this.transformNode(e.values,t),returning:this.transformNode(e.returning,t),onConflict:this.transformNode(e.onConflict,t),onDuplicateKey:this.transformNode(e.onDuplicateKey,t),endModifiers:this.transformNodeList(e.endModifiers,t),with:this.transformNode(e.with,t),ignore:e.ignore,orAction:this.transformNode(e.orAction,t),replace:e.replace,explain:this.transformNode(e.explain,t),defaultValues:e.defaultValues,top:this.transformNode(e.top,t),output:this.transformNode(e.output,t)}}transformValues(e,t){return{kind:"ValuesNode",values:this.transformNodeList(e.values,t)}}transformDeleteQuery(e,t){return{kind:"DeleteQueryNode",from:this.transformNode(e.from,t),using:this.transformNode(e.using,t),joins:this.transformNodeList(e.joins,t),where:this.transformNode(e.where,t),returning:this.transformNode(e.returning,t),endModifiers:this.transformNodeList(e.endModifiers,t),with:this.transformNode(e.with,t),orderBy:this.transformNode(e.orderBy,t),limit:this.transformNode(e.limit,t),explain:this.transformNode(e.explain,t),top:this.transformNode(e.top,t),output:this.transformNode(e.output,t)}}transformReturning(e,t){return{kind:"ReturningNode",selections:this.transformNodeList(e.selections,t)}}transformCreateTable(e,t){return{kind:"CreateTableNode",table:this.transformNode(e.table,t),columns:this.transformNodeList(e.columns,t),constraints:this.transformNodeList(e.constraints,t),temporary:e.temporary,ifNotExists:e.ifNotExists,onCommit:e.onCommit,frontModifiers:this.transformNodeList(e.frontModifiers,t),endModifiers:this.transformNodeList(e.endModifiers,t),selectQuery:this.transformNode(e.selectQuery,t)}}transformColumnDefinition(e,t){return{kind:"ColumnDefinitionNode",column:this.transformNode(e.column,t),dataType:this.transformNode(e.dataType,t),references:this.transformNode(e.references,t),primaryKey:e.primaryKey,autoIncrement:e.autoIncrement,unique:e.unique,notNull:e.notNull,unsigned:e.unsigned,defaultTo:this.transformNode(e.defaultTo,t),check:this.transformNode(e.check,t),generated:this.transformNode(e.generated,t),frontModifiers:this.transformNodeList(e.frontModifiers,t),endModifiers:this.transformNodeList(e.endModifiers,t),nullsNotDistinct:e.nullsNotDistinct,identity:e.identity,ifNotExists:e.ifNotExists}}transformAddColumn(e,t){return{kind:"AddColumnNode",column:this.transformNode(e.column,t)}}transformDropTable(e,t){return{kind:"DropTableNode",table:this.transformNode(e.table,t),ifExists:e.ifExists,cascade:e.cascade}}transformOrderBy(e,t){return{kind:"OrderByNode",items:this.transformNodeList(e.items,t)}}transformOrderByItem(e,t){return{kind:"OrderByItemNode",orderBy:this.transformNode(e.orderBy,t),direction:this.transformNode(e.direction,t),collation:this.transformNode(e.collation,t),nulls:e.nulls}}transformGroupBy(e,t){return{kind:"GroupByNode",items:this.transformNodeList(e.items,t)}}transformGroupByItem(e,t){return{kind:"GroupByItemNode",groupBy:this.transformNode(e.groupBy,t)}}transformUpdateQuery(e,t){return{kind:"UpdateQueryNode",table:this.transformNode(e.table,t),from:this.transformNode(e.from,t),joins:this.transformNodeList(e.joins,t),where:this.transformNode(e.where,t),updates:this.transformNodeList(e.updates,t),returning:this.transformNode(e.returning,t),endModifiers:this.transformNodeList(e.endModifiers,t),with:this.transformNode(e.with,t),explain:this.transformNode(e.explain,t),limit:this.transformNode(e.limit,t),top:this.transformNode(e.top,t),output:this.transformNode(e.output,t),orderBy:this.transformNode(e.orderBy,t)}}transformColumnUpdate(e,t){return{kind:"ColumnUpdateNode",column:this.transformNode(e.column,t),value:this.transformNode(e.value,t)}}transformLimit(e,t){return{kind:"LimitNode",limit:this.transformNode(e.limit,t)}}transformOffset(e,t){return{kind:"OffsetNode",offset:this.transformNode(e.offset,t)}}transformOnConflict(e,t){return{kind:"OnConflictNode",columns:this.transformNodeList(e.columns,t),constraint:this.transformNode(e.constraint,t),indexExpression:this.transformNode(e.indexExpression,t),indexWhere:this.transformNode(e.indexWhere,t),updates:this.transformNodeList(e.updates,t),updateWhere:this.transformNode(e.updateWhere,t),doNothing:e.doNothing}}transformOnDuplicateKey(e,t){return{kind:"OnDuplicateKeyNode",updates:this.transformNodeList(e.updates,t)}}transformCreateIndex(e,t){return{kind:"CreateIndexNode",name:this.transformNode(e.name,t),table:this.transformNode(e.table,t),columns:this.transformNodeList(e.columns,t),unique:e.unique,using:this.transformNode(e.using,t),ifNotExists:e.ifNotExists,where:this.transformNode(e.where,t),nullsNotDistinct:e.nullsNotDistinct}}transformList(e,t){return{kind:"ListNode",items:this.transformNodeList(e.items,t)}}transformDropIndex(e,t){return{kind:"DropIndexNode",name:this.transformNode(e.name,t),table:this.transformNode(e.table,t),ifExists:e.ifExists,cascade:e.cascade}}transformPrimaryKeyConstraint(e,t){return{kind:"PrimaryKeyConstraintNode",columns:this.transformNodeList(e.columns,t),name:this.transformNode(e.name,t),deferrable:e.deferrable,initiallyDeferred:e.initiallyDeferred}}transformUniqueConstraint(e,t){return{kind:"UniqueConstraintNode",columns:this.transformNodeList(e.columns,t),name:this.transformNode(e.name,t),nullsNotDistinct:e.nullsNotDistinct,deferrable:e.deferrable,initiallyDeferred:e.initiallyDeferred}}transformForeignKeyConstraint(e,t){return{kind:"ForeignKeyConstraintNode",columns:this.transformNodeList(e.columns,t),references:this.transformNode(e.references,t),name:this.transformNode(e.name,t),onDelete:e.onDelete,onUpdate:e.onUpdate,deferrable:e.deferrable,initiallyDeferred:e.initiallyDeferred}}transformSetOperation(e,t){return{kind:"SetOperationNode",operator:e.operator,expression:this.transformNode(e.expression,t),all:e.all}}transformReferences(e,t){return{kind:"ReferencesNode",table:this.transformNode(e.table,t),columns:this.transformNodeList(e.columns,t),onDelete:e.onDelete,onUpdate:e.onUpdate}}transformCheckConstraint(e,t){return{kind:"CheckConstraintNode",expression:this.transformNode(e.expression,t),name:this.transformNode(e.name,t)}}transformWith(e,t){return{kind:"WithNode",expressions:this.transformNodeList(e.expressions,t),recursive:e.recursive}}transformCommonTableExpression(e,t){return{kind:"CommonTableExpressionNode",name:this.transformNode(e.name,t),materialized:e.materialized,expression:this.transformNode(e.expression,t)}}transformCommonTableExpressionName(e,t){return{kind:"CommonTableExpressionNameNode",table:this.transformNode(e.table,t),columns:this.transformNodeList(e.columns,t)}}transformHaving(e,t){return{kind:"HavingNode",having:this.transformNode(e.having,t)}}transformCreateSchema(e,t){return{kind:"CreateSchemaNode",schema:this.transformNode(e.schema,t),ifNotExists:e.ifNotExists}}transformDropSchema(e,t){return{kind:"DropSchemaNode",schema:this.transformNode(e.schema,t),ifExists:e.ifExists,cascade:e.cascade}}transformAlterTable(e,t){return{kind:"AlterTableNode",table:this.transformNode(e.table,t),renameTo:this.transformNode(e.renameTo,t),setSchema:this.transformNode(e.setSchema,t),columnAlterations:this.transformNodeList(e.columnAlterations,t),addConstraint:this.transformNode(e.addConstraint,t),dropConstraint:this.transformNode(e.dropConstraint,t),renameConstraint:this.transformNode(e.renameConstraint,t),addIndex:this.transformNode(e.addIndex,t),dropIndex:this.transformNode(e.dropIndex,t)}}transformDropColumn(e,t){return{kind:"DropColumnNode",column:this.transformNode(e.column,t)}}transformRenameColumn(e,t){return{kind:"RenameColumnNode",column:this.transformNode(e.column,t),renameTo:this.transformNode(e.renameTo,t)}}transformAlterColumn(e,t){return{kind:"AlterColumnNode",column:this.transformNode(e.column,t),dataType:this.transformNode(e.dataType,t),dataTypeExpression:this.transformNode(e.dataTypeExpression,t),setDefault:this.transformNode(e.setDefault,t),dropDefault:e.dropDefault,setNotNull:e.setNotNull,dropNotNull:e.dropNotNull}}transformModifyColumn(e,t){return{kind:"ModifyColumnNode",column:this.transformNode(e.column,t)}}transformAddConstraint(e,t){return{kind:"AddConstraintNode",constraint:this.transformNode(e.constraint,t)}}transformDropConstraint(e,t){return{kind:"DropConstraintNode",constraintName:this.transformNode(e.constraintName,t),ifExists:e.ifExists,modifier:e.modifier}}transformRenameConstraint(e,t){return{kind:"RenameConstraintNode",oldName:this.transformNode(e.oldName,t),newName:this.transformNode(e.newName,t)}}transformCreateView(e,t){return{kind:"CreateViewNode",name:this.transformNode(e.name,t),temporary:e.temporary,orReplace:e.orReplace,ifNotExists:e.ifNotExists,materialized:e.materialized,columns:this.transformNodeList(e.columns,t),as:this.transformNode(e.as,t)}}transformRefreshMaterializedView(e,t){return{kind:"RefreshMaterializedViewNode",name:this.transformNode(e.name,t),concurrently:e.concurrently,withNoData:e.withNoData}}transformDropView(e,t){return{kind:"DropViewNode",name:this.transformNode(e.name,t),ifExists:e.ifExists,materialized:e.materialized,cascade:e.cascade}}transformGenerated(e,t){return{kind:"GeneratedNode",byDefault:e.byDefault,always:e.always,identity:e.identity,stored:e.stored,expression:this.transformNode(e.expression,t)}}transformDefaultValue(e,t){return{kind:"DefaultValueNode",defaultValue:this.transformNode(e.defaultValue,t)}}transformOn(e,t){return{kind:"OnNode",on:this.transformNode(e.on,t)}}transformSelectModifier(e,t){return{kind:"SelectModifierNode",modifier:e.modifier,rawModifier:this.transformNode(e.rawModifier,t),of:this.transformNodeList(e.of,t)}}transformCreateType(e,t){return{kind:"CreateTypeNode",name:this.transformNode(e.name,t),enum:this.transformNode(e.enum,t)}}transformDropType(e,t){return{kind:"DropTypeNode",name:this.transformNode(e.name,t),ifExists:e.ifExists}}transformExplain(e,t){return{kind:"ExplainNode",format:e.format,options:this.transformNode(e.options,t)}}transformSchemableIdentifier(e,t){return{kind:"SchemableIdentifierNode",schema:this.transformNode(e.schema,t),identifier:this.transformNode(e.identifier,t)}}transformAggregateFunction(e,t){return{kind:"AggregateFunctionNode",func:e.func,aggregated:this.transformNodeList(e.aggregated,t),distinct:e.distinct,orderBy:this.transformNode(e.orderBy,t),withinGroup:this.transformNode(e.withinGroup,t),filter:this.transformNode(e.filter,t),over:this.transformNode(e.over,t)}}transformOver(e,t){return{kind:"OverNode",orderBy:this.transformNode(e.orderBy,t),partitionBy:this.transformNode(e.partitionBy,t)}}transformPartitionBy(e,t){return{kind:"PartitionByNode",items:this.transformNodeList(e.items,t)}}transformPartitionByItem(e,t){return{kind:"PartitionByItemNode",partitionBy:this.transformNode(e.partitionBy,t)}}transformBinaryOperation(e,t){return{kind:"BinaryOperationNode",leftOperand:this.transformNode(e.leftOperand,t),operator:this.transformNode(e.operator,t),rightOperand:this.transformNode(e.rightOperand,t)}}transformUnaryOperation(e,t){return{kind:"UnaryOperationNode",operator:this.transformNode(e.operator,t),operand:this.transformNode(e.operand,t)}}transformUsing(e,t){return{kind:"UsingNode",tables:this.transformNodeList(e.tables,t)}}transformFunction(e,t){return{kind:"FunctionNode",func:e.func,arguments:this.transformNodeList(e.arguments,t)}}transformCase(e,t){return{kind:"CaseNode",value:this.transformNode(e.value,t),when:this.transformNodeList(e.when,t),else:this.transformNode(e.else,t),isStatement:e.isStatement}}transformWhen(e,t){return{kind:"WhenNode",condition:this.transformNode(e.condition,t),result:this.transformNode(e.result,t)}}transformJSONReference(e,t){return{kind:"JSONReferenceNode",reference:this.transformNode(e.reference,t),traversal:this.transformNode(e.traversal,t)}}transformJSONPath(e,t){return{kind:"JSONPathNode",inOperator:this.transformNode(e.inOperator,t),pathLegs:this.transformNodeList(e.pathLegs,t)}}transformJSONPathLeg(e,t){return{kind:"JSONPathLegNode",type:e.type,value:e.value}}transformJSONOperatorChain(e,t){return{kind:"JSONOperatorChainNode",operator:this.transformNode(e.operator,t),values:this.transformNodeList(e.values,t)}}transformTuple(e,t){return{kind:"TupleNode",values:this.transformNodeList(e.values,t)}}transformMergeQuery(e,t){return{kind:"MergeQueryNode",into:this.transformNode(e.into,t),using:this.transformNode(e.using,t),whens:this.transformNodeList(e.whens,t),with:this.transformNode(e.with,t),top:this.transformNode(e.top,t),endModifiers:this.transformNodeList(e.endModifiers,t),output:this.transformNode(e.output,t),returning:this.transformNode(e.returning,t)}}transformMatched(e,t){return{kind:"MatchedNode",not:e.not,bySource:e.bySource}}transformAddIndex(e,t){return{kind:"AddIndexNode",name:this.transformNode(e.name,t),columns:this.transformNodeList(e.columns,t),unique:e.unique,using:this.transformNode(e.using,t),ifNotExists:e.ifNotExists}}transformCast(e,t){return{kind:"CastNode",expression:this.transformNode(e.expression,t),dataType:this.transformNode(e.dataType,t)}}transformFetch(e,t){return{kind:"FetchNode",rowCount:this.transformNode(e.rowCount,t),modifier:e.modifier}}transformTop(e,t){return{kind:"TopNode",expression:e.expression,modifiers:e.modifiers}}transformOutput(e,t){return{kind:"OutputNode",selections:this.transformNodeList(e.selections,t)}}transformDataType(e,t){return e}transformSelectAll(e,t){return e}transformIdentifier(e,t){return e}transformValue(e,t){return e}transformPrimitiveValueList(e,t){return e}transformOperator(e,t){return e}transformDefaultInsertValue(e,t){return e}transformOrAction(e,t){return e}transformCollate(e,t){return e}}const oa=freeze({AlterTableNode:!0,CreateIndexNode:!0,CreateSchemaNode:!0,CreateTableNode:!0,CreateTypeNode:!0,CreateViewNode:!0,RefreshMaterializedViewNode:!0,DeleteQueryNode:!0,DropIndexNode:!0,DropSchemaNode:!0,DropTableNode:!0,DropTypeNode:!0,DropViewNode:!0,InsertQueryNode:!0,RawNode:!0,SelectQueryNode:!0,UpdateQueryNode:!0,MergeQueryNode:!0}),aa={json_agg:!0,to_json:!0};class WithSchemaTransformer extends OperationNodeTransformer{#s;#o=new Set;#a=new Set;constructor(e){super(),this.#s=e}transformNodeImpl(e,t){if(!this.#c(e))return super.transformNodeImpl(e,t);const r=this.#d(e);for(const e of r)this.#a.add(e);const n=this.#l(e);for(const e of n)this.#o.add(e);const i=super.transformNodeImpl(e,t);for(const e of n)this.#o.delete(e);for(const e of r)this.#a.delete(e);return i}transformSchemableIdentifier(e,t){const r=super.transformSchemableIdentifier(e,t);return r.schema||!this.#o.has(e.identifier.name)?r:{...r,schema:Qs.create(this.#s)}}transformReferences(e,t){const r=super.transformReferences(e,t);return r.table.table.schema?r:{...r,table:eo.createWithSchema(this.#s,r.table.table.identifier.name)}}transformAggregateFunction(e,t){return{...super.transformAggregateFunction({...e,aggregated:[]},t),aggregated:this.#u(e,t,"aggregated")}}transformFunction(e,t){return{...super.transformFunction({...e,arguments:[]},t),arguments:this.#u(e,t,"arguments")}}#u(e,t,r){return aa[e.func]?e[r].map(e=>!eo.is(e)||e.table.schema?this.transformNode(e,t):{...e,table:this.transformIdentifier(e.table.identifier,t)}):this.transformNodeList(e[r],t)}#c(e){return e.kind in oa}#l(e){const t=new Set;if("name"in e&&e.name&&Hs.is(e.name)&&this.#p(e.name,t),"from"in e&&e.from)for(const r of e.from.froms)this.#h(r,t);if("into"in e&&e.into&&this.#h(e.into,t),"table"in e&&e.table&&this.#h(e.table,t),"joins"in e&&e.joins)for(const r of e.joins)this.#h(r.table,t);return"using"in e&&e.using&&this.#h(e.using,t),t}#d(e){const t=new Set;return"with"in e&&e.with&&this.#f(e.with,t),t}#h(e,t){if(eo.is(e))this.#p(e.table,t);else if(Xs.is(e)&&eo.is(e.node))this.#p(e.node.table,t);else if($o.is(e))for(const r of e.items)this.#h(r,t)}#p(e,t){const r=e.identifier.name;this.#o.has(r)||this.#a.has(r)||t.add(r)}#f(e,t){for(const r of e.expressions){const e=r.name.table.table.identifier.name;this.#a.has(e)||t.add(e)}}}class WithSchemaPlugin{#m;constructor(e){this.#m=new WithSchemaTransformer(e)}transformQuery(e){return this.#m.transformNode(e.node,e.queryId)}async transformResult(e){return e.result}}const ca=freeze({is:e=>"MatchedNode"===e.kind,create:(e,t=!1)=>freeze({kind:"MatchedNode",not:e,bySource:t})});function parseMergeWhen(e,t,r){return Wo.create(parseFilterList([ca.create(!e.isMatched,e.bySource),...t&&t.length>0?[3===t.length&&r?parseReferentialBinaryOperation(t[0],t[1],t[2]):parseValueBinaryOperationOrExpression(t)]:[]],"and",!1))}function parseMergeThen(e){return isString(e)?yo.create([e],[]):isOperationNodeSource(e)?e.toOperationNode():e}class Deferred{#g;#y;#w;constructor(){this.#g=new Promise((e,t)=>{this.#w=t,this.#y=e})}get promise(){return this.#g}resolve=e=>{this.#y&&this.#y(e)};reject=e=>{this.#w&&this.#w(e)}}async function provideControlledConnection(e){const t=new Deferred,r=new Deferred;return e.provideConnection(async e=>(t.resolve(e),await r.promise)).catch(e=>t.reject(e)),freeze({connection:await t.promise,release:r.resolve})}const da=freeze([]);class QueryExecutorBase{#b;constructor(e=da){this.#b=e}get plugins(){return this.#b}transformQuery(e,t){for(const r of this.#b){const n=r.transformQuery({node:e,queryId:t});if(n.kind!==e.kind)throw new Error(["KyselyPlugin.transformQuery must return a node","of the same kind that was given to it.",`The plugin was given a ${e.kind}`,`but it returned a ${n.kind}`].join(" "));e=n}return e}async executeQuery(e){return await this.provideConnection(async t=>{const r=await t.executeQuery(e);return"numUpdatedOrDeletedRows"in r&&logOnce("kysely:warning: outdated driver/plugin detected! `QueryResult.numUpdatedOrDeletedRows` has been replaced with `QueryResult.numAffectedRows`."),await this.#v(r,e.queryId)})}async*stream(e,t){const{connection:r,release:n}=await provideControlledConnection(this);try{for await(const n of r.streamQuery(e,t))yield await this.#v(n,e.queryId)}finally{n()}}async#v(e,t){for(const r of this.#b)e=await r.transformResult({result:e,queryId:t});return e}}class NoopQueryExecutor extends QueryExecutorBase{get adapter(){throw new Error("this query cannot be compiled to SQL")}compileQuery(){throw new Error("this query cannot be compiled to SQL")}provideConnection(){throw new Error("this query cannot be executed")}withConnectionProvider(){throw new Error("this query cannot have a connection provider")}withPlugin(e){return new NoopQueryExecutor([...this.plugins,e])}withPlugins(e){return new NoopQueryExecutor([...this.plugins,...e])}withPluginAtFront(e){return new NoopQueryExecutor([e,...this.plugins])}withoutPlugins(){return new NoopQueryExecutor([])}}const la=new NoopQueryExecutor;class MergeResult{numChangedRows;constructor(e){this.numChangedRows=e}}class MergeQueryBuilder{#t;constructor(e){this.#t=freeze(e)}modifyEnd(e){return new MergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,e.toOperationNode())})}top(e,t){return new MergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithTop(this.#t.queryNode,parseTop(e,t))})}using(...e){return new WheneableMergeQueryBuilder({...this.#t,queryNode:jo.cloneWithUsing(this.#t.queryNode,parseJoin("Using",e))})}returning(e){return new MergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectArg(e))})}returningAll(e){return new MergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectAll(e))})}output(e){return new MergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectArg(e))})}outputAll(e){return new MergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectAll(e))})}}class WheneableMergeQueryBuilder{#t;constructor(e){this.#t=freeze(e)}modifyEnd(e){return new WheneableMergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,e.toOperationNode())})}top(e,t){return new WheneableMergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithTop(this.#t.queryNode,parseTop(e,t))})}whenMatched(){return this.#N([])}whenMatchedAnd(...e){return this.#N(e)}whenMatchedAndRef(e,t,r){return this.#N([e,t,r],!0)}#N(e,t){return new MatchedThenableMergeQueryBuilder({...this.#t,queryNode:jo.cloneWithWhen(this.#t.queryNode,parseMergeWhen({isMatched:!0},e,t))})}whenNotMatched(){return this.#T([])}whenNotMatchedAnd(...e){return this.#T(e)}whenNotMatchedAndRef(e,t,r){return this.#T([e,t,r],!0)}whenNotMatchedBySource(){return this.#T([],!1,!0)}whenNotMatchedBySourceAnd(...e){return this.#T(e,!1,!0)}whenNotMatchedBySourceAndRef(e,t,r){return this.#T([e,t,r],!0,!0)}returning(e){return new WheneableMergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectArg(e))})}returningAll(e){return new WheneableMergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithReturning(this.#t.queryNode,parseSelectAll(e))})}output(e){return new WheneableMergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectArg(e))})}outputAll(e){return new WheneableMergeQueryBuilder({...this.#t,queryNode:Qo.cloneWithOutput(this.#t.queryNode,parseSelectAll(e))})}#T(e,t=!1,r=!1){const n={...this.#t,queryNode:jo.cloneWithWhen(this.#t.queryNode,parseMergeWhen({isMatched:!1,bySource:r},e,t))};return new(r?MatchedThenableMergeQueryBuilder:NotMatchedThenableMergeQueryBuilder)(n)}$call(e){return e(this)}$if(e,t){return e?t(this):new WheneableMergeQueryBuilder({...this.#t})}toOperationNode(){return this.#t.executor.transformQuery(this.#t.queryNode,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){const e=this.compile(),t=await this.#t.executor.executeQuery(e),{adapter:r}=this.#t.executor,n=e.query;return n.returning&&r.supportsReturning||n.output&&r.supportsOutput?t.rows:[new MergeResult(t.numAffectedRows)]}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(void 0===t){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return t}}class MatchedThenableMergeQueryBuilder{#t;constructor(e){this.#t=freeze(e)}thenDelete(){return new WheneableMergeQueryBuilder({...this.#t,queryNode:jo.cloneWithThen(this.#t.queryNode,parseMergeThen("delete"))})}thenDoNothing(){return new WheneableMergeQueryBuilder({...this.#t,queryNode:jo.cloneWithThen(this.#t.queryNode,parseMergeThen("do nothing"))})}thenUpdate(e){return new WheneableMergeQueryBuilder({...this.#t,queryNode:jo.cloneWithThen(this.#t.queryNode,parseMergeThen(e(new UpdateQueryBuilder({queryId:this.#t.queryId,executor:la,queryNode:Bo.createWithoutTable()}))))})}thenUpdateSet(...e){return this.thenUpdate(t=>t.set(...e))}}class NotMatchedThenableMergeQueryBuilder{#t;constructor(e){this.#t=freeze(e)}thenDoNothing(){return new WheneableMergeQueryBuilder({...this.#t,queryNode:jo.cloneWithThen(this.#t.queryNode,parseMergeThen("do nothing"))})}thenInsertValues(e){const[t,r]=parseInsertExpression(e);return new WheneableMergeQueryBuilder({...this.#t,queryNode:jo.cloneWithThen(this.#t.queryNode,parseMergeThen(Ro.cloneWith(Ro.createWithoutInto(),{columns:t,values:r})))})}}class QueryCreator{#t;constructor(e){this.#t=freeze(e)}selectFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:this.#t.executor,queryNode:Vo.createFrom(parseTableExpressionOrList(e),this.#t.withNode)})}selectNoFrom(e){return createSelectQueryBuilder({queryId:createQueryId(),executor:this.#t.executor,queryNode:Vo.cloneWithSelections(Vo.create(this.#t.withNode),parseSelectArg(e))})}insertInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:this.#t.executor,queryNode:Ro.create(parseTable(e),this.#t.withNode)})}replaceInto(e){return new InsertQueryBuilder({queryId:createQueryId(),executor:this.#t.executor,queryNode:Ro.create(parseTable(e),this.#t.withNode,!0)})}deleteFrom(e){return new DeleteQueryBuilder({queryId:createQueryId(),executor:this.#t.executor,queryNode:Lo.create(parseTableExpressionOrList(e),this.#t.withNode)})}updateTable(e){return new UpdateQueryBuilder({queryId:createQueryId(),executor:this.#t.executor,queryNode:Bo.create(parseTableExpressionOrList(e),this.#t.withNode)})}mergeInto(e){return new MergeQueryBuilder({queryId:createQueryId(),executor:this.#t.executor,queryNode:jo.create(parseAliasedTable(e),this.#t.withNode)})}with(e,t){const r=parseCommonTableExpression(e,t);return new QueryCreator({...this.#t,withNode:this.#t.withNode?ia.cloneWithExpression(this.#t.withNode,r):ia.create(r)})}withRecursive(e,t){const r=parseCommonTableExpression(e,t);return new QueryCreator({...this.#t,withNode:this.#t.withNode?ia.cloneWithExpression(this.#t.withNode,r):ia.create(r,{recursive:!0})})}withPlugin(e){return new QueryCreator({...this.#t,executor:this.#t.executor.withPlugin(e)})}withoutPlugins(){return new QueryCreator({...this.#t,executor:this.#t.executor.withoutPlugins()})}withSchema(e){return new QueryCreator({...this.#t,executor:this.#t.executor.withPluginAtFront(new WithSchemaPlugin(e))})}}function parseJoin(e,t){if(3===t.length)return function(e,t,r,n){return so.createWithOn(e,parseTableExpression(t),parseReferentialBinaryOperation(r,"=",n))}(e,t[0],t[1],t[2]);if(2===t.length)return function(e,t,r){return r(function(e,t){return new JoinBuilder({joinNode:so.create(e,parseTableExpression(t))})}(e,t)).toOperationNode()}(e,t[0],t[1]);if(1===t.length)return function(e,t){return so.create(e,parseTableExpression(t))}(e,t[0]);throw new Error("not implemented")}const ua=freeze({is:e=>"OffsetNode"===e.kind,create:e=>freeze({kind:"OffsetNode",offset:e})}),pa=freeze({is:e=>"GroupByItemNode"===e.kind,create:e=>freeze({kind:"GroupByItemNode",groupBy:e})});function parseGroupBy(e){return parseReferenceExpressionOrList(e=isFunction(e)?e(expressionBuilder()):e).map(pa.create)}const ha=freeze({is:e=>"SetOperationNode"===e.kind,create:(e,t,r)=>freeze({kind:"SetOperationNode",operator:e,expression:t,all:r})});function parseSetOperations(e,t,r){return isFunction(t)&&(t=t(createExpressionBuilder())),isReadonlyArray(t)||(t=[t]),t.map(t=>ha.create(e,parseExpression(t),r))}class ExpressionWrapper{#k;constructor(e){this.#k=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(no.create(this.#k,parseValueBinaryOperationOrExpression(e)))}and(...e){return new AndWrapper(ro.create(this.#k,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new ExpressionWrapper(this.#k)}$notNull(){return new ExpressionWrapper(this.#k)}toOperationNode(){return this.#k}}class AliasedExpressionWrapper{#x;#S;constructor(e,t){this.#x=e,this.#S=t}get expression(){return this.#x}get alias(){return this.#S}toOperationNode(){return Xs.create(this.#x.toOperationNode(),isOperationNodeSource(this.#S)?this.#S.toOperationNode():Qs.create(this.#S))}}class OrWrapper{#k;constructor(e){this.#k=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}or(...e){return new OrWrapper(no.create(this.#k,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new OrWrapper(this.#k)}toOperationNode(){return _o.create(this.#k)}}class AndWrapper{#k;constructor(e){this.#k=e}get expressionType(){}as(e){return new AliasedExpressionWrapper(this,e)}and(...e){return new AndWrapper(ro.create(this.#k,parseValueBinaryOperationOrExpression(e)))}$castTo(){return new AndWrapper(this.#k)}toOperationNode(){return _o.create(this.#k)}}const fa={is:e=>"FetchNode"===e.kind,create:(e,t)=>({kind:"FetchNode",rowCount:So.create(e),modifier:t})};function parseFetch(e,t){if(!isNumber(e)&&!isBigInt(e))throw new Error(`Invalid fetch row count: ${e}`);if("only"!==(r=t)&&"with ties"!==r)throw new Error(`Invalid fetch modifier: ${t}`);var r;return fa.create(e,t)}class SelectQueryBuilderImpl{#t;constructor(e){this.#t=freeze(e)}get expressionType(){}get isSelectQueryBuilder(){return!0}where(...e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithWhere(this.#t.queryNode,parseValueBinaryOperationOrExpression(e))})}whereRef(e,t,r){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithWhere(this.#t.queryNode,parseReferentialBinaryOperation(e,t,r))})}having(...e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithHaving(this.#t.queryNode,parseValueBinaryOperationOrExpression(e))})}havingRef(e,t,r){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithHaving(this.#t.queryNode,parseReferentialBinaryOperation(e,t,r))})}select(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithSelections(this.#t.queryNode,parseSelectArg(e))})}distinctOn(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithDistinctOn(this.#t.queryNode,parseReferenceExpressionOrList(e))})}modifyFront(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithFrontModifier(this.#t.queryNode,to.createWithExpression(e.toOperationNode()))})}modifyEnd(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,to.createWithExpression(e.toOperationNode()))})}distinct(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithFrontModifier(this.#t.queryNode,to.create("Distinct"))})}forUpdate(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,to.create("ForUpdate",e?asArray(e).map(parseTable):void 0))})}forShare(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,to.create("ForShare",e?asArray(e).map(parseTable):void 0))})}forKeyShare(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,to.create("ForKeyShare",e?asArray(e).map(parseTable):void 0))})}forNoKeyUpdate(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,to.create("ForNoKeyUpdate",e?asArray(e).map(parseTable):void 0))})}skipLocked(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,to.create("SkipLocked"))})}noWait(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithEndModifier(this.#t.queryNode,to.create("NoWait"))})}selectAll(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithSelections(this.#t.queryNode,parseSelectAll(e))})}innerJoin(...e){return this.#r("InnerJoin",e)}leftJoin(...e){return this.#r("LeftJoin",e)}rightJoin(...e){return this.#r("RightJoin",e)}fullJoin(...e){return this.#r("FullJoin",e)}crossJoin(...e){return this.#r("CrossJoin",e)}innerJoinLateral(...e){return this.#r("LateralInnerJoin",e)}leftJoinLateral(...e){return this.#r("LateralLeftJoin",e)}crossJoinLateral(...e){return this.#r("LateralCrossJoin",e)}crossApply(...e){return this.#r("CrossApply",e)}outerApply(...e){return this.#r("OuterApply",e)}#r(e,t){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithJoin(this.#t.queryNode,parseJoin(e,t))})}orderBy(...e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithOrderByItems(this.#t.queryNode,parseOrderBy(e))})}groupBy(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithGroupByItems(this.#t.queryNode,parseGroupBy(e))})}limit(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithLimit(this.#t.queryNode,ta.create(parseValueExpression(e)))})}offset(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithOffset(this.#t.queryNode,ua.create(parseValueExpression(e)))})}fetch(e,t="only"){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithFetch(this.#t.queryNode,parseFetch(e,t))})}top(e,t){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithTop(this.#t.queryNode,parseTop(e,t))})}union(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithSetOperations(this.#t.queryNode,parseSetOperations("union",e,!1))})}unionAll(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithSetOperations(this.#t.queryNode,parseSetOperations("union",e,!0))})}intersect(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithSetOperations(this.#t.queryNode,parseSetOperations("intersect",e,!1))})}intersectAll(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithSetOperations(this.#t.queryNode,parseSetOperations("intersect",e,!0))})}except(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithSetOperations(this.#t.queryNode,parseSetOperations("except",e,!1))})}exceptAll(e){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithSetOperations(this.#t.queryNode,parseSetOperations("except",e,!0))})}as(e){return new AliasedSelectQueryBuilderImpl(this,e)}clearSelect(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithoutSelections(this.#t.queryNode)})}clearWhere(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithoutWhere(this.#t.queryNode)})}clearLimit(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithoutLimit(this.#t.queryNode)})}clearOffset(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithoutOffset(this.#t.queryNode)})}clearOrderBy(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithoutOrderBy(this.#t.queryNode)})}clearGroupBy(){return new SelectQueryBuilderImpl({...this.#t,queryNode:Vo.cloneWithoutGroupBy(this.#t.queryNode)})}$call(e){return e(this)}$if(e,t){return e?t(this):new SelectQueryBuilderImpl({...this.#t})}$castTo(){return new SelectQueryBuilderImpl(this.#t)}$narrowType(){return new SelectQueryBuilderImpl(this.#t)}$assertType(){return new SelectQueryBuilderImpl(this.#t)}$asTuple(){return new ExpressionWrapper(this.toOperationNode())}$asScalar(){return new ExpressionWrapper(this.toOperationNode())}withPlugin(e){return new SelectQueryBuilderImpl({...this.#t,executor:this.#t.executor.withPlugin(e)})}toOperationNode(){return this.#t.executor.transformQuery(this.#t.queryNode,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){const e=this.compile();return(await this.#t.executor.executeQuery(e)).rows}async executeTakeFirst(){const[e]=await this.execute();return e}async executeTakeFirstOrThrow(e=NoResultError){const t=await this.executeTakeFirst();if(void 0===t){throw isNoResultErrorConstructor(e)?new e(this.toOperationNode()):e(this.toOperationNode())}return t}async*stream(e=100){const t=this.compile(),r=this.#t.executor.stream(t,e);for await(const e of r)yield*e.rows}async explain(e,t){const r=new SelectQueryBuilderImpl({...this.#t,queryNode:Qo.cloneWithExplain(this.#t.queryNode,e,t)});return await r.execute()}}function createSelectQueryBuilder(e){return new SelectQueryBuilderImpl(e)}class AliasedSelectQueryBuilderImpl{#_;#S;constructor(e,t){this.#_=e,this.#S=t}get expression(){return this.#_}get alias(){return this.#S}get isAliasedSelectQueryBuilder(){return!0}toOperationNode(){return Xs.create(this.#_.toOperationNode(),Qs.create(this.#S))}}const ma=freeze({is:e=>"AggregateFunctionNode"===e.kind,create:(e,t=[])=>freeze({kind:"AggregateFunctionNode",func:e,aggregated:t}),cloneWithDistinct:e=>freeze({...e,distinct:!0}),cloneWithOrderBy(e,t,r=!1){const n=r?"withinGroup":"orderBy";return freeze({...e,[n]:e[n]?Ao.cloneWithItems(e[n],t):Ao.create(t)})},cloneWithFilter:(e,t)=>freeze({...e,filter:e.filter?zo.cloneWithOperation(e.filter,"And",t):zo.create(t)}),cloneWithOrFilter:(e,t)=>freeze({...e,filter:e.filter?zo.cloneWithOperation(e.filter,"Or",t):zo.create(t)}),cloneWithOver:(e,t)=>freeze({...e,over:t})}),ga=freeze({is:e=>"FunctionNode"===e.kind,create:(e,t)=>freeze({kind:"FunctionNode",func:e,arguments:t})});class AggregateFunctionBuilder{#t;constructor(e){this.#t=freeze(e)}get expressionType(){}as(e){return new AliasedAggregateFunctionBuilder(this,e)}distinct(){return new AggregateFunctionBuilder({...this.#t,aggregateFunctionNode:ma.cloneWithDistinct(this.#t.aggregateFunctionNode)})}orderBy(...e){return new AggregateFunctionBuilder({...this.#t,aggregateFunctionNode:Qo.cloneWithOrderByItems(this.#t.aggregateFunctionNode,parseOrderBy(e))})}clearOrderBy(){return new AggregateFunctionBuilder({...this.#t,aggregateFunctionNode:Qo.cloneWithoutOrderBy(this.#t.aggregateFunctionNode)})}withinGroupOrderBy(...e){return new AggregateFunctionBuilder({...this.#t,aggregateFunctionNode:ma.cloneWithOrderBy(this.#t.aggregateFunctionNode,parseOrderBy(e),!0)})}filterWhere(...e){return new AggregateFunctionBuilder({...this.#t,aggregateFunctionNode:ma.cloneWithFilter(this.#t.aggregateFunctionNode,parseValueBinaryOperationOrExpression(e))})}filterWhereRef(e,t,r){return new AggregateFunctionBuilder({...this.#t,aggregateFunctionNode:ma.cloneWithFilter(this.#t.aggregateFunctionNode,parseReferentialBinaryOperation(e,t,r))})}over(e){const t=new OverBuilder({overNode:Eo.create()});return new AggregateFunctionBuilder({...this.#t,aggregateFunctionNode:ma.cloneWithOver(this.#t.aggregateFunctionNode,(e?e(t):t).toOperationNode())})}$call(e){return e(this)}$castTo(){return new AggregateFunctionBuilder(this.#t)}$notNull(){return new AggregateFunctionBuilder(this.#t)}toOperationNode(){return this.#t.aggregateFunctionNode}}class AliasedAggregateFunctionBuilder{#A;#S;constructor(e,t){this.#A=e,this.#S=t}get expression(){return this.#A}get alias(){return this.#S}toOperationNode(){return Xs.create(this.#A.toOperationNode(),Qs.create(this.#S))}}function createFunctionModule(){const fn=(e,t)=>new ExpressionWrapper(ga.create(e,parseReferenceExpressionOrList(t??[]))),agg=(e,t)=>new AggregateFunctionBuilder({aggregateFunctionNode:ma.create(e,t?parseReferenceExpressionOrList(t):void 0)});return Object.assign(fn,{agg:agg,avg:e=>agg("avg",[e]),coalesce:(...e)=>fn("coalesce",e),count:e=>agg("count",[e]),countAll:e=>new AggregateFunctionBuilder({aggregateFunctionNode:ma.create("count",parseSelectAll(e))}),max:e=>agg("max",[e]),min:e=>agg("min",[e]),sum:e=>agg("sum",[e]),any:e=>fn("any",[e]),jsonAgg:e=>new AggregateFunctionBuilder({aggregateFunctionNode:ma.create("json_agg",[isString(e)?parseTable(e):e.toOperationNode()])}),toJson:e=>new ExpressionWrapper(ga.create("to_json",[isString(e)?parseTable(e):e.toOperationNode()]))})}const ya=freeze({is:e=>"UnaryOperationNode"===e.kind,create:(e,t)=>freeze({kind:"UnaryOperationNode",operator:e,operand:t})});const wa=freeze({is:e=>"CaseNode"===e.kind,create:e=>freeze({kind:"CaseNode",value:e}),cloneWithWhen:(e,t)=>freeze({...e,when:freeze(e.when?[...e.when,t]:[t])}),cloneWithThen:(e,t)=>freeze({...e,when:e.when?freeze([...e.when.slice(0,-1),Wo.cloneWithResult(e.when[e.when.length-1],t)]):void 0}),cloneWith:(e,t)=>freeze({...e,...t})});class CaseBuilder{#t;constructor(e){this.#t=freeze(e)}when(...e){return new CaseThenBuilder({...this.#t,node:wa.cloneWithWhen(this.#t.node,Wo.create(parseValueBinaryOperationOrExpression(e)))})}}class CaseThenBuilder{#t;constructor(e){this.#t=freeze(e)}then(e){return new CaseWhenBuilder({...this.#t,node:wa.cloneWithThen(this.#t.node,isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e))})}}class CaseWhenBuilder{#t;constructor(e){this.#t=freeze(e)}when(...e){return new CaseThenBuilder({...this.#t,node:wa.cloneWithWhen(this.#t.node,Wo.create(parseValueBinaryOperationOrExpression(e)))})}else(e){return new CaseEndBuilder({...this.#t,node:wa.cloneWith(this.#t.node,{else:isSafeImmediateValue(e)?parseSafeImmediateValue(e):parseValueExpression(e)})})}end(){return new ExpressionWrapper(wa.cloneWith(this.#t.node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(wa.cloneWith(this.#t.node,{isStatement:!0}))}}class CaseEndBuilder{#t;constructor(e){this.#t=freeze(e)}end(){return new ExpressionWrapper(wa.cloneWith(this.#t.node,{isStatement:!1}))}endCase(){return new ExpressionWrapper(wa.cloneWith(this.#t.node,{isStatement:!0}))}}const ba=freeze({is:e=>"JSONPathLegNode"===e.kind,create:(e,t)=>freeze({kind:"JSONPathLegNode",type:e,value:t})});class JSONPathBuilder{#k;constructor(e){this.#k=e}at(e){return this.#I("ArrayLocation",e)}key(e){return this.#I("Member",e)}#I(e,t){return vo.is(this.#k)?new TraversedJSONPathBuilder(vo.cloneWithTraversal(this.#k,To.is(this.#k.traversal)?To.cloneWithLeg(this.#k.traversal,ba.create(e,t)):No.cloneWithValue(this.#k.traversal,So.createImmediate(t)))):new TraversedJSONPathBuilder(To.cloneWithLeg(this.#k,ba.create(e,t)))}}class TraversedJSONPathBuilder extends JSONPathBuilder{#k;constructor(e){super(e),this.#k=e}get expressionType(){}as(e){return new AliasedJSONPathBuilder(this,e)}$castTo(){return new TraversedJSONPathBuilder(this.#k)}$notNull(){return new TraversedJSONPathBuilder(this.#k)}toOperationNode(){return this.#k}}class AliasedJSONPathBuilder{#E;#S;constructor(e,t){this.#E=e,this.#S=t}get expression(){return this.#E}get alias(){return this.#S}toOperationNode(){return Xs.create(this.#E.toOperationNode(),isOperationNodeSource(this.#S)?this.#S.toOperationNode():Qs.create(this.#S))}}const va=freeze({is:e=>"TupleNode"===e.kind,create:e=>freeze({kind:"TupleNode",values:freeze(e)})}),Na=["varchar","char","text","integer","int2","int4","int8","smallint","bigint","boolean","real","double precision","float4","float8","decimal","numeric","binary","bytea","date","datetime","time","timetz","timestamp","timestamptz","serial","bigserial","uuid","json","jsonb","blob","varbinary","int4range","int4multirange","int8range","int8multirange","numrange","nummultirange","tsrange","tsmultirange","tstzrange","tstzmultirange","daterange","datemultirange"],Ta=[/^varchar\(\d+\)$/,/^char\(\d+\)$/,/^decimal\(\d+, \d+\)$/,/^numeric\(\d+, \d+\)$/,/^binary\(\d+\)$/,/^datetime\(\d+\)$/,/^time\(\d+\)$/,/^timetz\(\d+\)$/,/^timestamp\(\d+\)$/,/^timestamptz\(\d+\)$/,/^varbinary\(\d+\)$/],ka=freeze({is:e=>"DataTypeNode"===e.kind,create:e=>freeze({kind:"DataTypeNode",dataType:e})});function parseDataTypeExpression(e){if(isOperationNodeSource(e))return e.toOperationNode();if(function(e){return!!Na.includes(e)||!!Ta.some(t=>t.test(e))}(e))return ka.create(e);throw new Error(`invalid column data type ${JSON.stringify(e)}`)}const xa=freeze({is:e=>"CastNode"===e.kind,create:(e,t)=>freeze({kind:"CastNode",expression:e,dataType:t})});function createExpressionBuilder(e=la){function unary(e,t){return new ExpressionWrapper((r=e,n=t,ya.create(uo.create(r),parseReferenceExpression(n))));var r,n}const t=Object.assign(function(e,t,r){return new ExpressionWrapper(parseValueBinaryOperation(e,t,r))},{fn:void 0,eb:void 0,selectFrom:t=>createSelectQueryBuilder({queryId:createQueryId(),executor:e,queryNode:Vo.createFrom(parseTableExpressionOrList(t))}),case:e=>new CaseBuilder({node:wa.create(isUndefined(e)?void 0:parseReferenceExpression(e))}),ref:(e,t)=>isUndefined(t)?new ExpressionWrapper(parseStringReference(e)):new JSONPathBuilder(function(e,t){const r=parseStringReference(e);if(isJSONOperator(t))return vo.create(r,No.create(uo.create(t)));const n=t.slice(0,-1);if(isJSONOperator(n))return vo.create(r,To.create(uo.create(n)));throw new Error(`Invalid JSON operator: ${t}`)}(e,t)),jsonPath:()=>new JSONPathBuilder(To.create()),table:e=>new ExpressionWrapper(parseTable(e)),val:e=>new ExpressionWrapper(parseValueExpression(e)),refTuple:(...e)=>new ExpressionWrapper(va.create(e.map(parseReferenceExpression))),tuple:(...e)=>new ExpressionWrapper(va.create(e.map(parseValueExpression))),lit:e=>new ExpressionWrapper(parseSafeImmediateValue(e)),unary:unary,not:e=>unary("not",e),exists:e=>unary("exists",e),neg:e=>unary("-",e),between:(e,t,r)=>new ExpressionWrapper(oo.create(parseReferenceExpression(e),uo.create("between"),ro.create(parseValueExpression(t),parseValueExpression(r)))),betweenSymmetric:(e,t,r)=>new ExpressionWrapper(oo.create(parseReferenceExpression(e),uo.create("between symmetric"),ro.create(parseValueExpression(t),parseValueExpression(r)))),and:e=>isReadonlyArray(e)?new ExpressionWrapper(parseFilterList(e,"and")):new ExpressionWrapper(parseFilterObject(e,"and")),or:e=>isReadonlyArray(e)?new ExpressionWrapper(parseFilterList(e,"or")):new ExpressionWrapper(parseFilterObject(e,"or")),parens(...e){const t=parseValueBinaryOperationOrExpression(e);return _o.is(t)?new ExpressionWrapper(t):new ExpressionWrapper(_o.create(t))},cast:(e,t)=>new ExpressionWrapper(xa.create(parseReferenceExpression(e),parseDataTypeExpression(t))),withSchema:t=>createExpressionBuilder(e.withPluginAtFront(new WithSchemaPlugin(t)))});return t.fn=createFunctionModule(),t.eb=t,t}function expressionBuilder(e){return createExpressionBuilder()}function parseExpression(e){if(isOperationNodeSource(e))return e.toOperationNode();if(isFunction(e))return e(expressionBuilder()).toOperationNode();throw new Error(`invalid expression: ${JSON.stringify(e)}`)}function parseAliasedExpression(e){if(isOperationNodeSource(e))return e.toOperationNode();if(isFunction(e))return e(expressionBuilder()).toOperationNode();throw new Error(`invalid aliased expression: ${JSON.stringify(e)}`)}function isExpressionOrFactory(e){return isExpression(e)||function(e){return isObject(e)&&"expression"in e&&isString(e.alias)&&isOperationNodeSource(e)}(e)||isFunction(e)}class DynamicTableBuilder{#C;get table(){return this.#C}constructor(e){this.#C=e}as(e){return new AliasedDynamicTableBuilder(this.#C,e)}}class AliasedDynamicTableBuilder{#C;#S;get table(){return this.#C}get alias(){return this.#S}constructor(e,t){this.#C=e,this.#S=t}toOperationNode(){return Xs.create(parseTable(this.#C),Qs.create(this.#S))}}function parseTableExpressionOrList(e){return isReadonlyArray(e)?e.map(e=>parseTableExpression(e)):[parseTableExpression(e)]}function parseTableExpression(e){return isString(e)?parseAliasedTable(e):isObject(t=e)&&isOperationNodeSource(t)&&isString(t.table)&&isString(t.alias)?e.toOperationNode():parseAliasedExpression(e);var t}function parseAliasedTable(e){const t=" as ";if(e.includes(t)){const[r,n]=e.split(t).map(trim$1);return Xs.create(parseTable(r),Qs.create(n))}return parseTable(e)}function parseTable(e){if(e.includes(".")){const[t,r]=e.split(".").map(trim$1);return eo.createWithSchema(t,r)}return eo.create(e)}function trim$1(e){return e.trim()}const Sa=freeze({is:e=>"AddColumnNode"===e.kind,create:e=>freeze({kind:"AddColumnNode",column:e})}),_a=freeze({is:e=>"ColumnDefinitionNode"===e.kind,create:(e,t)=>freeze({kind:"ColumnDefinitionNode",column:po.create(e),dataType:t}),cloneWithFrontModifier:(e,t)=>freeze({...e,frontModifiers:e.frontModifiers?freeze([...e.frontModifiers,t]):[t]}),cloneWithEndModifier:(e,t)=>freeze({...e,endModifiers:e.endModifiers?freeze([...e.endModifiers,t]):[t]}),cloneWith:(e,t)=>freeze({...e,...t})}),Aa=freeze({is:e=>"DropColumnNode"===e.kind,create:e=>freeze({kind:"DropColumnNode",column:po.create(e)})}),Ia=freeze({is:e=>"RenameColumnNode"===e.kind,create:(e,t)=>freeze({kind:"RenameColumnNode",column:po.create(e),renameTo:po.create(t)})}),Ea=freeze({is:e=>"CheckConstraintNode"===e.kind,create:(e,t)=>freeze({kind:"CheckConstraintNode",expression:e,name:t?Qs.create(t):void 0})}),Ca=["no action","restrict","cascade","set null","set default"],Oa=freeze({is:e=>"ReferencesNode"===e.kind,create:(e,t)=>freeze({kind:"ReferencesNode",table:e,columns:freeze([...t])}),cloneWithOnDelete:(e,t)=>freeze({...e,onDelete:t}),cloneWithOnUpdate:(e,t)=>freeze({...e,onUpdate:t})});function parseDefaultValueExpression(e){return isOperationNodeSource(e)?e.toOperationNode():So.createImmediate(e)}const Pa=freeze({is:e=>"GeneratedNode"===e.kind,create:e=>freeze({kind:"GeneratedNode",...e}),createWithExpression:e=>freeze({kind:"GeneratedNode",always:!0,expression:e}),cloneWith:(e,t)=>freeze({...e,...t})}),Ra=freeze({is:e=>"DefaultValueNode"===e.kind,create:e=>freeze({kind:"DefaultValueNode",defaultValue:e})});function parseOnModifyForeignAction(e){if(Ca.includes(e))return e;throw new Error(`invalid OnModifyForeignAction ${e}`)}class ColumnDefinitionBuilder{#k;constructor(e){this.#k=e}autoIncrement(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{autoIncrement:!0}))}identity(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{identity:!0}))}primaryKey(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{primaryKey:!0}))}references(e){const t=parseStringReference(e);if(!t.table||ho.is(t.column))throw new Error(`invalid call references('${e}'). The reference must have format table.column or schema.table.column`);return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{references:Oa.create(t.table,[t.column])}))}onDelete(e){if(!this.#k.references)throw new Error("on delete constraint can only be added for foreign keys");return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{references:Oa.cloneWithOnDelete(this.#k.references,parseOnModifyForeignAction(e))}))}onUpdate(e){if(!this.#k.references)throw new Error("on update constraint can only be added for foreign keys");return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{references:Oa.cloneWithOnUpdate(this.#k.references,parseOnModifyForeignAction(e))}))}unique(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{unique:!0}))}notNull(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{notNull:!0}))}unsigned(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{unsigned:!0}))}defaultTo(e){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{defaultTo:Ra.create(parseDefaultValueExpression(e))}))}check(e){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{check:Ea.create(e.toOperationNode())}))}generatedAlwaysAs(e){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{generated:Pa.createWithExpression(e.toOperationNode())}))}generatedAlwaysAsIdentity(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{generated:Pa.create({identity:!0,always:!0})}))}generatedByDefaultAsIdentity(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{generated:Pa.create({identity:!0,byDefault:!0})}))}stored(){if(!this.#k.generated)throw new Error("stored() can only be called after generatedAlwaysAs");return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{generated:Pa.cloneWith(this.#k.generated,{stored:!0})}))}modifyFront(e){return new ColumnDefinitionBuilder(_a.cloneWithFrontModifier(this.#k,e.toOperationNode()))}nullsNotDistinct(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{nullsNotDistinct:!0}))}ifNotExists(){return new ColumnDefinitionBuilder(_a.cloneWith(this.#k,{ifNotExists:!0}))}modifyEnd(e){return new ColumnDefinitionBuilder(_a.cloneWithEndModifier(this.#k,e.toOperationNode()))}$call(e){return e(this)}toOperationNode(){return this.#k}}const $a=freeze({is:e=>"ModifyColumnNode"===e.kind,create:e=>freeze({kind:"ModifyColumnNode",column:e})}),Ba=freeze({is:e=>"ForeignKeyConstraintNode"===e.kind,create:(e,t,r,n)=>freeze({kind:"ForeignKeyConstraintNode",columns:e,references:Oa.create(t,r),name:n?Qs.create(n):void 0}),cloneWith:(e,t)=>freeze({...e,...t})});class ForeignKeyConstraintBuilder{#k;constructor(e){this.#k=e}onDelete(e){return new ForeignKeyConstraintBuilder(Ba.cloneWith(this.#k,{onDelete:parseOnModifyForeignAction(e)}))}onUpdate(e){return new ForeignKeyConstraintBuilder(Ba.cloneWith(this.#k,{onUpdate:parseOnModifyForeignAction(e)}))}deferrable(){return new ForeignKeyConstraintBuilder(Ba.cloneWith(this.#k,{deferrable:!0}))}notDeferrable(){return new ForeignKeyConstraintBuilder(Ba.cloneWith(this.#k,{deferrable:!1}))}initiallyDeferred(){return new ForeignKeyConstraintBuilder(Ba.cloneWith(this.#k,{initiallyDeferred:!0}))}initiallyImmediate(){return new ForeignKeyConstraintBuilder(Ba.cloneWith(this.#k,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#k}}const Ua=freeze({is:e=>"AddConstraintNode"===e.kind,create:e=>freeze({kind:"AddConstraintNode",constraint:e})}),La=freeze({is:e=>"UniqueConstraintNode"===e.kind,create:(e,t,r)=>freeze({kind:"UniqueConstraintNode",columns:freeze(e.map(po.create)),name:t?Qs.create(t):void 0,nullsNotDistinct:r}),cloneWith:(e,t)=>freeze({...e,...t})}),za=freeze({is:e=>"DropConstraintNode"===e.kind,create:e=>freeze({kind:"DropConstraintNode",constraintName:Qs.create(e)}),cloneWith:(e,t)=>freeze({...e,...t})}),Da=freeze({is:e=>"AlterColumnNode"===e.kind,create:(e,t,r)=>freeze({kind:"AlterColumnNode",column:po.create(e),[t]:r})});class AlterColumnBuilder{#O;constructor(e){this.#O=e}setDataType(e){return new AlteredColumnBuilder(Da.create(this.#O,"dataType",parseDataTypeExpression(e)))}setDefault(e){return new AlteredColumnBuilder(Da.create(this.#O,"setDefault",parseDefaultValueExpression(e)))}dropDefault(){return new AlteredColumnBuilder(Da.create(this.#O,"dropDefault",!0))}setNotNull(){return new AlteredColumnBuilder(Da.create(this.#O,"setNotNull",!0))}dropNotNull(){return new AlteredColumnBuilder(Da.create(this.#O,"dropNotNull",!0))}$call(e){return e(this)}}class AlteredColumnBuilder{#P;constructor(e){this.#P=e}toOperationNode(){return this.#P}}class AlterTableExecutor{#t;constructor(e){this.#t=freeze(e)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class AlterTableAddForeignKeyConstraintBuilder{#t;constructor(e){this.#t=freeze(e)}onDelete(e){return new AlterTableAddForeignKeyConstraintBuilder({...this.#t,constraintBuilder:this.#t.constraintBuilder.onDelete(e)})}onUpdate(e){return new AlterTableAddForeignKeyConstraintBuilder({...this.#t,constraintBuilder:this.#t.constraintBuilder.onUpdate(e)})}deferrable(){return new AlterTableAddForeignKeyConstraintBuilder({...this.#t,constraintBuilder:this.#t.constraintBuilder.deferrable()})}notDeferrable(){return new AlterTableAddForeignKeyConstraintBuilder({...this.#t,constraintBuilder:this.#t.constraintBuilder.notDeferrable()})}initiallyDeferred(){return new AlterTableAddForeignKeyConstraintBuilder({...this.#t,constraintBuilder:this.#t.constraintBuilder.initiallyDeferred()})}initiallyImmediate(){return new AlterTableAddForeignKeyConstraintBuilder({...this.#t,constraintBuilder:this.#t.constraintBuilder.initiallyImmediate()})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(Ms.cloneWithTableProps(this.#t.node,{addConstraint:Ua.create(this.#t.constraintBuilder.toOperationNode())}),this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class AlterTableDropConstraintBuilder{#t;constructor(e){this.#t=freeze(e)}ifExists(){return new AlterTableDropConstraintBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{dropConstraint:za.cloneWith(this.#t.node.dropConstraint,{ifExists:!0})})})}cascade(){return new AlterTableDropConstraintBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{dropConstraint:za.cloneWith(this.#t.node.dropConstraint,{modifier:"cascade"})})})}restrict(){return new AlterTableDropConstraintBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{dropConstraint:za.cloneWith(this.#t.node.dropConstraint,{modifier:"restrict"})})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}const qa=freeze({is:e=>"PrimaryKeyConstraintNode"===e.kind,create:(e,t)=>freeze({kind:"PrimaryKeyConstraintNode",columns:freeze(e.map(po.create)),name:t?Qs.create(t):void 0}),cloneWith:(e,t)=>freeze({...e,...t})}),Wa=freeze({is:e=>"AddIndexNode"===e.kind,create:e=>freeze({kind:"AddIndexNode",name:Qs.create(e)}),cloneWith:(e,t)=>freeze({...e,...t}),cloneWithColumns:(e,t)=>freeze({...e,columns:[...e.columns||[],...t]})});class AlterTableAddIndexBuilder{#t;constructor(e){this.#t=freeze(e)}unique(){return new AlterTableAddIndexBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addIndex:Wa.cloneWith(this.#t.node.addIndex,{unique:!0})})})}column(e){return new AlterTableAddIndexBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addIndex:Wa.cloneWithColumns(this.#t.node.addIndex,[parseOrderedColumnName(e)])})})}columns(e){return new AlterTableAddIndexBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addIndex:Wa.cloneWithColumns(this.#t.node.addIndex,e.map(parseOrderedColumnName))})})}expression(e){return new AlterTableAddIndexBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addIndex:Wa.cloneWithColumns(this.#t.node.addIndex,[e.toOperationNode()])})})}using(e){return new AlterTableAddIndexBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addIndex:Wa.cloneWith(this.#t.node.addIndex,{using:yo.createWithSql(e)})})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class UniqueConstraintNodeBuilder{#k;constructor(e){this.#k=e}nullsNotDistinct(){return new UniqueConstraintNodeBuilder(La.cloneWith(this.#k,{nullsNotDistinct:!0}))}deferrable(){return new UniqueConstraintNodeBuilder(La.cloneWith(this.#k,{deferrable:!0}))}notDeferrable(){return new UniqueConstraintNodeBuilder(La.cloneWith(this.#k,{deferrable:!1}))}initiallyDeferred(){return new UniqueConstraintNodeBuilder(La.cloneWith(this.#k,{initiallyDeferred:!0}))}initiallyImmediate(){return new UniqueConstraintNodeBuilder(La.cloneWith(this.#k,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#k}}class PrimaryKeyConstraintBuilder{#k;constructor(e){this.#k=e}deferrable(){return new PrimaryKeyConstraintBuilder(qa.cloneWith(this.#k,{deferrable:!0}))}notDeferrable(){return new PrimaryKeyConstraintBuilder(qa.cloneWith(this.#k,{deferrable:!1}))}initiallyDeferred(){return new PrimaryKeyConstraintBuilder(qa.cloneWith(this.#k,{initiallyDeferred:!0}))}initiallyImmediate(){return new PrimaryKeyConstraintBuilder(qa.cloneWith(this.#k,{initiallyDeferred:!1}))}$call(e){return e(this)}toOperationNode(){return this.#k}}class CheckConstraintBuilder{#k;constructor(e){this.#k=e}$call(e){return e(this)}toOperationNode(){return this.#k}}const ja=freeze({is:e=>"RenameConstraintNode"===e.kind,create:(e,t)=>freeze({kind:"RenameConstraintNode",oldName:Qs.create(e),newName:Qs.create(t)})});class AlterTableBuilder{#t;constructor(e){this.#t=freeze(e)}renameTo(e){return new AlterTableExecutor({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{renameTo:parseTable(e)})})}setSchema(e){return new AlterTableExecutor({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{setSchema:Qs.create(e)})})}alterColumn(e,t){const r=t(new AlterColumnBuilder(e));return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,r.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,Aa.create(e))})}renameColumn(e,t){return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,Ia.create(e,t))})}addColumn(e,t,r=noop$2){const n=r(new ColumnDefinitionBuilder(_a.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,Sa.create(n.toOperationNode()))})}modifyColumn(e,t,r=noop$2){const n=r(new ColumnDefinitionBuilder(_a.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,$a.create(n.toOperationNode()))})}addUniqueConstraint(e,t,r=noop$2){const n=r(new UniqueConstraintNodeBuilder(La.create(t,e)));return new AlterTableExecutor({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addConstraint:Ua.create(n.toOperationNode())})})}addCheckConstraint(e,t,r=noop$2){const n=r(new CheckConstraintBuilder(Ea.create(t.toOperationNode(),e)));return new AlterTableExecutor({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addConstraint:Ua.create(n.toOperationNode())})})}addForeignKeyConstraint(e,t,r,n,i=noop$2){const s=i(new ForeignKeyConstraintBuilder(Ba.create(t.map(po.create),parseTable(r),n.map(po.create),e)));return new AlterTableAddForeignKeyConstraintBuilder({...this.#t,constraintBuilder:s})}addPrimaryKeyConstraint(e,t,r=noop$2){const n=r(new PrimaryKeyConstraintBuilder(qa.create(t,e)));return new AlterTableExecutor({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addConstraint:Ua.create(n.toOperationNode())})})}dropConstraint(e){return new AlterTableDropConstraintBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{dropConstraint:za.create(e)})})}renameConstraint(e,t){return new AlterTableDropConstraintBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{renameConstraint:ja.create(e,t)})})}addIndex(e){return new AlterTableAddIndexBuilder({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{addIndex:Wa.create(e)})})}dropIndex(e){return new AlterTableExecutor({...this.#t,node:Ms.cloneWithTableProps(this.#t.node,{dropIndex:Zs.create(e)})})}$call(e){return e(this)}}class AlterTableColumnAlteringBuilder{#t;constructor(e){this.#t=freeze(e)}alterColumn(e,t){const r=t(new AlterColumnBuilder(e));return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,r.toOperationNode())})}dropColumn(e){return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,Aa.create(e))})}renameColumn(e,t){return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,Ia.create(e,t))})}addColumn(e,t,r=noop$2){const n=r(new ColumnDefinitionBuilder(_a.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,Sa.create(n.toOperationNode()))})}modifyColumn(e,t,r=noop$2){const n=r(new ColumnDefinitionBuilder(_a.create(e,parseDataTypeExpression(t))));return new AlterTableColumnAlteringBuilder({...this.#t,node:Ms.cloneWithColumnAlteration(this.#t.node,$a.create(n.toOperationNode()))})}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class ImmediateValueTransformer extends OperationNodeTransformer{transformPrimitiveValueList(e){return xo.create(e.values.map(So.createImmediate))}transformValue(e){return So.createImmediate(e.value)}}class CreateIndexBuilder{#t;constructor(e){this.#t=freeze(e)}ifNotExists(){return new CreateIndexBuilder({...this.#t,node:Vs.cloneWith(this.#t.node,{ifNotExists:!0})})}unique(){return new CreateIndexBuilder({...this.#t,node:Vs.cloneWith(this.#t.node,{unique:!0})})}nullsNotDistinct(){return new CreateIndexBuilder({...this.#t,node:Vs.cloneWith(this.#t.node,{nullsNotDistinct:!0})})}on(e){return new CreateIndexBuilder({...this.#t,node:Vs.cloneWith(this.#t.node,{table:parseTable(e)})})}column(e){return new CreateIndexBuilder({...this.#t,node:Vs.cloneWithColumns(this.#t.node,[parseOrderedColumnName(e)])})}columns(e){return new CreateIndexBuilder({...this.#t,node:Vs.cloneWithColumns(this.#t.node,e.map(parseOrderedColumnName))})}expression(e){return new CreateIndexBuilder({...this.#t,node:Vs.cloneWithColumns(this.#t.node,[e.toOperationNode()])})}using(e){return new CreateIndexBuilder({...this.#t,node:Vs.cloneWith(this.#t.node,{using:yo.createWithSql(e)})})}where(...e){const t=new ImmediateValueTransformer;return new CreateIndexBuilder({...this.#t,node:Qo.cloneWithWhere(this.#t.node,t.transformNode(parseValueBinaryOperationOrExpression(e),this.#t.queryId))})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class CreateSchemaBuilder{#t;constructor(e){this.#t=freeze(e)}ifNotExists(){return new CreateSchemaBuilder({...this.#t,node:Fs.cloneWith(this.#t.node,{ifNotExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}function parseOnCommitAction(e){if(Js.includes(e))return e;throw new Error(`invalid OnCommitAction ${e}`)}class CreateTableBuilder{#t;constructor(e){this.#t=freeze(e)}temporary(){return new CreateTableBuilder({...this.#t,node:Ks.cloneWith(this.#t.node,{temporary:!0})})}onCommit(e){return new CreateTableBuilder({...this.#t,node:Ks.cloneWith(this.#t.node,{onCommit:parseOnCommitAction(e)})})}ifNotExists(){return new CreateTableBuilder({...this.#t,node:Ks.cloneWith(this.#t.node,{ifNotExists:!0})})}addColumn(e,t,r=noop$2){const n=r(new ColumnDefinitionBuilder(_a.create(e,parseDataTypeExpression(t))));return new CreateTableBuilder({...this.#t,node:Ks.cloneWithColumn(this.#t.node,n.toOperationNode())})}addPrimaryKeyConstraint(e,t,r=noop$2){const n=r(new PrimaryKeyConstraintBuilder(qa.create(t,e)));return new CreateTableBuilder({...this.#t,node:Ks.cloneWithConstraint(this.#t.node,n.toOperationNode())})}addUniqueConstraint(e,t,r=noop$2){const n=r(new UniqueConstraintNodeBuilder(La.create(t,e)));return new CreateTableBuilder({...this.#t,node:Ks.cloneWithConstraint(this.#t.node,n.toOperationNode())})}addCheckConstraint(e,t,r=noop$2){const n=r(new CheckConstraintBuilder(Ea.create(t.toOperationNode(),e)));return new CreateTableBuilder({...this.#t,node:Ks.cloneWithConstraint(this.#t.node,n.toOperationNode())})}addForeignKeyConstraint(e,t,r,n,i=noop$2){const s=i(new ForeignKeyConstraintBuilder(Ba.create(t.map(po.create),parseTable(r),n.map(po.create),e)));return new CreateTableBuilder({...this.#t,node:Ks.cloneWithConstraint(this.#t.node,s.toOperationNode())})}modifyFront(e){return new CreateTableBuilder({...this.#t,node:Ks.cloneWithFrontModifier(this.#t.node,e.toOperationNode())})}modifyEnd(e){return new CreateTableBuilder({...this.#t,node:Ks.cloneWithEndModifier(this.#t.node,e.toOperationNode())})}as(e){return new CreateTableBuilder({...this.#t,node:Ks.cloneWith(this.#t.node,{selectQuery:parseExpression(e)})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class DropIndexBuilder{#t;constructor(e){this.#t=freeze(e)}on(e){return new DropIndexBuilder({...this.#t,node:Zs.cloneWith(this.#t.node,{table:parseTable(e)})})}ifExists(){return new DropIndexBuilder({...this.#t,node:Zs.cloneWith(this.#t.node,{ifExists:!0})})}cascade(){return new DropIndexBuilder({...this.#t,node:Zs.cloneWith(this.#t.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class DropSchemaBuilder{#t;constructor(e){this.#t=freeze(e)}ifExists(){return new DropSchemaBuilder({...this.#t,node:Gs.cloneWith(this.#t.node,{ifExists:!0})})}cascade(){return new DropSchemaBuilder({...this.#t,node:Gs.cloneWith(this.#t.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class DropTableBuilder{#t;constructor(e){this.#t=freeze(e)}ifExists(){return new DropTableBuilder({...this.#t,node:Ys.cloneWith(this.#t.node,{ifExists:!0})})}cascade(){return new DropTableBuilder({...this.#t,node:Ys.cloneWith(this.#t.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}const Ma=freeze({is:e=>"CreateViewNode"===e.kind,create:e=>freeze({kind:"CreateViewNode",name:Hs.create(e)}),cloneWith:(e,t)=>freeze({...e,...t})});class ImmediateValuePlugin{#m=new ImmediateValueTransformer;transformQuery(e){return this.#m.transformNode(e.node,e.queryId)}transformResult(e){return Promise.resolve(e.result)}}class CreateViewBuilder{#t;constructor(e){this.#t=freeze(e)}temporary(){return new CreateViewBuilder({...this.#t,node:Ma.cloneWith(this.#t.node,{temporary:!0})})}materialized(){return new CreateViewBuilder({...this.#t,node:Ma.cloneWith(this.#t.node,{materialized:!0})})}ifNotExists(){return new CreateViewBuilder({...this.#t,node:Ma.cloneWith(this.#t.node,{ifNotExists:!0})})}orReplace(){return new CreateViewBuilder({...this.#t,node:Ma.cloneWith(this.#t.node,{orReplace:!0})})}columns(e){return new CreateViewBuilder({...this.#t,node:Ma.cloneWith(this.#t.node,{columns:e.map(parseColumnName)})})}as(e){const t=e.withPlugin(new ImmediateValuePlugin).toOperationNode();return new CreateViewBuilder({...this.#t,node:Ma.cloneWith(this.#t.node,{as:t})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}const Qa=freeze({is:e=>"DropViewNode"===e.kind,create:e=>freeze({kind:"DropViewNode",name:Hs.create(e)}),cloneWith:(e,t)=>freeze({...e,...t})});class DropViewBuilder{#t;constructor(e){this.#t=freeze(e)}materialized(){return new DropViewBuilder({...this.#t,node:Qa.cloneWith(this.#t.node,{materialized:!0})})}ifExists(){return new DropViewBuilder({...this.#t,node:Qa.cloneWith(this.#t.node,{ifExists:!0})})}cascade(){return new DropViewBuilder({...this.#t,node:Qa.cloneWith(this.#t.node,{cascade:!0})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}const Va=freeze({is:e=>"CreateTypeNode"===e.kind,create:e=>freeze({kind:"CreateTypeNode",name:e}),cloneWithEnum:(e,t)=>freeze({...e,enum:xo.create(t.map(So.createImmediate))})});class CreateTypeBuilder{#t;constructor(e){this.#t=freeze(e)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}asEnum(e){return new CreateTypeBuilder({...this.#t,node:Va.cloneWithEnum(this.#t.node,e)})}$call(e){return e(this)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}const Fa=freeze({is:e=>"DropTypeNode"===e.kind,create:e=>freeze({kind:"DropTypeNode",name:e}),cloneWith:(e,t)=>freeze({...e,...t})});class DropTypeBuilder{#t;constructor(e){this.#t=freeze(e)}ifExists(){return new DropTypeBuilder({...this.#t,node:Fa.cloneWith(this.#t.node,{ifExists:!0})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}function parseSchemableIdentifier(e){if(e.includes(".")){const t=e.split(".").map(trim);if(2===t.length)return Hs.createWithSchema(t[0],t[1]);throw new Error(`invalid schemable identifier ${e}`)}return Hs.create(e)}function trim(e){return e.trim()}const Ja=freeze({is:e=>"RefreshMaterializedViewNode"===e.kind,create:e=>freeze({kind:"RefreshMaterializedViewNode",name:Hs.create(e)}),cloneWith:(e,t)=>freeze({...e,...t})});class RefreshMaterializedViewBuilder{#t;constructor(e){this.#t=freeze(e)}concurrently(){return new RefreshMaterializedViewBuilder({...this.#t,node:Ja.cloneWith(this.#t.node,{concurrently:!0,withNoData:!1})})}withData(){return new RefreshMaterializedViewBuilder({...this.#t,node:Ja.cloneWith(this.#t.node,{withNoData:!1})})}withNoData(){return new RefreshMaterializedViewBuilder({...this.#t,node:Ja.cloneWith(this.#t.node,{withNoData:!0,concurrently:!1})})}$call(e){return e(this)}toOperationNode(){return this.#t.executor.transformQuery(this.#t.node,this.#t.queryId)}compile(){return this.#t.executor.compileQuery(this.toOperationNode(),this.#t.queryId)}async execute(){await this.#t.executor.executeQuery(this.compile())}}class SchemaModule{#R;constructor(e){this.#R=e}createTable(e){return new CreateTableBuilder({queryId:createQueryId(),executor:this.#R,node:Ks.create(parseTable(e))})}dropTable(e){return new DropTableBuilder({queryId:createQueryId(),executor:this.#R,node:Ys.create(parseTable(e))})}createIndex(e){return new CreateIndexBuilder({queryId:createQueryId(),executor:this.#R,node:Vs.create(e)})}dropIndex(e){return new DropIndexBuilder({queryId:createQueryId(),executor:this.#R,node:Zs.create(e)})}createSchema(e){return new CreateSchemaBuilder({queryId:createQueryId(),executor:this.#R,node:Fs.create(e)})}dropSchema(e){return new DropSchemaBuilder({queryId:createQueryId(),executor:this.#R,node:Gs.create(e)})}alterTable(e){return new AlterTableBuilder({queryId:createQueryId(),executor:this.#R,node:Ms.create(parseTable(e))})}createView(e){return new CreateViewBuilder({queryId:createQueryId(),executor:this.#R,node:Ma.create(e)})}refreshMaterializedView(e){return new RefreshMaterializedViewBuilder({queryId:createQueryId(),executor:this.#R,node:Ja.create(e)})}dropView(e){return new DropViewBuilder({queryId:createQueryId(),executor:this.#R,node:Qa.create(e)})}createType(e){return new CreateTypeBuilder({queryId:createQueryId(),executor:this.#R,node:Va.create(parseSchemableIdentifier(e))})}dropType(e){return new DropTypeBuilder({queryId:createQueryId(),executor:this.#R,node:Fa.create(parseSchemableIdentifier(e))})}withPlugin(e){return new SchemaModule(this.#R.withPlugin(e))}withoutPlugins(){return new SchemaModule(this.#R.withoutPlugins())}withSchema(e){return new SchemaModule(this.#R.withPluginAtFront(new WithSchemaPlugin(e)))}}class DynamicModule{ref(e){return new DynamicReferenceBuilder(e)}table(e){return new DynamicTableBuilder(e)}}class DefaultConnectionProvider{#$;constructor(e){this.#$=e}async provideConnection(e){const t=await this.#$.acquireConnection();try{return await e(t)}finally{await this.#$.releaseConnection(t)}}}class DefaultQueryExecutor extends QueryExecutorBase{#B;#U;#L;constructor(e,t,r,n=[]){super(n),this.#B=e,this.#U=t,this.#L=r}get adapter(){return this.#U}compileQuery(e,t){return this.#B.compileQuery(e,t)}provideConnection(e){return this.#L.provideConnection(e)}withPlugins(e){return new DefaultQueryExecutor(this.#B,this.#U,this.#L,[...this.plugins,...e])}withPlugin(e){return new DefaultQueryExecutor(this.#B,this.#U,this.#L,[...this.plugins,e])}withPluginAtFront(e){return new DefaultQueryExecutor(this.#B,this.#U,this.#L,[e,...this.plugins])}withConnectionProvider(e){return new DefaultQueryExecutor(this.#B,this.#U,e,[...this.plugins])}withoutPlugins(){return new DefaultQueryExecutor(this.#B,this.#U,this.#L,[])}}const Ka=globalThis.performance?.timeOrigin??Date.now(),Ha=globalThis.performance?.now?globalThis.performance.now.bind(globalThis.performance):()=>Date.now()-Ka,Za=["event","mark","measure","resource"];class _PerformanceEntry{__unenv__=!0;detail;entryType="event";name;startTime;constructor(e,t){this.name=e,this.startTime=t?.startTime||Ha(),this.detail=t?.detail}get duration(){return Ha()-this.startTime}toJSON(){return{name:this.name,entryType:this.entryType,startTime:this.startTime,duration:this.duration,detail:this.detail}}}class _PerformanceMark extends _PerformanceEntry{entryType="mark"}class _PerformanceMeasure extends _PerformanceEntry{entryType="measure"}class _Performance{__unenv__=!0;timeOrigin=Ka;eventCounts=new Map;_entries=[];_resourceTimingBufferSize=0;navigation=void 0;timing=void 0;onresourcetimingbufferfull=null;now(){return this.timeOrigin===Ka?Ha():Date.now()-this.timeOrigin}clearMarks(e){this._entries=e?this._entries.filter(t=>t.name!==e):this._entries.filter(e=>"mark"!==e.entryType)}clearMeasures(e){this._entries=e?this._entries.filter(t=>t.name!==e):this._entries.filter(e=>"measure"!==e.entryType)}clearResourceTimings(){this._entries=this._entries.filter(e=>"resource"!==e.entryType||"navigation"!==e.entryType)}getEntries(){return this._entries}getEntriesByName(e,t){return this._entries.filter(r=>r.name===e&&(!t||r.entryType===t))}getEntriesByType(e){return this._entries.filter(t=>t.entryType===e)}mark(e,t){const r=new _PerformanceMark(e,t);return this._entries.push(r),r}measure(e,t,r){let n,i;"string"==typeof t?(n=this.getEntriesByName(t,"mark")[0]?.startTime,i=this.getEntriesByName(r,"mark")[0]?.startTime):(n=Number.parseFloat(t?.start)||this.now(),i=Number.parseFloat(t?.end)||this.now());const s=new _PerformanceMeasure(e,{startTime:n,detail:{start:n,end:i}});return this._entries.push(s),s}setResourceTimingBufferSize(e){this._resourceTimingBufferSize=e}toJSON(){return this}addEventListener(e,t,r){throw i("Performance.addEventListener")}removeEventListener(e,t,r){throw i("Performance.removeEventListener")}dispatchEvent(e){throw i("Performance.dispatchEvent")}}const Ga=globalThis.PerformanceEntry||_PerformanceEntry,Ya=globalThis.PerformanceMark||_PerformanceMark,Xa=globalThis.PerformanceMeasure||_PerformanceMeasure,ec=globalThis.PerformanceResourceTiming||class extends _PerformanceEntry{entryType="resource";serverTiming=[];connectEnd=0;connectStart=0;decodedBodySize=0;domainLookupEnd=0;domainLookupStart=0;encodedBodySize=0;fetchStart=0;initiatorType="";name="";nextHopProtocol="";redirectEnd=0;redirectStart=0;requestStart=0;responseEnd=0;responseStart=0;secureConnectionStart=0;startTime=0;transferSize=0;workerStart=0;responseStatus=0},tc=globalThis.PerformanceObserver||class{__unenv__=!0;static supportedEntryTypes=Za;_callback=null;constructor(e){this._callback=e}takeRecords(){return[]}disconnect(){throw i("PerformanceObserver.disconnect")}observe(e){throw i("PerformanceObserver.observe")}},rc=globalThis.Performance||_Performance,nc=globalThis.PerformanceObserverEntryList||class{__unenv__=!0;getEntries(){return[]}getEntriesByName(e,t){return[]}getEntriesByType(e){return[]}},ic=globalThis.performance&&"addEventListener"in globalThis.performance?globalThis.performance:new _Performance;globalThis.performance||=ic,globalThis.Performance||=rc,globalThis.PerformanceEntry||=Ga,globalThis.PerformanceMark||=Ya,globalThis.PerformanceMeasure||=Xa,globalThis.PerformanceObserver||=tc,globalThis.PerformanceObserverEntryList||=nc,globalThis.PerformanceResourceTiming||=ec;const sc=globalThis.performance;function performanceNow(){return void 0!==sc&&isFunction(sc.now)?sc.now():Date.now()}class RuntimeDriver{#$;#z;#D;#q;#W;#j=new WeakSet;constructor(e,t){this.#q=!1,this.#$=e,this.#z=t}async init(){if(this.#W)throw new Error("driver has already been destroyed");this.#D||(this.#D=this.#$.init().then(()=>{this.#q=!0}).catch(e=>(this.#D=void 0,Promise.reject(e)))),await this.#D}async acquireConnection(){if(this.#W)throw new Error("driver has already been destroyed");this.#q||await this.init();const e=await this.#$.acquireConnection();return this.#j.has(e)||(this.#M()&&this.#Q(e),this.#j.add(e)),e}async releaseConnection(e){await this.#$.releaseConnection(e)}beginTransaction(e,t){return this.#$.beginTransaction(e,t)}commitTransaction(e){return this.#$.commitTransaction(e)}rollbackTransaction(e){return this.#$.rollbackTransaction(e)}savepoint(e,t,r){if(this.#$.savepoint)return this.#$.savepoint(e,t,r);throw new Error("The `savepoint` method is not supported by this driver")}rollbackToSavepoint(e,t,r){if(this.#$.rollbackToSavepoint)return this.#$.rollbackToSavepoint(e,t,r);throw new Error("The `rollbackToSavepoint` method is not supported by this driver")}releaseSavepoint(e,t,r){if(this.#$.releaseSavepoint)return this.#$.releaseSavepoint(e,t,r);throw new Error("The `releaseSavepoint` method is not supported by this driver")}async destroy(){this.#D&&(await this.#D,this.#W||(this.#W=this.#$.destroy().catch(e=>(this.#W=void 0,Promise.reject(e)))),await this.#W)}#M(){return this.#z.isLevelEnabled("query")||this.#z.isLevelEnabled("error")}#Q(e){const t=e.executeQuery,r=e.streamQuery,n=this;e.executeQuery=async r=>{let i;const s=performanceNow();try{return await t.call(e,r)}catch(e){throw i=e,await n.#V(e,r,s),e}finally{i||await n.#F(r,s)}},e.streamQuery=async function*(t,i){let s;const o=performanceNow();try{for await(const n of r.call(e,t,i))yield n}catch(e){throw s=e,await n.#V(e,t,o),e}finally{s||await n.#F(t,o,!0)}}}async#V(e,t,r){await this.#z.error(()=>({level:"error",error:e,query:t,queryDurationMillis:this.#J(r)}))}async#F(e,t,r=!1){await this.#z.query(()=>({level:"query",isStream:r,query:e,queryDurationMillis:this.#J(t)}))}#J(e){return performanceNow()-e}}const ignoreError=()=>{};class SingleConnectionProvider{#K;#H;constructor(e){this.#K=e}async provideConnection(e){for(;this.#H;)await this.#H.catch(ignoreError);return this.#H=this.#Z(e).finally(()=>{this.#H=void 0}),this.#H}async#Z(e){return await e(this.#K)}}const oc=["read only","read write"],ac=["read uncommitted","read committed","repeatable read","serializable","snapshot"];function validateTransactionSettings(e){if(e.accessMode&&!oc.includes(e.accessMode))throw new Error(`invalid transaction access mode ${e.accessMode}`);if(e.isolationLevel&&!ac.includes(e.isolationLevel))throw new Error(`invalid transaction isolation level ${e.isolationLevel}`)}freeze(["query","error"]);class Log{#G;#Y;constructor(e){isFunction(e)?(this.#Y=e,this.#G=freeze({query:!0,error:!0})):(this.#Y=defaultLogger,this.#G=freeze({query:e.includes("query"),error:e.includes("error")}))}isLevelEnabled(e){return this.#G[e]}async query(e){this.#G.query&&await this.#Y(e())}async error(e){this.#G.error&&await this.#Y(e())}}function defaultLogger(e){if("query"===e.level){const t="kysely:query:"+(e.isStream?"stream:":"");console.log(`${t} ${e.query.sql}`),console.log(`${t} duration: ${e.queryDurationMillis.toFixed(1)}ms`)}else"error"===e.level&&(e.error instanceof Error?console.error(`kysely:error: ${e.error.stack??e.error.message}`):console.error(`kysely:error: ${JSON.stringify({error:e.error,query:e.query.sql,queryDurationMillis:e.queryDurationMillis})}`))}Symbol.asyncDispose??=Symbol("Symbol.asyncDispose");class Kysely extends QueryCreator{#t;constructor(e){let t,r;if(isObject(n=e)&&isObject(n.config)&&isObject(n.driver)&&isObject(n.executor)&&isObject(n.dialect))t={executor:e.executor},r={...e};else{const n=e.dialect,i=n.createDriver(),s=n.createQueryCompiler(),o=n.createAdapter(),a=new Log(e.log??[]),c=new RuntimeDriver(i,a),d=new DefaultConnectionProvider(c),l=new DefaultQueryExecutor(s,o,d,e.plugins??[]);t={executor:l},r={config:e,executor:l,dialect:n,driver:c}}var n;super(t),this.#t=freeze(r)}get schema(){return new SchemaModule(this.#t.executor)}get dynamic(){return new DynamicModule}get introspection(){return this.#t.dialect.createIntrospector(this.withoutPlugins())}case(e){return new CaseBuilder({node:wa.create(isUndefined(e)?void 0:parseExpression(e))})}get fn(){return createFunctionModule()}transaction(){return new TransactionBuilder({...this.#t})}startTransaction(){return new ControlledTransactionBuilder({...this.#t})}connection(){return new ConnectionBuilder({...this.#t})}withPlugin(e){return new Kysely({...this.#t,executor:this.#t.executor.withPlugin(e)})}withoutPlugins(){return new Kysely({...this.#t,executor:this.#t.executor.withoutPlugins()})}withSchema(e){return new Kysely({...this.#t,executor:this.#t.executor.withPluginAtFront(new WithSchemaPlugin(e))})}withTables(){return new Kysely({...this.#t})}async destroy(){await this.#t.driver.destroy()}get isTransaction(){return!1}getExecutor(){return this.#t.executor}executeQuery(e,t){void 0!==t&&logOnce("Passing `queryId` in `db.executeQuery` is deprecated and will result in a compile-time error in the future.");const r=isObject(n=e)&&isFunction(n.compile)?e.compile():e;var n;return this.getExecutor().executeQuery(r)}async[Symbol.asyncDispose](){await this.destroy()}}class Transaction extends Kysely{#t;constructor(e){super(e),this.#t=e}get isTransaction(){return!0}transaction(){throw new Error("calling the transaction method for a Transaction is not supported")}connection(){throw new Error("calling the connection method for a Transaction is not supported")}async destroy(){throw new Error("calling the destroy method for a Transaction is not supported")}withPlugin(e){return new Transaction({...this.#t,executor:this.#t.executor.withPlugin(e)})}withoutPlugins(){return new Transaction({...this.#t,executor:this.#t.executor.withoutPlugins()})}withSchema(e){return new Transaction({...this.#t,executor:this.#t.executor.withPluginAtFront(new WithSchemaPlugin(e))})}withTables(){return new Transaction({...this.#t})}}class ConnectionBuilder{#t;constructor(e){this.#t=freeze(e)}async execute(e){return this.#t.executor.provideConnection(async t=>{const r=this.#t.executor.withConnectionProvider(new SingleConnectionProvider(t)),n=new Kysely({...this.#t,executor:r});return await e(n)})}}class TransactionBuilder{#t;constructor(e){this.#t=freeze(e)}setAccessMode(e){return new TransactionBuilder({...this.#t,accessMode:e})}setIsolationLevel(e){return new TransactionBuilder({...this.#t,isolationLevel:e})}async execute(e){const{isolationLevel:t,accessMode:r,...n}=this.#t,i={isolationLevel:t,accessMode:r};return validateTransactionSettings(i),this.#t.executor.provideConnection(async t=>{const r=this.#t.executor.withConnectionProvider(new SingleConnectionProvider(t)),s=new Transaction({...n,executor:r});try{await this.#t.driver.beginTransaction(t,i);const r=await e(s);return await this.#t.driver.commitTransaction(t),r}catch(e){throw await this.#t.driver.rollbackTransaction(t),e}})}}class ControlledTransactionBuilder{#t;constructor(e){this.#t=freeze(e)}setAccessMode(e){return new ControlledTransactionBuilder({...this.#t,accessMode:e})}setIsolationLevel(e){return new ControlledTransactionBuilder({...this.#t,isolationLevel:e})}async execute(){const{isolationLevel:e,accessMode:t,...r}=this.#t,n={isolationLevel:e,accessMode:t};validateTransactionSettings(n);const i=await provideControlledConnection(this.#t.executor);return await this.#t.driver.beginTransaction(i.connection,n),new ControlledTransaction({...r,connection:i,executor:this.#t.executor.withConnectionProvider(new SingleConnectionProvider(i.connection))})}}class ControlledTransaction extends Transaction{#t;#X;#ee;constructor(e){const t={isCommitted:!1,isRolledBack:!1};e={...e,executor:new NotCommittedOrRolledBackAssertingExecutor(e.executor,t)};const{connection:r,...n}=e;super(n),this.#t=freeze(e),this.#ee=t;const i=createQueryId();this.#X=t=>e.executor.compileQuery(t,i)}get isCommitted(){return this.#ee.isCommitted}get isRolledBack(){return this.#ee.isRolledBack}commit(){return assertNotCommittedOrRolledBack(this.#ee),new Command(async()=>{await this.#t.driver.commitTransaction(this.#t.connection.connection),this.#ee.isCommitted=!0,this.#t.connection.release()})}rollback(){return assertNotCommittedOrRolledBack(this.#ee),new Command(async()=>{await this.#t.driver.rollbackTransaction(this.#t.connection.connection),this.#ee.isRolledBack=!0,this.#t.connection.release()})}savepoint(e){return assertNotCommittedOrRolledBack(this.#ee),new Command(async()=>(await(this.#t.driver.savepoint?.(this.#t.connection.connection,e,this.#X)),new ControlledTransaction({...this.#t})))}rollbackToSavepoint(e){return assertNotCommittedOrRolledBack(this.#ee),new Command(async()=>(await(this.#t.driver.rollbackToSavepoint?.(this.#t.connection.connection,e,this.#X)),new ControlledTransaction({...this.#t})))}releaseSavepoint(e){return assertNotCommittedOrRolledBack(this.#ee),new Command(async()=>(await(this.#t.driver.releaseSavepoint?.(this.#t.connection.connection,e,this.#X)),new ControlledTransaction({...this.#t})))}withPlugin(e){return new ControlledTransaction({...this.#t,executor:this.#t.executor.withPlugin(e)})}withoutPlugins(){return new ControlledTransaction({...this.#t,executor:this.#t.executor.withoutPlugins()})}withSchema(e){return new ControlledTransaction({...this.#t,executor:this.#t.executor.withPluginAtFront(new WithSchemaPlugin(e))})}withTables(){return new ControlledTransaction({...this.#t})}}class Command{#te;constructor(e){this.#te=e}async execute(){return await this.#te()}}function assertNotCommittedOrRolledBack(e){if(e.isCommitted)throw new Error("Transaction is already committed");if(e.isRolledBack)throw new Error("Transaction is already rolled back")}class NotCommittedOrRolledBackAssertingExecutor{#R;#ee;constructor(e,t){this.#R=e instanceof NotCommittedOrRolledBackAssertingExecutor?e.#R:e,this.#ee=t}get adapter(){return this.#R.adapter}get plugins(){return this.#R.plugins}transformQuery(e,t){return this.#R.transformQuery(e,t)}compileQuery(e,t){return this.#R.compileQuery(e,t)}provideConnection(e){return this.#R.provideConnection(e)}executeQuery(e){return assertNotCommittedOrRolledBack(this.#ee),this.#R.executeQuery(e)}stream(e,t){return assertNotCommittedOrRolledBack(this.#ee),this.#R.stream(e,t)}withConnectionProvider(e){return new NotCommittedOrRolledBackAssertingExecutor(this.#R.withConnectionProvider(e),this.#ee)}withPlugin(e){return new NotCommittedOrRolledBackAssertingExecutor(this.#R.withPlugin(e),this.#ee)}withPlugins(e){return new NotCommittedOrRolledBackAssertingExecutor(this.#R.withPlugins(e),this.#ee)}withPluginAtFront(e){return new NotCommittedOrRolledBackAssertingExecutor(this.#R.withPluginAtFront(e),this.#ee)}withoutPlugins(){return new NotCommittedOrRolledBackAssertingExecutor(this.#R.withoutPlugins(),this.#ee)}}class RawBuilderImpl{#t;constructor(e){this.#t=freeze(e)}get expressionType(){}get isRawBuilder(){return!0}as(e){return new AliasedRawBuilderImpl(this,e)}$castTo(){return new RawBuilderImpl({...this.#t})}$notNull(){return new RawBuilderImpl(this.#t)}withPlugin(e){return new RawBuilderImpl({...this.#t,plugins:void 0!==this.#t.plugins?freeze([...this.#t.plugins,e]):freeze([e])})}toOperationNode(){return this.#re(this.#ne())}compile(e){return this.#ie(this.#ne(e))}async execute(e){const t=this.#ne(e);return t.executeQuery(this.#ie(t))}#ne(e){const t=void 0!==e?e.getExecutor():la;return void 0!==this.#t.plugins?t.withPlugins(this.#t.plugins):t}#re(e){return e.transformQuery(this.#t.rawNode,this.#t.queryId)}#ie(e){return e.compileQuery(this.#re(e),this.#t.queryId)}}function createRawBuilder(e){return new RawBuilderImpl(e)}class AliasedRawBuilderImpl{#se;#S;constructor(e,t){this.#se=e,this.#S=t}get expression(){return this.#se}get alias(){return this.#S}get rawBuilder(){return this.#se}toOperationNode(){return Xs.create(this.#se.toOperationNode(),isOperationNodeSource(this.#S)?this.#S.toOperationNode():Qs.create(this.#S))}}const cc=Object.assign((e,...t)=>createRawBuilder({queryId:createQueryId(),rawNode:yo.create(e,t?.map(parseParameter)??[])}),{ref:e=>createRawBuilder({queryId:createQueryId(),rawNode:yo.createWithChild(parseStringReference(e))}),val:e=>createRawBuilder({queryId:createQueryId(),rawNode:yo.createWithChild(parseValueExpression(e))}),value(e){return this.val(e)},table:e=>createRawBuilder({queryId:createQueryId(),rawNode:yo.createWithChild(parseTable(e))}),id(...e){const t=new Array(e.length+1).fill(".");return t[0]="",t[t.length-1]="",createRawBuilder({queryId:createQueryId(),rawNode:yo.create(t,e.map(Qs.create))})},lit:e=>createRawBuilder({queryId:createQueryId(),rawNode:yo.createWithChild(So.createImmediate(e))}),literal(e){return this.lit(e)},raw:e=>createRawBuilder({queryId:createQueryId(),rawNode:yo.createWithSql(e)}),join(e,t=cc`, `){const r=new Array(Math.max(2*e.length-1,0)),n=t.toOperationNode();for(let t=0;t<e.length;++t)r[2*t]=parseParameter(e[t]),t!==e.length-1&&(r[2*t+1]=n);return createRawBuilder({queryId:createQueryId(),rawNode:yo.createWithChildren(r)})}});function parseParameter(e){return isOperationNodeSource(e)?e.toOperationNode():parseValueExpression(e)}class OperationNodeVisitor{nodeStack=[];get parentNode(){return this.nodeStack[this.nodeStack.length-2]}#oe=freeze({AliasNode:this.visitAlias.bind(this),ColumnNode:this.visitColumn.bind(this),IdentifierNode:this.visitIdentifier.bind(this),SchemableIdentifierNode:this.visitSchemableIdentifier.bind(this),RawNode:this.visitRaw.bind(this),ReferenceNode:this.visitReference.bind(this),SelectQueryNode:this.visitSelectQuery.bind(this),SelectionNode:this.visitSelection.bind(this),TableNode:this.visitTable.bind(this),FromNode:this.visitFrom.bind(this),SelectAllNode:this.visitSelectAll.bind(this),AndNode:this.visitAnd.bind(this),OrNode:this.visitOr.bind(this),ValueNode:this.visitValue.bind(this),ValueListNode:this.visitValueList.bind(this),PrimitiveValueListNode:this.visitPrimitiveValueList.bind(this),ParensNode:this.visitParens.bind(this),JoinNode:this.visitJoin.bind(this),OperatorNode:this.visitOperator.bind(this),WhereNode:this.visitWhere.bind(this),InsertQueryNode:this.visitInsertQuery.bind(this),DeleteQueryNode:this.visitDeleteQuery.bind(this),ReturningNode:this.visitReturning.bind(this),CreateTableNode:this.visitCreateTable.bind(this),AddColumnNode:this.visitAddColumn.bind(this),ColumnDefinitionNode:this.visitColumnDefinition.bind(this),DropTableNode:this.visitDropTable.bind(this),DataTypeNode:this.visitDataType.bind(this),OrderByNode:this.visitOrderBy.bind(this),OrderByItemNode:this.visitOrderByItem.bind(this),GroupByNode:this.visitGroupBy.bind(this),GroupByItemNode:this.visitGroupByItem.bind(this),UpdateQueryNode:this.visitUpdateQuery.bind(this),ColumnUpdateNode:this.visitColumnUpdate.bind(this),LimitNode:this.visitLimit.bind(this),OffsetNode:this.visitOffset.bind(this),OnConflictNode:this.visitOnConflict.bind(this),OnDuplicateKeyNode:this.visitOnDuplicateKey.bind(this),CreateIndexNode:this.visitCreateIndex.bind(this),DropIndexNode:this.visitDropIndex.bind(this),ListNode:this.visitList.bind(this),PrimaryKeyConstraintNode:this.visitPrimaryKeyConstraint.bind(this),UniqueConstraintNode:this.visitUniqueConstraint.bind(this),ReferencesNode:this.visitReferences.bind(this),CheckConstraintNode:this.visitCheckConstraint.bind(this),WithNode:this.visitWith.bind(this),CommonTableExpressionNode:this.visitCommonTableExpression.bind(this),CommonTableExpressionNameNode:this.visitCommonTableExpressionName.bind(this),HavingNode:this.visitHaving.bind(this),CreateSchemaNode:this.visitCreateSchema.bind(this),DropSchemaNode:this.visitDropSchema.bind(this),AlterTableNode:this.visitAlterTable.bind(this),DropColumnNode:this.visitDropColumn.bind(this),RenameColumnNode:this.visitRenameColumn.bind(this),AlterColumnNode:this.visitAlterColumn.bind(this),ModifyColumnNode:this.visitModifyColumn.bind(this),AddConstraintNode:this.visitAddConstraint.bind(this),DropConstraintNode:this.visitDropConstraint.bind(this),RenameConstraintNode:this.visitRenameConstraint.bind(this),ForeignKeyConstraintNode:this.visitForeignKeyConstraint.bind(this),CreateViewNode:this.visitCreateView.bind(this),RefreshMaterializedViewNode:this.visitRefreshMaterializedView.bind(this),DropViewNode:this.visitDropView.bind(this),GeneratedNode:this.visitGenerated.bind(this),DefaultValueNode:this.visitDefaultValue.bind(this),OnNode:this.visitOn.bind(this),ValuesNode:this.visitValues.bind(this),SelectModifierNode:this.visitSelectModifier.bind(this),CreateTypeNode:this.visitCreateType.bind(this),DropTypeNode:this.visitDropType.bind(this),ExplainNode:this.visitExplain.bind(this),DefaultInsertValueNode:this.visitDefaultInsertValue.bind(this),AggregateFunctionNode:this.visitAggregateFunction.bind(this),OverNode:this.visitOver.bind(this),PartitionByNode:this.visitPartitionBy.bind(this),PartitionByItemNode:this.visitPartitionByItem.bind(this),SetOperationNode:this.visitSetOperation.bind(this),BinaryOperationNode:this.visitBinaryOperation.bind(this),UnaryOperationNode:this.visitUnaryOperation.bind(this),UsingNode:this.visitUsing.bind(this),FunctionNode:this.visitFunction.bind(this),CaseNode:this.visitCase.bind(this),WhenNode:this.visitWhen.bind(this),JSONReferenceNode:this.visitJSONReference.bind(this),JSONPathNode:this.visitJSONPath.bind(this),JSONPathLegNode:this.visitJSONPathLeg.bind(this),JSONOperatorChainNode:this.visitJSONOperatorChain.bind(this),TupleNode:this.visitTuple.bind(this),MergeQueryNode:this.visitMergeQuery.bind(this),MatchedNode:this.visitMatched.bind(this),AddIndexNode:this.visitAddIndex.bind(this),CastNode:this.visitCast.bind(this),FetchNode:this.visitFetch.bind(this),TopNode:this.visitTop.bind(this),OutputNode:this.visitOutput.bind(this),OrActionNode:this.visitOrAction.bind(this),CollateNode:this.visitCollate.bind(this)});visitNode=e=>{this.nodeStack.push(e),this.#oe[e.kind](e),this.nodeStack.pop()}}const dc=/'/g;class DefaultQueryCompiler extends OperationNodeVisitor{#ae="";#ce=[];get numParameters(){return this.#ce.length}compileQuery(e,t){return this.#ae="",this.#ce=[],this.nodeStack.splice(0,this.nodeStack.length),this.visitNode(e),freeze({query:e,queryId:t,sql:this.getSql(),parameters:[...this.#ce]})}getSql(){return this.#ae}visitSelectQuery(e){const t=!(void 0===this.parentNode||_o.is(this.parentNode)||Ro.is(this.parentNode)||Ks.is(this.parentNode)||Ma.is(this.parentNode)||ha.is(this.parentNode));void 0===this.parentNode&&e.explain&&(this.visitNode(e.explain),this.append(" ")),t&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("select"),e.distinctOn&&(this.append(" "),this.compileDistinctOn(e.distinctOn)),e.frontModifiers?.length&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.top&&(this.append(" "),this.visitNode(e.top)),e.selections&&(this.append(" "),this.compileList(e.selections)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.groupBy&&(this.append(" "),this.visitNode(e.groupBy)),e.having&&(this.append(" "),this.visitNode(e.having)),e.setOperations&&(this.append(" "),this.compileList(e.setOperations," ")),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.offset&&(this.append(" "),this.visitNode(e.offset)),e.fetch&&(this.append(" "),this.visitNode(e.fetch)),e.endModifiers?.length&&(this.append(" "),this.compileList(this.sortSelectModifiers([...e.endModifiers])," ")),t&&this.append(")")}visitFrom(e){this.append("from "),this.compileList(e.froms)}visitSelection(e){this.visitNode(e.selection)}visitColumn(e){this.visitNode(e.column)}compileDistinctOn(e){this.append("distinct on ("),this.compileList(e),this.append(")")}compileList(e,t=", "){const r=e.length-1;for(let n=0;n<=r;n++)this.visitNode(e[n]),n<r&&this.append(t)}visitWhere(e){this.append("where "),this.visitNode(e.where)}visitHaving(e){this.append("having "),this.visitNode(e.having)}visitInsertQuery(e){const t=this.nodeStack.find(Qo.is),r=t!==e;!r&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&!jo.is(t)&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append(e.replace?"replace":"insert"),e.ignore&&(logOnce("`InsertQueryNode.ignore` is deprecated. Use `InsertQueryNode.orAction` instead."),this.append(" ignore")),e.orAction&&(this.append(" "),this.visitNode(e.orAction)),e.top&&(this.append(" "),this.visitNode(e.top)),e.into&&(this.append(" into "),this.visitNode(e.into)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.output&&(this.append(" "),this.visitNode(e.output)),e.values&&(this.append(" "),this.visitNode(e.values)),e.defaultValues&&(this.append(" "),this.append("default values")),e.onConflict&&(this.append(" "),this.visitNode(e.onConflict)),e.onDuplicateKey&&(this.append(" "),this.visitNode(e.onDuplicateKey)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&!jo.is(t)&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitValues(e){this.append("values "),this.compileList(e.values)}visitDeleteQuery(e){const t=this.nodeStack.find(Qo.is)!==e;!t&&e.explain&&(this.visitNode(e.explain),this.append(" ")),t&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("delete "),e.top&&(this.visitNode(e.top),this.append(" ")),this.visitNode(e.from),e.output&&(this.append(" "),this.visitNode(e.output)),e.using&&(this.append(" "),this.visitNode(e.using)),e.joins&&(this.append(" "),this.compileList(e.joins," ")),e.where&&(this.append(" "),this.visitNode(e.where)),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),t&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitReturning(e){this.append("returning "),this.compileList(e.selections)}visitAlias(e){this.visitNode(e.node),this.append(" as "),this.visitNode(e.alias)}visitReference(e){e.table&&(this.visitNode(e.table),this.append(".")),this.visitNode(e.column)}visitSelectAll(e){this.append("*")}visitIdentifier(e){this.append(this.getLeftIdentifierWrapper()),this.compileUnwrappedIdentifier(e),this.append(this.getRightIdentifierWrapper())}compileUnwrappedIdentifier(e){if(!isString(e.name))throw new Error("a non-string identifier was passed to compileUnwrappedIdentifier.");this.append(this.sanitizeIdentifier(e.name))}visitAnd(e){this.visitNode(e.left),this.append(" and "),this.visitNode(e.right)}visitOr(e){this.visitNode(e.left),this.append(" or "),this.visitNode(e.right)}visitValue(e){e.immediate?this.appendImmediateValue(e.value):this.appendValue(e.value)}visitValueList(e){this.append("("),this.compileList(e.values),this.append(")")}visitTuple(e){this.append("("),this.compileList(e.values),this.append(")")}visitPrimitiveValueList(e){this.append("(");const{values:t}=e;for(let e=0;e<t.length;++e)this.appendValue(t[e]),e!==t.length-1&&this.append(", ");this.append(")")}visitParens(e){this.append("("),this.visitNode(e.node),this.append(")")}visitJoin(e){this.append(pc[e.joinType]),this.append(" "),this.visitNode(e.table),e.on&&(this.append(" "),this.visitNode(e.on))}visitOn(e){this.append("on "),this.visitNode(e.on)}visitRaw(e){const{sqlFragments:t,parameters:r}=e;for(let e=0;e<t.length;++e)this.append(t[e]),r.length>e&&this.visitNode(r[e])}visitOperator(e){this.append(e.operator)}visitTable(e){this.visitNode(e.table)}visitSchemableIdentifier(e){e.schema&&(this.visitNode(e.schema),this.append(".")),this.visitNode(e.identifier)}visitCreateTable(e){this.append("create "),e.frontModifiers&&e.frontModifiers.length>0&&(this.compileList(e.frontModifiers," "),this.append(" ")),e.temporary&&this.append("temporary "),this.append("table "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.table),e.selectQuery?(this.append(" as "),this.visitNode(e.selectQuery)):(this.append(" ("),this.compileList([...e.columns,...e.constraints??[]]),this.append(")"),e.onCommit&&(this.append(" on commit "),this.append(e.onCommit)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," ")))}visitColumnDefinition(e){e.ifNotExists&&this.append("if not exists "),this.visitNode(e.column),this.append(" "),this.visitNode(e.dataType),e.unsigned&&this.append(" unsigned"),e.frontModifiers&&e.frontModifiers.length>0&&(this.append(" "),this.compileList(e.frontModifiers," ")),e.generated&&(this.append(" "),this.visitNode(e.generated)),e.identity&&this.append(" identity"),e.defaultTo&&(this.append(" "),this.visitNode(e.defaultTo)),e.notNull&&this.append(" not null"),e.unique&&this.append(" unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.primaryKey&&this.append(" primary key"),e.autoIncrement&&(this.append(" "),this.append(this.getAutoIncrement())),e.references&&(this.append(" "),this.visitNode(e.references)),e.check&&(this.append(" "),this.visitNode(e.check)),e.endModifiers&&e.endModifiers.length>0&&(this.append(" "),this.compileList(e.endModifiers," "))}getAutoIncrement(){return"auto_increment"}visitReferences(e){this.append("references "),this.visitNode(e.table),this.append(" ("),this.compileList(e.columns),this.append(")"),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate))}visitDropTable(e){this.append("drop table "),e.ifExists&&this.append("if exists "),this.visitNode(e.table),e.cascade&&this.append(" cascade")}visitDataType(e){this.append(e.dataType)}visitOrderBy(e){this.append("order by "),this.compileList(e.items)}visitOrderByItem(e){this.visitNode(e.orderBy),e.collation&&(this.append(" "),this.visitNode(e.collation)),e.direction&&(this.append(" "),this.visitNode(e.direction)),e.nulls&&(this.append(" nulls "),this.append(e.nulls))}visitGroupBy(e){this.append("group by "),this.compileList(e.items)}visitGroupByItem(e){this.visitNode(e.groupBy)}visitUpdateQuery(e){const t=this.nodeStack.find(Qo.is),r=t!==e;if(!r&&e.explain&&(this.visitNode(e.explain),this.append(" ")),r&&!jo.is(t)&&this.append("("),e.with&&(this.visitNode(e.with),this.append(" ")),this.append("update "),e.top&&(this.visitNode(e.top),this.append(" ")),e.table&&(this.visitNode(e.table),this.append(" ")),this.append("set "),e.updates&&this.compileList(e.updates),e.output&&(this.append(" "),this.visitNode(e.output)),e.from&&(this.append(" "),this.visitNode(e.from)),e.joins){if(!e.from)throw new Error("Joins in an update query are only supported as a part of a PostgreSQL 'update set from join' query. If you want to create a MySQL 'update join set' query, see https://kysely.dev/docs/examples/update/my-sql-joins");this.append(" "),this.compileList(e.joins," ")}e.where&&(this.append(" "),this.visitNode(e.where)),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),e.limit&&(this.append(" "),this.visitNode(e.limit)),e.returning&&(this.append(" "),this.visitNode(e.returning)),r&&!jo.is(t)&&this.append(")"),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitColumnUpdate(e){this.visitNode(e.column),this.append(" = "),this.visitNode(e.value)}visitLimit(e){this.append("limit "),this.visitNode(e.limit)}visitOffset(e){this.append("offset "),this.visitNode(e.offset)}visitOnConflict(e){this.append("on conflict"),e.columns?(this.append(" ("),this.compileList(e.columns),this.append(")")):e.constraint?(this.append(" on constraint "),this.visitNode(e.constraint)):e.indexExpression&&(this.append(" ("),this.visitNode(e.indexExpression),this.append(")")),e.indexWhere&&(this.append(" "),this.visitNode(e.indexWhere)),!0===e.doNothing?this.append(" do nothing"):e.updates&&(this.append(" do update set "),this.compileList(e.updates),e.updateWhere&&(this.append(" "),this.visitNode(e.updateWhere)))}visitOnDuplicateKey(e){this.append("on duplicate key update "),this.compileList(e.updates)}visitCreateIndex(e){this.append("create "),e.unique&&this.append("unique "),this.append("index "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.using&&(this.append(" using "),this.visitNode(e.using)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.nullsNotDistinct&&this.append(" nulls not distinct"),e.where&&(this.append(" "),this.visitNode(e.where))}visitDropIndex(e){this.append("drop index "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.table&&(this.append(" on "),this.visitNode(e.table)),e.cascade&&this.append(" cascade")}visitCreateSchema(e){this.append("create schema "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.schema)}visitDropSchema(e){this.append("drop schema "),e.ifExists&&this.append("if exists "),this.visitNode(e.schema),e.cascade&&this.append(" cascade")}visitPrimaryKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("primary key ("),this.compileList(e.columns),this.append(")"),this.buildDeferrable(e)}buildDeferrable(e){void 0!==e.deferrable&&(e.deferrable?this.append(" deferrable"):this.append(" not deferrable")),void 0!==e.initiallyDeferred&&(e.initiallyDeferred?this.append(" initially deferred"):this.append(" initially immediate"))}visitUniqueConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("unique"),e.nullsNotDistinct&&this.append(" nulls not distinct"),this.append(" ("),this.compileList(e.columns),this.append(")"),this.buildDeferrable(e)}visitCheckConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("check ("),this.visitNode(e.expression),this.append(")")}visitForeignKeyConstraint(e){e.name&&(this.append("constraint "),this.visitNode(e.name),this.append(" ")),this.append("foreign key ("),this.compileList(e.columns),this.append(") "),this.visitNode(e.references),e.onDelete&&(this.append(" on delete "),this.append(e.onDelete)),e.onUpdate&&(this.append(" on update "),this.append(e.onUpdate)),this.buildDeferrable(e)}visitList(e){this.compileList(e.items)}visitWith(e){this.append("with "),e.recursive&&this.append("recursive "),this.compileList(e.expressions)}visitCommonTableExpression(e){this.visitNode(e.name),this.append(" as "),isBoolean(e.materialized)&&(e.materialized||this.append("not "),this.append("materialized ")),this.visitNode(e.expression)}visitCommonTableExpressionName(e){this.visitNode(e.table),e.columns&&(this.append("("),this.compileList(e.columns),this.append(")"))}visitAlterTable(e){this.append("alter table "),this.visitNode(e.table),this.append(" "),e.renameTo&&(this.append("rename to "),this.visitNode(e.renameTo)),e.setSchema&&(this.append("set schema "),this.visitNode(e.setSchema)),e.addConstraint&&this.visitNode(e.addConstraint),e.dropConstraint&&this.visitNode(e.dropConstraint),e.renameConstraint&&this.visitNode(e.renameConstraint),e.columnAlterations&&this.compileColumnAlterations(e.columnAlterations),e.addIndex&&this.visitNode(e.addIndex),e.dropIndex&&this.visitNode(e.dropIndex)}visitAddColumn(e){this.append("add column "),this.visitNode(e.column)}visitRenameColumn(e){this.append("rename column "),this.visitNode(e.column),this.append(" to "),this.visitNode(e.renameTo)}visitDropColumn(e){this.append("drop column "),this.visitNode(e.column)}visitAlterColumn(e){this.append("alter column "),this.visitNode(e.column),this.append(" "),e.dataType&&(this.announcesNewColumnDataType()&&this.append("type "),this.visitNode(e.dataType),e.dataTypeExpression&&(this.append("using "),this.visitNode(e.dataTypeExpression))),e.setDefault&&(this.append("set default "),this.visitNode(e.setDefault)),e.dropDefault&&this.append("drop default"),e.setNotNull&&this.append("set not null"),e.dropNotNull&&this.append("drop not null")}visitModifyColumn(e){this.append("modify column "),this.visitNode(e.column)}visitAddConstraint(e){this.append("add "),this.visitNode(e.constraint)}visitDropConstraint(e){this.append("drop constraint "),e.ifExists&&this.append("if exists "),this.visitNode(e.constraintName),"cascade"===e.modifier?this.append(" cascade"):"restrict"===e.modifier&&this.append(" restrict")}visitRenameConstraint(e){this.append("rename constraint "),this.visitNode(e.oldName),this.append(" to "),this.visitNode(e.newName)}visitSetOperation(e){this.append(e.operator),this.append(" "),e.all&&this.append("all "),this.visitNode(e.expression)}visitCreateView(e){this.append("create "),e.orReplace&&this.append("or replace "),e.materialized&&this.append("materialized "),e.temporary&&this.append("temporary "),this.append("view "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),this.append(" "),e.columns&&(this.append("("),this.compileList(e.columns),this.append(") ")),e.as&&(this.append("as "),this.visitNode(e.as))}visitRefreshMaterializedView(e){this.append("refresh materialized view "),e.concurrently&&this.append("concurrently "),this.visitNode(e.name),e.withNoData?this.append(" with no data"):this.append(" with data")}visitDropView(e){this.append("drop "),e.materialized&&this.append("materialized "),this.append("view "),e.ifExists&&this.append("if exists "),this.visitNode(e.name),e.cascade&&this.append(" cascade")}visitGenerated(e){this.append("generated "),e.always&&this.append("always "),e.byDefault&&this.append("by default "),this.append("as "),e.identity&&this.append("identity"),e.expression&&(this.append("("),this.visitNode(e.expression),this.append(")")),e.stored&&this.append(" stored")}visitDefaultValue(e){this.append("default "),this.visitNode(e.defaultValue)}visitSelectModifier(e){e.rawModifier?this.visitNode(e.rawModifier):this.append(lc[e.modifier]),e.of&&(this.append(" of "),this.compileList(e.of,", "))}visitCreateType(e){this.append("create type "),this.visitNode(e.name),e.enum&&(this.append(" as enum "),this.visitNode(e.enum))}visitDropType(e){this.append("drop type "),e.ifExists&&this.append("if exists "),this.visitNode(e.name)}visitExplain(e){this.append("explain"),(e.options||e.format)&&(this.append(" "),this.append(this.getLeftExplainOptionsWrapper()),e.options&&(this.visitNode(e.options),e.format&&this.append(this.getExplainOptionsDelimiter())),e.format&&(this.append("format"),this.append(this.getExplainOptionAssignment()),this.append(e.format)),this.append(this.getRightExplainOptionsWrapper()))}visitDefaultInsertValue(e){this.append("default")}visitAggregateFunction(e){this.append(e.func),this.append("("),e.distinct&&this.append("distinct "),this.compileList(e.aggregated),e.orderBy&&(this.append(" "),this.visitNode(e.orderBy)),this.append(")"),e.withinGroup&&(this.append(" within group ("),this.visitNode(e.withinGroup),this.append(")")),e.filter&&(this.append(" filter("),this.visitNode(e.filter),this.append(")")),e.over&&(this.append(" "),this.visitNode(e.over))}visitOver(e){this.append("over("),e.partitionBy&&(this.visitNode(e.partitionBy),e.orderBy&&this.append(" ")),e.orderBy&&this.visitNode(e.orderBy),this.append(")")}visitPartitionBy(e){this.append("partition by "),this.compileList(e.items)}visitPartitionByItem(e){this.visitNode(e.partitionBy)}visitBinaryOperation(e){this.visitNode(e.leftOperand),this.append(" "),this.visitNode(e.operator),this.append(" "),this.visitNode(e.rightOperand)}visitUnaryOperation(e){this.visitNode(e.operator),this.isMinusOperator(e.operator)||this.append(" "),this.visitNode(e.operand)}isMinusOperator(e){return uo.is(e)&&"-"===e.operator}visitUsing(e){this.append("using "),this.compileList(e.tables)}visitFunction(e){this.append(e.func),this.append("("),this.compileList(e.arguments),this.append(")")}visitCase(e){this.append("case"),e.value&&(this.append(" "),this.visitNode(e.value)),e.when&&(this.append(" "),this.compileList(e.when," ")),e.else&&(this.append(" else "),this.visitNode(e.else)),this.append(" end"),e.isStatement&&this.append(" case")}visitWhen(e){this.append("when "),this.visitNode(e.condition),e.result&&(this.append(" then "),this.visitNode(e.result))}visitJSONReference(e){this.visitNode(e.reference),this.visitNode(e.traversal)}visitJSONPath(e){e.inOperator&&this.visitNode(e.inOperator),this.append("'$");for(const t of e.pathLegs)this.visitNode(t);this.append("'")}visitJSONPathLeg(e){const t="ArrayLocation"===e.type;this.append(t?"[":"."),this.append(String(e.value)),t&&this.append("]")}visitJSONOperatorChain(e){for(let t=0,r=e.values.length;t<r;t++)t===r-1?this.visitNode(e.operator):this.append("->"),this.visitNode(e.values[t])}visitMergeQuery(e){e.with&&(this.visitNode(e.with),this.append(" ")),this.append("merge "),e.top&&(this.visitNode(e.top),this.append(" ")),this.append("into "),this.visitNode(e.into),e.using&&(this.append(" "),this.visitNode(e.using)),e.whens&&(this.append(" "),this.compileList(e.whens," ")),e.returning&&(this.append(" "),this.visitNode(e.returning)),e.output&&(this.append(" "),this.visitNode(e.output)),e.endModifiers?.length&&(this.append(" "),this.compileList(e.endModifiers," "))}visitMatched(e){e.not&&this.append("not "),this.append("matched"),e.bySource&&this.append(" by source")}visitAddIndex(e){this.append("add "),e.unique&&this.append("unique "),this.append("index "),this.visitNode(e.name),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.using&&(this.append(" using "),this.visitNode(e.using))}visitCast(e){this.append("cast("),this.visitNode(e.expression),this.append(" as "),this.visitNode(e.dataType),this.append(")")}visitFetch(e){this.append("fetch next "),this.visitNode(e.rowCount),this.append(` rows ${e.modifier}`)}visitOutput(e){this.append("output "),this.compileList(e.selections)}visitTop(e){this.append(`top(${e.expression})`),e.modifiers&&this.append(` ${e.modifiers}`)}visitOrAction(e){this.append(e.action)}visitCollate(e){this.append("collate "),this.visitNode(e.collation)}append(e){this.#ae+=e}appendValue(e){this.addParameter(e),this.append(this.getCurrentParameterPlaceholder())}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getCurrentParameterPlaceholder(){return"$"+this.numParameters}getLeftExplainOptionsWrapper(){return"("}getExplainOptionAssignment(){return" "}getExplainOptionsDelimiter(){return", "}getRightExplainOptionsWrapper(){return")"}sanitizeIdentifier(e){const t=this.getLeftIdentifierWrapper(),r=this.getRightIdentifierWrapper();let n="";for(const i of e)n+=i,i===t?n+=t:i===r&&(n+=r);return n}sanitizeStringLiteral(e){return e.replace(dc,"''")}addParameter(e){this.#ce.push(e)}appendImmediateValue(e){if(isString(e))this.appendStringLiteral(e);else if(isNumber(e)||isBoolean(e)||isBigInt(e))this.append(e.toString());else if(isNull$1(e))this.append("null");else{if(!isDate(e))throw new Error(`invalid immediate value ${e}`);this.appendImmediateValue(e.toISOString())}}appendStringLiteral(e){this.append("'"),this.append(this.sanitizeStringLiteral(e)),this.append("'")}sortSelectModifiers(e){return e.sort((e,t)=>e.modifier&&t.modifier?uc[e.modifier]-uc[t.modifier]:1),freeze(e)}compileColumnAlterations(e){this.compileList(e)}announcesNewColumnDataType(){return!0}}const lc=freeze({ForKeyShare:"for key share",ForNoKeyUpdate:"for no key update",ForUpdate:"for update",ForShare:"for share",NoWait:"nowait",SkipLocked:"skip locked",Distinct:"distinct"}),uc=freeze({ForKeyShare:1,ForNoKeyUpdate:1,ForUpdate:1,ForShare:1,NoWait:2,SkipLocked:2,Distinct:0}),pc=freeze({InnerJoin:"inner join",LeftJoin:"left join",RightJoin:"right join",FullJoin:"full join",CrossJoin:"cross join",LateralInnerJoin:"inner join lateral",LateralLeftJoin:"left join lateral",LateralCrossJoin:"cross join lateral",OuterApply:"outer apply",CrossApply:"cross apply",Using:"using"}),hc=freeze({raw:(e,t=[])=>freeze({sql:e,query:yo.createWithSql(e),parameters:freeze(t),queryId:createQueryId()})});class DialectAdapterBase{get supportsCreateIfNotExists(){return!0}get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}get supportsOutput(){return!1}}function parseSavepointCommand(e,t){return yo.createWithChildren([yo.createWithSql(`${e} `),Qs.create(t)])}class SqliteDriver{#de;#le=new ConnectionMutex;#ue;#K;constructor(e){this.#de=freeze({...e})}async init(){this.#ue=isFunction(this.#de.database)?await this.#de.database():this.#de.database,this.#K=new SqliteConnection(this.#ue),this.#de.onCreateConnection&&await this.#de.onCreateConnection(this.#K)}async acquireConnection(){return await this.#le.lock(),this.#K}async beginTransaction(e){await e.executeQuery(hc.raw("begin"))}async commitTransaction(e){await e.executeQuery(hc.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(hc.raw("rollback"))}async savepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("savepoint",t),createQueryId()))}async rollbackToSavepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("rollback to",t),createQueryId()))}async releaseSavepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("release",t),createQueryId()))}async releaseConnection(){this.#le.unlock()}async destroy(){this.#ue?.close()}}class SqliteConnection{#ue;constructor(e){this.#ue=e}executeQuery(e){const{sql:t,parameters:r}=e,n=this.#ue.prepare(t);if(n.reader)return Promise.resolve({rows:n.all(r)});const{changes:i,lastInsertRowid:s}=n.run(r);return Promise.resolve({numAffectedRows:null!=i?BigInt(i):void 0,insertId:null!=s?BigInt(s):void 0,rows:[]})}async*streamQuery(e,t){const{sql:r,parameters:n,query:i}=e,s=this.#ue.prepare(r);if(!Vo.is(i))throw new Error("Sqlite driver only supports streaming of select queries");{const e=s.iterate(n);for(const t of e)yield{rows:[t]}}}}class ConnectionMutex{#g;#y;async lock(){for(;this.#g;)await this.#g;this.#g=new Promise(e=>{this.#y=e})}unlock(){const e=this.#y;this.#g=void 0,this.#y=void 0,e?.()}}const fc=/"/g;class SqliteQueryCompiler extends DefaultQueryCompiler{visitOrAction(e){this.append("or "),this.append(e.action)}getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return'"'}getRightIdentifierWrapper(){return'"'}getAutoIncrement(){return"autoincrement"}sanitizeIdentifier(e){return e.replace(fc,'""')}visitDefaultInsertValue(e){this.append("null")}}const mc="kysely_migration",gc="kysely_migration_lock";freeze({__noMigrations__:!0});class SqliteIntrospector{#ue;constructor(e){this.#ue=e}async getSchemas(){return[]}async getTables(e={withInternalKyselyTables:!1}){return await this.#pe(e)}async getMetadata(e){return{tables:await this.getTables(e)}}#he(e,t){let r=e.selectFrom("sqlite_master").where("type","in",["table","view"]).where("name","not like","sqlite_%").select(["name","sql","type"]).orderBy("name");return t.withInternalKyselyTables||(r=r.where("name","!=",mc).where("name","!=",gc)),r}async#pe(e){const t=await this.#he(this.#ue,e).execute(),r=await this.#ue.with("table_list",t=>this.#he(t,e)).selectFrom(["table_list as tl",cc`pragma_table_info(tl.name)`.as("p")]).select(["tl.name as table","p.cid","p.name","p.type","p.notnull","p.dflt_value","p.pk"]).orderBy("tl.name").orderBy("p.cid").execute(),n={};for(const e of r)n[e.table]??=[],n[e.table].push(e);return t.map(({name:e,sql:t,type:r})=>{let i=t?.split(/[\(\),]/)?.find(e=>e.toLowerCase().includes("autoincrement"))?.trimStart()?.split(/\s+/)?.[0]?.replace(/["`]/g,"");const s=n[e]??[];if(!i){const e=s.filter(e=>e.pk>0);1===e.length&&"integer"===e[0].type.toLowerCase()&&(i=e[0].name)}return{name:e,isView:"view"===r,columns:s.map(e=>({name:e.name,dataType:e.type,isNullable:!e.notnull,isAutoIncrementing:e.name===i,hasDefaultValue:null!=e.dflt_value,comment:void 0}))}})}}class SqliteAdapter extends DialectAdapterBase{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!0}async acquireMigrationLock(e,t){}async releaseMigrationLock(e,t){}}class SqliteDialect{#de;constructor(e){this.#de=freeze({...e})}createDriver(){return new SqliteDriver(this.#de)}createQueryCompiler(){return new SqliteQueryCompiler}createAdapter(){return new SqliteAdapter}createIntrospector(e){return new SqliteIntrospector(e)}}const yc=/"/g;class PostgresQueryCompiler extends DefaultQueryCompiler{sanitizeIdentifier(e){return e.replace(yc,'""')}}class PostgresIntrospector{#ue;constructor(e){this.#ue=e}async getSchemas(){return(await this.#ue.selectFrom("pg_catalog.pg_namespace").select("nspname").$castTo().execute()).map(e=>({name:e.nspname}))}async getTables(e={withInternalKyselyTables:!1}){let t=this.#ue.selectFrom("pg_catalog.pg_attribute as a").innerJoin("pg_catalog.pg_class as c","a.attrelid","c.oid").innerJoin("pg_catalog.pg_namespace as ns","c.relnamespace","ns.oid").innerJoin("pg_catalog.pg_type as typ","a.atttypid","typ.oid").innerJoin("pg_catalog.pg_namespace as dtns","typ.typnamespace","dtns.oid").select(["a.attname as column","a.attnotnull as not_null","a.atthasdef as has_default","c.relname as table","c.relkind as table_type","ns.nspname as schema","typ.typname as type","dtns.nspname as type_schema",cc`col_description(a.attrelid, a.attnum)`.as("column_description"),cc`pg_get_serial_sequence(quote_ident(ns.nspname) || '.' || quote_ident(c.relname), a.attname)`.as("auto_incrementing")]).where("c.relkind","in",["r","v","p"]).where("ns.nspname","!~","^pg_").where("ns.nspname","!=","information_schema").where("ns.nspname","!=","crdb_internal").where("a.attnum",">=",0).where("a.attisdropped","!=",!0).orderBy("ns.nspname").orderBy("c.relname").orderBy("a.attnum").$castTo();e.withInternalKyselyTables||(t=t.where("c.relname","!=",mc).where("c.relname","!=",gc));const r=await t.execute();return this.#fe(r)}async getMetadata(e){return{tables:await this.getTables(e)}}#fe(e){return e.reduce((e,t)=>{let r=e.find(e=>e.name===t.table&&e.schema===t.schema);return r||(r=freeze({name:t.table,isView:"v"===t.table_type,schema:t.schema,columns:[]}),e.push(r)),r.columns.push(freeze({name:t.column,dataType:t.type,dataTypeSchema:t.type_schema,isNullable:!t.not_null,isAutoIncrementing:null!==t.auto_incrementing,hasDefaultValue:t.has_default,comment:t.column_description??void 0})),e},[])}}const wc=BigInt("3853314791062309107");class PostgresAdapter extends DialectAdapterBase{get supportsTransactionalDdl(){return!0}get supportsReturning(){return!0}async acquireMigrationLock(e,t){await cc`select pg_advisory_xact_lock(${cc.lit(wc)})`.execute(e)}async releaseMigrationLock(e,t){}}function extendStackTrace(e,t){if(isObject(r=e)&&isString(r.stack)&&t.stack){const r=t.stack.split("\n").slice(1).join("\n");return e.stack+=`\n${r}`,e}var r;return e}const bc=Symbol();class MysqlDriver{#de;#j=new WeakMap;#me;constructor(e){this.#de=freeze({...e})}async init(){this.#me=isFunction(this.#de.pool)?await this.#de.pool():this.#de.pool}async acquireConnection(){const e=await this.#ge();let t=this.#j.get(e);return t||(t=new MysqlConnection(e),this.#j.set(e,t),this.#de?.onCreateConnection&&await this.#de.onCreateConnection(t)),this.#de?.onReserveConnection&&await this.#de.onReserveConnection(t),t}async#ge(){return new Promise((e,t)=>{this.#me.getConnection(async(r,n)=>{r?t(r):e(n)})})}async beginTransaction(e,t){if(t.isolationLevel||t.accessMode){const r=[];t.isolationLevel&&r.push(`isolation level ${t.isolationLevel}`),t.accessMode&&r.push(t.accessMode);const n=`set transaction ${r.join(", ")}`;await e.executeQuery(hc.raw(n))}await e.executeQuery(hc.raw("begin"))}async commitTransaction(e){await e.executeQuery(hc.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(hc.raw("rollback"))}async savepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("savepoint",t),createQueryId()))}async rollbackToSavepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("rollback to",t),createQueryId()))}async releaseSavepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("release savepoint",t),createQueryId()))}async releaseConnection(e){e[bc]()}async destroy(){return new Promise((e,t)=>{this.#me.end(r=>{r?t(r):e()})})}}class MysqlConnection{#ye;constructor(e){this.#ye=e}async executeQuery(e){try{const r=await this.#we(e);if(isObject(t=r)&&"insertId"in t&&"affectedRows"in t){const{insertId:e,affectedRows:t,changedRows:n}=r;return{insertId:null!=e&&"0"!==e.toString()?BigInt(e):void 0,numAffectedRows:null!=t?BigInt(t):void 0,numChangedRows:null!=n?BigInt(n):void 0,rows:[]}}return Array.isArray(r)?{rows:r}:{rows:[]}}catch(e){throw extendStackTrace(e,new Error)}var t}#we(e){return new Promise((t,r)=>{this.#ye.query(e.sql,e.parameters,(e,n)=>{e?r(e):t(n)})})}async*streamQuery(e,t){const r=this.#ye.query(e.sql,e.parameters).stream({objectMode:!0});try{for await(const e of r)yield{rows:[e]}}catch(e){if(e&&"object"==typeof e&&"code"in e&&"ERR_STREAM_PREMATURE_CLOSE"===e.code)return;throw e}}[bc](){this.#ye.release()}}const vc=/`/g;class MysqlQueryCompiler extends DefaultQueryCompiler{getCurrentParameterPlaceholder(){return"?"}getLeftExplainOptionsWrapper(){return""}getExplainOptionAssignment(){return"="}getExplainOptionsDelimiter(){return" "}getRightExplainOptionsWrapper(){return""}getLeftIdentifierWrapper(){return"`"}getRightIdentifierWrapper(){return"`"}sanitizeIdentifier(e){return e.replace(vc,"``")}visitCreateIndex(e){this.append("create "),e.unique&&this.append("unique "),this.append("index "),e.ifNotExists&&this.append("if not exists "),this.visitNode(e.name),e.using&&(this.append(" using "),this.visitNode(e.using)),e.table&&(this.append(" on "),this.visitNode(e.table)),e.columns&&(this.append(" ("),this.compileList(e.columns),this.append(")")),e.where&&(this.append(" "),this.visitNode(e.where))}}class MysqlIntrospector{#ue;constructor(e){this.#ue=e}async getSchemas(){return(await this.#ue.selectFrom("information_schema.schemata").select("schema_name").$castTo().execute()).map(e=>({name:e.SCHEMA_NAME}))}async getTables(e={withInternalKyselyTables:!1}){let t=this.#ue.selectFrom("information_schema.columns as columns").innerJoin("information_schema.tables as tables",e=>e.onRef("columns.TABLE_CATALOG","=","tables.TABLE_CATALOG").onRef("columns.TABLE_SCHEMA","=","tables.TABLE_SCHEMA").onRef("columns.TABLE_NAME","=","tables.TABLE_NAME")).select(["columns.COLUMN_NAME","columns.COLUMN_DEFAULT","columns.TABLE_NAME","columns.TABLE_SCHEMA","tables.TABLE_TYPE","columns.IS_NULLABLE","columns.DATA_TYPE","columns.EXTRA","columns.COLUMN_COMMENT"]).where("columns.TABLE_SCHEMA","=",cc`database()`).orderBy("columns.TABLE_NAME").orderBy("columns.ORDINAL_POSITION").$castTo();e.withInternalKyselyTables||(t=t.where("columns.TABLE_NAME","!=",mc).where("columns.TABLE_NAME","!=",gc));const r=await t.execute();return this.#fe(r)}async getMetadata(e){return{tables:await this.getTables(e)}}#fe(e){return e.reduce((e,t)=>{let r=e.find(e=>e.name===t.TABLE_NAME);return r||(r=freeze({name:t.TABLE_NAME,isView:"VIEW"===t.TABLE_TYPE,schema:t.TABLE_SCHEMA,columns:[]}),e.push(r)),r.columns.push(freeze({name:t.COLUMN_NAME,dataType:t.DATA_TYPE,isNullable:"YES"===t.IS_NULLABLE,isAutoIncrementing:t.EXTRA.toLowerCase().includes("auto_increment"),hasDefaultValue:null!==t.COLUMN_DEFAULT,comment:""===t.COLUMN_COMMENT?void 0:t.COLUMN_COMMENT})),e},[])}}const Nc="ea586330-2c93-47c8-908d-981d9d270f9d";class MysqlAdapter extends DialectAdapterBase{get supportsTransactionalDdl(){return!1}get supportsReturning(){return!1}async acquireMigrationLock(e,t){await cc`select get_lock(${cc.lit(Nc)}, ${cc.lit(3600)})`.execute(e)}async releaseMigrationLock(e,t){await cc`select release_lock(${cc.lit(Nc)})`.execute(e)}}class MysqlDialect{#de;constructor(e){this.#de=e}createDriver(){return new MysqlDriver(this.#de)}createQueryCompiler(){return new MysqlQueryCompiler}createAdapter(){return new MysqlAdapter}createIntrospector(e){return new MysqlIntrospector(e)}}const Tc=Symbol();class PostgresDriver{#de;#j=new WeakMap;#me;constructor(e){this.#de=freeze({...e})}async init(){this.#me=isFunction(this.#de.pool)?await this.#de.pool():this.#de.pool}async acquireConnection(){const e=await this.#me.connect();let t=this.#j.get(e);return t||(t=new PostgresConnection(e,{cursor:this.#de.cursor??null}),this.#j.set(e,t),this.#de.onCreateConnection&&await this.#de.onCreateConnection(t)),this.#de.onReserveConnection&&await this.#de.onReserveConnection(t),t}async beginTransaction(e,t){if(t.isolationLevel||t.accessMode){let r="start transaction";t.isolationLevel&&(r+=` isolation level ${t.isolationLevel}`),t.accessMode&&(r+=` ${t.accessMode}`),await e.executeQuery(hc.raw(r))}else await e.executeQuery(hc.raw("begin"))}async commitTransaction(e){await e.executeQuery(hc.raw("commit"))}async rollbackTransaction(e){await e.executeQuery(hc.raw("rollback"))}async savepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("savepoint",t),createQueryId()))}async rollbackToSavepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("rollback to",t),createQueryId()))}async releaseSavepoint(e,t,r){await e.executeQuery(r(parseSavepointCommand("release",t),createQueryId()))}async releaseConnection(e){e[Tc]()}async destroy(){if(this.#me){const e=this.#me;this.#me=void 0,await e.end()}}}class PostgresConnection{#be;#ve;constructor(e,t){this.#be=e,this.#ve=t}async executeQuery(e){try{const{command:t,rowCount:r,rows:n}=await this.#be.query(e.sql,[...e.parameters]);return{numAffectedRows:"INSERT"===t||"UPDATE"===t||"DELETE"===t||"MERGE"===t?BigInt(r):void 0,rows:n??[]}}catch(e){throw extendStackTrace(e,new Error)}}async*streamQuery(e,t){if(!this.#ve.cursor)throw new Error("'cursor' is not present in your postgres dialect config. It's required to make streaming work in postgres.");if(!Number.isInteger(t)||t<=0)throw new Error("chunkSize must be a positive integer");const r=this.#be.query(new this.#ve.cursor(e.sql,e.parameters.slice()));try{for(;;){const e=await r.read(t);if(0===e.length)break;yield{rows:e}}}finally{await r.close()}}[Tc](){this.#be.release()}}class PostgresDialect{#de;constructor(e){this.#de=e}createDriver(){return new PostgresDriver(this.#de)}createQueryCompiler(){return new PostgresQueryCompiler}createAdapter(){return new PostgresAdapter}createIntrospector(e){return new PostgresIntrospector(e)}}class MssqlAdapter extends DialectAdapterBase{get supportsCreateIfNotExists(){return!1}get supportsTransactionalDdl(){return!0}get supportsOutput(){return!0}async acquireMigrationLock(e){await cc`exec sp_getapplock @DbPrincipal = ${cc.lit("dbo")}, @Resource = ${cc.lit(mc)}, @LockMode = ${cc.lit("Exclusive")}`.execute(e)}async releaseMigrationLock(){}}const kc=Symbol(),xc=Symbol(),Sc=Symbol();class MssqlDriver{#de;#me;constructor(e){this.#de=freeze({...e});const{tarn:t,tedious:r,validateConnections:n}=this.#de,{validateConnections:i,...s}=t.options;this.#me=new t.Pool({...s,create:async()=>{const e=await r.connectionFactory();return await new MssqlConnection(e,r).connect()},destroy:async e=>{await e[xc]()},validate:!1===n||!1===i?void 0:e=>e[Sc]()})}async init(){}async acquireConnection(){return await this.#me.acquire().promise}async beginTransaction(e,t){await e.beginTransaction(t)}async commitTransaction(e){await e.commitTransaction()}async rollbackTransaction(e){await e.rollbackTransaction()}async savepoint(e,t){await e.savepoint(t)}async rollbackToSavepoint(e,t){await e.rollbackTransaction(t)}async releaseConnection(e){(this.#de.resetConnectionsOnRelease||this.#de.tedious.resetConnectionOnRelease)&&await e[kc](),this.#me.release(e)}async destroy(){await this.#me.destroy()}}class MssqlConnection{#K;#Ne;#Te;constructor(e,t){this.#K=e,this.#Ne=!1,this.#Te=t}async beginTransaction(e){const{isolationLevel:t}=e;await new Promise((e,r)=>this.#K.beginTransaction(t=>{t?r(t):e(void 0)},t?randomString(8):void 0,t?this.#ke(t):void 0))}async commitTransaction(){await new Promise((e,t)=>this.#K.commitTransaction(r=>{r?t(r):e(void 0)}))}async connect(){const{promise:e,reject:t,resolve:r}=new Deferred;function endListener(){t(new Error("The connection ended without ever completing the connection"))}return this.#K.connect(e=>{if(e)return t(e);r()}),this.#K.on("error",e=>{e instanceof Error&&"code"in e&&"ESOCKET"===e.code&&(this.#Ne=!0),console.error(e),t(e)}),this.#K.once("end",endListener),await e,this.#K.off("end",endListener),this}async executeQuery(e){try{const t=new Deferred,r=new MssqlRequest({compiledQuery:e,tedious:this.#Te,onDone:t});this.#K.execSql(r.request);const{rowCount:n,rows:i}=await t.promise;return{numAffectedRows:void 0!==n?BigInt(n):void 0,rows:i}}catch(e){throw extendStackTrace(e,new Error)}}async rollbackTransaction(e){await new Promise((t,r)=>this.#K.rollbackTransaction(e=>{e?r(e):t(void 0)},e))}async savepoint(e){await new Promise((t,r)=>this.#K.saveTransaction(e=>{e?r(e):t(void 0)},e))}async*streamQuery(e,t){if(!Number.isInteger(t)||t<=0)throw new Error("chunkSize must be a positive integer");const r=new MssqlRequest({compiledQuery:e,streamChunkSize:t,tedious:this.#Te});this.#K.execSql(r.request);try{for(;;){const e=await r.readChunk();if(0===e.length)break;if(yield{rows:e},e.length<t)break}}finally{await this.#xe(r)}}#ke(e){const{ISOLATION_LEVEL:t}=this.#Te,r={"read committed":t.READ_COMMITTED,"read uncommitted":t.READ_UNCOMMITTED,"repeatable read":t.REPEATABLE_READ,serializable:t.SERIALIZABLE,snapshot:t.SNAPSHOT}[e];if(void 0===r)throw new Error(`Unknown isolation level: ${e}`);return r}#xe(e){return new Promise(t=>{e.request.once("requestCompleted",t);this.#K.cancel()||(e.request.off("requestCompleted",t),t())})}[xc](){return"closed"in this.#K&&this.#K.closed?Promise.resolve():new Promise(e=>{this.#K.once("end",e),this.#K.close()})}async[kc](){await new Promise((e,t)=>{this.#K.reset(r=>{if(r)return t(r);e()})})}async[Sc](){if(this.#Ne||this.#Se())return!1;try{const e=new Deferred,t=new MssqlRequest({compiledQuery:hc.raw("select 1"),onDone:e,tedious:this.#Te});return this.#K.execSql(t.request),await e.promise,!0}catch{return!1}}#Se(){return"closed"in this.#K&&Boolean(this.#K.closed)}}class MssqlRequest{#_e;#Ae;#Ie;#Ee;#Te;#Ce;constructor(e){const{compiledQuery:t,onDone:r,streamChunkSize:n,tedious:i}=e;if(this.#Ae=[],this.#Ie=n,this.#Ee={},this.#Te=i,r){const e="onDone";this.#Ee[e]=(t,n)=>{if("chunkReady"!==t){if(delete this.#Ee[e],"error"===t)return r.reject(n);r.resolve({rowCount:this.#Ce,rows:this.#Ae})}}}this.#_e=new this.#Te.Request(t.sql,(e,t)=>{if(e)return Object.values(this.#Ee).forEach(t=>t("error",e instanceof AggregateError?e.errors:e));this.#Ce=t}),this.#Oe(t.parameters),this.#Pe()}get request(){return this.#_e}readChunk(){const e=this.readChunk.name;return new Promise((t,r)=>{this.#Ee[e]=(n,i)=>{if(delete this.#Ee[e],"error"===n)return r(i);t(this.#Ae.splice(0,this.#Ie))},this.#_e.resume()})}#Oe(e){for(let t=0;t<e.length;t++){const r=e[t];this.#_e.addParameter(String(t+1),this.#Re(r),r)}}#Pe(){const e=this.#Ie?()=>{this.#Ie<=this.#Ae.length&&(this.#_e.pause(),Object.values(this.#Ee).forEach(e=>e("chunkReady")))}:()=>{},rowListener=t=>{const r={};for(const e of t)r[e.metadata.colName]=e.value;this.#Ae.push(r),e()};this.#_e.on("row",rowListener),this.#_e.once("requestCompleted",()=>{Object.values(this.#Ee).forEach(e=>e("completed")),this.#_e.off("row",rowListener)})}#Re(e){return isNull$1(e)||isUndefined(e)||isString(e)?this.#Te.TYPES.NVarChar:isBigInt(e)||isNumber(e)&&e%1==0?e<-2147483648||e>2147483647?this.#Te.TYPES.BigInt:this.#Te.TYPES.Int:isNumber(e)?this.#Te.TYPES.Float:isBoolean(e)?this.#Te.TYPES.Bit:isDate(e)?this.#Te.TYPES.DateTime:(t=e,void 0!==d&&d.isBuffer(t)?this.#Te.TYPES.VarBinary:this.#Te.TYPES.NVarChar);var t}}class MssqlIntrospector{#ue;constructor(e){this.#ue=e}async getSchemas(){return await this.#ue.selectFrom("sys.schemas").select("name").execute()}async getTables(e={withInternalKyselyTables:!1}){const t=await this.#ue.selectFrom("sys.tables as tables").leftJoin("sys.schemas as table_schemas","table_schemas.schema_id","tables.schema_id").innerJoin("sys.columns as columns","columns.object_id","tables.object_id").innerJoin("sys.types as types","types.user_type_id","columns.user_type_id").leftJoin("sys.schemas as type_schemas","type_schemas.schema_id","types.schema_id").leftJoin("sys.extended_properties as comments",e=>e.onRef("comments.major_id","=","tables.object_id").onRef("comments.minor_id","=","columns.column_id").on("comments.name","=","MS_Description")).$if(!e.withInternalKyselyTables,e=>e.where("tables.name","!=",mc).where("tables.name","!=",gc)).select(["tables.name as table_name",e=>e.ref("tables.type").$castTo().as("table_type"),"table_schemas.name as table_schema_name","columns.default_object_id as column_default_object_id","columns.generated_always_type_desc as column_generated_always_type","columns.is_computed as column_is_computed","columns.is_identity as column_is_identity","columns.is_nullable as column_is_nullable","columns.is_rowguidcol as column_is_rowguidcol","columns.name as column_name","types.is_nullable as type_is_nullable","types.name as type_name","type_schemas.name as type_schema_name","comments.value as column_comment"]).unionAll(this.#ue.selectFrom("sys.views as views").leftJoin("sys.schemas as view_schemas","view_schemas.schema_id","views.schema_id").innerJoin("sys.columns as columns","columns.object_id","views.object_id").innerJoin("sys.types as types","types.user_type_id","columns.user_type_id").leftJoin("sys.schemas as type_schemas","type_schemas.schema_id","types.schema_id").leftJoin("sys.extended_properties as comments",e=>e.onRef("comments.major_id","=","views.object_id").onRef("comments.minor_id","=","columns.column_id").on("comments.name","=","MS_Description")).select(["views.name as table_name","views.type as table_type","view_schemas.name as table_schema_name","columns.default_object_id as column_default_object_id","columns.generated_always_type_desc as column_generated_always_type","columns.is_computed as column_is_computed","columns.is_identity as column_is_identity","columns.is_nullable as column_is_nullable","columns.is_rowguidcol as column_is_rowguidcol","columns.name as column_name","types.is_nullable as type_is_nullable","types.name as type_name","type_schemas.name as type_schema_name","comments.value as column_comment"])).orderBy("table_schema_name").orderBy("table_name").orderBy("column_name").execute(),r={};for(const e of t){const t=`${e.table_schema_name}.${e.table_name}`;(r[t]=r[t]||freeze({columns:[],isView:"V "===e.table_type,name:e.table_name,schema:e.table_schema_name??void 0})).columns.push(freeze({dataType:e.type_name,dataTypeSchema:e.type_schema_name??void 0,hasDefaultValue:e.column_default_object_id>0||"NOT_APPLICABLE"!==e.column_generated_always_type||e.column_is_identity||e.column_is_computed||e.column_is_rowguidcol,isAutoIncrementing:e.column_is_identity,isNullable:e.column_is_nullable&&e.type_is_nullable,name:e.column_name,comment:e.column_comment??void 0}))}return Object.values(r)}async getMetadata(e){return{tables:await this.getTables(e)}}}const _c=/^[a-z0-9_]$/i;class MssqlQueryCompiler extends DefaultQueryCompiler{getCurrentParameterPlaceholder(){return`@${this.numParameters}`}visitOffset(e){super.visitOffset(e),this.append(" rows")}compileColumnAlterations(e){const t={};for(const r of e)t[r.kind]||(t[r.kind]=[]),t[r.kind].push(r);let r=!0;t.AddColumnNode&&(this.append("add "),this.compileList(t.AddColumnNode),r=!1),t.AlterColumnNode&&(r||this.append(", "),this.compileList(t.AlterColumnNode)),t.DropColumnNode&&(r||this.append(", "),this.append("drop column "),this.compileList(t.DropColumnNode)),t.ModifyColumnNode&&(r||this.append(", "),this.compileList(t.ModifyColumnNode)),t.RenameColumnNode&&(r||this.append(", "),this.compileList(t.RenameColumnNode))}visitAddColumn(e){this.visitNode(e.column)}visitDropColumn(e){this.visitNode(e.column)}visitMergeQuery(e){super.visitMergeQuery(e),this.append(";")}visitCollate(e){this.append("collate ");const{name:t}=e.collation;for(const e of t)if(!_c.test(e))throw new Error(`Invalid collation: ${t}`);this.append(t)}announcesNewColumnDataType(){return!1}}class MssqlDialect{#de;constructor(e){this.#de=e}createDriver(){return new MssqlDriver(this.#de)}createQueryCompiler(){return new MssqlQueryCompiler}createAdapter(){return new MssqlAdapter}createIntrospector(e){return new MssqlIntrospector(e)}}function withApplyDefault(e,t,r){return"update"===r?e:null==e&&void 0!==t.defaultValue?"function"==typeof t.defaultValue?t.defaultValue():t.defaultValue:e}let Ac=[],Ic=-1;const Ec="[0m",Cc="[1m",Oc="[2m",Pc={yellow:"[33m",magenta:"[35m"},Rc={black:"[40m"},createAdapter=({adapter:e,config:t})=>r=>{const n={...t,supportsBooleans:t.supportsBooleans??!0,supportsDates:t.supportsDates??!0,supportsJSON:t.supportsJSON??!1,adapterName:t.adapterName??t.adapterId,supportsNumericIds:t.supportsNumericIds??!0};if(!0===r.advanced?.database?.useNumberId&&!1===n.supportsNumericIds)throw new Error(`[${n.adapterName}] Your database or database adapter does not support numeric ids. Please disable "useNumberId" in your config.`);const i=getAuthTables(r),getDefaultFieldName=({field:e,model:t})=>{if("id"===e||"_id"===e)return"id";const r=getDefaultModelName(t);let n=i[r]?.fields[e];if(n||(n=Object.values(i[r]?.fields).find(t=>t.fieldName===e)),!n)throw debugLog(`Field ${e} not found in model ${r}`),debugLog("Schema:",i),new Error(`Field ${e} not found in model ${r}`);return e},getDefaultModelName=e=>{if(n.usePlural&&"s"===e.charAt(e.length-1)){let t=e.slice(0,-1),r=i[t]?t:void 0;if(r||(r=Object.entries(i).find(([e,r])=>r.modelName===t)?.[0]),r)return r}let t=i[e]?e:void 0;if(t||(t=Object.entries(i).find(([t,r])=>r.modelName===e)?.[0]),!t)throw debugLog(`Model "${e}" not found in schema`),debugLog("Schema:",i),new Error(`Model "${e}" not found in schema`);return t},getModelName=e=>{const t=getDefaultModelName(e),r=n&&n.usePlural;return i&&i[t]&&i[t].modelName!==e?r?`${i[t].modelName}s`:i[t].modelName:r?`${e}s`:e};function getFieldName({model:e,field:t}){const r=getDefaultModelName(e),n=getDefaultFieldName({model:r,field:t});return i[r]?.fields[n]?.fieldName||n}const debugLog=(...e)=>{if(!0===n.debugLogs||"object"==typeof n.debugLogs){if("object"==typeof n.debugLogs&&"isRunningAdapterTests"in n.debugLogs)return void(n.debugLogs.isRunningAdapterTests&&(e.shift(),Ac.push(e)));if("object"==typeof n.debugLogs&&n.debugLogs.logCondition&&!n.debugLogs.logCondition?.())return;if("object"==typeof e[0]&&"method"in e[0]){const t=e.shift().method;if("object"==typeof n.debugLogs){if("create"===t&&!n.debugLogs.create)return;if("update"===t&&!n.debugLogs.update)return;if("updateMany"===t&&!n.debugLogs.updateMany)return;if("findOne"===t&&!n.debugLogs.findOne)return;if("findMany"===t&&!n.debugLogs.findMany)return;if("delete"===t&&!n.debugLogs.delete)return;if("deleteMany"===t&&!n.debugLogs.deleteMany)return;if("count"===t&&!n.debugLogs.count)return}rs.info(`[${n.adapterName}]`,...e)}else rs.info(`[${n.adapterName}]`,...e)}},idField=({customModelName:e,forceAllowId:t})=>{const i=!n.disableIdGeneration&&!r.advanced?.database?.useNumberId&&!t,s=getDefaultModelName(e??"id");return{type:r.advanced?.database?.useNumberId?"number":"string",required:!!i,...i?{defaultValue(){if(n.disableIdGeneration)return;const e=r.advanced?.database?.useNumberId;let t=r.advanced?.database?.generateId;return void 0!==r.advanced?.generateId&&(rs.warn("Your Better Auth config includes advanced.generateId which is deprecated. Please use advanced.database.generateId instead. This will be removed in future releases."),t=r.advanced?.generateId),!1===t||e?void 0:t?t({model:s}):n.customIdGenerator?n.customIdGenerator({model:s}):generateId()}}:{}}},getFieldAttributes=({model:e,field:t})=>{const r=getDefaultModelName(e),n=getDefaultFieldName({field:t,model:e}),s=i[r].fields;return s.id=idField({customModelName:r}),s[n]},s=e({options:r,schema:i,debugLog:debugLog,getFieldName:getFieldName,getModelName:getModelName,getDefaultModelName:getDefaultModelName,getDefaultFieldName:getDefaultFieldName,getFieldAttributes:getFieldAttributes}),transformInput=async(e,t,s,o)=>{const a={},c=i[t].fields,d=n.mapKeysTransformInput??{};n.disableIdGeneration||r.advanced?.database?.useNumberId||(c.id=idField({customModelName:t,forceAllowId:o&&"id"in e}));for(const o in c){const l=e[o],u=c[o];let p=d[o]||c[o].fieldName||o;if(void 0===l&&(!u.defaultValue&&!u.transform?.input||"update"===s))continue;let h=withApplyDefault(l,u,s);u.transform?.input&&(h=await u.transform.input(h)),"id"===u.references?.field&&r.advanced?.database?.useNumberId?h=Array.isArray(h)?h.map(Number):Number(h):!1===n.supportsJSON&&"object"==typeof h&&"json"===u.type?h=JSON.stringify(h):!1===n.supportsDates&&h instanceof Date&&"date"===u.type?h=h.toISOString():!1===n.supportsBooleans&&"boolean"==typeof h&&(h=h?1:0),n.customTransformInput&&(h=n.customTransformInput({data:h,action:s,field:p,fieldAttributes:u,model:t,schema:i,options:r})),a[p]=h}return a},transformOutput=async(e,t,s=[])=>{if(!e)return null;const o=n.mapKeysTransformOutput??{},a={},c=i[t].fields,d=Object.entries(o).find(([e,t])=>"id"===t)?.[0];c[d??"id"]={type:r.advanced?.database?.useNumberId?"number":"string"};for(const d in c){if(s.length&&!s.includes(d))continue;const l=c[d];if(l){const c=l.fieldName||d;let u=e[Object.entries(o).find(([e,t])=>t===c)?.[0]||c];l.transform?.output&&(u=await l.transform.output(u));let p=o[d]||d;"id"===c||"id"===l.references?.field?void 0!==u&&(u=String(u)):!1===n.supportsJSON&&"string"==typeof u&&"json"===l.type?u=safeJSONParse(u):!1===n.supportsDates&&"string"==typeof u&&"date"===l.type?u=new Date(u):!1===n.supportsBooleans&&"number"==typeof u&&"boolean"===l.type&&(u=1===u),n.customTransformOutput&&(u=n.customTransformOutput({data:u,field:p,fieldAttributes:l,select:s,model:t,schema:i,options:r})),a[p]=u}}return a},transformWhereClause=({model:e,where:t})=>{if(!t)return;const i=n.mapKeysTransformInput??{};return t.map(t=>{const{field:n,value:s,operator:o="eq",connector:a="AND"}=t;if("in"===o&&!Array.isArray(s))throw new Error("Value must be an array");const c=getDefaultModelName(e),d=getDefaultFieldName({field:n,model:e}),l=i[d]||getFieldName({field:d,model:c}),u=getFieldAttributes({field:d,model:c});return"id"!==d&&"id"!==u.references?.field||!r.advanced?.database?.useNumberId?{operator:o,connector:a,field:l,value:s}:Array.isArray(s)?{operator:o,connector:a,field:l,value:s.map(Number)}:{operator:o,connector:a,field:l,value:Number(s)}})};return{create:async({data:e,model:t,select:r,forceAllowId:i=!1})=>{Ic++;let o=Ic;const a=getModelName(t);if("id"in e&&!i){rs.warn(`[${n.adapterName}] - You are trying to create a record with an id. This is not allowed as we handle id generation for you, unless you pass in the \`forceAllowId\` parameter. The id will be ignored.`);const t=new Error,r=t.stack?.split("\n").filter((e,t)=>1!==t).join("\n").replace("Error:","Create method with `id` being called at:");console.log(r),e.id=void 0}debugLog({method:"create"},`${formatTransactionId(o)} ${formatStep(1,4)}`,`${formatMethod("create")} ${formatAction("Unsafe Input")}:`,{model:a,data:e});const c=await transformInput(e,t,"create",i);debugLog({method:"create"},`${formatTransactionId(o)} ${formatStep(2,4)}`,`${formatMethod("create")} ${formatAction("Parsed Input")}:`,{model:a,data:c});const d=await s.create({data:c,model:a});debugLog({method:"create"},`${formatTransactionId(o)} ${formatStep(3,4)}`,`${formatMethod("create")} ${formatAction("DB Result")}:`,{model:a,res:d});const l=await transformOutput(d,t,r);return debugLog({method:"create"},`${formatTransactionId(o)} ${formatStep(4,4)}`,`${formatMethod("create")} ${formatAction("Parsed Result")}:`,{model:a,data:l}),l},update:async({model:e,where:t,update:r})=>{Ic++;let n=Ic;const i=getModelName(e),o=transformWhereClause({model:e,where:t});debugLog({method:"update"},`${formatTransactionId(n)} ${formatStep(1,4)}`,`${formatMethod("update")} ${formatAction("Unsafe Input")}:`,{model:i,data:r});const a=await transformInput(r,e,"update");debugLog({method:"update"},`${formatTransactionId(n)} ${formatStep(2,4)}`,`${formatMethod("update")} ${formatAction("Parsed Input")}:`,{model:i,data:a});const c=await s.update({model:i,where:o,update:a});debugLog({method:"update"},`${formatTransactionId(n)} ${formatStep(3,4)}`,`${formatMethod("update")} ${formatAction("DB Result")}:`,{model:i,data:c});const d=await transformOutput(c,e);return debugLog({method:"update"},`${formatTransactionId(n)} ${formatStep(4,4)}`,`${formatMethod("update")} ${formatAction("Parsed Result")}:`,{model:i,data:d}),d},updateMany:async({model:e,where:t,update:r})=>{Ic++;let n=Ic;const i=getModelName(e),o=transformWhereClause({model:e,where:t});debugLog({method:"updateMany"},`${formatTransactionId(n)} ${formatStep(1,4)}`,`${formatMethod("updateMany")} ${formatAction("Unsafe Input")}:`,{model:i,data:r});const a=await transformInput(r,e,"update");debugLog({method:"updateMany"},`${formatTransactionId(n)} ${formatStep(2,4)}`,`${formatMethod("updateMany")} ${formatAction("Parsed Input")}:`,{model:i,data:a});const c=await s.updateMany({model:i,where:o,update:a});return debugLog({method:"updateMany"},`${formatTransactionId(n)} ${formatStep(3,4)}`,`${formatMethod("updateMany")} ${formatAction("DB Result")}:`,{model:i,data:c}),debugLog({method:"updateMany"},`${formatTransactionId(n)} ${formatStep(4,4)}`,`${formatMethod("updateMany")} ${formatAction("Parsed Result")}:`,{model:i,data:c}),c},findOne:async({model:e,where:t,select:r})=>{Ic++;let n=Ic;const i=getModelName(e),o=transformWhereClause({model:e,where:t});debugLog({method:"findOne"},`${formatTransactionId(n)} ${formatStep(1,3)}`,`${formatMethod("findOne")}:`,{model:i,where:o,select:r});const a=await s.findOne({model:i,where:o,select:r});debugLog({method:"findOne"},`${formatTransactionId(n)} ${formatStep(2,3)}`,`${formatMethod("findOne")} ${formatAction("DB Result")}:`,{model:i,data:a});const c=await transformOutput(a,e,r);return debugLog({method:"findOne"},`${formatTransactionId(n)} ${formatStep(3,3)}`,`${formatMethod("findOne")} ${formatAction("Parsed Result")}:`,{model:i,data:c}),c},findMany:async({model:e,where:t,limit:n,sortBy:i,offset:o})=>{Ic++;let a=Ic;const c=n??r.advanced?.database?.defaultFindManyLimit??100,d=getModelName(e),l=transformWhereClause({model:e,where:t});debugLog({method:"findMany"},`${formatTransactionId(a)} ${formatStep(1,3)}`,`${formatMethod("findMany")}:`,{model:d,where:l,limit:c,sortBy:i,offset:o});const u=await s.findMany({model:d,where:l,limit:c,sortBy:i,offset:o});debugLog({method:"findMany"},`${formatTransactionId(a)} ${formatStep(2,3)}`,`${formatMethod("findMany")} ${formatAction("DB Result")}:`,{model:d,data:u});const p=await Promise.all(u.map(async t=>await transformOutput(t,e)));return debugLog({method:"findMany"},`${formatTransactionId(a)} ${formatStep(3,3)}`,`${formatMethod("findMany")} ${formatAction("Parsed Result")}:`,{model:d,data:p}),p},delete:async({model:e,where:t})=>{Ic++;let r=Ic;const n=getModelName(e),i=transformWhereClause({model:e,where:t});debugLog({method:"delete"},`${formatTransactionId(r)} ${formatStep(1,2)}`,`${formatMethod("delete")}:`,{model:n,where:i}),await s.delete({model:n,where:i}),debugLog({method:"delete"},`${formatTransactionId(r)} ${formatStep(2,2)}`,`${formatMethod("delete")} ${formatAction("DB Result")}:`,{model:n})},deleteMany:async({model:e,where:t})=>{Ic++;let r=Ic;const n=getModelName(e),i=transformWhereClause({model:e,where:t});debugLog({method:"deleteMany"},`${formatTransactionId(r)} ${formatStep(1,2)}`,`${formatMethod("deleteMany")} ${formatAction("DeleteMany")}:`,{model:n,where:i});const o=await s.deleteMany({model:n,where:i});return debugLog({method:"deleteMany"},`${formatTransactionId(r)} ${formatStep(2,2)}`,`${formatMethod("deleteMany")} ${formatAction("DB Result")}:`,{model:n,data:o}),o},count:async({model:e,where:t})=>{Ic++;let r=Ic;const n=getModelName(e),i=transformWhereClause({model:e,where:t});debugLog({method:"count"},`${formatTransactionId(r)} ${formatStep(1,2)}`,`${formatMethod("count")}:`,{model:n,where:i});const o=await s.count({model:n,where:i});return debugLog({method:"count"},`${formatTransactionId(r)} ${formatStep(2,2)}`,`${formatMethod("count")}:`,{model:n,data:o}),o},createSchema:s.createSchema?async(e,t)=>{const n=getAuthTables(r);return r.secondaryStorage&&!r.session?.storeSessionInDatabase&&delete n.session,!r.rateLimit||"database"!==r.rateLimit.storage||void 0!==r.rateLimit.enabled&&!0!==r.rateLimit.enabled||(n.ratelimit={modelName:r.rateLimit.modelName??"ratelimit",fields:{key:{type:"string",unique:!0,required:!0,fieldName:r.rateLimit.fields?.key??"key"},count:{type:"number",required:!0,fieldName:r.rateLimit.fields?.count??"count"},lastRequest:{type:"number",required:!0,bigint:!0,defaultValue:()=>Date.now(),fieldName:r.rateLimit.fields?.lastRequest??"lastRequest"}}}),s.createSchema({file:t,tables:n})}:void 0,options:{adapterConfig:n,...s.options??{}},id:n.adapterId,...n.debugLogs?.isRunningAdapterTests?{adapterTestDebugLogs:{resetDebugLogs(){Ac=[]},printDebugLogs(){const e="─".repeat(80);let t=Ac.reverse().map(e=>(e[0]=`\n${e[0]}`,[...e,"\n"])).reduce((e,t)=>[...t,...e],[`\n${e}`]);console.log(...t)}}}:{}}};function formatTransactionId(e){return`${Pc.magenta}#${e}${Ec}`}function formatStep(e,t){return`${Rc.black}${Pc.yellow}[${e}/${t}]${Ec}`}function formatMethod(e){return`${Cc}${e}${Ec}`}function formatAction(e){return`${Oc}(${e})${Ec}`}function getDatabaseType(e){if(!e)return null;if("dialect"in e)return getDatabaseType(e.dialect);if("createDriver"in e){if(e instanceof SqliteDialect)return"sqlite";if(e instanceof MysqlDialect)return"mysql";if(e instanceof PostgresDialect)return"postgres";if(e instanceof MssqlDialect)return"mssql"}return"aggregate"in e?"sqlite":"getConnection"in e?"mysql":"connect"in e?"postgres":"fileControl"in e?"sqlite":null}const createKyselyAdapter=async e=>{const t=e.database;if(!t)return{kysely:null,databaseType:null};if("db"in t)return{kysely:t.db,databaseType:t.type};if("dialect"in t)return{kysely:new Kysely({dialect:t.dialect}),databaseType:t.type};let r;const n=getDatabaseType(t);if("createDriver"in t&&(r=t),"aggregate"in t&&(r=new SqliteDialect({database:t})),"getConnection"in t&&(r=new MysqlDialect(t)),"connect"in t&&(r=new PostgresDialect({pool:t})),"fileControl"in t){const{BunSqliteDialect:e}=await import("../../../_/bun-sqlite-dialect.mjs");r=new e({database:t})}return{kysely:r?new Kysely({dialect:r}):null,databaseType:n}},kyselyAdapter=(e,t)=>createAdapter({config:{adapterId:"kysely",adapterName:"Kysely Adapter",usePlural:t?.usePlural,debugLogs:t?.debugLogs,supportsBooleans:!("sqlite"===t?.type||"mssql"===t?.type||!t?.type),supportsDates:!("sqlite"===t?.type||"mssql"===t?.type||!t?.type),supportsJSON:!1},adapter:({getFieldName:r,schema:n})=>{const withReturning=async(n,i,s,o)=>{let a;if("mysql"===t?.type){await i.execute();const t=n.id?"id":o.length>0&&o[0].field?o[0].field:"id";if(!n.id&&0===o.length)return a=await e.selectFrom(s).selectAll().orderBy(r({model:s,field:t}),"desc").limit(1).executeTakeFirst(),a;const c=n[t]||o[0].value;return a=await e.selectFrom(s).selectAll().orderBy(r({model:s,field:t}),"desc").where(r({model:s,field:t}),"=",c).limit(1).executeTakeFirst(),a}return"mssql"===t?.type?(a=await i.outputAll("inserted").executeTakeFirst(),a):(a=await i.returningAll().executeTakeFirst(),a)};function convertWhereClause(e,i){if(!i)return{and:null,or:null};const s={and:[],or:[]};return i.forEach(i=>{let{field:o,value:a,operator:c="=",connector:d="AND"}=i;const l=r({model:e,field:o});a=function(e,r,i){if("id"===i)return e;const{type:s="sqlite"}=t||{};let o=n[r]?.fields[i];return o||(o=Object.values(n).find(e=>e.modelName===r)),"boolean"!==o.type||"sqlite"!==s&&"mssql"!==s||null==e?"date"===o.type&&e&&e instanceof Date&&"sqlite"===s?e.toISOString():e:e?1:0}(a,e,o);const expr=e=>"in"===c.toLowerCase()?e(l,"in",Array.isArray(a)?a:[a]):"contains"===c?e(l,"like",`%${a}%`):"starts_with"===c?e(l,"like",`${a}%`):"ends_with"===c?e(l,"like",`%${a}`):e(l,"eq"===c?"=":"ne"===c?"<>":"gt"===c?">":"gte"===c?">=":"lt"===c?"<":"lte"===c?"<=":c,a);"OR"===d?s.or.push(expr):s.and.push(expr)}),{and:s.and.length?s.and:null,or:s.or.length?s.or:null}}return{async create({data:t,model:r}){const n=e.insertInto(r).values(t);return await withReturning(t,n,r,[])},async findOne({model:t,where:r,select:n}){const{and:i,or:s}=convertWhereClause(t,r);let o=e.selectFrom(t).selectAll();i&&(o=o.where(e=>e.and(i.map(t=>t(e))))),s&&(o=o.where(e=>e.or(s.map(t=>t(e)))));const a=await o.executeTakeFirst();return a||null},async findMany({model:n,where:i,limit:s,offset:o,sortBy:a}){const{and:c,or:d}=convertWhereClause(n,i);let l=e.selectFrom(n);c&&(l=l.where(e=>e.and(c.map(t=>t(e))))),d&&(l=l.where(e=>e.or(d.map(t=>t(e))))),"mssql"===t?.type?o||(l=l.top(s||100)):l=l.limit(s||100),a&&(l=l.orderBy(r({model:n,field:a.field}),a.direction)),o&&("mssql"===t?.type?(a||(l=l.orderBy(r({model:n,field:"id"}))),l=l.offset(o).fetch(s||100)):l=l.offset(o));const u=await l.selectAll().execute();return u||[]},async update({model:t,where:r,update:n}){const{and:i,or:s}=convertWhereClause(t,r);let o=e.updateTable(t).set(n);return i&&(o=o.where(e=>e.and(i.map(t=>t(e))))),s&&(o=o.where(e=>e.or(s.map(t=>t(e))))),await withReturning(n,o,t,r)},async updateMany({model:t,where:r,update:n}){const{and:i,or:s}=convertWhereClause(t,r);let o=e.updateTable(t).set(n);i&&(o=o.where(e=>e.and(i.map(t=>t(e))))),s&&(o=o.where(e=>e.or(s.map(t=>t(e)))));return(await o.execute()).length},async count({model:t,where:r}){const{and:n,or:i}=convertWhereClause(t,r);let s=e.selectFrom(t).select(e.fn.count("id").as("count"));n&&(s=s.where(e=>e.and(n.map(t=>t(e))))),i&&(s=s.where(e=>e.or(i.map(t=>t(e)))));return(await s.execute())[0].count},async delete({model:t,where:r}){const{and:n,or:i}=convertWhereClause(t,r);let s=e.deleteFrom(t);n&&(s=s.where(e=>e.and(n.map(t=>t(e))))),i&&(s=s.where(e=>e.or(i.map(t=>t(e))))),await s.execute()},async deleteMany({model:t,where:r}){const{and:n,or:i}=convertWhereClause(t,r);let s=e.deleteFrom(t);return n&&(s=s.where(e=>e.and(n.map(t=>t(e))))),i&&(s=s.where(e=>e.or(i.map(t=>t(e))))),(await s.execute()).length},options:t}}});const createInternalAdapter=(e,t)=>{const r=t.options,n=r.secondaryStorage,i=r.session?.expiresIn||604800,{createWithHooks:s,updateWithHooks:o,updateManyWithHooks:a}=function(e,t){const r=t.hooks;return{createWithHooks:async function(t,n,i,s){let o=t;for(const e of r||[]){const t=e[n]?.create?.before;if(t){const e=await t(o,s);if(!1===e)return null;"object"==typeof e&&"data"in e&&(o={...o,...e.data})}}const a=i?await i.fn(o):null,c=!i||i.executeMainFn?await e.create({model:n,data:o,forceAllowId:!0}):a;for(const e of r||[]){const t=e[n]?.create?.after;t&&await t(c,s)}return c},updateWithHooks:async function(t,n,i,s,o){let a=t;for(const e of r||[]){const r=e[i]?.update?.before;if(r){const e=await r(t,o);if(!1===e)return null;a="object"==typeof e?e.data:e}}const c=s?await s.fn(a):null,d=!s||s.executeMainFn?await e.update({model:i,update:a,where:n}):c;for(const e of r||[]){const t=e[i]?.update?.after;t&&await t(d,o)}return d},updateManyWithHooks:async function(t,n,i,s,o){let a=t;for(const e of r||[]){const r=e[i]?.update?.before;if(r){const e=await r(t,o);if(!1===e)return null;a="object"==typeof e?e.data:e}}const c=s?await s.fn(a):null,d=!s||s.executeMainFn?await e.updateMany({model:i,update:a,where:n}):c;for(const e of r||[]){const t=e[i]?.update?.after;t&&await t(d,o)}return d}}}(e,t);return{createOAuthUser:async(e,t,r)=>{const n=await s({createdAt:new Date,updatedAt:new Date,...e},"user",void 0,r);return{user:n,account:await s({...t,userId:n.id||e.id,createdAt:new Date,updatedAt:new Date},"account",void 0,r)}},createUser:async(e,t)=>await s({createdAt:new Date,updatedAt:new Date,emailVerified:!1,...e,email:e.email?.toLowerCase()},"user",void 0,t),createAccount:async(e,t)=>await s({createdAt:new Date,updatedAt:new Date,...e},"account",void 0,t),listSessions:async r=>{if(n){const e=await n.get(`active-sessions-${r}`);if(!e)return[];const i=safeJSONParse(e)||[],s=Date.now(),o=i.filter(e=>e.expiresAt>s),a=[];for(const e of o){const r=await n.get(e.token);if(r){const e=JSON.parse(r),n=parseSessionOutput(t.options,{...e.session,expiresAt:new Date(e.session.expiresAt)});a.push(n)}}return a}return await e.findMany({model:"session",where:[{field:"userId",value:r}]})},listUsers:async(t,r,n,i)=>await e.findMany({model:"user",limit:t,offset:r,sortBy:n,where:i}),countTotalUsers:async t=>{const r=await e.count({model:"user",where:t});return"string"==typeof r?parseInt(r):r},deleteUser:async t=>{n&&await n.delete(`active-sessions-${t}`),n&&!r.session?.storeSessionInDatabase||await e.deleteMany({model:"session",where:[{field:"userId",value:t}]}),await e.deleteMany({model:"account",where:[{field:"userId",value:t}]}),await e.delete({model:"user",where:[{field:"id",value:t}]})},createSession:async(e,t,o,a,c)=>{const d=t.headers||t.request?.headers,{id:l,...u}=a||{},p={ipAddress:(t.request||t.headers)&&getIp(t.request||t.headers,t.context.options)||"",userAgent:d?.get("user-agent")||"",...u,expiresAt:getDate(o?86400:i,"sec"),userId:e,token:generateId(32),createdAt:new Date,updatedAt:new Date,...c?u:{}},h=await s(p,"session",n?{fn:async t=>{const r=await n.get(`active-sessions-${e}`);let s=[];const o=Date.now();return r&&(s=safeJSONParse(r)||[],s=s.filter(e=>e.expiresAt>o)),s.push({token:p.token,expiresAt:o+1e3*i}),await n.set(`active-sessions-${e}`,JSON.stringify(s),i),t},executeMainFn:r.session?.storeSessionInDatabase}:void 0,t);return h},findSession:async i=>{if(n){const e=await n.get(i);if(!e&&!r.session?.storeSessionInDatabase)return null;if(e){const r=JSON.parse(e);return{session:parseSessionOutput(t.options,{...r.session,expiresAt:new Date(r.session.expiresAt),createdAt:new Date(r.session.createdAt),updatedAt:new Date(r.session.updatedAt)}),user:parseUserOutput(t.options,{...r.user,createdAt:new Date(r.user.createdAt),updatedAt:new Date(r.user.updatedAt)})}}}const s=await e.findOne({model:"session",where:[{value:i,field:"token"}]});if(!s)return null;const o=await e.findOne({model:"user",where:[{value:s.userId,field:"id"}]});if(!o)return null;return{session:parseSessionOutput(t.options,s),user:parseUserOutput(t.options,o)}},findSessions:async t=>{if(n){const e=[];for(const r of t){const t=await n.get(r);if(t){const r=JSON.parse(t),n={session:{...r.session,expiresAt:new Date(r.session.expiresAt)},user:{...r.user,createdAt:new Date(r.user.createdAt),updatedAt:new Date(r.user.updatedAt)}};e.push(n)}}return e}const r=await e.findMany({model:"session",where:[{field:"token",value:t,operator:"in"}]}),i=r.map(e=>e.userId);if(!i.length)return[];const s=await e.findMany({model:"user",where:[{field:"id",value:i,operator:"in"}]});return r.map(e=>{const t=s.find(t=>t.id===e.userId);return t?{session:e,user:t}:null})},updateSession:async(e,t,i)=>await o(t,[{field:"token",value:e}],"session",n?{async fn(t){const r=await n.get(e);let i=null;if(r){return i={...JSON.parse(r).session,...t},i}return null},executeMainFn:r.session?.storeSessionInDatabase}:void 0,i),deleteSession:async i=>{n&&(await n.delete(i),!r.session?.storeSessionInDatabase||t.options.session?.preserveSessionInDatabase)||await e.delete({model:"session",where:[{field:"token",value:i}]})},deleteAccounts:async t=>{await e.deleteMany({model:"account",where:[{field:"userId",value:t}]})},deleteAccount:async t=>{await e.delete({model:"account",where:[{field:"id",value:t}]})},deleteSessions:async i=>{if(n){if("string"==typeof i){const e=await n.get(`active-sessions-${i}`),t=e?safeJSONParse(e):[];if(!t)return;for(const e of t)await n.delete(e.token)}else for(const e of i){await n.get(e)&&await n.delete(e)}if(!r.session?.storeSessionInDatabase||t.options.session?.preserveSessionInDatabase)return}await e.deleteMany({model:"session",where:[{field:Array.isArray(i)?"token":"userId",value:i,operator:Array.isArray(i)?"in":void 0}]})},findOAuthUser:async(t,r,n)=>{const i=await e.findMany({model:"account",where:[{value:r,field:"accountId"}]}).then(e=>e.find(e=>e.providerId===n));if(i){const r=await e.findOne({model:"user",where:[{value:i.userId,field:"id"}]});if(r)return{user:r,accounts:[i]};{const r=await e.findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]});return r?{user:r,accounts:[i]}:null}}{const r=await e.findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]});if(r){return{user:r,accounts:await e.findMany({model:"account",where:[{value:r.id,field:"userId"}]})||[]}}return null}},findUserByEmail:async(t,r)=>{const n=await e.findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]});if(!n)return null;if(r?.includeAccounts){return{user:n,accounts:await e.findMany({model:"account",where:[{value:n.id,field:"userId"}]})}}return{user:n,accounts:[]}},findUserById:async t=>await e.findOne({model:"user",where:[{field:"id",value:t}]}),linkAccount:async(e,t)=>await s({...e,createdAt:new Date,updatedAt:new Date},"account",void 0,t),updateUser:async(e,t,r)=>{const i=await o(t,[{field:"id",value:e}],"user",void 0,r);if(n&&i){const t=await n.get(`active-sessions-${e}`);if(t){const e=Date.now(),r=(safeJSONParse(t)||[]).filter(t=>t.expiresAt>e);await Promise.all(r.map(async({token:t})=>{const r=await n.get(t);if(!r)return;const s=safeJSONParse(r);if(!s)return;const o=Math.max(Math.floor((new Date(s.session.expiresAt).getTime()-e)/1e3),0);await n.set(t,JSON.stringify({session:s.session,user:i}),o)}))}}return i},updateUserByEmail:async(e,t,r)=>await o(t,[{field:"email",value:e.toLowerCase()}],"user",void 0,r),updatePassword:async(e,t,r)=>{await a({password:t},[{field:"userId",value:e},{field:"providerId",value:"credential"}],"account",void 0,r)},findAccounts:async t=>await e.findMany({model:"account",where:[{field:"userId",value:t}]}),findAccount:async t=>await e.findOne({model:"account",where:[{field:"accountId",value:t}]}),findAccountByProviderId:async(t,r)=>await e.findOne({model:"account",where:[{field:"accountId",value:t},{field:"providerId",value:r}]}),findAccountByUserId:async t=>await e.findMany({model:"account",where:[{field:"userId",value:t}]}),updateAccount:async(e,t,r)=>await o(t,[{field:"id",value:e}],"account",void 0,r),createVerificationValue:async(e,t)=>await s({createdAt:new Date,updatedAt:new Date,...e},"verification",void 0,t),findVerificationValue:async t=>{const n=await e.findMany({model:"verification",where:[{field:"identifier",value:t}],sortBy:{field:"createdAt",direction:"desc"},limit:1});r.verification?.disableCleanup||await e.deleteMany({model:"verification",where:[{field:"expiresAt",value:new Date,operator:"lt"}]});return n[0]},deleteVerificationValue:async t=>{await e.delete({model:"verification",where:[{field:"id",value:t}]})},deleteVerificationByIdentifier:async t=>{await e.delete({model:"verification",where:[{field:"identifier",value:t}]})},updateVerificationValue:async(e,t,r)=>await o(t,[{field:"id",value:e}],"verification",void 0,r)}};async function getAdapter(e){if(!e.database){const t=getAuthTables(e),r=Object.keys(t).reduce((e,t)=>(e[t]=[],e),{});return rs.warn("No database configuration provided. Using memory adapter in development"),(e=>createAdapter({config:{adapterId:"memory",adapterName:"Memory Adapter",usePlural:!1,debugLogs:!1,customTransformInput:t=>t.options.advanced?.database?.useNumberId&&"id"===t.field&&"create"===t.action?e[t.model].length+1:t.data},adapter:({getFieldName:t,options:r,debugLog:n})=>{function convertWhereClause(t,r){const n=e[r];if(!n)throw rs.error(`[MemoryAdapter] Model ${r} not found in the DB`,Object.keys(e)),new Error(`Model ${r} not found`);return n.filter(e=>t.every(t=>{let{field:r,value:n,operator:i}=t;if("in"===i){if(!Array.isArray(n))throw new Error("Value must be an array");return n.includes(e[r])}return"contains"===i?e[r].includes(n):"starts_with"===i?e[r].startsWith(n):"ends_with"===i?e[r].endsWith(n):e[r]===n}))}return{create:async({model:t,data:n})=>(r.advanced?.database?.useNumberId&&(n.id=e[t].length+1),e[t]||(e[t]=[]),e[t].push(n),n),findOne:async({model:e,where:t})=>convertWhereClause(t,e)[0]||null,findMany:async({model:r,where:n,sortBy:i,limit:s,offset:o})=>{let a=e[r];return n&&(a=convertWhereClause(n,r)),i&&(a=a.sort((e,n)=>{const s=t({model:r,field:i.field});return"asc"===i.direction?e[s]>n[s]?1:-1:e[s]<n[s]?1:-1})),void 0!==o&&(a=a.slice(o)),void 0!==s&&(a=a.slice(0,s)),a},count:async({model:t})=>e[t].length,update:async({model:e,where:t,update:r})=>{const n=convertWhereClause(t,e);return n.forEach(e=>{Object.assign(e,r)}),n[0]||null},delete:async({model:t,where:r})=>{const n=e[t],i=convertWhereClause(r,t);e[t]=n.filter(e=>!i.includes(e))},deleteMany:async({model:t,where:r})=>{const n=e[t],i=convertWhereClause(r,t);let s=0;return e[t]=n.filter(e=>i.includes(e)?(s++,!1):!i.includes(e)),s},updateMany({model:e,where:t,update:r}){const n=convertWhereClause(t,e);return n.forEach(e=>{Object.assign(e,r)}),n[0]||null}}}}))(r)(e)}if("function"==typeof e.database)return e.database(e);const{kysely:t,databaseType:r}=await createKyselyAdapter(e);if(!t)throw new BetterAuthError("Failed to initialize database adapter");return kyselyAdapter(t,{type:r||"sqlite",debugLogs:"debugLogs"in e.database&&e.database.debugLogs})(e)}const $c={postgres:{string:["character varying","varchar","text"],number:["int4","integer","bigint","smallint","numeric","real","double precision"],boolean:["bool","boolean"],date:["timestamp","date"]},mysql:{string:["varchar","text"],number:["integer","int","bigint","smallint","decimal","float","double"],boolean:["boolean","tinyint"],date:["timestamp","datetime","date"]},sqlite:{string:["TEXT"],number:["INTEGER","REAL"],boolean:["INTEGER","BOOLEAN"],date:["DATE","INTEGER"]},mssql:{string:["text","varchar"],number:["int","bigint","smallint","decimal","float","double"],boolean:["bit","smallint"],date:["datetime","date"]}};function matchType(e,t,r){if("string[]"===t||"number[]"===t)return e.toLowerCase().includes("json");const n=$c[r];return(Array.isArray(t)?n.string.map(e=>e.toLowerCase()):n[t].map(e=>e.toLowerCase())).includes(e.toLowerCase().split("(")[0].trim())}async function getMigrations(e){const t=function(e){const t=getAuthTables(e);let r={};for(const e in t){const n=t[e],i=n.fields;let s={};Object.entries(i).forEach(([e,r])=>{if(s[r.fieldName||e]=r,r.references){const n=t[r.references.model];n&&(s[r.fieldName||e].references={model:n.modelName,field:r.references.field})}}),r[n.modelName]?r[n.modelName].fields={...r[n.modelName].fields,...s}:r[n.modelName]={fields:s,order:n.order||1/0}}return r}(e),n=createLogger(e.logger);let{kysely:i,databaseType:s}=await createKyselyAdapter(e);s||(n.warn("Could not determine database type, defaulting to sqlite. Please provide a type in the database options to avoid this."),s="sqlite"),i||(n.error("Only kysely adapter is supported for migrations. You can use `generate` command to generate the schema, if you're using a different adapter."),r.exit(1));const o=await i.introspection.getTables(),a=[],c=[];for(const[e,r]of Object.entries(t)){const t=o.find(t=>t.name===e);if(!t){const t=a.findIndex(t=>t.table===e),n={table:e,fields:r.fields,order:r.order||1/0},i=a.findIndex(e=>(e.order||1/0)>n.order);-1===i?-1===t?a.push(n):a[t].fields={...a[t].fields,...r.fields}:a.splice(i,0,n);continue}let i={};for(const[o,a]of Object.entries(r.fields)){const r=t.columns.find(e=>e.name===o);r?matchType(r.dataType,a.type,s)||n.warn(`Field ${o} in table ${e} has a different type in the database. Expected ${a.type} but got ${r.dataType}.`):i[o]=a}Object.keys(i).length>0&&c.push({table:e,fields:i,order:r.order||1/0})}const d=[];function getType(t,r){const n=t.type,i={string:{sqlite:"text",postgres:"text",mysql:t.unique?"varchar(255)":t.references?"varchar(36)":"text",mssql:t.unique||t.sortable?"varchar(255)":t.references?"varchar(36)":"text"},boolean:{sqlite:"integer",postgres:"boolean",mysql:"boolean",mssql:"smallint"},number:{sqlite:t.bigint?"bigint":"integer",postgres:t.bigint?"bigint":"integer",mysql:t.bigint?"bigint":"integer",mssql:t.bigint?"bigint":"integer"},date:{sqlite:"date",postgres:"timestamp",mysql:"datetime",mssql:"datetime"},id:{postgres:e.advanced?.database?.useNumberId?"serial":"text",mysql:e.advanced?.database?.useNumberId?"integer":"varchar(36)",mssql:e.advanced?.database?.useNumberId?"integer":"varchar(36)",sqlite:e.advanced?.database?.useNumberId?"integer":"text"}};return"id"===r||"id"===t.references?.field?i.id[s]:"sqlite"!==s||"string[]"!==n&&"number[]"!==n?"string[]"===n||"number[]"===n?"jsonb":Array.isArray(n)?"text":i[n][s||"sqlite"]:"text"}if(c.length)for(const e of c)for(const[t,r]of Object.entries(e.fields)){const n=getType(r,t),s=i.schema.alterTable(e.table).addColumn(t,n,e=>(e=!1!==r.required?e.notNull():e,r.references&&(e=e.references(`${r.references.model}.${r.references.field}`)),r.unique&&(e=e.unique()),e));d.push(s)}if(a.length)for(const t of a){let r=i.schema.createTable(t.table).addColumn("id",e.advanced?.database?.useNumberId?"postgres"===s?"serial":"integer":"mysql"===s||"mssql"===s?"varchar(36)":"text",t=>e.advanced?.database?.useNumberId?"postgres"===s?t.primaryKey().notNull():t.autoIncrement().primaryKey().notNull():t.primaryKey().notNull());for(const[e,n]of Object.entries(t.fields)){const t=getType(n,e);r=r.addColumn(e,t,e=>(e=!1!==n.required?e.notNull():e,n.references&&(e=e.references(`${n.references.model}.${n.references.field}`)),n.unique&&(e=e.unique()),e))}d.push(r)}return{toBeCreated:a,toBeAdded:c,runMigrations:async function(){for(const e of d)await e.execute()},compileMigrations:async function(){return d.map(e=>e.compile().sql).join(";\n\n")+";"}}}async function checkPassword(e,t){const r=await t.context.internalAdapter.findAccounts(e),n=r?.find(e=>"credential"===e.providerId),i=n?.password;if(!n||!i||!t.body.password)throw new h("BAD_REQUEST",{message:"No password credential found"});if(!await t.context.password.verify({hash:i,password:t.body.password}))throw new h("BAD_REQUEST",{message:"Invalid password"});return!0}const Bc="better-auth-secret-123456789",init=async e=>{const t=await getAdapter(e),r=e.plugins||[],i=function(e){const t=[];e.advanced;return t}(e),s=createLogger(e.logger),o=getBaseURL(e.baseURL,e.basePath),a=e.secret||Wi.BETTER_AUTH_SECRET||Wi.AUTH_SECRET||Bc;a===Bc&&Mi&&s.error("You are using the default secret. Please set `BETTER_AUTH_SECRET` in your environment variables or pass `secret` in your auth config.");const c=function(e){const t=createCookieGetter(e),r=t("session_token",{maxAge:e.session?.expiresIn||Hi(7,"d").toSeconds()}),n=t("session_data",{maxAge:e.session?.cookieCache?.maxAge||300}),i=t("dont_remember");return{sessionToken:{name:r.name,options:r.attributes},sessionData:{name:n.name,options:n.attributes},dontRememberToken:{name:i.name,options:i.attributes}}}(e={...e,secret:a,baseURL:o?new URL(o).origin:"",basePath:e.basePath||"/api/auth",plugins:r.concat(i)}),d=getAuthTables(e),l=Object.keys(e.socialProviders||{}).map(t=>{const r=e.socialProviders?.[t];if(!r||!1===r.enabled)return null;r.clientId||s.warn(`Social provider ${t} is missing clientId or clientSecret`);const n=ys[t](r);return n.disableImplicitSignUp=r.disableImplicitSignUp,n}).filter(e=>null!==e),u={appName:e.appName||"Better Auth",socialProviders:l,options:e,tables:d,trustedOrigins:getTrustedOrigins(e),baseURL:o||"",sessionConfig:{updateAge:void 0!==e.session?.updateAge?e.session.updateAge:86400,expiresIn:e.session?.expiresIn||604800,freshAge:void 0===e.session?.freshAge?86400:e.session.freshAge},secret:a,rateLimit:{...e.rateLimit,enabled:e.rateLimit?.enabled??Mi,window:e.rateLimit?.window||10,max:e.rateLimit?.max||100,storage:e.rateLimit?.storage||(e.secondaryStorage?"secondary-storage":"memory")},authCookies:c,logger:s,generateId:({model:t,size:r})=>"function"==typeof e.advanced?.generateId?e.advanced.generateId({model:t,size:r}):"function"==typeof e?.advanced?.database?.generateId?e.advanced.database.generateId({model:t,size:r}):generateId(r),session:null,secondaryStorage:e.secondaryStorage,password:{hash:e.emailAndPassword?.password?.hash||hashPassword,verify:e.emailAndPassword?.password?.verify||verifyPassword,config:{minPasswordLength:e.emailAndPassword?.minPasswordLength||8,maxPasswordLength:e.emailAndPassword?.maxPasswordLength||128},checkPassword:checkPassword},setNewSession(e){this.newSession=e},newSession:null,adapter:t,internalAdapter:createInternalAdapter(t,{options:e,hooks:e.databaseHooks?[e.databaseHooks]:[]}),createAuthCookie:createCookieGetter(e),async runMigrations(){if(!e.database||"updateMany"in e.database)throw new BetterAuthError("Database is not provided or it's an adapter. Migrations are only supported with a database instance.");const{runMigrations:t}=await getMigrations(e);await t()}};let{context:p}=function(e){let t=e.options;const r=t.plugins||[];let i=e;const s=[];for(const e of r)if(e.init){const r=e.init(i);if("object"==typeof r){if(r.options){const{databaseHooks:e,...i}=r.options;e&&s.push(e),t=n(t,i)}r.context&&(i={...i,...r.context})}}return s.push(t.databaseHooks),i.internalAdapter=createInternalAdapter(e.adapter,{options:t,hooks:s.filter(e=>void 0!==e),generateId:e.generateId}),i.options=t,{context:i}}(u);return p};function getTrustedOrigins(e){const t=getBaseURL(e.baseURL,e.basePath);if(!t)return[];const r=[new URL(t).origin];e.trustedOrigins&&Array.isArray(e.trustedOrigins)&&r.push(...e.trustedOrigins);const n=Wi.BETTER_AUTH_TRUSTED_ORIGINS;if(n&&r.push(...n.split(",")),r.filter(e=>!e).length)throw new BetterAuthError("A provided trusted origin is invalid, make sure your trusted origins list is properly defined.");return r}const betterAuth=e=>{const t=init(e),{api:r}=getEndpoints(t,e),n=e.plugins?.reduce((e,t)=>t.$ERROR_CODES?{...e,...t.$ERROR_CODES}:e,{});return{handler:async r=>{const n=await t,i=n.options.basePath||"/api/auth";if(!n.options.baseURL){const e=getBaseURL(void 0,i,r);if(!e)throw new BetterAuthError("Could not get base URL from request. Please provide a valid base URL.");n.baseURL=e,n.options.baseURL=getOrigin(n.baseURL)||void 0}n.trustedOrigins=[...e.trustedOrigins?Array.isArray(e.trustedOrigins)?e.trustedOrigins:await e.trustedOrigins(r):[],n.options.baseURL];const{handler:s}=((e,t)=>{const{api:r,middlewares:n}=getEndpoints(e,t),i=new URL(e.baseURL).pathname;return createRouter(r,{routerContext:e,openapi:{disabled:!0},basePath:i,routerMiddleware:[{path:"/**",middleware:as},...n],async onRequest(t){const r=e.options.disabledPaths||[],n=new URL(t.url).pathname.replace(i,"");if(r.includes(n))return new Response("Not Found",{status:404});for(const r of e.options.plugins||[])if(r.onRequest){const n=await r.onRequest(t,e);if(n&&"response"in n)return n.response}return onRequestRateLimit(t,e)},async onResponse(t){for(const r of e.options.plugins||[])if(r.onResponse){const n=await r.onResponse(t,e);if(n)return n.response}return t},onError(r){if(r instanceof h&&"FOUND"===r.status)return;if(t.onAPIError?.throw)throw r;if(t.onAPIError?.onError)return void t.onAPIError.onError(r,e);const n=t.logger?.level,i="error"===n||"warn"===n||"debug"===n?rs:void 0;if(!0!==t.logger?.disabled){if(r&&"object"==typeof r&&"message"in r&&"string"==typeof r.message&&(r.message.includes("no column")||r.message.includes("column")||r.message.includes("relation")||r.message.includes("table")||r.message.includes("does not exist")))return void e.logger?.error(r.message);r instanceof h?("INTERNAL_SERVER_ERROR"===r.status&&e.logger.error(r.status,r),i?.error(r.message)):e.logger?.error(r&&"object"==typeof r&&"name"in r?r.name:"",r)}}})})(n,e);return s(r)},api:r,options:e,$context:t,$Infer:{},$ERROR_CODES:{...n,...cs}}},Uc=Symbol.for("drizzle:entityKind");function is(e,t){if(!e||"object"!=typeof e)return!1;if(e instanceof t)return!0;if(!Object.prototype.hasOwnProperty.call(t,Uc))throw new Error(`Class "${t.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let r=Object.getPrototypeOf(e).constructor;if(r)for(;r;){if(Uc in r&&r[Uc]===t[Uc])return!0;r=Object.getPrototypeOf(r)}return!1}class Column{constructor(e,t){this.table=e,this.config=t,this.name=t.name,this.keyAsName=t.keyAsName,this.notNull=t.notNull,this.default=t.default,this.defaultFn=t.defaultFn,this.onUpdateFn=t.onUpdateFn,this.hasDefault=t.hasDefault,this.primary=t.primaryKey,this.isUnique=t.isUnique,this.uniqueName=t.uniqueName,this.uniqueType=t.uniqueType,this.dataType=t.dataType,this.columnType=t.columnType,this.generated=t.generated,this.generatedIdentity=t.generatedIdentity}static[Uc]="Column";name;keyAsName;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;generated=void 0;generatedIdentity=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}shouldDisableInsert(){return void 0!==this.config.generated&&"byDefault"!==this.config.generated.type}}class ColumnBuilder{static[Uc]="ColumnBuilder";config;constructor(e,t,r){this.config={name:e,keyAsName:""===e,notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:t,columnType:r,generated:void 0}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(e){return this.config.onUpdateFn=e,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}setName(e){""===this.config.name&&(this.config.name=e)}}const Lc=Symbol.for("drizzle:Name");class ForeignKeyBuilder{static[Uc]="PgForeignKeyBuilder";reference;_onUpdate="no action";_onDelete="no action";constructor(e,t){this.reference=()=>{const{name:t,columns:r,foreignColumns:n}=e();return{name:t,columns:r,foreignTable:n[0].table,foreignColumns:n}},t&&(this._onUpdate=t.onUpdate,this._onDelete=t.onDelete)}onUpdate(e){return this._onUpdate=void 0===e?"no action":e,this}onDelete(e){return this._onDelete=void 0===e?"no action":e,this}build(e){return new ForeignKey(e,this)}}class ForeignKey{constructor(e,t){this.table=e,this.reference=t.reference,this.onUpdate=t._onUpdate,this.onDelete=t._onDelete}static[Uc]="PgForeignKey";reference;onUpdate;onDelete;getName(){const{name:e,columns:t,foreignColumns:r}=this.reference(),n=t.map(e=>e.name),i=r.map(e=>e.name),s=[this.table[Lc],...n,r[0].table[Lc],...i];return e??`${s.join("_")}_fk`}}function parsePgArrayValue(e,t,r){for(let n=t;n<e.length;n++){const i=e[n];if("\\"!==i){if('"'===i)return[e.slice(t,n).replace(/\\/g,""),n+1];if(!r&&(","===i||"}"===i))return[e.slice(t,n).replace(/\\/g,""),n]}else n++}return[e.slice(t).replace(/\\/g,""),e.length]}function parsePgNestedArray(e,t=0){const r=[];let n=t,i=!1;for(;n<e.length;){const s=e[n];if(","===s){(i||n===t)&&r.push(""),i=!0,n++;continue}if(i=!1,"\\"===s){n+=2;continue}if('"'===s){const[t,i]=parsePgArrayValue(e,n+1,!0);r.push(t),n=i;continue}if("}"===s)return[r,n+1];if("{"===s){const[t,i]=parsePgNestedArray(e,n+1);r.push(t),n=i;continue}const[o,a]=parsePgArrayValue(e,n,!1);r.push(o),n=a}return[r,n]}function parsePgArray(e){const[t]=parsePgNestedArray(e,1);return t}function makePgArray(e){return`{${e.map(e=>Array.isArray(e)?makePgArray(e):"string"==typeof e?`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`:`${e}`).join(",")}}`}class PgColumnBuilder extends ColumnBuilder{foreignKeyConfigs=[];static[Uc]="PgColumnBuilder";array(e){return new PgArrayBuilder(this.config.name,this,e)}references(e,t={}){return this.foreignKeyConfigs.push({ref:e,actions:t}),this}unique(e,t){return this.config.isUnique=!0,this.config.uniqueName=e,this.config.uniqueType=t?.nulls,this}generatedAlwaysAs(e){return this.config.generated={as:e,type:"always",mode:"stored"},this}buildForeignKeys(e,t){return this.foreignKeyConfigs.map(({ref:r,actions:n})=>function(e,...t){return e(...t)}((r,n)=>{const i=new ForeignKeyBuilder(()=>{const t=r();return{columns:[e],foreignColumns:[t]}});return n.onUpdate&&i.onUpdate(n.onUpdate),n.onDelete&&i.onDelete(n.onDelete),i.build(t)},r,n))}buildExtraConfigColumn(e){return new ExtraConfigColumn(e,this.config)}}class PgColumn extends Column{constructor(e,t){t.uniqueName||(t.uniqueName=function(e,t){return`${e[Lc]}_${t.join("_")}_unique`}(e,[t.name])),super(e,t),this.table=e}static[Uc]="PgColumn"}class ExtraConfigColumn extends PgColumn{static[Uc]="ExtraConfigColumn";getSQLType(){return this.getSQLType()}indexConfig={order:this.config.order??"asc",nulls:this.config.nulls??"last",opClass:this.config.opClass};defaultConfig={order:"asc",nulls:"last",opClass:void 0};asc(){return this.indexConfig.order="asc",this}desc(){return this.indexConfig.order="desc",this}nullsFirst(){return this.indexConfig.nulls="first",this}nullsLast(){return this.indexConfig.nulls="last",this}op(e){return this.indexConfig.opClass=e,this}}class PgArrayBuilder extends PgColumnBuilder{static[Uc]="PgArrayBuilder";constructor(e,t,r){super(e,"array","PgArray"),this.config.baseBuilder=t,this.config.size=r}build(e){const t=this.config.baseBuilder.build(e);return new PgArray(e,this.config,t)}}class PgArray extends PgColumn{constructor(e,t,r,n){super(e,t),this.baseColumn=r,this.range=n,this.size=t.size}size;static[Uc]="PgArray";getSQLType(){return`${this.baseColumn.getSQLType()}[${"number"==typeof this.size?this.size:""}]`}mapFromDriverValue(e){return"string"==typeof e&&(e=parsePgArray(e)),e.map(e=>this.baseColumn.mapFromDriverValue(e))}mapToDriverValue(e,t=!1){const r=e.map(e=>null===e?null:is(this.baseColumn,PgArray)?this.baseColumn.mapToDriverValue(e,!0):this.baseColumn.mapToDriverValue(e));return t?r:makePgArray(r)}}const zc=Symbol.for("drizzle:isPgEnum");class Subquery{static[Uc]="Subquery";constructor(e,t,r,n=!1,i=[]){this._={brand:"Subquery",sql:e,selectedFields:t,alias:r,isWith:n,usedTables:i}}}class WithSubquery extends Subquery{static[Uc]="WithSubquery"}const Dc={startActiveSpan:(e,t)=>t()},qc=Symbol.for("drizzle:ViewBaseConfig"),Wc=Symbol.for("drizzle:Schema"),jc=Symbol.for("drizzle:Columns"),Mc=Symbol.for("drizzle:ExtraConfigColumns"),Qc=Symbol.for("drizzle:OriginalName"),Vc=Symbol.for("drizzle:BaseName"),Fc=Symbol.for("drizzle:IsAlias"),Jc=Symbol.for("drizzle:ExtraConfigBuilder"),Kc=Symbol.for("drizzle:IsDrizzleTable");class Table{static[Uc]="Table";static Symbol={Name:Lc,Schema:Wc,OriginalName:Qc,Columns:jc,ExtraConfigColumns:Mc,BaseName:Vc,IsAlias:Fc,ExtraConfigBuilder:Jc};[Lc];[Qc];[Wc];[jc];[Mc];[Vc];[Fc]=!1;[Kc]=!0;[Jc]=void 0;constructor(e,t,r){this[Lc]=this[Qc]=e,this[Wc]=t,this[Vc]=r}}function getTableName(e){return e[Lc]}function getTableUniqueName(e){return`${e[Wc]??"public"}.${e[Lc]}`}function isSQLWrapper(e){return null!=e&&"function"==typeof e.getSQL}class StringChunk{static[Uc]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new SQL([this])}}class SQL{constructor(e){this.queryChunks=e;for(const t of e)if(is(t,Table)){const e=t[Table.Symbol.Schema];this.usedTables.push(void 0===e?t[Table.Symbol.Name]:e+"."+t[Table.Symbol.Name])}}static[Uc]="SQL";decoder=Hc;shouldInlineParams=!1;usedTables=[];append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return Dc.startActiveSpan("drizzle.buildSQL",t=>{const r=this.buildQueryFromSourceParams(this.queryChunks,e);return t?.setAttributes({"drizzle.query.text":r.sql,"drizzle.query.params":JSON.stringify(r.params)}),r})}buildQueryFromSourceParams(e,t){const r=Object.assign({},t,{inlineParams:t.inlineParams||this.shouldInlineParams,paramStartIndex:t.paramStartIndex||{value:0}}),{casing:n,escapeName:i,escapeParam:s,prepareTyping:o,inlineParams:a,paramStartIndex:c}=r;return function(e){const t={sql:"",params:[]};for(const r of e)t.sql+=r.sql,t.params.push(...r.params),r.typings?.length&&(t.typings||(t.typings=[]),t.typings.push(...r.typings));return t}(e.map(e=>{if(is(e,StringChunk))return{sql:e.value.join(""),params:[]};if(is(e,Name))return{sql:i(e.value),params:[]};if(void 0===e)return{sql:"",params:[]};if(Array.isArray(e)){const t=[new StringChunk("(")];for(const[r,n]of e.entries())t.push(n),r<e.length-1&&t.push(new StringChunk(", "));return t.push(new StringChunk(")")),this.buildQueryFromSourceParams(t,r)}if(is(e,SQL))return this.buildQueryFromSourceParams(e.queryChunks,{...r,inlineParams:a||e.shouldInlineParams});if(is(e,Table)){const t=e[Table.Symbol.Schema],r=e[Table.Symbol.Name];return{sql:void 0===t||e[Fc]?i(r):i(t)+"."+i(r),params:[]}}if(is(e,Column)){const r=n.getColumnCasing(e);if("indexes"===t.invokeSource)return{sql:i(r),params:[]};const s=e.table[Table.Symbol.Schema];return{sql:e.table[Fc]||void 0===s?i(e.table[Table.Symbol.Name])+"."+i(r):i(s)+"."+i(e.table[Table.Symbol.Name])+"."+i(r),params:[]}}if(is(e,View)){const t=e[qc].schema,r=e[qc].name;return{sql:void 0===t||e[qc].isAlias?i(r):i(t)+"."+i(r),params:[]}}if(is(e,Param)){if(is(e.value,Placeholder))return{sql:s(c.value++,e),params:[e],typings:["none"]};const t=null===e.value?null:e.encoder.mapToDriverValue(e.value);if(is(t,SQL))return this.buildQueryFromSourceParams([t],r);if(a)return{sql:this.mapInlineParam(t,r),params:[]};let n=["none"];return o&&(n=[o(e.encoder)]),{sql:s(c.value++,t),params:[t],typings:n}}return is(e,Placeholder)?{sql:s(c.value++,e),params:[e],typings:["none"]}:is(e,SQL.Aliased)&&void 0!==e.fieldAlias?{sql:i(e.fieldAlias),params:[]}:is(e,Subquery)?e._.isWith?{sql:i(e._.alias),params:[]}:this.buildQueryFromSourceParams([new StringChunk("("),e._.sql,new StringChunk(") "),new Name(e._.alias)],r):(d=e)&&"function"==typeof d&&zc in d&&!0===d[zc]?e.schema?{sql:i(e.schema)+"."+i(e.enumName),params:[]}:{sql:i(e.enumName),params:[]}:isSQLWrapper(e)?e.shouldOmitSQLParens?.()?this.buildQueryFromSourceParams([e.getSQL()],r):this.buildQueryFromSourceParams([new StringChunk("("),e.getSQL(),new StringChunk(")")],r):a?{sql:this.mapInlineParam(e,r),params:[]}:{sql:s(c.value++,e),params:[e],typings:["none"]};var d}))}mapInlineParam(e,{escapeString:t}){if(null===e)return"null";if("number"==typeof e||"boolean"==typeof e)return e.toString();if("string"==typeof e)return t(e);if("object"==typeof e){const r=e.toString();return t("[object Object]"===r?JSON.stringify(e):r)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return void 0===e?this:new SQL.Aliased(this,e)}mapWith(e){return this.decoder="function"==typeof e?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}if(e){return e?this:void 0}}class Name{constructor(e){this.value=e}static[Uc]="Name";brand;getSQL(){return new SQL([this])}}const Hc={mapFromDriverValue:e=>e},Zc={mapToDriverValue:e=>e};class Param{constructor(e,t=Zc){this.value=e,this.encoder=t}static[Uc]="Param";brand;getSQL(){return new SQL([this])}}function sql(e,...t){const r=[];(t.length>0||e.length>0&&""!==e[0])&&r.push(new StringChunk(e[0]));for(const[n,i]of t.entries())r.push(i,new StringChunk(e[n+1]));return new SQL(r)}var Gc;(Gc=sql||(sql={})).empty=function(){return new SQL([])},Gc.fromList=function(e){return new SQL(e)},Gc.raw=function(e){return new SQL([new StringChunk(e)])},Gc.join=function(e,t){const r=[];for(const[n,i]of e.entries())n>0&&void 0!==t&&r.push(t),r.push(i);return new SQL(r)},Gc.identifier=function(e){return new Name(e)},Gc.placeholder=function(e){return new Placeholder(e)},Gc.param=function(e,t){return new Param(e,t)},(e=>{class Aliased{constructor(e,t){this.sql=e,this.fieldAlias=t}static[Uc]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new Aliased(this.sql,this.fieldAlias)}}e.Aliased=Aliased})(SQL||(SQL={}));class Placeholder{constructor(e){this.name=e}static[Uc]="Placeholder";getSQL(){return new SQL([this])}}function fillPlaceholders(e,t){return e.map(e=>{if(is(e,Placeholder)){if(!(e.name in t))throw new Error(`No value for placeholder "${e.name}" was provided`);return t[e.name]}if(is(e,Param)&&is(e.value,Placeholder)){if(!(e.value.name in t))throw new Error(`No value for placeholder "${e.value.name}" was provided`);return e.encoder.mapToDriverValue(t[e.value.name])}return e})}const Yc=Symbol.for("drizzle:IsDrizzleView");class View{static[Uc]="View";[qc];[Yc]=!0;constructor({name:e,schema:t,selectedFields:r,query:n}){this[qc]={name:e,originalName:e,schema:t,selectedFields:r,query:n,isExisting:!n,isAlias:!1}}getSQL(){return new SQL([this])}}Column.prototype.getSQL=function(){return new SQL([this])},Table.prototype.getSQL=function(){return new SQL([this])},Subquery.prototype.getSQL=function(){return new SQL([this])};class ColumnAliasProxyHandler{constructor(e){this.table=e}static[Uc]="ColumnAliasProxyHandler";get(e,t){return"table"===t?this.table:e[t]}}class TableAliasProxyHandler{constructor(e,t){this.alias=e,this.replaceOriginalName=t}static[Uc]="TableAliasProxyHandler";get(e,t){if(t===Table.Symbol.IsAlias)return!0;if(t===Table.Symbol.Name)return this.alias;if(this.replaceOriginalName&&t===Table.Symbol.OriginalName)return this.alias;if(t===qc)return{...e[qc],name:this.alias,isAlias:!0};if(t===Table.Symbol.Columns){const t=e[Table.Symbol.Columns];if(!t)return t;const r={};return Object.keys(t).map(n=>{r[n]=new Proxy(t[n],new ColumnAliasProxyHandler(new Proxy(e,this)))}),r}const r=e[t];return is(r,Column)?new Proxy(r,new ColumnAliasProxyHandler(new Proxy(e,this))):r}}function aliasedTable(e,t){return new Proxy(e,new TableAliasProxyHandler(t,!1))}function aliasedTableColumn(e,t){return new Proxy(e,new ColumnAliasProxyHandler(new Proxy(e.table,new TableAliasProxyHandler(t,!1))))}function mapColumnsInAliasedSQLToAlias(e,t){return new SQL.Aliased(mapColumnsInSQLToAlias(e.sql,t),e.fieldAlias)}function mapColumnsInSQLToAlias(e,t){return sql.join(e.queryChunks.map(e=>is(e,Column)?aliasedTableColumn(e,t):is(e,SQL)?mapColumnsInSQLToAlias(e,t):is(e,SQL.Aliased)?mapColumnsInAliasedSQLToAlias(e,t):e))}class DrizzleError extends Error{static[Uc]="DrizzleError";constructor({message:e,cause:t}){super(e),this.name="DrizzleError",this.cause=t}}class TransactionRollbackError extends DrizzleError{static[Uc]="TransactionRollbackError";constructor(){super({message:"Rollback"})}}class ConsoleLogWriter{static[Uc]="ConsoleLogWriter";write(e){console.log(e)}}class DefaultLogger{static[Uc]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new ConsoleLogWriter}logQuery(e,t){const r=t.map(e=>{try{return JSON.stringify(e)}catch{return String(e)}}),n=r.length?` -- params: [${r.join(", ")}]`:"";this.writer.write(`Query: ${e}${n}`)}}class NoopLogger{static[Uc]="NoopLogger";logQuery(){}}class QueryPromise{static[Uc]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(t=>(e?.(),t),t=>{throw e?.(),t})}then(e,t){return this.execute().then(e,t)}}function orderSelectedFields(e,t){return Object.entries(e).reduce((e,[r,n])=>{if("string"!=typeof r)return e;const i=t?[...t,r]:[r];return is(n,Column)||is(n,SQL)||is(n,SQL.Aliased)?e.push({path:i,field:n}):is(n,Table)?e.push(...orderSelectedFields(n[Table.Symbol.Columns],i)):e.push(...orderSelectedFields(n,i)),e},[])}function haveSameKeys(e,t){const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const[e,t]of r.entries())if(t!==n[e])return!1;return!0}function mapUpdateSet(e,t){const r=Object.entries(t).filter(([,e])=>void 0!==e).map(([t,r])=>is(r,SQL)||is(r,Column)?[t,r]:[t,new Param(r,e[Table.Symbol.Columns][t])]);if(0===r.length)throw new Error("No values to set");return Object.fromEntries(r)}function getTableLikeName(e){return is(e,Subquery)?e._.alias:is(e,View)?e[qc].name:is(e,SQL)?void 0:e[Table.Symbol.IsAlias]?e[Table.Symbol.Name]:e[Table.Symbol.BaseName]}function getColumnNameAndConfig(e,t){return{name:"string"==typeof e&&e.length>0?e:"",config:"object"==typeof e?e:t}}class PgIntColumnBaseBuilder extends PgColumnBuilder{static[Uc]="PgIntColumnBaseBuilder";generatedAlwaysAsIdentity(e){if(e){const{name:t,...r}=e;this.config.generatedIdentity={type:"always",sequenceName:t,sequenceOptions:r}}else this.config.generatedIdentity={type:"always"};return this.config.hasDefault=!0,this.config.notNull=!0,this}generatedByDefaultAsIdentity(e){if(e){const{name:t,...r}=e;this.config.generatedIdentity={type:"byDefault",sequenceName:t,sequenceOptions:r}}else this.config.generatedIdentity={type:"byDefault"};return this.config.hasDefault=!0,this.config.notNull=!0,this}}class PgBigInt53Builder extends PgIntColumnBaseBuilder{static[Uc]="PgBigInt53Builder";constructor(e){super(e,"number","PgBigInt53")}build(e){return new PgBigInt53(e,this.config)}}class PgBigInt53 extends PgColumn{static[Uc]="PgBigInt53";getSQLType(){return"bigint"}mapFromDriverValue(e){return"number"==typeof e?e:Number(e)}}class PgBigInt64Builder extends PgIntColumnBaseBuilder{static[Uc]="PgBigInt64Builder";constructor(e){super(e,"bigint","PgBigInt64")}build(e){return new PgBigInt64(e,this.config)}}class PgBigInt64 extends PgColumn{static[Uc]="PgBigInt64";getSQLType(){return"bigint"}mapFromDriverValue(e){return BigInt(e)}}function bigint(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return"number"===n.mode?new PgBigInt53Builder(r):new PgBigInt64Builder(r)}class PgBigSerial53Builder extends PgColumnBuilder{static[Uc]="PgBigSerial53Builder";constructor(e){super(e,"number","PgBigSerial53"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new PgBigSerial53(e,this.config)}}class PgBigSerial53 extends PgColumn{static[Uc]="PgBigSerial53";getSQLType(){return"bigserial"}mapFromDriverValue(e){return"number"==typeof e?e:Number(e)}}class PgBigSerial64Builder extends PgColumnBuilder{static[Uc]="PgBigSerial64Builder";constructor(e){super(e,"bigint","PgBigSerial64"),this.config.hasDefault=!0}build(e){return new PgBigSerial64(e,this.config)}}class PgBigSerial64 extends PgColumn{static[Uc]="PgBigSerial64";getSQLType(){return"bigserial"}mapFromDriverValue(e){return BigInt(e)}}function bigserial(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return"number"===n.mode?new PgBigSerial53Builder(r):new PgBigSerial64Builder(r)}class PgBooleanBuilder extends PgColumnBuilder{static[Uc]="PgBooleanBuilder";constructor(e){super(e,"boolean","PgBoolean")}build(e){return new PgBoolean(e,this.config)}}class PgBoolean extends PgColumn{static[Uc]="PgBoolean";getSQLType(){return"boolean"}}function boolean(e){return new PgBooleanBuilder(e??"")}class PgCharBuilder extends PgColumnBuilder{static[Uc]="PgCharBuilder";constructor(e,t){super(e,"string","PgChar"),this.config.length=t.length,this.config.enumValues=t.enum}build(e){return new PgChar(e,this.config)}}class PgChar extends PgColumn{static[Uc]="PgChar";length=this.config.length;enumValues=this.config.enumValues;getSQLType(){return void 0===this.length?"char":`char(${this.length})`}}function char(e,t={}){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgCharBuilder(r,n)}class PgCidrBuilder extends PgColumnBuilder{static[Uc]="PgCidrBuilder";constructor(e){super(e,"string","PgCidr")}build(e){return new PgCidr(e,this.config)}}class PgCidr extends PgColumn{static[Uc]="PgCidr";getSQLType(){return"cidr"}}function cidr(e){return new PgCidrBuilder(e??"")}class PgCustomColumnBuilder extends PgColumnBuilder{static[Uc]="PgCustomColumnBuilder";constructor(e,t,r){super(e,"custom","PgCustomColumn"),this.config.fieldConfig=t,this.config.customTypeParams=r}build(e){return new PgCustomColumn(e,this.config)}}class PgCustomColumn extends PgColumn{static[Uc]="PgCustomColumn";sqlName;mapTo;mapFrom;constructor(e,t){super(e,t),this.sqlName=t.customTypeParams.dataType(t.fieldConfig),this.mapTo=t.customTypeParams.toDriver,this.mapFrom=t.customTypeParams.fromDriver}getSQLType(){return this.sqlName}mapFromDriverValue(e){return"function"==typeof this.mapFrom?this.mapFrom(e):e}mapToDriverValue(e){return"function"==typeof this.mapTo?this.mapTo(e):e}}function customType(e){return(t,r)=>{const{name:n,config:i}=getColumnNameAndConfig(t,r);return new PgCustomColumnBuilder(n,i,e)}}class PgDateColumnBaseBuilder extends PgColumnBuilder{static[Uc]="PgDateColumnBaseBuilder";defaultNow(){return this.default(sql`now()`)}}class PgDateBuilder extends PgDateColumnBaseBuilder{static[Uc]="PgDateBuilder";constructor(e){super(e,"date","PgDate")}build(e){return new PgDate(e,this.config)}}class PgDate extends PgColumn{static[Uc]="PgDate";getSQLType(){return"date"}mapFromDriverValue(e){return new Date(e)}mapToDriverValue(e){return e.toISOString()}}class PgDateStringBuilder extends PgDateColumnBaseBuilder{static[Uc]="PgDateStringBuilder";constructor(e){super(e,"string","PgDateString")}build(e){return new PgDateString(e,this.config)}}class PgDateString extends PgColumn{static[Uc]="PgDateString";getSQLType(){return"date"}}function date(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return"date"===n?.mode?new PgDateBuilder(r):new PgDateStringBuilder(r)}class PgDoublePrecisionBuilder extends PgColumnBuilder{static[Uc]="PgDoublePrecisionBuilder";constructor(e){super(e,"number","PgDoublePrecision")}build(e){return new PgDoublePrecision(e,this.config)}}class PgDoublePrecision extends PgColumn{static[Uc]="PgDoublePrecision";getSQLType(){return"double precision"}mapFromDriverValue(e){return"string"==typeof e?Number.parseFloat(e):e}}function doublePrecision(e){return new PgDoublePrecisionBuilder(e??"")}class PgInetBuilder extends PgColumnBuilder{static[Uc]="PgInetBuilder";constructor(e){super(e,"string","PgInet")}build(e){return new PgInet(e,this.config)}}class PgInet extends PgColumn{static[Uc]="PgInet";getSQLType(){return"inet"}}function inet(e){return new PgInetBuilder(e??"")}class PgIntegerBuilder extends PgIntColumnBaseBuilder{static[Uc]="PgIntegerBuilder";constructor(e){super(e,"number","PgInteger")}build(e){return new PgInteger(e,this.config)}}class PgInteger extends PgColumn{static[Uc]="PgInteger";getSQLType(){return"integer"}mapFromDriverValue(e){return"string"==typeof e?Number.parseInt(e):e}}function integer(e){return new PgIntegerBuilder(e??"")}class PgIntervalBuilder extends PgColumnBuilder{static[Uc]="PgIntervalBuilder";constructor(e,t){super(e,"string","PgInterval"),this.config.intervalConfig=t}build(e){return new PgInterval(e,this.config)}}class PgInterval extends PgColumn{static[Uc]="PgInterval";fields=this.config.intervalConfig.fields;precision=this.config.intervalConfig.precision;getSQLType(){return`interval${this.fields?` ${this.fields}`:""}${this.precision?`(${this.precision})`:""}`}}function interval(e,t={}){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgIntervalBuilder(r,n)}class PgJsonBuilder extends PgColumnBuilder{static[Uc]="PgJsonBuilder";constructor(e){super(e,"json","PgJson")}build(e){return new PgJson(e,this.config)}}class PgJson extends PgColumn{static[Uc]="PgJson";constructor(e,t){super(e,t)}getSQLType(){return"json"}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){if("string"==typeof e)try{return JSON.parse(e)}catch{return e}return e}}function json(e){return new PgJsonBuilder(e??"")}class PgJsonbBuilder extends PgColumnBuilder{static[Uc]="PgJsonbBuilder";constructor(e){super(e,"json","PgJsonb")}build(e){return new PgJsonb(e,this.config)}}class PgJsonb extends PgColumn{static[Uc]="PgJsonb";constructor(e,t){super(e,t)}getSQLType(){return"jsonb"}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){if("string"==typeof e)try{return JSON.parse(e)}catch{return e}return e}}function jsonb(e){return new PgJsonbBuilder(e??"")}class PgLineBuilder extends PgColumnBuilder{static[Uc]="PgLineBuilder";constructor(e){super(e,"array","PgLine")}build(e){return new PgLineTuple(e,this.config)}}class PgLineTuple extends PgColumn{static[Uc]="PgLine";getSQLType(){return"line"}mapFromDriverValue(e){const[t,r,n]=e.slice(1,-1).split(",");return[Number.parseFloat(t),Number.parseFloat(r),Number.parseFloat(n)]}mapToDriverValue(e){return`{${e[0]},${e[1]},${e[2]}}`}}class PgLineABCBuilder extends PgColumnBuilder{static[Uc]="PgLineABCBuilder";constructor(e){super(e,"json","PgLineABC")}build(e){return new PgLineABC(e,this.config)}}class PgLineABC extends PgColumn{static[Uc]="PgLineABC";getSQLType(){return"line"}mapFromDriverValue(e){const[t,r,n]=e.slice(1,-1).split(",");return{a:Number.parseFloat(t),b:Number.parseFloat(r),c:Number.parseFloat(n)}}mapToDriverValue(e){return`{${e.a},${e.b},${e.c}}`}}function line(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return n?.mode&&"tuple"!==n.mode?new PgLineABCBuilder(r):new PgLineBuilder(r)}class PgMacaddrBuilder extends PgColumnBuilder{static[Uc]="PgMacaddrBuilder";constructor(e){super(e,"string","PgMacaddr")}build(e){return new PgMacaddr(e,this.config)}}class PgMacaddr extends PgColumn{static[Uc]="PgMacaddr";getSQLType(){return"macaddr"}}function macaddr(e){return new PgMacaddrBuilder(e??"")}class PgMacaddr8Builder extends PgColumnBuilder{static[Uc]="PgMacaddr8Builder";constructor(e){super(e,"string","PgMacaddr8")}build(e){return new PgMacaddr8(e,this.config)}}class PgMacaddr8 extends PgColumn{static[Uc]="PgMacaddr8";getSQLType(){return"macaddr8"}}function macaddr8(e){return new PgMacaddr8Builder(e??"")}class PgNumericBuilder extends PgColumnBuilder{static[Uc]="PgNumericBuilder";constructor(e,t,r){super(e,"string","PgNumeric"),this.config.precision=t,this.config.scale=r}build(e){return new PgNumeric(e,this.config)}}class PgNumeric extends PgColumn{static[Uc]="PgNumeric";precision;scale;constructor(e,t){super(e,t),this.precision=t.precision,this.scale=t.scale}mapFromDriverValue(e){return"string"==typeof e?e:String(e)}getSQLType(){return void 0!==this.precision&&void 0!==this.scale?`numeric(${this.precision}, ${this.scale})`:void 0===this.precision?"numeric":`numeric(${this.precision})`}}class PgNumericNumberBuilder extends PgColumnBuilder{static[Uc]="PgNumericNumberBuilder";constructor(e,t,r){super(e,"number","PgNumericNumber"),this.config.precision=t,this.config.scale=r}build(e){return new PgNumericNumber(e,this.config)}}class PgNumericNumber extends PgColumn{static[Uc]="PgNumericNumber";precision;scale;constructor(e,t){super(e,t),this.precision=t.precision,this.scale=t.scale}mapFromDriverValue(e){return"number"==typeof e?e:Number(e)}mapToDriverValue=String;getSQLType(){return void 0!==this.precision&&void 0!==this.scale?`numeric(${this.precision}, ${this.scale})`:void 0===this.precision?"numeric":`numeric(${this.precision})`}}class PgNumericBigIntBuilder extends PgColumnBuilder{static[Uc]="PgNumericBigIntBuilder";constructor(e,t,r){super(e,"bigint","PgNumericBigInt"),this.config.precision=t,this.config.scale=r}build(e){return new PgNumericBigInt(e,this.config)}}class PgNumericBigInt extends PgColumn{static[Uc]="PgNumericBigInt";precision;scale;constructor(e,t){super(e,t),this.precision=t.precision,this.scale=t.scale}mapFromDriverValue=BigInt;mapToDriverValue=String;getSQLType(){return void 0!==this.precision&&void 0!==this.scale?`numeric(${this.precision}, ${this.scale})`:void 0===this.precision?"numeric":`numeric(${this.precision})`}}function numeric(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t),i=n?.mode;return"number"===i?new PgNumericNumberBuilder(r,n?.precision,n?.scale):"bigint"===i?new PgNumericBigIntBuilder(r,n?.precision,n?.scale):new PgNumericBuilder(r,n?.precision,n?.scale)}class PgPointTupleBuilder extends PgColumnBuilder{static[Uc]="PgPointTupleBuilder";constructor(e){super(e,"array","PgPointTuple")}build(e){return new PgPointTuple(e,this.config)}}class PgPointTuple extends PgColumn{static[Uc]="PgPointTuple";getSQLType(){return"point"}mapFromDriverValue(e){if("string"==typeof e){const[t,r]=e.slice(1,-1).split(",");return[Number.parseFloat(t),Number.parseFloat(r)]}return[e.x,e.y]}mapToDriverValue(e){return`(${e[0]},${e[1]})`}}class PgPointObjectBuilder extends PgColumnBuilder{static[Uc]="PgPointObjectBuilder";constructor(e){super(e,"json","PgPointObject")}build(e){return new PgPointObject(e,this.config)}}class PgPointObject extends PgColumn{static[Uc]="PgPointObject";getSQLType(){return"point"}mapFromDriverValue(e){if("string"==typeof e){const[t,r]=e.slice(1,-1).split(",");return{x:Number.parseFloat(t),y:Number.parseFloat(r)}}return e}mapToDriverValue(e){return`(${e.x},${e.y})`}}function point(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return n?.mode&&"tuple"!==n.mode?new PgPointObjectBuilder(r):new PgPointTupleBuilder(r)}function bytesToFloat64(e,t){const r=new ArrayBuffer(8),n=new DataView(r);for(let r=0;r<8;r++)n.setUint8(r,e[t+r]);return n.getFloat64(0,!0)}function parseEWKB(e){const t=function(e){const t=[];for(let r=0;r<e.length;r+=2)t.push(Number.parseInt(e.slice(r,r+2),16));return new Uint8Array(t)}(e);let r=0;const n=t[r];r+=1;const i=new DataView(t.buffer),s=i.getUint32(r,1===n);if(r+=4,536870912&s&&(i.getUint32(r,1===n),r+=4),1==(65535&s)){const e=bytesToFloat64(t,r);r+=8;const n=bytesToFloat64(t,r);return r+=8,[e,n]}throw new Error("Unsupported geometry type")}class PgGeometryBuilder extends PgColumnBuilder{static[Uc]="PgGeometryBuilder";constructor(e){super(e,"array","PgGeometry")}build(e){return new PgGeometry(e,this.config)}}class PgGeometry extends PgColumn{static[Uc]="PgGeometry";getSQLType(){return"geometry(point)"}mapFromDriverValue(e){return parseEWKB(e)}mapToDriverValue(e){return`point(${e[0]} ${e[1]})`}}class PgGeometryObjectBuilder extends PgColumnBuilder{static[Uc]="PgGeometryObjectBuilder";constructor(e){super(e,"json","PgGeometryObject")}build(e){return new PgGeometryObject(e,this.config)}}class PgGeometryObject extends PgColumn{static[Uc]="PgGeometryObject";getSQLType(){return"geometry(point)"}mapFromDriverValue(e){const t=parseEWKB(e);return{x:t[0],y:t[1]}}mapToDriverValue(e){return`point(${e.x} ${e.y})`}}function geometry(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return n?.mode&&"tuple"!==n.mode?new PgGeometryObjectBuilder(r):new PgGeometryBuilder(r)}class PgRealBuilder extends PgColumnBuilder{static[Uc]="PgRealBuilder";constructor(e,t){super(e,"number","PgReal"),this.config.length=t}build(e){return new PgReal(e,this.config)}}class PgReal extends PgColumn{static[Uc]="PgReal";constructor(e,t){super(e,t)}getSQLType(){return"real"}mapFromDriverValue=e=>"string"==typeof e?Number.parseFloat(e):e}function real(e){return new PgRealBuilder(e??"")}class PgSerialBuilder extends PgColumnBuilder{static[Uc]="PgSerialBuilder";constructor(e){super(e,"number","PgSerial"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new PgSerial(e,this.config)}}class PgSerial extends PgColumn{static[Uc]="PgSerial";getSQLType(){return"serial"}}function serial(e){return new PgSerialBuilder(e??"")}class PgSmallIntBuilder extends PgIntColumnBaseBuilder{static[Uc]="PgSmallIntBuilder";constructor(e){super(e,"number","PgSmallInt")}build(e){return new PgSmallInt(e,this.config)}}class PgSmallInt extends PgColumn{static[Uc]="PgSmallInt";getSQLType(){return"smallint"}mapFromDriverValue=e=>"string"==typeof e?Number(e):e}function smallint(e){return new PgSmallIntBuilder(e??"")}class PgSmallSerialBuilder extends PgColumnBuilder{static[Uc]="PgSmallSerialBuilder";constructor(e){super(e,"number","PgSmallSerial"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new PgSmallSerial(e,this.config)}}class PgSmallSerial extends PgColumn{static[Uc]="PgSmallSerial";getSQLType(){return"smallserial"}}function smallserial(e){return new PgSmallSerialBuilder(e??"")}class PgTextBuilder extends PgColumnBuilder{static[Uc]="PgTextBuilder";constructor(e,t){super(e,"string","PgText"),this.config.enumValues=t.enum}build(e){return new PgText(e,this.config)}}class PgText extends PgColumn{static[Uc]="PgText";enumValues=this.config.enumValues;getSQLType(){return"text"}}function text(e,t={}){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgTextBuilder(r,n)}class PgTimeBuilder extends PgDateColumnBaseBuilder{constructor(e,t,r){super(e,"string","PgTime"),this.withTimezone=t,this.precision=r,this.config.withTimezone=t,this.config.precision=r}static[Uc]="PgTimeBuilder";build(e){return new PgTime(e,this.config)}}class PgTime extends PgColumn{static[Uc]="PgTime";withTimezone;precision;constructor(e,t){super(e,t),this.withTimezone=t.withTimezone,this.precision=t.precision}getSQLType(){return`time${void 0===this.precision?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}}function time(e,t={}){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgTimeBuilder(r,n.withTimezone??!1,n.precision)}class PgTimestampBuilder extends PgDateColumnBaseBuilder{static[Uc]="PgTimestampBuilder";constructor(e,t,r){super(e,"date","PgTimestamp"),this.config.withTimezone=t,this.config.precision=r}build(e){return new PgTimestamp(e,this.config)}}class PgTimestamp extends PgColumn{static[Uc]="PgTimestamp";withTimezone;precision;constructor(e,t){super(e,t),this.withTimezone=t.withTimezone,this.precision=t.precision}getSQLType(){return`timestamp${void 0===this.precision?"":` (${this.precision})`}${this.withTimezone?" with time zone":""}`}mapFromDriverValue=e=>new Date(this.withTimezone?e:e+"+0000");mapToDriverValue=e=>e.toISOString()}class PgTimestampStringBuilder extends PgDateColumnBaseBuilder{static[Uc]="PgTimestampStringBuilder";constructor(e,t,r){super(e,"string","PgTimestampString"),this.config.withTimezone=t,this.config.precision=r}build(e){return new PgTimestampString(e,this.config)}}class PgTimestampString extends PgColumn{static[Uc]="PgTimestampString";withTimezone;precision;constructor(e,t){super(e,t),this.withTimezone=t.withTimezone,this.precision=t.precision}getSQLType(){return`timestamp${void 0===this.precision?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}}function timestamp(e,t={}){const{name:r,config:n}=getColumnNameAndConfig(e,t);return"string"===n?.mode?new PgTimestampStringBuilder(r,n.withTimezone??!1,n.precision):new PgTimestampBuilder(r,n?.withTimezone??!1,n?.precision)}class PgUUIDBuilder extends PgColumnBuilder{static[Uc]="PgUUIDBuilder";constructor(e){super(e,"string","PgUUID")}defaultRandom(){return this.default(sql`gen_random_uuid()`)}build(e){return new PgUUID(e,this.config)}}class PgUUID extends PgColumn{static[Uc]="PgUUID";getSQLType(){return"uuid"}}function uuid(e){return new PgUUIDBuilder(e??"")}class PgVarcharBuilder extends PgColumnBuilder{static[Uc]="PgVarcharBuilder";constructor(e,t){super(e,"string","PgVarchar"),this.config.length=t.length,this.config.enumValues=t.enum}build(e){return new PgVarchar(e,this.config)}}class PgVarchar extends PgColumn{static[Uc]="PgVarchar";length=this.config.length;enumValues=this.config.enumValues;getSQLType(){return void 0===this.length?"varchar":`varchar(${this.length})`}}function varchar(e,t={}){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgVarcharBuilder(r,n)}class PgBinaryVectorBuilder extends PgColumnBuilder{static[Uc]="PgBinaryVectorBuilder";constructor(e,t){super(e,"string","PgBinaryVector"),this.config.dimensions=t.dimensions}build(e){return new PgBinaryVector(e,this.config)}}class PgBinaryVector extends PgColumn{static[Uc]="PgBinaryVector";dimensions=this.config.dimensions;getSQLType(){return`bit(${this.dimensions})`}}function bit(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgBinaryVectorBuilder(r,n)}class PgHalfVectorBuilder extends PgColumnBuilder{static[Uc]="PgHalfVectorBuilder";constructor(e,t){super(e,"array","PgHalfVector"),this.config.dimensions=t.dimensions}build(e){return new PgHalfVector(e,this.config)}}class PgHalfVector extends PgColumn{static[Uc]="PgHalfVector";dimensions=this.config.dimensions;getSQLType(){return`halfvec(${this.dimensions})`}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){return e.slice(1,-1).split(",").map(e=>Number.parseFloat(e))}}function halfvec(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgHalfVectorBuilder(r,n)}class PgSparseVectorBuilder extends PgColumnBuilder{static[Uc]="PgSparseVectorBuilder";constructor(e,t){super(e,"string","PgSparseVector"),this.config.dimensions=t.dimensions}build(e){return new PgSparseVector(e,this.config)}}class PgSparseVector extends PgColumn{static[Uc]="PgSparseVector";dimensions=this.config.dimensions;getSQLType(){return`sparsevec(${this.dimensions})`}}function sparsevec(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgSparseVectorBuilder(r,n)}class PgVectorBuilder extends PgColumnBuilder{static[Uc]="PgVectorBuilder";constructor(e,t){super(e,"array","PgVector"),this.config.dimensions=t.dimensions}build(e){return new PgVector(e,this.config)}}class PgVector extends PgColumn{static[Uc]="PgVector";dimensions=this.config.dimensions;getSQLType(){return`vector(${this.dimensions})`}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){return e.slice(1,-1).split(",").map(e=>Number.parseFloat(e))}}function vector(e,t){const{name:r,config:n}=getColumnNameAndConfig(e,t);return new PgVectorBuilder(r,n)}const Xc=Symbol.for("drizzle:PgInlineForeignKeys"),ed=Symbol.for("drizzle:EnableRLS");class PgTable extends Table{static[Uc]="PgTable";static Symbol=Object.assign({},Table.Symbol,{InlineForeignKeys:Xc,EnableRLS:ed});[Xc]=[];[ed]=!1;[Table.Symbol.ExtraConfigBuilder]=void 0;[Table.Symbol.ExtraConfigColumns]={}}function pgTableWithSchema(e,t,r,n,i=e){const s=new PgTable(e,n,i),o="function"==typeof t?t({bigint:bigint,bigserial:bigserial,boolean:boolean,char:char,cidr:cidr,customType:customType,date:date,doublePrecision:doublePrecision,inet:inet,integer:integer,interval:interval,json:json,jsonb:jsonb,line:line,macaddr:macaddr,macaddr8:macaddr8,numeric:numeric,point:point,geometry:geometry,real:real,serial:serial,smallint:smallint,smallserial:smallserial,text:text,time:time,timestamp:timestamp,uuid:uuid,varchar:varchar,bit:bit,halfvec:halfvec,sparsevec:sparsevec,vector:vector}):t,a=Object.fromEntries(Object.entries(o).map(([e,t])=>{const r=t;r.setName(e);const n=r.build(s);return s[Xc].push(...r.buildForeignKeys(n,s)),[e,n]})),c=Object.fromEntries(Object.entries(o).map(([e,t])=>{const r=t;r.setName(e);return[e,r.buildExtraConfigColumn(s)]})),d=Object.assign(s,a);return d[Table.Symbol.Columns]=a,d[Table.Symbol.ExtraConfigColumns]=c,Object.assign(d,{enableRLS:()=>(d[PgTable.Symbol.EnableRLS]=!0,d)})}const pgTable=(e,t,r)=>pgTableWithSchema(e,t,0,void 0);class PrimaryKeyBuilder{static[Uc]="PgPrimaryKeyBuilder";columns;name;constructor(e,t){this.columns=e,this.name=t}build(e){return new PrimaryKey(e,this.columns,this.name)}}class PrimaryKey{constructor(e,t,r){this.table=e,this.columns=t,this.name=r}static[Uc]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[PgTable.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}}function bindIfParam(e,t){return!function(e){return"object"==typeof e&&null!==e&&"mapToDriverValue"in e&&"function"==typeof e.mapToDriverValue}(t)||isSQLWrapper(e)||is(e,Param)||is(e,Placeholder)||is(e,Column)||is(e,Table)||is(e,View)?e:new Param(e,t)}const eq=(e,t)=>sql`${e} = ${bindIfParam(t,e)}`,ne=(e,t)=>sql`${e} <> ${bindIfParam(t,e)}`;function and(...e){const t=e.filter(e=>void 0!==e);if(0!==t.length)return 1===t.length?new SQL(t):new SQL([new StringChunk("("),sql.join(t,new StringChunk(" and ")),new StringChunk(")")])}function or(...e){const t=e.filter(e=>void 0!==e);if(0!==t.length)return 1===t.length?new SQL(t):new SQL([new StringChunk("("),sql.join(t,new StringChunk(" or ")),new StringChunk(")")])}function not(e){return sql`not ${e}`}const gt=(e,t)=>sql`${e} > ${bindIfParam(t,e)}`,gte=(e,t)=>sql`${e} >= ${bindIfParam(t,e)}`,lt=(e,t)=>sql`${e} < ${bindIfParam(t,e)}`,lte=(e,t)=>sql`${e} <= ${bindIfParam(t,e)}`;function inArray(e,t){return Array.isArray(t)?0===t.length?sql`false`:sql`${e} in ${t.map(t=>bindIfParam(t,e))}`:sql`${e} in ${bindIfParam(t,e)}`}function notInArray(e,t){return Array.isArray(t)?0===t.length?sql`true`:sql`${e} not in ${t.map(t=>bindIfParam(t,e))}`:sql`${e} not in ${bindIfParam(t,e)}`}function isNull(e){return sql`${e} is null`}function isNotNull(e){return sql`${e} is not null`}function exists(e){return sql`exists ${e}`}function notExists(e){return sql`not exists ${e}`}function between(e,t,r){return sql`${e} between ${bindIfParam(t,e)} and ${bindIfParam(r,e)}`}function notBetween(e,t,r){return sql`${e} not between ${bindIfParam(t,e)} and ${bindIfParam(r,e)}`}function like(e,t){return sql`${e} like ${t}`}function notLike(e,t){return sql`${e} not like ${t}`}function ilike(e,t){return sql`${e} ilike ${t}`}function notIlike(e,t){return sql`${e} not ilike ${t}`}function asc(e){return sql`${e} asc`}function desc(e){return sql`${e} desc`}class Relation{constructor(e,t,r){this.sourceTable=e,this.referencedTable=t,this.relationName=r,this.referencedTableName=t[Table.Symbol.Name]}static[Uc]="Relation";referencedTableName;fieldName}class Relations{constructor(e,t){this.table=e,this.config=t}static[Uc]="Relations"}class One extends Relation{constructor(e,t,r,n){super(e,t,r?.relationName),this.config=r,this.isNullable=n}static[Uc]="One";withFieldName(e){const t=new One(this.sourceTable,this.referencedTable,this.config,this.isNullable);return t.fieldName=e,t}}class Many extends Relation{constructor(e,t,r){super(e,t,r?.relationName),this.config=r}static[Uc]="Many";withFieldName(e){const t=new Many(this.sourceTable,this.referencedTable,this.config);return t.fieldName=e,t}}function createOne(e){return function(t,r){return new One(e,t,r,r?.fields.reduce((e,t)=>e&&t.notNull,!0)??!1)}}function createMany(e){return function(t,r){return new Many(e,t,r)}}function normalizeRelation(e,t,r){if(is(r,One)&&r.config)return{fields:r.config.fields,references:r.config.references};const n=t[getTableUniqueName(r.referencedTable)];if(!n)throw new Error(`Table "${r.referencedTable[Table.Symbol.Name]}" not found in schema`);const i=e[n];if(!i)throw new Error(`Table "${n}" not found in schema`);const s=r.sourceTable,o=t[getTableUniqueName(s)];if(!o)throw new Error(`Table "${s[Table.Symbol.Name]}" not found in schema`);const a=[];for(const e of Object.values(i.relations))(r.relationName&&r!==e&&e.relationName===r.relationName||!r.relationName&&e.referencedTable===r.sourceTable)&&a.push(e);if(a.length>1)throw r.relationName?new Error(`There are multiple relations with name "${r.relationName}" in table "${n}"`):new Error(`There are multiple relations between "${n}" and "${r.sourceTable[Table.Symbol.Name]}". Please specify relation name`);if(a[0]&&is(a[0],One)&&a[0].config)return{fields:a[0].config.references,references:a[0].config.fields};throw new Error(`There is not enough information to infer relation "${o}.${r.fieldName}"`)}function createTableRelationsHelpers(e){return{one:createOne(e),many:createMany(e)}}function mapRelationalRow(e,t,r,n,i=e=>e){const s={};for(const[o,a]of n.entries())if(a.isJson){const n=t.relations[a.tsKey],c=r[o],d="string"==typeof c?JSON.parse(c):c;s[a.tsKey]=is(n,One)?d&&mapRelationalRow(e,e[a.relationTableTsKey],d,a.selection,i):d.map(t=>mapRelationalRow(e,e[a.relationTableTsKey],t,a.selection,i))}else{const e=i(r[o]),t=a.field;let n;n=is(t,Column)?t:is(t,SQL)?t.decoder:t.sql.decoder,s[a.tsKey]=null===e?null:n.mapFromDriverValue(e)}return s}const drizzleAdapter=(e,t)=>createAdapter({config:{adapterId:"drizzle",adapterName:"Drizzle Adapter",usePlural:t.usePlural??!1,debugLogs:t.debugLogs??!1},adapter:({getFieldName:r,debugLog:n})=>{function getSchema(r){const n=t.schema||e._.fullSchema;if(!n)throw new BetterAuthError("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");const i=n[r];if(!i)throw new BetterAuthError(`[# Drizzle Adapter]: The model "${r}" was not found in the schema object. Please pass the schema directly to the adapter options.`);return i}const withReturning=async(r,n,i,s)=>{if("mysql"!==t.provider){return(await n.returning())[0]}await n.execute();const o=getSchema(r),a=n.config?.values;if(s?.length){const t=convertWhereClause(s,r);return(await e.select().from(o).where(...t))[0]}if(a&&a[0]?.id?.value){let t=a[0]?.id?.value;if(!t){t=(await e.select({id:sql`LAST_INSERT_ID()`}).from(o).orderBy(desc(o.id)).limit(1))[0].id}return(await e.select().from(o).where(eq(o.id,t)).limit(1).execute())[0]}if(i.id){return(await e.select().from(o).where(eq(o.id,i.id)).limit(1).execute())[0]}if(!("id"in o))throw new BetterAuthError(`The model "${r}" does not have an "id" field. Please use the "id" field as your primary key.`);return(await e.select().from(o).orderBy(desc(o.id)).limit(1).execute())[0]};function convertWhereClause(e,t){const n=getSchema(t);if(!e)return[];if(1===e.length){const i=e[0];if(!i)return[];const s=r({model:t,field:i.field});if(!n[s])throw new BetterAuthError(`The field "${i.field}" does not exist in the schema for the model "${t}". Please update your schema.`);if("in"===i.operator){if(!Array.isArray(i.value))throw new BetterAuthError(`The value for the field "${i.field}" must be an array when using the "in" operator.`);return[inArray(n[s],i.value)]}return"contains"===i.operator?[like(n[s],`%${i.value}%`)]:"starts_with"===i.operator?[like(n[s],`${i.value}%`)]:"ends_with"===i.operator?[like(n[s],`%${i.value}`)]:"lt"===i.operator?[lt(n[s],i.value)]:"lte"===i.operator?[lte(n[s],i.value)]:"ne"===i.operator?[ne(n[s],i.value)]:"gt"===i.operator?[gt(n[s],i.value)]:"gte"===i.operator?[gte(n[s],i.value)]:[eq(n[s],i.value)]}const i=e.filter(e=>"AND"===e.connector||!e.connector),s=e.filter(e=>"OR"===e.connector),o=and(...i.map(e=>{const i=r({model:t,field:e.field});if("in"===e.operator){if(!Array.isArray(e.value))throw new BetterAuthError(`The value for the field "${e.field}" must be an array when using the "in" operator.`);return inArray(n[i],e.value)}return eq(n[i],e.value)})),a=or(...s.map(e=>{const i=r({model:t,field:e.field});return eq(n[i],e.value)})),c=[];return i.length&&c.push(o),s.length&&c.push(a),c}return{async create({model:t,data:r}){const n=getSchema(t);!function(e,t,r){if(!e)throw new BetterAuthError("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");for(const n in r)if(!e[n])throw new BetterAuthError(`The field "${n}" does not exist in the "${t}" schema. Please update your drizzle schema or re-generate using "npx @better-auth/cli generate".`)}(n,t,r);const i=e.insert(n).values(r);return await withReturning(t,i,r)},async findOne({model:t,where:r}){const n=getSchema(t),i=convertWhereClause(r,t),s=await e.select().from(n).where(...i);return s.length?s[0]:null},async findMany({model:t,where:n,sortBy:i,limit:s,offset:o}){const a=getSchema(t),c=n?convertWhereClause(n,t):[],d="desc"===i?.direction?desc:asc,l=e.select().from(a).limit(s||100).offset(o||0);return i?.field&&l.orderBy(d(a[r({model:t,field:i?.field})])),await l.where(...c)},async count({model:t,where:r}){const n=getSchema(t),i=r?convertWhereClause(r,t):[];return(await e.select({count:sql`count(${sql.raw("*")})`.mapWith(Number)}).from(n).where(...i))[0].count},async update({model:t,where:r,update:n}){const i=getSchema(t),s=convertWhereClause(r,t),o=e.update(i).set(n).where(...s);return await withReturning(t,o,n,r)},async updateMany({model:t,where:r,update:n}){const i=getSchema(t),s=convertWhereClause(r,t),o=e.update(i).set(n).where(...s);return await o},async delete({model:t,where:r}){const n=getSchema(t),i=convertWhereClause(r,t),s=e.delete(n).where(...i);return await s},async deleteMany({model:t,where:r}){const n=getSchema(t),i=convertWhereClause(r,t),s=e.delete(n).where(...i);return await s},options:t}}});async function getUserInfo(e,t){if(e.idToken){const t=decodeJwt(e.idToken);if(t&&t.sub&&t.email)return{id:t.sub,emailVerified:t.email_verified,image:t.picture,...t}}if(!t)return null;const r=await betterFetch(t,{method:"GET",headers:{Authorization:`Bearer ${e.accessToken}`}});return{id:r.data?.sub,emailVerified:r.data?.email_verified,email:r.data?.email,image:r.data?.picture,name:r.data?.name,...r.data}}const genericOAuth=e=>{const t={INVALID_OAUTH_CONFIGURATION:"Invalid OAuth configuration"};return{id:"generic-oauth",init:t=>{const r=e.config.map(e=>{let r=e.userInfoUrl;return{id:e.providerId,name:e.providerId,createAuthorizationURL:r=>createAuthorizationURL({id:e.providerId,options:{clientId:e.clientId,clientSecret:e.clientSecret,redirectURI:e.redirectURI},authorizationEndpoint:e.authorizationUrl,state:r.state,codeVerifier:e.pkce?r.codeVerifier:void 0,scopes:e.scopes||[],redirectURI:`${t.baseURL}/oauth2/callback/${e.providerId}`}),async validateAuthorizationCode(t){let n=e.tokenUrl;if(e.discoveryUrl){const t=await betterFetch(e.discoveryUrl,{method:"GET",headers:e.discoveryHeaders});t.data&&(n=t.data.token_endpoint,r=t.data.userinfo_endpoint)}if(!n)throw new h("BAD_REQUEST",{message:"Invalid OAuth configuration. Token URL not found."});return validateAuthorizationCode({headers:e.authorizationHeaders,code:t.code,codeVerifier:t.codeVerifier,redirectURI:t.redirectURI,options:{clientId:e.clientId,clientSecret:e.clientSecret,redirectURI:e.redirectURI},tokenEndpoint:n,authentication:e.authentication})},async refreshAccessToken(t){let r=e.tokenUrl;if(e.discoveryUrl){const t=await betterFetch(e.discoveryUrl,{method:"GET",headers:e.discoveryHeaders});t.data&&(r=t.data.token_endpoint)}if(!r)throw new h("BAD_REQUEST",{message:"Invalid OAuth configuration. Token URL not found."});return refreshAccessToken({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},authentication:e.authentication,tokenEndpoint:r})},async getUserInfo(t){const n=e.getUserInfo?await e.getUserInfo(t):await getUserInfo(t,r);return n?{user:{id:n?.id,email:n?.email,emailVerified:n?.emailVerified,image:n?.image,name:n?.name,...e.mapProfileToUser?.(n)},data:n}:null}}});return{context:{socialProviders:r.concat(t.socialProviders)}}},endpoints:{signInWithOAuth2:os("/sign-in/oauth2",{method:"POST",body:object({providerId:string$1().meta({description:"The provider ID for the OAuth provider"}),callbackURL:string$1().meta({description:"The URL to redirect to after sign in"}).optional(),errorCallbackURL:string$1().meta({description:"The URL to redirect to if an error occurs"}).optional(),newUserCallbackURL:string$1().meta({description:'The URL to redirect to after login if the user is new. Eg: "/welcome"'}).optional(),disableRedirect:boolean$2().meta({description:"Disable redirect"}).optional(),scopes:array(string$1()).meta({description:"Scopes to be passed to the provider authorization request."}).optional(),requestSignUp:boolean$2().meta({description:"Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider. Eg: false"}).optional()}),metadata:{openapi:{description:"Sign in with OAuth2",responses:{200:{description:"Sign in with OAuth2",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"},redirect:{type:"boolean"}}}}}}}}}},async r=>{const{providerId:n}=r.body,i=e.config.find(e=>e.providerId===n);if(!i)throw new h("BAD_REQUEST",{message:`No config found for provider ${n}`});const{discoveryUrl:s,authorizationUrl:o,tokenUrl:a,clientId:c,clientSecret:d,scopes:l,redirectURI:u,responseType:p,pkce:f,prompt:m,accessType:g,authorizationUrlParams:y,responseMode:w,authentication:b}=i;let v=o,N=a;if(s){const e=await betterFetch(s,{method:"GET",headers:i.discoveryHeaders,onError(e){r.context.logger.error(e.error.message,e.error,{discoveryUrl:s})}});e.data&&(v=e.data.authorization_endpoint,N=e.data.token_endpoint)}if(!v||!N)throw new h("BAD_REQUEST",{message:t.INVALID_OAUTH_CONFIGURATION});if(y){const e=new URL(v);for(const[t,r]of Object.entries(y))e.searchParams.set(t,r);v=e.toString()}const{state:T,codeVerifier:k}=await generateState(r),x=await createAuthorizationURL({id:n,options:{clientId:c,redirectURI:u},authorizationEndpoint:v,state:T,codeVerifier:f?k:void 0,scopes:r.body.scopes?[...r.body.scopes,...l||[]]:l||[],redirectURI:`${r.context.baseURL}/oauth2/callback/${n}`,prompt:m,accessType:g,responseType:p,responseMode:w,additionalParams:y});return r.json({url:x.toString(),redirect:!r.body.disableRedirect})}),oAuth2Callback:os("/oauth2/callback/:providerId",{method:"GET",query:object({code:string$1().meta({description:"The OAuth2 code"}).optional(),error:string$1().meta({description:"The error message, if any"}).optional(),error_description:string$1().meta({description:"The error description, if any"}).optional(),state:string$1().meta({description:"The state parameter from the OAuth2 request"}).optional()}),metadata:{client:!1,openapi:{description:"OAuth2 callback",responses:{200:{description:"OAuth2 callback",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"}}}}}}}}}},async t=>{const r=t.context.options.onAPIError?.errorURL||`${t.context.baseURL}/error`;if(t.query.error||!t.query.code)throw t.redirect(`${r}?error=${t.query.error||"oAuth_code_missing"}&error_description=${t.query.error_description}`);const n=e.config.find(e=>e.providerId===t.params.providerId);if(!n)throw new h("BAD_REQUEST",{message:`No config found for provider ${t.params.providerId}`});let i;const s=await parseState(t),{callbackURL:o,codeVerifier:a,errorURL:c,requestSignUp:d,newUserURL:l,link:u}=s,p=t.query.code;function redirectOnError(e){const r=t.context.options.onAPIError?.errorURL||`${t.context.baseURL}/error`;let n=c||r;throw n=n.includes("?")?`${n}&error=${e}`:`${n}?error=${e}`,t.redirect(n)}let f=n.tokenUrl,m=n.userInfoUrl;if(n.discoveryUrl){const e=await betterFetch(n.discoveryUrl,{method:"GET",headers:n.discoveryHeaders});e.data&&(f=e.data.token_endpoint,m=e.data.userinfo_endpoint)}try{if(!f)throw new h("BAD_REQUEST",{message:"Invalid OAuth configuration."});i=await validateAuthorizationCode({headers:n.authorizationHeaders,code:p,codeVerifier:n.pkce?a:void 0,redirectURI:`${t.context.baseURL}/oauth2/callback/${n.providerId}`,options:{clientId:n.clientId,clientSecret:n.clientSecret,redirectURI:n.redirectURI},tokenEndpoint:f,authentication:n.authentication,additionalParams:n.tokenUrlParams})}catch(e){throw t.context.logger.error(e&&"object"==typeof e&&"name"in e?e.name:"",e),redirectOnError("oauth_code_verification_failed")}if(!i)throw new h("BAD_REQUEST",{message:"Invalid OAuth configuration."});const g=n.getUserInfo?await n.getUserInfo(i):await getUserInfo(i,m);if(!g)throw redirectOnError("user_info_is_missing");const y=n.mapProfileToUser?await n.mapProfileToUser(g):g;if(!y?.email)throw t.context.logger.error("Unable to get user info",g),redirectOnError("email_is_missing");if(u){if(!0!==t.context.options.account?.accountLinking?.allowDifferentEmails&&u.email!==y.email.toLowerCase())return redirectOnError("email_doesn't_match");const e=await t.context.internalAdapter.findAccountByProviderId(g.id,n.providerId);if(e){if(e.userId!==u.userId)return redirectOnError("account_already_linked_to_different_user");const r=Object.fromEntries(Object.entries({accessToken:i.accessToken,idToken:i.idToken,refreshToken:i.refreshToken,accessTokenExpiresAt:i.accessTokenExpiresAt,refreshTokenExpiresAt:i.refreshTokenExpiresAt,scope:i.scopes?.join(",")}).filter(([e,t])=>void 0!==t));await t.context.internalAdapter.updateAccount(e.id,r)}else{if(!await t.context.internalAdapter.createAccount({userId:u.userId,providerId:n.providerId,accountId:g.id,accessToken:i.accessToken,accessTokenExpiresAt:i.accessTokenExpiresAt,refreshTokenExpiresAt:i.refreshTokenExpiresAt,scope:i.scopes?.join(","),refreshToken:i.refreshToken,idToken:i.idToken}))return redirectOnError("unable_to_link_account")}let r;try{r=o.toString()}catch{r=o}throw t.redirect(r)}const w=await handleOAuthUserInfo(t,{userInfo:{...g,...y},account:{providerId:n.providerId,accountId:g.id,...i,scope:i.scopes?.join(",")},callbackURL:o,disableSignUp:n.disableImplicitSignUp&&!d||n.disableSignUp,overrideUserInfo:n.overrideUserInfo});if(w.error)return redirectOnError(w.error.split(" ").join("_"));const{session:b,user:v}=w.data;let N;await setSessionCookie(t,{session:b,user:v});try{N=(w.isRegister&&l||o).toString()}catch{N=w.isRegister&&l||o}throw t.redirect(N)}),oAuth2LinkAccount:os("/oauth2/link",{method:"POST",body:object({providerId:string$1(),callbackURL:string$1(),scopes:array(string$1()).meta({description:"Additional scopes to request when linking the account"}).optional(),errorCallbackURL:string$1().meta({description:"The URL to redirect to if there is an error during the link process"}).optional()}),use:[ds],metadata:{openapi:{description:"Link an OAuth2 account to the current user session",responses:{200:{description:"Authorization URL generated successfully for linking an OAuth2 account",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string",format:"uri",description:"The authorization URL to redirect the user to for linking the OAuth2 account"},redirect:{type:"boolean",description:"Indicates that the client should redirect to the provided URL",enum:[!0]}},required:["url","redirect"]}}}}}}}},async r=>{const n=r.context.session,i=e.config.find(e=>e.providerId===r.body.providerId);if(!i)throw new h("NOT_FOUND",{message:cs.PROVIDER_NOT_FOUND});const{providerId:s,clientId:o,clientSecret:a,redirectURI:c,authorizationUrl:d,discoveryUrl:l,pkce:u,scopes:p,prompt:f,accessType:m,authorizationUrlParams:g}=i;let y=d;if(!y){if(!l)throw new h("BAD_REQUEST",{message:t.INVALID_OAUTH_CONFIGURATION});const e=await betterFetch(l,{method:"GET",headers:i.discoveryHeaders,onError(e){r.context.logger.error(e.error.message,e.error,{discoveryUrl:l})}});e.data&&(y=e.data.authorization_endpoint)}if(!y)throw new h("BAD_REQUEST",{message:t.INVALID_OAUTH_CONFIGURATION});const w=await generateState(r,{userId:n.user.id,email:n.user.email}),b=await createAuthorizationURL({id:s,options:{clientId:o,redirectURI:c||`${r.context.baseURL}/oauth2/callback/${s}`},authorizationEndpoint:y,state:w.state,codeVerifier:u?w.codeVerifier:void 0,scopes:r.body.scopes||p||[],redirectURI:c||`${r.context.baseURL}/oauth2/callback/${s}`,prompt:f,accessType:m,additionalParams:g});return r.json({url:b.toString(),redirect:!0})})},$ERROR_CODES:t}},td=globalThis.crypto;let rd=1;const nd=new Set,id="(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])",sd=`(${id}[.]){3}${id}`,od=new RegExp(`^${sd}$`),ad="(?:[0-9a-fA-F]{1,4})",cd=new RegExp(`^((?:${ad}:){7}(?:${ad}|:)|(?:${ad}:){6}(?:${sd}|:${ad}|:)|(?:${ad}:){5}(?::${sd}|(:${ad}){1,2}|:)|(?:${ad}:){4}(?:(:${ad}){0,1}:${sd}|(:${ad}){1,3}|:)|(?:${ad}:){3}(?:(:${ad}){0,2}:${sd}|(:${ad}){1,4}|:)|(?:${ad}:){2}(?:(:${ad}){0,3}:${sd}|(:${ad}){1,5}|:)|(?:${ad}:){1}(?:(:${ad}){0,4}:${sd}|(:${ad}){1,6}|:)|(?::((?::${ad}){0,5}:${sd}|(?::${ad}){1,7}|:)))(%[0-9a-zA-Z-.:]{1,})?$`),dd=new TextEncoder,crypto$1_randomBytes=e=>td.getRandomValues(d.alloc(e)),crypto$1_pbkdf2Sync=async(e,t,r,n)=>td.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:t,iterations:r},await td.subtle.importKey("raw",dd.encode(e),"PBKDF2",!1,["deriveBits"]),8*n,["deriveBits"]),crypto$1_createHash=e=>({update:t=>({digest:r=>{let n;if(t instanceof Uint8Array||(t=dd.encode(t)),"sha256"===e)n=td.subtle.digest("SHA-256",t);else{if("md5"!==e)throw Error("createHash only supports sha256 or md5 in this environment, not ${type}.");n=td.subtle.digest("md5",t)}if("hex"===r)return n.then(e=>d.from(e).toString("hex"));if(r)throw Error(`createHash only supports hex encoding or unencoded in this environment, not ${r}`);return n}})}),crypto$1_createHmac=(e,t)=>({update:e=>({digest:async()=>d.from(await td.subtle.sign("HMAC",await td.subtle.importKey("raw",t,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),dd.encode(e)))})}),ld=globalThis.performance,ud={env:{}},pd={userInfo:()=>({username:"postgres"})},hd={readFile(){throw new Error("Reading files not supported on CloudFlare")}},fd={isIP:e=>od.test(e)?4:cd.test(e)?6:0,Socket:function(){const e=Object.assign(new c,{readyState:"open",raw:null,writer:null,reader:null,connect:async function(t,r){try{e.readyState="opening";const{connect:n}=await import("cloudflare:sockets");e.raw=n(r+":"+t,e.ssl?{secureTransport:"starttls"}:{}),e.raw.closed.then(()=>{"upgrade"!==e.readyState?function(){if("closed"===e.readyState)return;e.readyState="closed",e.emit("close")}():(e.readyState="open",e.emit("secureConnect"))},t=>e.emit("error",t)),e.writer=e.raw.writable.getWriter(),e.reader=e.raw.readable.getReader(),e.ssl?async function(){const{value:t}=await e.reader.read();e.emit("data",d.from(t))}():read(),e.writer.ready.then(()=>{e.readyState="open",e.emit("connect")})}catch(e){error(e)}},write:function(t,r){return e.writer.write(t).then(r,error),!0},end:function(t){return t?e.write(t,()=>e.raw.close()):e.raw.close()},destroy:function(){e.destroyed=!0,e.end()},read:read});return e;async function read(){try{let t,r;for(;({done:t,value:r}=await e.reader.read()),!t;)e.emit("data",d.from(r))}catch(e){error(e)}}function error(t){e.emit("error",t),e.emit("close")}}},md={connect:({socket:e,servername:t})=>(e.writer.releaseLock(),e.reader.releaseLock(),e.readyState="upgrading",e.raw=e.raw.startTls({servername:t}),e.raw.closed.then(()=>e.emit("close"),t=>e.emit("error",t)),e.writer=e.raw.writable.getWriter(),e.reader=e.raw.readable.getReader(),e.writer.ready.then(()=>{e.read(),e.readyState="upgrade"}),e)};function clearImmediate(e){nd.delete(e)}const gd=new Map,yd=new Map,wd=Symbol("OriginError"),bd={};class Query extends Promise{constructor(e,t,r,n,i={}){let s,o;super((e,t)=>{s=e,o=t}),this.tagged=Array.isArray(e.raw),this.strings=e,this.args=t,this.handler=r,this.canceller=n,this.options=i,this.state=null,this.statement=null,this.resolve=e=>(this.active=!1,s(e)),this.reject=e=>(this.active=!1,o(e)),this.active=!1,this.cancelled=null,this.executed=!1,this.signature="",this[wd]=this.handler.debug?new Error:this.tagged&&function(e){if(gd.has(e))return gd.get(e);const t=Error.stackTraceLimit;return Error.stackTraceLimit=4,gd.set(e,new Error),Error.stackTraceLimit=t,gd.get(e)}(this.strings)}get origin(){return(this.handler.debug?this[wd].stack:this.tagged&&yd.has(this.strings)?yd.get(this.strings):yd.set(this.strings,this[wd].stack).get(this.strings))||""}static get[Symbol.species](){return Promise}cancel(){return this.canceller&&(this.canceller(this),this.canceller=null)}simple(){return this.options.simple=!0,this.options.prepare=!1,this}async readable(){return this.simple(),this.streaming=!0,this}async writable(){return this.simple(),this.streaming=!0,this}cursor(e=1,t){if(this.options.simple=!1,"function"==typeof e&&(t=e,e=1),this.cursorRows=e,"function"==typeof t)return this.cursorFn=t,this;let r;return{[Symbol.asyncIterator]:()=>({next:()=>{if(this.executed&&!this.active)return{done:!0};r&&r();const e=new Promise((e,t)=>{this.cursorFn=t=>(e({value:t,done:!1}),new Promise(e=>r=e)),this.resolve=()=>(this.active=!1,e({done:!0})),this.reject=e=>(this.active=!1,t(e))});return this.execute(),e},return:()=>(r&&r(bd),{done:!0})})}}describe(){return this.options.simple=!1,this.onlyDescribe=this.options.prepare=!0,this}stream(){throw new Error(".stream has been renamed to .forEach")}forEach(e){return this.forEachFn=e,this.handle(),this}raw(){return this.isRaw=!0,this}values(){return this.isRaw="values",this}async handle(){!this.executed&&(this.executed=!0)&&await 1&&this.handler(this)}execute(){return this.handle(),this}then(){return this.handle(),super.then.apply(this,arguments)}catch(){return this.handle(),super.catch.apply(this,arguments)}finally(){return this.handle(),super.finally.apply(this,arguments)}}class PostgresError extends Error{constructor(e){super(e.message),this.name=this.constructor.name,Object.assign(this,e)}}const vd={connection:function connection(e,t,r){const{host:n,port:i}=r||t,s=Object.assign(new Error("write "+e+" "+(t.path||n+":"+i)),{code:e,errno:e,address:t.path||n},t.path?{}:{port:i});return Error.captureStackTrace(s,connection),s},postgres:function postgres(e){const t=new PostgresError(e);return Error.captureStackTrace(t,postgres),t},generic:function generic(e,t){const r=Object.assign(new Error(e+": "+t),{code:e});return Error.captureStackTrace(r,generic),r},notSupported:function notSupported(e){const t=Object.assign(new Error(e+" (B) is not supported"),{code:"MESSAGE_NOT_SUPPORTED",name:e});return Error.captureStackTrace(t,notSupported),t}};const Nd={string:{to:25,from:null,serialize:e=>""+e},number:{to:0,from:[21,23,26,700,701],serialize:e=>""+e,parse:e=>+e},json:{to:114,from:[114,3802],serialize:e=>JSON.stringify(e),parse:e=>JSON.parse(e)},boolean:{to:16,from:16,serialize:e=>!0===e?"t":"f",parse:e=>"t"===e},date:{to:1184,from:[1082,1114,1184],serialize:e=>(e instanceof Date?e:new Date(e)).toISOString(),parse:e=>new Date(e)},bytea:{to:17,from:17,serialize:e=>"\\x"+d.from(e).toString("hex"),parse:e=>d.from(e.slice(2),"hex")}};class NotTagged{then(){notTagged()}catch(){notTagged()}finally(){notTagged()}}class Identifier extends NotTagged{constructor(e){super(),this.value=escapeIdentifier(e)}}class Parameter extends NotTagged{constructor(e,t,r){super(),this.value=e,this.type=t,this.array=r}}class Builder extends NotTagged{constructor(e,t){super(),this.first=e,this.rest=t}build(e,t,r,n){const i=kd.map(([t,r])=>({fn:r,i:e.search(t)})).sort((e,t)=>e.i-t.i).pop();return-1===i.i?escapeIdentifiers(this.first,n):i.fn(this.first,this.rest,t,r,n)}}function handleValue(e,t,r,n){let i=e instanceof Parameter?e.value:e;if(void 0===i&&(e instanceof Parameter?e.value=n.transform.undefined:i=e=n.transform.undefined,void 0===i))throw vd.generic("UNDEFINED_VALUE","Undefined values are not allowed");return"$"+r.push(e instanceof Parameter?(t.push(e.value),e.array?e.array[e.type||_d(e.value)]||e.type||firstIsString(e.value):e.type):(t.push(e),_d(e)))}const Td=typeHandlers(Nd);function stringify(e,t,r,n,i,s){for(let o=1;o<e.strings.length;o++)t+=stringifyValue(t,r,n,i,s)+e.strings[o],r=e.args[o];return t}function stringifyValue(e,t,r,n,i){return t instanceof Builder?t.build(e,r,n,i):t instanceof Query?fragment(t,r,n,i):t instanceof Identifier?t.value:t&&t[0]instanceof Query?t.reduce((e,t)=>e+" "+fragment(t,r,n,i),""):handleValue(t,r,n,i)}function fragment(e,t,r,n){return e.fragment=!0,stringify(e,e.strings[0],e.args[0],t,r,n)}function valuesBuilder(e,t,r,n,i){return e.map(e=>"("+n.map(n=>stringifyValue("values",e[n],t,r,i)).join(",")+")").join(",")}function values(e,t,r,n,i){const s=Array.isArray(e[0]);return valuesBuilder(s?e:[e],r,n,t.length?t.flat():Object.keys(s?e[0]:e),i)}function select(e,t,r,n,i){if("string"==typeof e&&(e=[e].concat(t)),Array.isArray(e))return escapeIdentifiers(e,i);let s;return(t.length?t.flat():Object.keys(e)).map(t=>(s=e[t],(s instanceof Query?fragment(s,r,n,i):s instanceof Identifier?s.value:handleValue(s,r,n,i))+" as "+escapeIdentifier(i.transform.column.to?i.transform.column.to(t):t))).join(",")}const kd=Object.entries({values:values,in:(...e)=>{const t=values(...e);return"()"===t?"(null)":t},select:select,as:select,returning:select,"\\(":select,update:(e,t,r,n,i)=>(t.length?t.flat():Object.keys(e)).map(t=>escapeIdentifier(i.transform.column.to?i.transform.column.to(t):t)+"="+stringifyValue("values",e[t],r,n,i)),insert(e,t,r,n,i){const s=t.length?t.flat():Object.keys(Array.isArray(e)?e[0]:e);return"("+escapeIdentifiers(s,i)+")values"+valuesBuilder(Array.isArray(e)?e:[e],r,n,s,i)}}).map(([e,t])=>[new RegExp("((?:^|[\\s(])"+e+"(?:$|[\\s(]))(?![\\s\\S]*\\1)","i"),t]);function notTagged(){throw vd.generic("NOT_TAGGED_CALL","Query not called as a tagged template literal")}const xd=Td.serializers,Sd=Td.parsers;function firstIsString(e){return Array.isArray(e)?firstIsString(e[0]):"string"==typeof e?1009:0}const mergeUserTypes=function(e){const t=typeHandlers(e||{});return{serializers:Object.assign({},xd,t.serializers),parsers:Object.assign({},Sd,t.parsers)}};function typeHandlers(e){return Object.keys(e).reduce((t,r)=>(e[r].from&&[].concat(e[r].from).forEach(n=>t.parsers[n]=e[r].parse),e[r].serialize&&(t.serializers[e[r].to]=e[r].serialize,e[r].from&&[].concat(e[r].from).forEach(n=>t.serializers[n]=e[r].serialize)),t),{parsers:{},serializers:{}})}function escapeIdentifiers(e,{transform:{column:t}}){return e.map(e=>escapeIdentifier(t.to?t.to(e):e)).join(",")}const escapeIdentifier=function(e){return'"'+e.replace(/"/g,'""').replace(/\./g,'"."')+'"'},_d=function inferType(e){return e instanceof Parameter?e.type:e instanceof Date?1184:e instanceof Uint8Array?17:!0===e||!1===e?16:"bigint"==typeof e?20:Array.isArray(e)?inferType(e[0]):0},Ad=/\\/g,Id=/"/g;const Ed=function arraySerializer(e,t,r,n){if(!1===Array.isArray(e))return e;if(!e.length)return"{}";const i=e[0],s=1020===n?";":",";return Array.isArray(i)&&!i.type?"{"+e.map(e=>arraySerializer(e,t,r,n)).join(s)+"}":"{"+e.map(e=>{if(void 0===e&&void 0===(e=r.transform.undefined))throw vd.generic("UNDEFINED_VALUE","Undefined values are not allowed");return null===e?"null":'"'+function(e){return e.replace(Ad,"\\\\").replace(Id,'\\"')}(t?t(e.type?e.value:e):""+e)+'"'}).join(s)+"}"},Cd={i:0,char:null,str:"",quoted:!1,last:0},arrayParser=function(e,t,r){return Cd.i=Cd.last=0,arrayParserLoop(Cd,e,t,r)};function arrayParserLoop(e,t,r,n){const i=[],s=1020===n?";":",";for(;e.i<t.length;e.i++){if(e.char=t[e.i],e.quoted)"\\"===e.char?e.str+=t[++e.i]:'"'===e.char?(i.push(r?r(e.str):e.str),e.str="",e.quoted='"'===t[e.i+1],e.last=e.i+2):e.str+=e.char;else if('"'===e.char)e.quoted=!0;else if("{"===e.char)e.last=++e.i,i.push(arrayParserLoop(e,t,r,n));else{if("}"===e.char){e.quoted=!1,e.last<e.i&&i.push(r?r(t.slice(e.last,e.i)):t.slice(e.last,e.i)),e.last=e.i+1;break}e.char===s&&"}"!==e.p&&'"'!==e.p&&(i.push(r?r(t.slice(e.last,e.i)):t.slice(e.last,e.i)),e.last=e.i+1)}e.p=e.char}return e.last<e.i&&i.push(r?r(t.slice(e.last,e.i+1)):t.slice(e.last,e.i+1)),i}const toCamel=e=>{let t=e[0];for(let r=1;r<e.length;r++)t+="_"===e[r]?e[++r].toUpperCase():e[r];return t},toPascal=e=>{let t=e[0].toUpperCase();for(let r=1;r<e.length;r++)t+="_"===e[r]?e[++r].toUpperCase():e[r];return t},toKebab=e=>e.replace(/_/g,"-"),fromCamel=e=>e.replace(/([A-Z])/g,"_$1").toLowerCase(),fromPascal=e=>(e.slice(0,1)+e.slice(1).replace(/([A-Z])/g,"_$1")).toLowerCase(),fromKebab=e=>e.replace(/-/g,"_");function createJsonTransform(e){return function jsonTransform(t,r){return"object"!=typeof t||null===t||114!==r.type&&3802!==r.type?t:Array.isArray(t)?t.map(e=>jsonTransform(e,r)):Object.entries(t).reduce((t,[n,i])=>Object.assign(t,{[e(n)]:jsonTransform(i,r)}),{})}}toCamel.column={from:toCamel},toCamel.value={from:createJsonTransform(toCamel)},fromCamel.column={to:fromCamel};const Od={...toCamel};Od.column.to=fromCamel,toPascal.column={from:toPascal},toPascal.value={from:createJsonTransform(toPascal)},fromPascal.column={to:fromPascal};const Pd={...toPascal};Pd.column.to=fromPascal,toKebab.column={from:toKebab},toKebab.value={from:createJsonTransform(toKebab)},fromKebab.column={to:fromKebab};const Rd={...toKebab};Rd.column.to=fromKebab;class Result extends Array{constructor(){super(),Object.defineProperties(this,{count:{value:null,writable:!0},state:{value:null,writable:!0},command:{value:null,writable:!0},columns:{value:null,writable:!0},statement:{value:null,writable:!0}})}static get[Symbol.species](){return Array}}function Queue(e=[]){let t=e.slice(),r=0;return{get length(){return t.length-r},remove:e=>{const r=t.indexOf(e);return-1===r?null:(t.splice(r,1),e)},push:e=>(t.push(e),e),shift:()=>{const e=t[r++];return r===t.length?(r=0,t=[]):t[r-1]=void 0,e}}}let $d=d.allocUnsafe(256);const Bd="BCcDdEFfHPpQSX".split("").reduce((e,t)=>{const r=t.charCodeAt(0);return e[t]=()=>($d[0]=r,Ud.i=5,Ud),e},{}),Ud=Object.assign(function(){return Ud.i=0,Ud},Bd,{N:String.fromCharCode(0),i:0,inc:e=>(Ud.i+=e,Ud),str(e){const t=d.byteLength(e);return fit(t),Ud.i+=$d.write(e,Ud.i,t,"utf8"),Ud},i16:e=>(fit(2),$d.writeUInt16BE(e,Ud.i),Ud.i+=2,Ud),i32:(e,t)=>t||0===t?($d.writeUInt32BE(e,t),Ud):(fit(4),$d.writeUInt32BE(e,Ud.i),Ud.i+=4,Ud),z:e=>(fit(e),$d.fill(0,Ud.i,Ud.i+e),Ud.i+=e,Ud),raw:e=>($d=d.concat([$d.subarray(0,Ud.i),e]),Ud.i=$d.length,Ud),end(e=1){$d.writeUInt32BE(Ud.i-e,e);const t=$d.subarray(0,Ud.i);return Ud.i=0,$d=d.allocUnsafe(256),t}});function fit(e){if($d.length-Ud.i<e){const t=$d,r=t.length;$d=d.allocUnsafe(r+(r>>1)+e),t.copy($d)}}let Ld=1;const zd=Ud().S().end(),Dd=Ud().H().end(),qd=Ud().i32(8).i32(80877103).end(8),Wd=d.concat([Ud().E().str(Ud.N).i32(0).end(),zd]),jd=Ud().D().str("S").str(Ud.N).end(),noop$1=()=>{},Md=new Set(["FetchPreparedStatement","RevalidateCachedQuery","transformAssignedExpr"]),Qd={83:"severity_local",86:"severity",67:"code",77:"message",68:"detail",72:"hint",80:"position",112:"internal_position",113:"internal_query",87:"where",115:"schema_name",116:"table_name",99:"column_name",100:"data type_name",110:"constraint_name",70:"file",76:"line",82:"routine"};function Connection(e,t={},{onopen:r=noop$1,onend:n=noop$1,onclose:i=noop$1}={}){const{ssl:s,max:o,user:a,host:c,port:u,database:p,parsers:h,transform:f,onnotice:m,onnotify:g,onparameter:y,max_pipeline:w,keep_alive:b,backoff:v,target_session_attrs:N}=e,T=Queue(),k=Ld++,x={pid:null,secret:null},S=timer(end,e.idle_timeout),A=timer(end,e.max_lifetime),I=timer(function(){errored(vd.connection("CONNECT_TIMEOUT",e,O)),O.destroy()},e.connect_timeout);let E,O=null,P=new Result,R=d.alloc(0),$=e.fetch_types,B={},U={},L=Math.random().toString(36).slice(2),z=1,D=0,q=0,W=0,j=0,M=0,Q=0,V=0,F=null,J=null,K=!1,H=null,Z=null,G=null,Y=null,X=null,ee=null,te=null,re=null,ie=null,se=null;const oe={queue:t.closed,idleTimer:S,connect(e){G=e,reconnect()},terminate:terminate,execute:execute,cancel:async function({pid:e,secret:t},r,n){try{E=Ud().i32(16).i32(80877102).i32(e).i32(t).end(16),await connect(),O.once("error",n),O.once("close",r)}catch(e){n(e)}},end:end,count:0,id:k};return t.closed&&t.closed.push(oe),oe;function execute(t){if(K)return queryError(t,vd.connection("CONNECTION_DESTROYED",e));if(!t.cancelled)try{return t.state=x,ie?T.push(t):(ie=t,ie.active=!0),function(t){const r=[],n=[],i=stringify(t,t.strings[0],t.args[0],r,n,e);!t.tagged&&t.args.forEach(t=>handleValue(t,r,n,e)),t.prepare=e.prepare&&(!("prepare"in t.options)||t.options.prepare),t.string=i,t.signature=t.prepare&&n+i,t.onlyDescribe&&delete U[t.signature],t.parameters=t.parameters||r,t.prepared=t.prepare&&t.signature in U,t.describeFirst=t.onlyDescribe||r.length&&!t.prepared,t.statement=t.prepared?U[t.signature]:{string:i,types:n,name:t.prepare?L+z++:""},"function"==typeof e.debug&&e.debug(k,i,r,n)}(t),write(function(e){if(e.parameters.length>=65534)throw vd.generic("MAX_PARAMETERS_EXCEEDED","Max number of parameters (65534) exceeded");return e.options.simple?Ud().Q().str(e.statement.string+Ud.N).end():e.describeFirst?d.concat([describe(e),Dd]):e.prepare?e.prepared?prepared(e):d.concat([describe(e),prepared(e)]):function(e){return d.concat([Parse(e.statement.string,e.parameters,e.statement.types),jd,prepared(e)])}(e)}(t))&&!t.describeFirst&&!t.cursorFn&&T.length<w&&(!t.options.onexecute||t.options.onexecute(oe))}catch(e){return 0===T.length&&write(zd),errored(e),!0}}function describe(e){return d.concat([Parse(e.statement.string,e.parameters,e.statement.types,e.statement.name),Describe("S",e.statement.name)])}function prepared(e){return d.concat([Bind(e.parameters,e.statement.types,e.statement.name,e.cursorName),e.cursorFn?Execute("",e.cursorRows):Wd])}function write(e,t){return ee=ee?d.concat([ee,e]):d.from(e),ee.length>=1024?nextWrite(t):(null===J&&(J=function(e){const t=rd++;return nd.add(t),queueMicrotask(()=>{nd.has(t)&&(e(),nd.delete(t))}),t}(nextWrite)),!0)}function nextWrite(e){const t=O.write(ee,e);return null!==J&&clearImmediate(J),ee=J=null,t}async function secure(){write(qd);if(!await new Promise(e=>O.once("data",t=>e(83===t[0])))&&"prefer"===s)return connected();O.removeAllListeners(),O=md.connect({socket:O,servername:fd.isIP(O.host)?void 0:O.host,..."require"===s||"allow"===s||"prefer"===s?{rejectUnauthorized:!1}:"verify-full"===s?{}:"object"==typeof s?s:{}}),O.on("secureConnect",connected),O.on("error",error),O.on("close",closed),O.on("drain",drain)}function drain(){!ie&&r(oe)}function data(e){if(!(H&&(H.push(e),q-=e.length,q>0)))for(R=H?d.concat(H,M-q):0===R.length?e:d.concat([R,e],R.length+e.length);R.length>4;){if(M=R.readUInt32BE(1),M>=R.length){q=M-R.length,H=[R];break}try{handle(R.subarray(0,M+1))}catch(e){ie&&(ie.cursorFn||ie.describeFirst)&&write(zd),errored(e)}R=R.subarray(M+1),q=0,H=null}}async function connect(){if(K=!1,B={},O||(O=await async function(){let t;try{t=e.socket?await Promise.resolve(e.socket(e)):new fd.Socket}catch(e){return void error(e)}return t.on("error",error),t.on("close",closed),t.on("drain",drain),t}()),O){if(I.start(),e.socket)return s?secure():connected();if(O.on("connect",s?secure:connected),e.path)return O.connect(e.path);O.ssl=s,O.connect(u[W],c[W]),O.host=c[W],O.port=u[W],W=(W+1)%u.length}}function reconnect(){setTimeout(connect,D?D+Q-ld.now():0)}function connected(){try{U={},$=e.fetch_types,L=Math.random().toString(36).slice(2),z=1,A.start(),O.on("data",data),b&&O.setKeepAlive&&O.setKeepAlive(!0,1e3*b);write(E||Ud().inc(4).i16(3).z(2).str(Object.entries(Object.assign({user:a,database:p,client_encoding:"UTF8"},e.connection)).filter(([,e])=>e).map(([e,t])=>e+Ud.N+t).join(Ud.N)).z(2).end(0))}catch(e){error(e)}}function error(r){if(oe.queue!==t.connecting||!e.host[j+1])for(errored(r);T.length;)queryError(T.shift(),r)}function errored(e){X&&(X.destroy(e),X=null),ie&&queryError(ie,e),G&&(queryError(G,e),G=null)}function queryError(t,r){if(t.reserve)return t.reject(r);r&&"object"==typeof r||(r=new Error(r)),"query"in r||"parameters"in r||Object.defineProperties(r,{stack:{value:r.stack+t.origin.replace(/.*\n/,"\n"),enumerable:e.debug},query:{value:t.string,enumerable:e.debug},parameters:{value:t.parameters,enumerable:e.debug},args:{value:t.args,enumerable:e.debug},types:{value:t.statement&&t.statement.types,enumerable:e.debug}}),t.reject(r)}function end(){return Y||(!oe.reserved&&n(oe),oe.reserved||G||ie||0!==T.length?Y=new Promise(e=>te=e):(terminate(),new Promise(e=>O&&"closed"!==O.readyState?O.once("close",e):e())))}function terminate(){K=!0,(X||ie||G||T.length)&&error(vd.connection("CONNECTION_DESTROYED",e)),clearImmediate(J),O&&(O.removeListener("data",data),O.removeListener("connect",connected),"open"===O.readyState&&O.end(Ud().X().end())),te&&(te(),Y=te=null)}async function closed(t){if(R=d.alloc(0),q=0,H=null,clearImmediate(J),O.removeListener("data",data),O.removeListener("connect",connected),S.cancel(),A.cancel(),I.cancel(),O.removeAllListeners(),O=null,G)return reconnect();!t&&(ie||T.length)&&error(vd.connection("CONNECTION_CLOSED",e,O)),D=ld.now(),t&&e.shared.retries++,Q=1e3*("function"==typeof v?v(e.shared.retries):v),i(oe,vd.connection("CONNECTION_CLOSED",e,O))}function handle(e,t=e[0]){(68===t?DataRow:100===t?CopyData:65===t?NotificationResponse:83===t?ParameterStatus:90===t?ReadyForQuery:67===t?CommandComplete:50===t?BindComplete:49===t?ParseComplete:116===t?ParameterDescription:84===t?RowDescription:82===t?Authentication:110===t?NoData:75===t?BackendKeyData:69===t?ErrorResponse:115===t?PortalSuspended:51===t?CloseComplete:71===t?CopyInResponse:78===t?NoticeResponse:72===t?CopyOutResponse:99===t?CopyDone:73===t?EmptyQueryResponse:86===t?FunctionCallResponse:118===t?NegotiateProtocolVersion:87===t?CopyBothResponse:UnknownMessage)(e)}function DataRow(e){let t,r,n,i=7;const s=ie.isRaw?new Array(ie.statement.columns.length):{};for(let o=0;o<ie.statement.columns.length;o++)r=ie.statement.columns[o],t=e.readInt32BE(i),i+=4,n=-1===t?null:!0===ie.isRaw?e.subarray(i,i+=t):void 0===r.parser?e.toString("utf8",i,i+=t):!0===r.parser.array?r.parser(e.toString("utf8",i+1,i+=t)):r.parser(e.toString("utf8",i,i+=t)),ie.isRaw?s[o]=!0===ie.isRaw?n:f.value.from?f.value.from(n,r):n:s[r.name]=f.value.from?f.value.from(n,r):n;ie.forEachFn?ie.forEachFn(f.row.from?f.row.from(s):s,P):P[V++]=f.row.from?f.row.from(s):s}function ParameterStatus(t){const[r,n]=t.toString("utf8",5,t.length-1).split(Ud.N);B[r]=n,e.parameters[r]!==n&&(e.parameters[r]=n,y&&y(r,n))}function ReadyForQuery(t){if(ie&&ie.options.simple&&ie.resolve(Z||P),ie=Z=null,P=new Result,I.cancel(),G){if(N){if(!B.in_hot_standby||!B.default_transaction_read_only)return function(){const e=new Query(["\n      show transaction_read_only;\n      select pg_catalog.pg_is_in_recovery()\n    "],[],execute,null,{simple:!0});e.resolve=([[e],[t]])=>{B.default_transaction_read_only=e.transaction_read_only,B.in_hot_standby=t.pg_is_in_recovery?"on":"off"},e.execute()}();if(function(t,r){return"read-write"===t&&"on"===r.default_transaction_read_only||"read-only"===t&&"off"===r.default_transaction_read_only||"primary"===t&&"on"===r.in_hot_standby||"standby"===t&&"off"===r.in_hot_standby||"prefer-standby"===t&&"off"===r.in_hot_standby&&e.host[j]}(N,B))return terminate()}return $?(G.reserve&&(G=null),async function(){$=!1;const t=await new Query(["\n      select b.oid, b.typarray\n      from pg_catalog.pg_type a\n      left join pg_catalog.pg_type b on b.oid = a.typelem\n      where a.typcategory = 'A'\n      group by b.oid, b.typarray\n      order by b.oid\n    "],[],execute);t.forEach(({oid:t,typarray:r})=>function(t,r){if(e.parsers[r]&&e.serializers[r])return;const n=e.parsers[t];e.shared.typeArrayMap[t]=r,e.parsers[r]=e=>arrayParser(e,n,r),e.parsers[r].array=!0,e.serializers[r]=n=>Ed(n,e.serializers[t],e,r)}(t,r))}()):(G&&!G.reserve&&execute(G),e.shared.retries=j=0,void(G=null))}for(;T.length&&(ie=T.shift())&&(ie.active=!0,ie.cancelled);)Connection(e).cancel(ie.state,ie.cancelled.resolve,ie.cancelled.reject);ie||(oe.reserved?oe.reserved.release||73!==t[5]?oe.reserved():Y?terminate():(oe.reserved=null,r(oe)):Y?terminate():r(oe))}function CommandComplete(e){V=0;for(let t=e.length-1;t>0;t--)if(32===e[t]&&e[t+1]<58&&null===P.count&&(P.count=+e.toString("utf8",t+1,e.length-1)),e[t-1]>=65){P.command=e.toString("utf8",5,t),P.state=x;break}return se&&(se(),se=null),"BEGIN"!==P.command||1===o||oe.reserved?ie.options.simple?BindComplete():(ie.cursorFn&&(P.count&&ie.cursorFn(P),write(zd)),void ie.resolve(P)):errored(vd.generic("UNSAFE_TRANSACTION","Only use sql.begin, sql.reserved or max: 1"))}function ParseComplete(){ie.parsing=!1}function BindComplete(){!P.statement&&(P.statement=ie.statement),P.columns=ie.statement.columns}function ParameterDescription(e){const t=e.readUInt16BE(5);for(let r=0;r<t;++r)!ie.statement.types[r]&&(ie.statement.types[r]=e.readUInt32BE(7+4*r));ie.prepare&&(U[ie.signature]=ie.statement),ie.describeFirst&&!ie.onlyDescribe&&(write(prepared(ie)),ie.describeFirst=!1)}function RowDescription(e){P.command&&(Z=Z||[P],Z.push(P=new Result),P.count=null,ie.statement.columns=null);const t=e.readUInt16BE(5);let r,n=7;ie.statement.columns=Array(t);for(let i=0;i<t;++i){for(r=n;0!==e[n++];);const t=e.readUInt32BE(n),s=e.readUInt16BE(n+4),o=e.readUInt32BE(n+6);ie.statement.columns[i]={name:f.column.from?f.column.from(e.toString("utf8",r,n-1)):e.toString("utf8",r,n-1),parser:h[o],table:t,number:s,type:o},n+=18}if(P.statement=ie.statement,ie.onlyDescribe)return ie.resolve(ie.statement),write(zd)}async function Authentication(e,t=e.readUInt32BE(5)){(3===t?AuthenticationCleartextPassword:5===t?AuthenticationMD5Password:10===t?SASL:11===t?SASLContinue:12===t?SASLFinal:0!==t?UnknownAuth:noop$1)(e,t)}async function AuthenticationCleartextPassword(){const e=await Pass();write(Ud().p().str(e).z(1).end())}async function AuthenticationMD5Password(e){const t="md5"+await md5(d.concat([d.from(await md5(await Pass()+a)),e.subarray(9)]));write(Ud().p().str(t).z(1).end())}async function SASL(){re=(await crypto$1_randomBytes(18)).toString("base64"),Ud().p().str("SCRAM-SHA-256"+Ud.N);const e=Ud.i;write(Ud.inc(4).str("n,,n=*,r="+re).i32(Ud.i-e-4,e).end())}async function SASLContinue(e){const t=e.toString("utf8",9).split(",").reduce((e,t)=>(e[t[0]]=t.slice(2),e),{}),r=await crypto$1_pbkdf2Sync(await Pass(),d.from(t.s,"base64"),parseInt(t.i),32,"sha256"),n=await hmac(r,"Client Key"),i="n=*,r="+re+",r="+t.r+",s="+t.s+",i="+t.i+",c=biws,r="+t.r;F=(await hmac(await hmac(r,"Server Key"),i)).toString("base64");const s="c=biws,r="+t.r+",p="+function(e,t){const r=Math.max(e.length,t.length),n=d.allocUnsafe(r);for(let i=0;i<r;i++)n[i]=e[i]^t[i];return n}(n,d.from(await hmac(await function(e){return crypto$1_createHash("sha256").update(e).digest()}(n),i))).toString("base64");write(Ud().p().str(s).end())}function SASLFinal(e){e.toString("utf8",9).split(Ud.N,1)[0].slice(2)!==F&&(errored(vd.generic("SASL_SIGNATURE_MISMATCH","The server did not return the correct signature")),O.destroy())}function Pass(){return Promise.resolve("function"==typeof e.pass?e.pass():e.pass)}function NoData(){if(P.statement=ie.statement,P.statement.columns=[],ie.onlyDescribe)return ie.resolve(ie.statement),write(zd)}function BackendKeyData(e){x.pid=e.readUInt32BE(5),x.secret=e.readUInt32BE(9)}function ErrorResponse(e){ie&&(ie.cursorFn||ie.describeFirst)&&write(zd);const t=vd.postgres(parseError(e));ie&&ie.retried?errored(ie.retried):ie&&ie.prepared&&Md.has(t.routine)?function(e,t){delete U[e.signature],e.retried=t,execute(e)}(ie,t):errored(t)}function NotificationResponse(e){if(!g)return;let t=9;for(;0!==e[t++];);g(e.toString("utf8",9,t-1),e.toString("utf8",t,e.length-1))}async function PortalSuspended(){try{const e=await Promise.resolve(ie.cursorFn(P));V=0,e===bd?write(function(e=""){return d.concat([Ud().C().str("P").str(e+Ud.N).end(),Ud().S().end()])}(ie.portal)):(P=new Result,write(Execute("",ie.cursorRows)))}catch(e){write(zd),ie.reject(e)}}function CloseComplete(){P.count&&ie.cursorFn(P),ie.resolve(P)}function CopyInResponse(){X=new l.Writable({autoDestroy:!0,write(e,t,r){O.write(Ud().d().raw(e).end(),r)},destroy(e,t){t(e),O.write(Ud().f().str(e+Ud.N).end()),X=null},final(e){O.write(Ud().c().end()),se=e}}),ie.resolve(X)}function CopyOutResponse(){X=new l.Readable({read(){O.resume()}}),ie.resolve(X)}function CopyBothResponse(){X=new l.Duplex({autoDestroy:!0,read(){O.resume()},write(e,t,r){O.write(Ud().d().raw(e).end(),r)},destroy(e,t){t(e),O.write(Ud().f().str(e+Ud.N).end()),X=null},final(e){O.write(Ud().c().end()),se=e}}),ie.resolve(X)}function CopyData(e){X&&(X.push(e.subarray(5))||O.pause())}function CopyDone(){X&&X.push(null),X=null}function NoticeResponse(e){m?m(parseError(e)):console.log(parseError(e))}function EmptyQueryResponse(){}function FunctionCallResponse(){errored(vd.notSupported("FunctionCallResponse"))}function NegotiateProtocolVersion(){errored(vd.notSupported("NegotiateProtocolVersion"))}function UnknownMessage(e){console.error("Postgres.js : Unknown Message:",e[0])}function UnknownAuth(e,t){console.error("Postgres.js : Unknown Auth:",t)}function Bind(t,r,n="",i=""){let s,o;return Ud().B().str(i+Ud.N).str(n+Ud.N).i16(0).i16(t.length),t.forEach((n,i)=>{if(null===n)return Ud.i32(4294967295);o=r[i],t[i]=n=o in e.serializers?e.serializers[o](n):""+n,s=Ud.i,Ud.inc(4).str(n).i32(Ud.i-s-4,s)}),Ud.i16(0),Ud.end()}function Parse(e,t,r,n=""){return Ud().P().str(n+Ud.N).str(e+Ud.N).i16(t.length),t.forEach((e,t)=>Ud.i32(r[t]||0)),Ud.end()}function Describe(e,t=""){return Ud().D().str(e).str(t+Ud.N).end()}function Execute(e="",t=0){return d.concat([Ud().E().str(e+Ud.N).i32(t).end(),Dd])}}function parseError(e){const t={};let r=5;for(let n=5;n<e.length-1;n++)0===e[n]&&(t[Qd[e[r]]]=e.toString("utf8",r+1,n),r=n+1);return t}function md5(e){return crypto$1_createHash("md5").update(e).digest("hex")}function hmac(e,t){return crypto$1_createHmac("sha256",e).update(t).digest()}function timer(e,t){if(!(t="function"==typeof t?t():t))return{cancel:noop$1,start:noop$1};let r;return{cancel(){r&&(clearTimeout(r),r=null)},start(){r&&clearTimeout(r),r=setTimeout(done,1e3*t,arguments)}};function done(t){e.apply(null,t),r=null}}const noop=()=>{};function Subscribe(e,t){const r=new Map,n="postgresjs_"+Math.random().toString(36).slice(2),i={};let s,o,a=!1;const c=subscribe.sql=e({...t,transform:{column:{},value:{},row:{}},max:1,fetch_types:!1,idle_timeout:null,max_lifetime:null,connection:{...t.connection,replication:"database"},onclose:async function(){a||(o=null,i.pid=i.secret=void 0,connected(await init(c,n,t.publications)),r.forEach(e=>e.forEach(({onsubscribe:e})=>e())))},no_subscribe:!0}),l=c.end,u=c.close;return c.end=async()=>(a=!0,o&&await new Promise(e=>(o.once("close",e),o.end())),l()),c.close=async()=>(o&&await new Promise(e=>(o.once("close",e),o.end())),u()),subscribe;async function subscribe(e,a,d=noop,l=noop){e=function(e){const t=e.match(/^(\*|insert|update|delete)?:?([^.]+?\.?[^=]+)?=?(.+)?/i)||[];if(!t)throw new Error("Malformed subscribe pattern: "+e);const[,r,n,i]=t;return(r||"*")+(n?":"+(-1===n.indexOf(".")?"public."+n:n):"")+(i?"="+i:"")}(e),s||(s=init(c,n,t.publications));const u={fn:a,onsubscribe:d},p=r.has(e)?r.get(e).add(u):r.set(e,new Set([u])).get(e),unsubscribe=()=>{p.delete(u),0===p.size&&r.delete(e)};return s.then(e=>(connected(e),d(),o&&o.on("error",l),{unsubscribe:unsubscribe,state:i,sql:c}))}function connected(e){o=e.stream,i.pid=e.state.pid,i.secret=e.state.secret}async function init(e,r,n){if(!n)throw new Error("Missing publication names");const i=await e.unsafe(`CREATE_REPLICATION_SLOT ${r} TEMPORARY LOGICAL pgoutput NOEXPORT_SNAPSHOT`),[s]=i,o=await e.unsafe(`START_REPLICATION SLOT ${r} LOGICAL ${s.consistent_point} (proto_version '1', publication_names '${n}')`).writable(),a={lsn:d.concat(s.consistent_point.split("/").map(e=>d.from(("00000000"+e).slice(-8),"hex")))};return o.on("data",function(r){119===r[0]?function(e,t,r,n,i){const char=(e,[t,r])=>(e[t.charCodeAt(0)]=r,e);Object.entries({R:e=>{let n=1;const s=t[e.readUInt32BE(n)]={schema:e.toString("utf8",n+=4,n=e.indexOf(0,n))||"pg_catalog",table:e.toString("utf8",n+1,n=e.indexOf(0,n+1)),columns:Array(e.readUInt16BE(n+=2)),keys:[]};n+=2;let o,a=0;for(;n<e.length;)o=s.columns[a++]={key:e[n++],name:i.column.from?i.column.from(e.toString("utf8",n,n=e.indexOf(0,n))):e.toString("utf8",n,n=e.indexOf(0,n)),type:e.readUInt32BE(n+=1),parser:r[e.readUInt32BE(n)],atttypmod:e.readUInt32BE(n+=4)},o.key&&s.keys.push(o),n+=4},Y:()=>{},O:()=>{},B:e=>{t.date=function(e){return new Date(Date.UTC(2e3,0,1)+Number(e/BigInt(1e3)))}(e.readBigInt64BE(9)),t.lsn=e.subarray(1,9)},I:e=>{let r=1;const s=t[e.readUInt32BE(r)],{row:o}=tuples(e,s.columns,r+=7,i);n(o,{command:"insert",relation:s})},D:e=>{let r=1;const s=t[e.readUInt32BE(r)];r+=4;const o=75===e[r];n(o||79===e[r]?tuples(e,s.columns,r+=3,i).row:null,{command:"delete",relation:s,key:o})},U:e=>{let r=1;const s=t[e.readUInt32BE(r)];r+=4;const o=75===e[r],a=o||79===e[r]?tuples(e,s.columns,r+=3,i):null;a&&(r=a.i);const{row:c}=tuples(e,s.columns,r+3,i);n(c,{command:"update",relation:s,key:o,old:a&&a.row})},T:()=>{},C:()=>{}}).reduce(char,{})[e[0]](e)}(r.subarray(25),a,e.options.parsers,handle,t.transform):107===r[0]&&r[17]&&(a.lsn=r.subarray(1,9),function(){const e=d.alloc(34);e[0]="r".charCodeAt(0),e.fill(a.lsn,1),e.writeBigInt64BE(BigInt(Date.now()-Date.UTC(2e3,0,1))*BigInt(1e3),25),o.write(e)}())}),o.on("error",function(e){console.error("Unexpected error during logical streaming - reconnecting",e)}),o.on("close",e.close),{stream:o,state:i.state};function handle(e,t){const r=t.relation.schema+"."+t.relation.table;call("*",e,t),call("*:"+r,e,t),t.relation.keys.length&&call("*:"+r+"="+t.relation.keys.map(t=>e[t.name]),e,t),call(t.command,e,t),call(t.command+":"+r,e,t),t.relation.keys.length&&call(t.command+":"+r+"="+t.relation.keys.map(t=>e[t.name]),e,t)}}function call(e,t,n){r.has(e)&&r.get(e).forEach(({fn:r})=>r(t,n,e))}}function tuples(e,t,r,n){let i,s,o;const a=n.raw?new Array(t.length):{};for(let c=0;c<t.length;c++)i=e[r++],s=t[c],o=110===i?null:117===i?void 0:void 0===s.parser?e.toString("utf8",r+4,r+=4+e.readUInt32BE(r)):!0===s.parser.array?s.parser(e.toString("utf8",r+5,r+=4+e.readUInt32BE(r))):s.parser(e.toString("utf8",r+4,r+=4+e.readUInt32BE(r))),n.raw?a[c]=!0===n.raw?o:n.value.from?n.value.from(o,s):o:a[s.name]=n.value.from?n.value.from(o,s):o;return{i:r,row:n.row.from?n.row.from(a):a}}function largeObject(e,t,r=393216){return new Promise(async(n,i)=>{await e.begin(async e=>{let i;!t&&([{oid:t}]=await(e`select lo_creat(-1) as oid`));const[{fd:s}]=await(e`select lo_open(${t}, ${r}) as fd`),o={writable:async function({highWaterMark:e=16384,start:t=0}={}){return t&&await o.seek(t),new l.Writable({highWaterMark:e,write(e,t,r){o.write(e).then(()=>r(),r)}})},readable:async function({highWaterMark:e=16384,start:t=0,end:r=1/0}={}){let n=r-t;return t&&await o.seek(t),new l.Readable({highWaterMark:e,async read(e){const t=e>n?e-n:e;n-=e;const[{data:r}]=await o.read(t);this.push(r),r.length<e&&this.push(null)}})},close:()=>e`select lo_close(${s})`.then(i),tell:()=>e`select lo_tell64(${s})`,read:t=>e`select loread(${s}, ${t}) as data`,write:t=>e`select lowrite(${s}, ${t})`,truncate:t=>e`select lo_truncate64(${s}, ${t})`,seek:(t,r=0)=>e`select lo_lseek64(${s}, ${t}, ${r})`,size:()=>e`
          select
            lo_lseek64(${s}, location, 0) as position,
            seek.size
          from (
            select
              lo_lseek64($1, 0, 2) as size,
              tell.location
            from (select lo_tell64($1) as location) tell
          ) seek
        `};return n(o),new Promise(async e=>i=e)}).catch(i)})}function Postgres(e,t){const r=function(e,t){if(e&&e.shared)return e;const r=ud.env,n=(e&&"string"!=typeof e?e:t)||{},{url:i,multihost:s}=function(e){if(!e||"string"!=typeof e)return{url:{searchParams:new Map}};let t=e;t=t.slice(t.indexOf("://")+3).split(/[?/]/)[0],t=decodeURIComponent(t.slice(t.indexOf("@")+1));const r=new URL(e.replace(t,t.split(",")[0]));return{url:{username:decodeURIComponent(r.username),password:decodeURIComponent(r.password),host:r.host,hostname:r.hostname,port:r.port,pathname:r.pathname,searchParams:r.searchParams},multihost:t.indexOf(",")>-1&&t}}(e),o=[...i.searchParams].reduce((e,[t,r])=>(e[t]=r,e),{}),a=n.hostname||n.host||s||i.hostname||r.PGHOST||"localhost",c=n.port||i.port||r.PGPORT||5432,d=n.user||n.username||i.username||r.PGUSERNAME||r.PGUSER||function(){try{return pd.userInfo().username}catch(e){return ud.env.USERNAME||ud.env.USER||ud.env.LOGNAME}}();n.no_prepare&&(n.prepare=!1),o.sslmode&&(o.ssl=o.sslmode,delete o.sslmode),"timeout"in n&&(console.log("The timeout option is deprecated, use idle_timeout instead"),n.idle_timeout=n.timeout),"system"===o.sslrootcert&&(o.ssl="verify-full");const l=["idle_timeout","connect_timeout","max_lifetime","max_pipeline","backoff","keep_alive"],u={max:10,ssl:!1,idle_timeout:null,connect_timeout:30,max_lifetime:max_lifetime,max_pipeline:100,backoff:backoff,keep_alive:60,prepare:!0,debug:!1,fetch_types:!0,publications:"alltables",target_session_attrs:null};return{host:Array.isArray(a)?a:a.split(",").map(e=>e.split(":")[0]),port:Array.isArray(c)?c:a.split(",").map(e=>parseInt(e.split(":")[1]||c)),path:n.path||a.indexOf("/")>-1&&a+"/.s.PGSQL."+c,database:n.database||n.db||(i.pathname||"").slice(1)||r.PGDATABASE||d,user:d,pass:n.pass||n.password||i.password||r.PGPASSWORD||"",...Object.entries(u).reduce((e,[t,i])=>{const s=t in n?n[t]:t in o?"disable"!==o[t]&&"false"!==o[t]&&o[t]:r["PG"+t.toUpperCase()]||i;return e[t]="string"==typeof s&&l.includes(t)?+s:s,e},{}),connection:{application_name:r.PGAPPNAME||"postgres.js",...n.connection,...Object.entries(o).reduce((e,[t,r])=>(t in u||(e[t]=r),e),{})},types:n.types||{},target_session_attrs:tsa(n,i,r),onnotice:n.onnotice,onnotify:n.onnotify,onclose:n.onclose,onparameter:n.onparameter,socket:n.socket,transform:parseTransform(n.transform||{undefined:void 0}),parameters:{},shared:{retries:0,typeArrayMap:{}},...mergeUserTypes(n.types)}}(e,t),n=r.no_subscribe||Subscribe(Postgres,{...r});let i=!1;const s=Queue(),o=Queue(),a=Queue(),c=Queue(),d=Queue(),l=Queue(),u=Queue(),p=Queue(),h={connecting:o,closed:c},f=[...Array(r.max)].map(()=>Connection(r,h,{onopen:onopen,onend:onend,onclose:onclose})),m=Sql(function(e){if(i)return e.reject(vd.connection("CONNECTION_ENDED",r,r));if(l.length)return go(l.shift(),e);if(c.length)return connect(c.shift(),e);u.length?go(u.shift(),e):s.push(e)});return Object.assign(m,{get parameters(){return r.parameters},largeObject:largeObject.bind(null,m),subscribe:n,CLOSE:bd,END:bd,PostgresError:PostgresError,options:r,reserve:async function(){const e=Queue(),t=l.length?l.shift():await new Promise((e,t)=>{const r={reserve:e,reject:t};s.push(r),c.length&&connect(c.shift(),r)});move(t,a),t.reserved=()=>e.length?t.execute(e.shift()):move(t,a),t.reserved.release=!0;const r=Sql(function(r){t.queue===p?e.push(r):t.execute(r)||move(t,p)});return r.release=()=>{t.reserved=null,onopen(t)},r},listen:listen,begin:async function(e,t){!t&&(t=e,e="");const r=Queue();let n,i=0,s=null;try{return await m.unsafe("begin "+e.replace(/[^a-z ]/gi,""),[],{onexecute:function(e){n=e,move(e,a),e.reserved=()=>r.length?e.execute(r.shift()):move(e,a)}}).execute(),await Promise.race([async function scope(e,t,n){const o=Sql(handler);let a,c;o.savepoint=savepoint,o.prepare=e=>s=e.replace(/[^a-z0-9$-_. ]/gi),n&&await(o`savepoint ${o(n)}`);try{if(c=await new Promise((e,r)=>{const n=t(o);Promise.resolve(Array.isArray(n)?Promise.all(n):n).then(e,r)}),a)throw a}catch(e){throw await(n?o`rollback to ${o(n)}`:o`rollback`),e instanceof PostgresError&&"25P02"===e.code&&a||e}n||(s?await(o`prepare transaction '${o.unsafe(s)}'`):await(o`commit`));return c;function savepoint(t,r){return t&&Array.isArray(t.raw)?savepoint(e=>e.apply(e,arguments)):(1===arguments.length&&(r=t,t=null),scope(e,r,"s"+i+++(t?"_"+t:"")))}function handler(t){t.catch(e=>a||(a=e)),e.queue===p?r.push(t):e.execute(t)||move(e,p)}}(n,t),new Promise((e,t)=>n.onclose=t)])}catch(e){throw e}},close:async function(){await Promise.all(f.map(e=>e.end()))},end:async function({timeout:e=null}={}){if(i)return i;let t;return await 1,i=Promise.race([new Promise(r=>null!==e&&(t=setTimeout(destroy,1e3*e,r))),Promise.all(f.map(e=>e.end()).concat(listen.sql?listen.sql.end({timeout:0}):[],n.sql?n.sql.end({timeout:0}):[]))]).then(()=>clearTimeout(t))}}),m;function Sql(e){return e.debug=r.debug,Object.entries(r.types).reduce((e,[t,r])=>(e[t]=e=>new Parameter(e,r.to),e),typed),Object.assign(sql,{types:typed,typed:typed,unsafe:function(t,r=[],n={}){2===arguments.length&&!Array.isArray(r)&&(n=r,r=[]);const i=new Query([t],r,e,cancel,{prepare:!1,...n,simple:"simple"in n?n.simple:0===r.length});return i},notify:notify,array:array,json:json,file:function(t,r=[],n={}){2===arguments.length&&!Array.isArray(r)&&(n=r,r=[]);const i=new Query([],r,r=>{hd.readFile(t,"utf8",(t,n)=>{if(t)return r.reject(t);r.strings=[n],e(r)})},cancel,{...n,simple:"simple"in n?n.simple:0===r.length});return i}}),sql;function typed(e,t){return new Parameter(e,t)}function sql(t,...n){return t&&Array.isArray(t.raw)?new Query(t,n,e,cancel):"string"!=typeof t||n.length?new Builder(t,n):new Identifier(r.transform.column.to?r.transform.column.to(t):t)}}async function listen(e,t,n){const i={fn:t,onlisten:n},s=listen.sql||(listen.sql=Postgres({...r,max:1,idle_timeout:null,max_lifetime:null,fetch_types:!1,onclose(){Object.entries(listen.channels).forEach(([e,{listeners:t}])=>{delete listen.channels[e],Promise.all(t.map(t=>listen(e,t.fn,t.onlisten).catch(()=>{})))})},onnotify(e,t){e in listen.channels&&listen.channels[e].listeners.forEach(e=>e.fn(t))}})),o=listen.channels||(listen.channels={});if(e in o){o[e].listeners.push(i);const t=await o[e].result;return i.onlisten&&i.onlisten(),{state:t.state,unlisten:unlisten}}o[e]={result:s`listen ${s.unsafe('"'+e.replace(/"/g,'""')+'"')}`,listeners:[i]};const a=await o[e].result;return i.onlisten&&i.onlisten(),{state:a.state,unlisten:unlisten};async function unlisten(){if(e in o!=!1&&(o[e].listeners=o[e].listeners.filter(e=>e!==i),!o[e].listeners.length))return delete o[e],s`unlisten ${s.unsafe('"'+e.replace(/"/g,'""')+'"')}`}}async function notify(e,t){return await(m`select pg_notify(${e}, ${""+t})`)}function move(e,t){return e.queue.remove(e),t.push(e),e.queue=t,t===l?e.idleTimer.start():e.idleTimer.cancel(),e}function json(e){return new Parameter(e,3802)}function array(e,t){return Array.isArray(e)?new Parameter(e,t||(e.length?_d(e)||25:0),r.shared.typeArrayMap):array(Array.from(arguments))}function go(e,t){return e.execute(t)?move(e,u):move(e,p)}function cancel(e){return new Promise((t,n)=>{e.state?e.active?Connection(r).cancel(e.state,t,n):e.cancelled={resolve:t,reject:n}:(s.remove(e),e.cancelled=!0,e.reject(vd.generic("57014","canceling statement due to user request")),t())})}async function destroy(e){for(await Promise.all(f.map(e=>e.terminate()));s.length;)s.shift().reject(vd.connection("CONNECTION_DESTROYED",r));e()}function connect(e,t){return move(e,o),e.connect(t),e}function onend(e){move(e,d)}function onopen(e){if(0===s.length)return move(e,l);let t=Math.ceil(s.length/(o.length+1)),r=!0;for(;r&&s.length&&t-- >0;){const t=s.shift();if(t.reserve)return t.reserve(e);r=e.execute(t)}move(e,r?u:p)}function onclose(e,t){move(e,c),e.reserved=null,e.onclose&&(e.onclose(t),e.onclose=null),r.onclose&&r.onclose(e.id),s.length&&connect(e,s.shift())}}function tsa(e,t,r){const n=e.target_session_attrs||t.searchParams.get("target_session_attrs")||r.PGTARGETSESSIONATTRS;if(!n||["read-write","read-only","primary","standby","prefer-standby"].includes(n))return n;throw new Error("target_session_attrs "+n+" is not supported")}function backoff(e){return(.5+Math.random()/2)*Math.min(3**e/100,20)}function max_lifetime(){return 60*(30+30*Math.random())}function parseTransform(e){return{undefined:e.undefined,column:{from:"function"==typeof e.column?e.column:e.column&&e.column.from,to:e.column&&e.column.to},value:{from:"function"==typeof e.value?e.value:e.value&&e.value.from,to:e.value&&e.value.to},row:{from:"function"==typeof e.row?e.row:e.row&&e.row.from,to:e.row&&e.row.to}}}Object.assign(Postgres,{PostgresError:PostgresError,toPascal:toPascal,pascal:Pd,toCamel:toCamel,camel:Od,toKebab:toKebab,kebab:Rd,fromPascal:fromPascal,fromCamel:fromCamel,fromKebab:fromKebab,BigInt:{to:20,from:[20],parse:e=>BigInt(e),serialize:e=>e.toString()}});class SelectionProxyHandler{static[Uc]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,t){if("_"===t)return{...e._,selectedFields:new Proxy(e._.selectedFields,this)};if(t===qc)return{...e[qc],selectedFields:new Proxy(e[qc].selectedFields,this)};if("symbol"==typeof t)return e[t];const r=(is(e,Subquery)?e._.selectedFields:is(e,View)?e[qc].selectedFields:e)[t];if(is(r,SQL.Aliased)){if("sql"===this.config.sqlAliasedBehavior&&!r.isSelectionField)return r.sql;const e=r.clone();return e.isSelectionField=!0,e}if(is(r,SQL)){if("sql"===this.config.sqlBehavior)return r;throw new Error(`You tried to reference "${t}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return is(r,Column)?this.config.alias?new Proxy(r,new ColumnAliasProxyHandler(new Proxy(r.table,new TableAliasProxyHandler(this.config.alias,this.config.replaceOriginalName??!1)))):r:"object"!=typeof r||null===r?r:new Proxy(r,new SelectionProxyHandler(this.config))}}function toSnakeCase(e){return(e.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).map(e=>e.toLowerCase()).join("_")}function toCamelCase(e){return(e.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).reduce((e,t,r)=>e+(0===r?t.toLowerCase():`${t[0].toUpperCase()}${t.slice(1)}`),"")}function noopCase(e){return e}class CasingCache{static[Uc]="CasingCache";cache={};cachedTables={};convert;constructor(e){this.convert="snake_case"===e?toSnakeCase:"camelCase"===e?toCamelCase:noopCase}getColumnCasing(e){if(!e.keyAsName)return e.name;const t=`${e.table[Table.Symbol.Schema]??"public"}.${e.table[Table.Symbol.OriginalName]}.${e.name}`;return this.cache[t]||this.cacheTable(e.table),this.cache[t]}cacheTable(e){const t=`${e[Table.Symbol.Schema]??"public"}.${e[Table.Symbol.OriginalName]}`;if(!this.cachedTables[t]){for(const r of Object.values(e[Table.Symbol.Columns])){const e=`${t}.${r.name}`;this.cache[e]=this.convert(r.name)}this.cachedTables[t]=!0}}clearCache(){this.cache={},this.cachedTables={}}}class PgViewBase extends View{static[Uc]="PgViewBase"}class PgDialect{static[Uc]="PgDialect";casing;constructor(e){this.casing=new CasingCache(e?.casing)}async migrate(e,t,r){const n="string"==typeof r?"__drizzle_migrations":r.migrationsTable??"__drizzle_migrations",i="string"==typeof r?"drizzle":r.migrationsSchema??"drizzle",s=sql`
			CREATE TABLE IF NOT EXISTS ${sql.identifier(i)}.${sql.identifier(n)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at bigint
			)
		`;await t.execute(sql`CREATE SCHEMA IF NOT EXISTS ${sql.identifier(i)}`),await t.execute(s);const o=(await t.all(sql`select id, hash, created_at from ${sql.identifier(i)}.${sql.identifier(n)} order by created_at desc limit 1`))[0];await t.transaction(async t=>{for await(const r of e)if(!o||Number(o.created_at)<r.folderMillis){for(const e of r.sql)await t.execute(sql.raw(e));await t.execute(sql`insert into ${sql.identifier(i)}.${sql.identifier(n)} ("hash", "created_at") values(${r.hash}, ${r.folderMillis})`)}})}escapeName(e){return`"${e}"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;const t=[sql`with `];for(const[r,n]of e.entries())t.push(sql`${sql.identifier(n._.alias)} as (${n._.sql})`),r<e.length-1&&t.push(sql`, `);return t.push(sql` `),sql.join(t)}buildDeleteQuery({table:e,where:t,returning:r,withList:n}){return sql`${this.buildWithCTE(n)}delete from ${e}${t?sql` where ${t}`:void 0}${r?sql` returning ${this.buildSelection(r,{isSingleTable:!0})}`:void 0}`}buildUpdateSet(e,t){const r=e[Table.Symbol.Columns],n=Object.keys(r).filter(e=>void 0!==t[e]||void 0!==r[e]?.onUpdateFn),i=n.length;return sql.join(n.flatMap((e,n)=>{const s=r[e],o=t[e]??sql.param(s.onUpdateFn(),s),a=sql`${sql.identifier(this.casing.getColumnCasing(s))} = ${o}`;return n<i-1?[a,sql.raw(", ")]:[a]}))}buildUpdateQuery({table:e,set:t,where:r,returning:n,withList:i,from:s,joins:o}){const a=this.buildWithCTE(i),c=e[PgTable.Symbol.Name],d=e[PgTable.Symbol.Schema],l=e[PgTable.Symbol.OriginalName],u=c===l?void 0:c,p=sql`${d?sql`${sql.identifier(d)}.`:void 0}${sql.identifier(l)}${u&&sql` ${sql.identifier(u)}`}`,h=this.buildUpdateSet(e,t),f=s&&sql.join([sql.raw(" from "),this.buildFromTable(s)]);return sql`${a}update ${p} set ${h}${f}${this.buildJoins(o)}${r?sql` where ${r}`:void 0}${n?sql` returning ${this.buildSelection(n,{isSingleTable:!s})}`:void 0}`}buildSelection(e,{isSingleTable:t=!1}={}){const r=e.length,n=e.flatMap(({field:e},n)=>{const i=[];if(is(e,SQL.Aliased)&&e.isSelectionField)i.push(sql.identifier(e.fieldAlias));else if(is(e,SQL.Aliased)||is(e,SQL)){const r=is(e,SQL.Aliased)?e.sql:e;t?i.push(new SQL(r.queryChunks.map(e=>is(e,PgColumn)?sql.identifier(this.casing.getColumnCasing(e)):e))):i.push(r),is(e,SQL.Aliased)&&i.push(sql` as ${sql.identifier(e.fieldAlias)}`)}else is(e,Column)&&(t?i.push(sql.identifier(this.casing.getColumnCasing(e))):i.push(e));return n<r-1&&i.push(sql`, `),i});return sql.join(n)}buildJoins(e){if(!e||0===e.length)return;const t=[];for(const[r,n]of e.entries()){0===r&&t.push(sql` `);const i=n.table,s=n.lateral?sql` lateral`:void 0,o=n.on?sql` on ${n.on}`:void 0;if(is(i,PgTable)){const e=i[PgTable.Symbol.Name],r=i[PgTable.Symbol.Schema],a=i[PgTable.Symbol.OriginalName],c=e===a?void 0:n.alias;t.push(sql`${sql.raw(n.joinType)} join${s} ${r?sql`${sql.identifier(r)}.`:void 0}${sql.identifier(a)}${c&&sql` ${sql.identifier(c)}`}${o}`)}else if(is(i,View)){const e=i[qc].name,r=i[qc].schema,a=i[qc].originalName,c=e===a?void 0:n.alias;t.push(sql`${sql.raw(n.joinType)} join${s} ${r?sql`${sql.identifier(r)}.`:void 0}${sql.identifier(a)}${c&&sql` ${sql.identifier(c)}`}${o}`)}else t.push(sql`${sql.raw(n.joinType)} join${s} ${i}${o}`);r<e.length-1&&t.push(sql` `)}return sql.join(t)}buildFromTable(e){if(is(e,Table)&&e[Table.Symbol.IsAlias]){let t=sql`${sql.identifier(e[Table.Symbol.OriginalName])}`;return e[Table.Symbol.Schema]&&(t=sql`${sql.identifier(e[Table.Symbol.Schema])}.${t}`),sql`${t} ${sql.identifier(e[Table.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:t,fieldsFlat:r,where:n,having:i,table:s,joins:o,orderBy:a,groupBy:c,limit:d,offset:l,lockingClause:u,distinct:p,setOperators:h}){const f=r??orderSelectedFields(t);for(const e of f)if(is(e.field,Column)&&getTableName(e.field.table)!==(is(s,Subquery)?s._.alias:is(s,PgViewBase)?s[qc].name:is(s,SQL)?void 0:getTableName(s))&&!(e=>o?.some(({alias:t})=>t===(e[Table.Symbol.IsAlias]?getTableName(e):e[Table.Symbol.BaseName])))(e.field.table)){const t=getTableName(e.field.table);throw new Error(`Your "${e.path.join("->")}" field references a column "${t}"."${e.field.name}", but the table "${t}" is not part of the query! Did you forget to join it?`)}const m=!o||0===o.length,g=this.buildWithCTE(e);let y;p&&(y=!0===p?sql` distinct`:sql` distinct on (${sql.join(p.on,sql`, `)})`);const w=this.buildSelection(f,{isSingleTable:m}),b=this.buildFromTable(s),v=this.buildJoins(o),N=n?sql` where ${n}`:void 0,T=i?sql` having ${i}`:void 0;let k,x;a&&a.length>0&&(k=sql` order by ${sql.join(a,sql`, `)}`),c&&c.length>0&&(x=sql` group by ${sql.join(c,sql`, `)}`);const S="object"==typeof d||"number"==typeof d&&d>=0?sql` limit ${d}`:void 0,A=l?sql` offset ${l}`:void 0,I=sql.empty();if(u){const e=sql` for ${sql.raw(u.strength)}`;u.config.of&&e.append(sql` of ${sql.join(Array.isArray(u.config.of)?u.config.of:[u.config.of],sql`, `)}`),u.config.noWait?e.append(sql` nowait`):u.config.skipLocked&&e.append(sql` skip locked`),I.append(e)}const E=sql`${g}select${y} ${w} from ${b}${v}${N}${x}${T}${k}${S}${A}${I}`;return h.length>0?this.buildSetOperations(E,h):E}buildSetOperations(e,t){const[r,...n]=t;if(!r)throw new Error("Cannot pass undefined values to any set operator");return 0===n.length?this.buildSetOperationQuery({leftSelect:e,setOperator:r}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:r}),n)}buildSetOperationQuery({leftSelect:e,setOperator:{type:t,isAll:r,rightSelect:n,limit:i,orderBy:s,offset:o}}){const a=sql`(${e.getSQL()}) `,c=sql`(${n.getSQL()})`;let d;if(s&&s.length>0){const e=[];for(const t of s)if(is(t,PgColumn))e.push(sql.identifier(t.name));else if(is(t,SQL)){for(let e=0;e<t.queryChunks.length;e++){const r=t.queryChunks[e];is(r,PgColumn)&&(t.queryChunks[e]=sql.identifier(r.name))}e.push(sql`${t}`)}else e.push(sql`${t}`);d=sql` order by ${sql.join(e,sql`, `)} `}const l="object"==typeof i||"number"==typeof i&&i>=0?sql` limit ${i}`:void 0,u=sql.raw(`${t} ${r?"all ":""}`);return sql`${a}${u}${c}${d}${l}${o?sql` offset ${o}`:void 0}`}buildInsertQuery({table:e,values:t,onConflict:r,returning:n,withList:i,select:s,overridingSystemValue_:o}){const a=[],c=e[Table.Symbol.Columns],d=Object.entries(c).filter(([e,t])=>!t.shouldDisableInsert()),l=d.map(([,e])=>sql.identifier(this.casing.getColumnCasing(e)));if(s){const e=t;is(e,SQL)?a.push(e):a.push(e.getSQL())}else{const e=t;a.push(sql.raw("values "));for(const[t,r]of e.entries()){const n=[];for(const[e,t]of d){const i=r[e];if(void 0===i||is(i,Param)&&void 0===i.value)if(void 0!==t.defaultFn){const e=t.defaultFn(),r=is(e,SQL)?e:sql.param(e,t);n.push(r)}else if(t.default||void 0===t.onUpdateFn)n.push(sql`default`);else{const e=t.onUpdateFn(),r=is(e,SQL)?e:sql.param(e,t);n.push(r)}else n.push(i)}a.push(n),t<e.length-1&&a.push(sql`, `)}}const u=this.buildWithCTE(i),p=sql.join(a);return sql`${u}insert into ${e} ${l} ${!0===o?sql`overriding system value `:void 0}${p}${r?sql` on conflict ${r}`:void 0}${n?sql` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0}`}buildRefreshMaterializedViewQuery({view:e,concurrently:t,withNoData:r}){return sql`refresh materialized view${t?sql` concurrently`:void 0} ${e}${r?sql` with no data`:void 0}`}prepareTyping(e){return is(e,PgJsonb)||is(e,PgJson)?"json":is(e,PgNumeric)?"decimal":is(e,PgTime)?"time":is(e,PgTimestamp)||is(e,PgTimestampString)?"timestamp":is(e,PgDate)||is(e,PgDateString)?"date":is(e,PgUUID)?"uuid":"none"}sqlToQuery(e,t){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:t})}buildRelationalQueryWithoutPK({fullSchema:e,schema:t,tableNamesMap:r,table:n,tableConfig:i,queryConfig:s,tableAlias:o,nestedQueryRelation:a,joinOn:c}){let d,l,u,p=[],h=[];const f=[];if(!0===s){p=Object.entries(i.columns).map(([e,t])=>({dbKey:t.name,tsKey:e,field:aliasedTableColumn(t,o),relationTableTsKey:void 0,isJson:!1,selection:[]}))}else{const n=Object.fromEntries(Object.entries(i.columns).map(([e,t])=>[e,aliasedTableColumn(t,o)]));if(s.where){const e="function"==typeof s.where?s.where(n,{and:and,between:between,eq:eq,exists:exists,gt:gt,gte:gte,ilike:ilike,inArray:inArray,isNull:isNull,isNotNull:isNotNull,like:like,lt:lt,lte:lte,ne:ne,not:not,notBetween:notBetween,notExists:notExists,notLike:notLike,notIlike:notIlike,notInArray:notInArray,or:or,sql:sql}):s.where;u=e&&mapColumnsInSQLToAlias(e,o)}const a=[];let c=[];if(s.columns){let e=!1;for(const[t,r]of Object.entries(s.columns))void 0!==r&&t in i.columns&&(e||!0!==r||(e=!0),c.push(t));c.length>0&&(c=e?c.filter(e=>!0===s.columns?.[e]):Object.keys(i.columns).filter(e=>!c.includes(e)))}else c=Object.keys(i.columns);for(const e of c){const t=i.columns[e];a.push({tsKey:e,value:t})}let m,g=[];if(s.with&&(g=Object.entries(s.with).filter(e=>!!e[1]).map(([e,t])=>({tsKey:e,queryConfig:t,relation:i.relations[e]}))),s.extras){m="function"==typeof s.extras?s.extras(n,{sql:sql}):s.extras;for(const[e,t]of Object.entries(m))a.push({tsKey:e,value:mapColumnsInAliasedSQLToAlias(t,o)})}for(const{tsKey:e,value:t}of a)p.push({dbKey:is(t,SQL.Aliased)?t.fieldAlias:i.columns[e].name,tsKey:e,field:is(t,Column)?aliasedTableColumn(t,o):t,relationTableTsKey:void 0,isJson:!1,selection:[]});let y="function"==typeof s.orderBy?s.orderBy(n,{sql:sql,asc:asc,desc:desc}):s.orderBy??[];Array.isArray(y)||(y=[y]),h=y.map(e=>is(e,Column)?aliasedTableColumn(e,o):mapColumnsInSQLToAlias(e,o)),d=s.limit,l=s.offset;for(const{tsKey:n,queryConfig:i,relation:s}of g){const a=normalizeRelation(t,r,s),c=r[getTableUniqueName(s.referencedTable)],d=`${o}_${n}`,l=and(...a.fields.map((e,t)=>eq(aliasedTableColumn(a.references[t],d),aliasedTableColumn(e,o)))),u=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:t,tableNamesMap:r,table:e[c],tableConfig:t[c],queryConfig:is(s,One)?!0===i?{limit:1}:{...i,limit:1}:i,tableAlias:d,joinOn:l,nestedQueryRelation:s}),h=sql`${sql.identifier(d)}.${sql.identifier("data")}`.as(n);f.push({on:sql`true`,table:new Subquery(u.sql,{},d),alias:d,joinType:"left",lateral:!0}),p.push({dbKey:n,tsKey:n,field:h,relationTableTsKey:c,isJson:!0,selection:u.selection})}}if(0===p.length)throw new DrizzleError({message:`No fields selected for table "${i.tsName}" ("${o}")`});let m;if(u=and(c,u),a){let e=sql`json_build_array(${sql.join(p.map(({field:e,tsKey:t,isJson:r})=>r?sql`${sql.identifier(`${o}_${t}`)}.${sql.identifier("data")}`:is(e,SQL.Aliased)?e.sql:e),sql`, `)})`;is(a,Many)&&(e=sql`coalesce(json_agg(${e}${h.length>0?sql` order by ${sql.join(h,sql`, `)}`:void 0}), '[]'::json)`);const t=[{dbKey:"data",tsKey:"data",field:e.as("data"),isJson:!0,relationTableTsKey:i.tsName,selection:p}];void 0!==d||void 0!==l||h.length>0?(m=this.buildSelectQuery({table:aliasedTable(n,o),fields:{},fieldsFlat:[{path:[],field:sql.raw("*")}],where:u,limit:d,offset:l,orderBy:h,setOperators:[]}),u=void 0,d=void 0,l=void 0,h=[]):m=aliasedTable(n,o),m=this.buildSelectQuery({table:is(m,PgTable)?m:new Subquery(m,{},o),fields:{},fieldsFlat:t.map(({field:e})=>({path:[],field:is(e,Column)?aliasedTableColumn(e,o):e})),joins:f,where:u,limit:d,offset:l,orderBy:h,setOperators:[]})}else m=this.buildSelectQuery({table:aliasedTable(n,o),fields:{},fieldsFlat:p.map(({field:e})=>({path:[],field:is(e,Column)?aliasedTableColumn(e,o):e})),joins:f,where:u,limit:d,offset:l,orderBy:h,setOperators:[]});return{tableTsKey:i.tsName,sql:m,selection:p}}}class TypedQueryBuilder{static[Uc]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}}class PgSelectBuilder{static[Uc]="PgSelectBuilder";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){const t=!!this.fields,r=e;let n;return n=this.fields?this.fields:is(r,Subquery)?Object.fromEntries(Object.keys(r._.selectedFields).map(e=>[e,r[e]])):is(r,PgViewBase)?r[qc].selectedFields:is(r,SQL)?{}:r[Table.Symbol.Columns],new PgSelectBase({table:r,fields:n,isPartialSelect:t,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}}class PgSelectQueryBuilderBase extends TypedQueryBuilder{static[Uc]="PgSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;cacheConfig=void 0;usedTables=new Set;constructor({table:e,fields:t,isPartialSelect:r,session:n,dialect:i,withList:s,distinct:o}){super(),this.config={withList:s,table:e,fields:{...t},distinct:o,setOperators:[]},this.isPartialSelect=r,this.session=n,this.dialect=i,this._={selectedFields:t,config:this.config},this.tableName=getTableLikeName(e),this.joinsNotNullableMap="string"==typeof this.tableName?{[this.tableName]:!0}:{};for(const t of extractUsedTable(e))this.usedTables.add(t)}getUsedTables(){return[...this.usedTables]}createJoin(e,t){return(r,n)=>{const i=this.tableName,s=getTableLikeName(r);for(const e of extractUsedTable(r))this.usedTables.add(e);if("string"==typeof s&&this.config.joins?.some(e=>e.alias===s))throw new Error(`Alias "${s}" is already used in this query`);if(!this.isPartialSelect&&(1===Object.keys(this.joinsNotNullableMap).length&&"string"==typeof i&&(this.config.fields={[i]:this.config.fields}),"string"==typeof s&&!is(r,SQL))){const e=is(r,Subquery)?r._.selectedFields:is(r,View)?r[qc].selectedFields:r[Table.Symbol.Columns];this.config.fields[s]=e}if("function"==typeof n&&(n=n(new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:n,table:r,joinType:e,alias:s,lateral:t}),"string"==typeof s)switch(e){case"left":this.joinsNotNullableMap[s]=!1;break;case"right":this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([e])=>[e,!1])),this.joinsNotNullableMap[s]=!0;break;case"cross":case"inner":this.joinsNotNullableMap[s]=!0;break;case"full":this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([e])=>[e,!1])),this.joinsNotNullableMap[s]=!1}return this}}leftJoin=this.createJoin("left",!1);leftJoinLateral=this.createJoin("left",!0);rightJoin=this.createJoin("right",!1);innerJoin=this.createJoin("inner",!1);innerJoinLateral=this.createJoin("inner",!0);fullJoin=this.createJoin("full",!1);crossJoin=this.createJoin("cross",!1);crossJoinLateral=this.createJoin("cross",!0);createSetOperator(e,t){return r=>{const n="function"==typeof r?r(getPgSetOperators()):r;if(!haveSameKeys(this.getSelectedFields(),n.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:t,rightSelect:n}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);intersectAll=this.createSetOperator("intersect",!0);except=this.createSetOperator("except",!1);exceptAll=this.createSetOperator("except",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return"function"==typeof e&&(e=e(new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return"function"==typeof e&&(e=e(new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if("function"==typeof e[0]){const t=e[0](new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(t)?t:[t]}else this.config.groupBy=e;return this}orderBy(...e){if("function"==typeof e[0]){const t=e[0](new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),r=Array.isArray(t)?t:[t];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}else{const t=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=t:this.config.orderBy=t}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,t={}){return this.config.lockingClause={strength:e,config:t},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}as(e){const t=[];if(t.push(...extractUsedTable(this.config.table)),this.config.joins)for(const e of this.config.joins)t.push(...extractUsedTable(e.table));return new Proxy(new Subquery(this.getSQL(),this.config.fields,e,!1,[...new Set(t)]),new SelectionProxyHandler({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new SelectionProxyHandler({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}$withCache(e){return this.cacheConfig=void 0===e?{config:{},enable:!0,autoInvalidate:!0}:!1===e?{enable:!1}:{enable:!0,autoInvalidate:!0,...e},this}}class PgSelectBase extends PgSelectQueryBuilderBase{static[Uc]="PgSelect";_prepare(e){const{session:t,config:r,dialect:n,joinsNotNullableMap:i,authToken:s,cacheConfig:o,usedTables:a}=this;if(!t)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");const{fields:c}=r;return Dc.startActiveSpan("drizzle.prepareQuery",()=>{const r=orderSelectedFields(c),d=t.prepareQuery(n.sqlToQuery(this.getSQL()),r,e,!0,void 0,{type:"select",tables:[...a]},o);return d.joinsNotNullableMap=i,d.setToken(s)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>Dc.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken))}function createSetOperator(e,t){return(r,n,...i)=>{const s=[n,...i].map(r=>({type:e,isAll:t,rightSelect:r}));for(const e of s)if(!haveSameKeys(r.getSelectedFields(),e.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return r.addSetOperators(s)}}!function(e,t){for(const r of t)for(const t of Object.getOwnPropertyNames(r.prototype))"constructor"!==t&&Object.defineProperty(e.prototype,t,Object.getOwnPropertyDescriptor(r.prototype,t)||Object.create(null))}(PgSelectBase,[QueryPromise]);const getPgSetOperators=()=>({union:Vd,unionAll:Fd,intersect:Jd,intersectAll:Kd,except:Hd,exceptAll:Zd}),Vd=createSetOperator("union",!1),Fd=createSetOperator("union",!0),Jd=createSetOperator("intersect",!1),Kd=createSetOperator("intersect",!0),Hd=createSetOperator("except",!1),Zd=createSetOperator("except",!0);class QueryBuilder{static[Uc]="PgQueryBuilder";dialect;dialectConfig;constructor(e){this.dialect=is(e,PgDialect)?e:void 0,this.dialectConfig=is(e,PgDialect)?void 0:e}$with=(e,t)=>{const r=this;return{as:n=>("function"==typeof n&&(n=n(r)),new Proxy(new WithSubquery(n.getSQL(),t??("getSelectedFields"in n?n.getSelectedFields()??{}:{}),e,!0),new SelectionProxyHandler({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}};with(...e){const t=this;return{select:function(r){return new PgSelectBuilder({fields:r??void 0,session:void 0,dialect:t.getDialect(),withList:e})},selectDistinct:function(e){return new PgSelectBuilder({fields:e??void 0,session:void 0,dialect:t.getDialect(),distinct:!0})},selectDistinctOn:function(e,r){return new PgSelectBuilder({fields:r??void 0,session:void 0,dialect:t.getDialect(),distinct:{on:e}})}}}select(e){return new PgSelectBuilder({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new PgSelectBuilder({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,t){return new PgSelectBuilder({fields:t??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new PgDialect(this.dialectConfig)),this.dialect}}function extractUsedTable(e){return is(e,PgTable)?[e[Wc]?`${e[Wc]}.${e[Table.Symbol.BaseName]}`:e[Table.Symbol.BaseName]]:is(e,Subquery)?e._.usedTables??[]:is(e,SQL)?e.usedTables??[]:[]}class PgDeleteBase extends QueryPromise{constructor(e,t,r,n){super(),this.session=t,this.dialect=r,this.config={table:e,withList:n}}static[Uc]="PgDelete";config;cacheConfig;where(e){return this.config.where=e,this}returning(e=this.config.table[Table.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=orderSelectedFields(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e){return Dc.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"delete",tables:extractUsedTable(this.config.table)},this.cacheConfig))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>Dc.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new SelectionProxyHandler({alias:getTableName(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}}class PgInsertBuilder{constructor(e,t,r,n,i){this.table=e,this.session=t,this.dialect=r,this.withList=n,this.overridingSystemValue_=i}static[Uc]="PgInsertBuilder";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(0===(e=Array.isArray(e)?e:[e]).length)throw new Error("values() must be called with at least one value");const t=e.map(e=>{const t={},r=this.table[Table.Symbol.Columns];for(const n of Object.keys(e)){const i=e[n];t[n]=is(i,SQL)?i:new Param(i,r[n])}return t});return new PgInsertBase(this.table,t,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){const t="function"==typeof e?e(new QueryBuilder):e;if(!is(t,SQL)&&!haveSameKeys(this.table[jc],t._.selectedFields))throw new Error("Insert select error: selected fields are not the same or are in a different order compared to the table definition");return new PgInsertBase(this.table,t,this.session,this.dialect,this.withList,!0)}}class PgInsertBase extends QueryPromise{constructor(e,t,r,n,i,s,o){super(),this.session=r,this.dialect=n,this.config={table:e,values:t,withList:i,select:s,overridingSystemValue_:o}}static[Uc]="PgInsert";config;cacheConfig;returning(e=this.config.table[Table.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=orderSelectedFields(e),this}onConflictDoNothing(e={}){if(void 0===e.target)this.config.onConflict=sql`do nothing`;else{let t="";t=Array.isArray(e.target)?e.target.map(e=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(e))).join(","):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));const r=e.where?sql` where ${e.where}`:void 0;this.config.onConflict=sql`(${sql.raw(t)})${r} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');const t=e.where?sql` where ${e.where}`:void 0,r=e.targetWhere?sql` where ${e.targetWhere}`:void 0,n=e.setWhere?sql` where ${e.setWhere}`:void 0,i=this.dialect.buildUpdateSet(this.config.table,mapUpdateSet(this.config.table,e.set));let s="";return s=Array.isArray(e.target)?e.target.map(e=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(e))).join(","):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=sql`(${sql.raw(s)})${r} do update set ${i}${t}${n}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e){return Dc.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"insert",tables:extractUsedTable(this.config.table)},this.cacheConfig))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>Dc.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new SelectionProxyHandler({alias:getTableName(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}}class PgRefreshMaterializedView extends QueryPromise{constructor(e,t,r){super(),this.session=t,this.dialect=r,this.config={view:e}}static[Uc]="PgRefreshMaterializedView";config;concurrently(){if(void 0!==this.config.withNoData)throw new Error("Cannot use concurrently and withNoData together");return this.config.concurrently=!0,this}withNoData(){if(void 0!==this.config.concurrently)throw new Error("Cannot use concurrently and withNoData together");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e){return Dc.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>Dc.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken))}class PgUpdateBuilder{constructor(e,t,r,n){this.table=e,this.session=t,this.dialect=r,this.withList=n}static[Uc]="PgUpdateBuilder";authToken;setToken(e){return this.authToken=e,this}set(e){return new PgUpdateBase(this.table,mapUpdateSet(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}}class PgUpdateBase extends QueryPromise{constructor(e,t,r,n,i){super(),this.session=r,this.dialect=n,this.config={set:t,table:e,withList:i,joins:[]},this.tableName=getTableLikeName(e),this.joinsNotNullableMap="string"==typeof this.tableName?{[this.tableName]:!0}:{}}static[Uc]="PgUpdate";config;tableName;joinsNotNullableMap;cacheConfig;from(e){const t=e,r=getTableLikeName(t);return"string"==typeof r&&(this.joinsNotNullableMap[r]=!0),this.config.from=t,this}getTableLikeFields(e){return is(e,PgTable)?e[Table.Symbol.Columns]:is(e,Subquery)?e._.selectedFields:e[qc].selectedFields}createJoin(e){return(t,r)=>{const n=getTableLikeName(t);if("string"==typeof n&&this.config.joins.some(e=>e.alias===n))throw new Error(`Alias "${n}" is already used in this query`);if("function"==typeof r){const e=this.config.from&&!is(this.config.from,SQL)?this.getTableLikeFields(this.config.from):void 0;r=r(new Proxy(this.config.table[Table.Symbol.Columns],new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})),e&&new Proxy(e,new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))}if(this.config.joins.push({on:r,table:t,joinType:e,alias:n}),"string"==typeof n)switch(e){case"left":this.joinsNotNullableMap[n]=!1;break;case"right":this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([e])=>[e,!1])),this.joinsNotNullableMap[n]=!0;break;case"inner":this.joinsNotNullableMap[n]=!0;break;case"full":this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([e])=>[e,!1])),this.joinsNotNullableMap[n]=!1}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[Table.Symbol.Columns]),this.config.from)){const t=getTableLikeName(this.config.from);if("string"==typeof t&&this.config.from&&!is(this.config.from,SQL)){const r=this.getTableLikeFields(this.config.from);e[t]=r}for(const t of this.config.joins){const r=getTableLikeName(t.table);if("string"==typeof r&&!is(t.table,SQL)){const n=this.getTableLikeFields(t.table);e[r]=n}}}return this.config.returningFields=e,this.config.returning=orderSelectedFields(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}_prepare(e){const t=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"insert",tables:extractUsedTable(this.config.table)},this.cacheConfig);return t.joinsNotNullableMap=this.joinsNotNullableMap,t}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new SelectionProxyHandler({alias:getTableName(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}}class PgCountBuilder extends SQL{constructor(e){super(PgCountBuilder.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=PgCountBuilder.buildCount(e.source,e.filters)}sql;token;static[Uc]="PgCountBuilder";[Symbol.toStringTag]="PgCountBuilder";session;static buildEmbeddedCount(e,t){return sql`(select count(*) from ${e}${sql.raw(" where ").if(t)}${t})`}static buildCount(e,t){return sql`select count(*) as count from ${e}${sql.raw(" where ").if(t)}${t};`}setToken(e){return this.token=e,this}then(e,t){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,t)}catch(e){return this.then(void 0,e)}finally(e){return this.then(t=>(e?.(),t),t=>{throw e?.(),t})}}class RelationalQueryBuilder{constructor(e,t,r,n,i,s,o){this.fullSchema=e,this.schema=t,this.tableNamesMap=r,this.table=n,this.tableConfig=i,this.dialect=s,this.session=o}static[Uc]="PgRelationalQueryBuilder";findMany(e){return new PgRelationalQuery(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return new PgRelationalQuery(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}}class PgRelationalQuery extends QueryPromise{constructor(e,t,r,n,i,s,o,a,c){super(),this.fullSchema=e,this.schema=t,this.tableNamesMap=r,this.table=n,this.tableConfig=i,this.dialect=s,this.session=o,this.config=a,this.mode=c}static[Uc]="PgRelationalQuery";_prepare(e){return Dc.startActiveSpan("drizzle.prepareQuery",()=>{const{query:t,builtQuery:r}=this._toSQL();return this.session.prepareQuery(r,void 0,e,!0,(e,r)=>{const n=e.map(e=>mapRelationalRow(this.schema,this.tableConfig,e,t.selection,r));return"first"===this.mode?n[0]:n})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){const e=this._getQuery();return{query:e,builtQuery:this.dialect.sqlToQuery(e.sql)}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return Dc.startActiveSpan("drizzle.operation",()=>this._prepare().execute(void 0,this.authToken))}}class PgRaw extends QueryPromise{constructor(e,t,r,n){super(),this.execute=e,this.sql=t,this.query=r,this.mapBatchResult=n}static[Uc]="PgRaw";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,t){return t?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}}class PgDatabase{constructor(e,t,r){if(this.dialect=e,this.session=t,this._=r?{schema:r.schema,fullSchema:r.fullSchema,tableNamesMap:r.tableNamesMap,session:t}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:t},this.query={},this._.schema)for(const[n,i]of Object.entries(this._.schema))this.query[n]=new RelationalQueryBuilder(r.fullSchema,this._.schema,this._.tableNamesMap,r.fullSchema[n],i,e,t);this.$cache={invalidate:async e=>{}}}static[Uc]="PgDatabase";query;$with=(e,t)=>{const r=this;return{as:n=>("function"==typeof n&&(n=n(new QueryBuilder(r.dialect))),new Proxy(new WithSubquery(n.getSQL(),t??("getSelectedFields"in n?n.getSelectedFields()??{}:{}),e,!0),new SelectionProxyHandler({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}};$count(e,t){return new PgCountBuilder({source:e,filters:t,session:this.session})}$cache;with(...e){const t=this;return{select:function(r){return new PgSelectBuilder({fields:r??void 0,session:t.session,dialect:t.dialect,withList:e})},selectDistinct:function(r){return new PgSelectBuilder({fields:r??void 0,session:t.session,dialect:t.dialect,withList:e,distinct:!0})},selectDistinctOn:function(r,n){return new PgSelectBuilder({fields:n??void 0,session:t.session,dialect:t.dialect,withList:e,distinct:{on:r}})},update:function(r){return new PgUpdateBuilder(r,t.session,t.dialect,e)},insert:function(r){return new PgInsertBuilder(r,t.session,t.dialect,e)},delete:function(r){return new PgDeleteBase(r,t.session,t.dialect,e)}}}select(e){return new PgSelectBuilder({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new PgSelectBuilder({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,t){return new PgSelectBuilder({fields:t??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new PgUpdateBuilder(e,this.session,this.dialect)}insert(e){return new PgInsertBuilder(e,this.session,this.dialect)}delete(e){return new PgDeleteBase(e,this.session,this.dialect)}refreshMaterializedView(e){return new PgRefreshMaterializedView(e,this.session,this.dialect)}authToken;execute(e){const t="string"==typeof e?sql.raw(e):e.getSQL(),r=this.dialect.sqlToQuery(t),n=this.session.prepareQuery(r,void 0,void 0,!1);return new PgRaw(()=>n.execute(void 0,this.authToken),t,r,e=>n.mapResult(e,!0))}transaction(e,t){return this.session.transaction(e,t)}}class Cache{static[Uc]="Cache"}class NoopCache extends Cache{strategy(){return"all"}static[Uc]="NoopCache";async get(e){}async put(e,t,r,n){}async onMutate(e){}}async function hashQuery(e,t){const r=`${e}-${JSON.stringify(t)}`,n=(new TextEncoder).encode(r),i=await crypto.subtle.digest("SHA-256",n),s=[...new Uint8Array(i)].map(e=>e.toString(16).padStart(2,"0")).join("");return s}class DrizzleQueryError extends Error{constructor(e,t,r){super(`Failed query: ${e}\nparams: ${t}`),this.query=e,this.params=t,this.cause=r,Error.captureStackTrace(this,DrizzleQueryError),r&&(this.cause=r)}}class PgPreparedQuery{constructor(e,t,r,n){this.query=e,this.cache=t,this.queryMetadata=r,this.cacheConfig=n,t&&"all"===t.strategy()&&void 0===n&&(this.cacheConfig={enable:!0,autoInvalidate:!0}),this.cacheConfig?.enable||(this.cacheConfig=void 0)}authToken;getQuery(){return this.query}mapResult(e,t){return e}setToken(e){return this.authToken=e,this}static[Uc]="PgPreparedQuery";joinsNotNullableMap;async queryWithCache(e,t,r){if(void 0===this.cache||is(this.cache,NoopCache)||void 0===this.queryMetadata)try{return await r()}catch(r){throw new DrizzleQueryError(e,t,r)}if(this.cacheConfig&&!this.cacheConfig.enable)try{return await r()}catch(r){throw new DrizzleQueryError(e,t,r)}if(("insert"===this.queryMetadata.type||"update"===this.queryMetadata.type||"delete"===this.queryMetadata.type)&&this.queryMetadata.tables.length>0)try{const[e]=await Promise.all([r(),this.cache.onMutate({tables:this.queryMetadata.tables})]);return e}catch(r){throw new DrizzleQueryError(e,t,r)}if(!this.cacheConfig)try{return await r()}catch(r){throw new DrizzleQueryError(e,t,r)}if("select"===this.queryMetadata.type){const n=await this.cache.get(this.cacheConfig.tag??await hashQuery(e,t),this.queryMetadata.tables,void 0!==this.cacheConfig.tag,this.cacheConfig.autoInvalidate);if(void 0===n){let n;try{n=await r()}catch(r){throw new DrizzleQueryError(e,t,r)}return await this.cache.put(this.cacheConfig.tag??await hashQuery(e,t),n,this.cacheConfig.autoInvalidate?this.queryMetadata.tables:[],void 0!==this.cacheConfig.tag,this.cacheConfig.config),n}return n}try{return await r()}catch(r){throw new DrizzleQueryError(e,t,r)}}}class PgSession{constructor(e){this.dialect=e}static[Uc]="PgSession";execute(e,t){return Dc.startActiveSpan("drizzle.operation",()=>Dc.startActiveSpan("drizzle.prepareQuery",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(t).execute(void 0,t))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,t){const r=await this.execute(e,t);return Number(r[0].count)}}class PgTransaction extends PgDatabase{constructor(e,t,r,n=0){super(e,t,r),this.schema=r,this.nestedIndex=n}static[Uc]="PgTransaction";rollback(){throw new TransactionRollbackError}getTransactionConfigSQL(e){const t=[];return e.isolationLevel&&t.push(`isolation level ${e.isolationLevel}`),e.accessMode&&t.push(e.accessMode),"boolean"==typeof e.deferrable&&t.push(e.deferrable?"deferrable":"not deferrable"),sql.raw(t.join(" "))}setTransaction(e){return this.session.execute(sql`set transaction ${this.getTransactionConfigSQL(e)}`)}}class PostgresJsPreparedQuery extends PgPreparedQuery{constructor(e,t,r,n,i,s,o,a,c,d){super({sql:t,params:r},i,s,o),this.client=e,this.queryString=t,this.params=r,this.logger=n,this.fields=a,this._isResponseInArrayMode=c,this.customResultMapper=d}static[Uc]="PostgresJsPreparedQuery";async execute(e={}){return Dc.startActiveSpan("drizzle.execute",async t=>{const r=fillPlaceholders(this.params,e);t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.logger.logQuery(this.queryString,r);const{fields:n,queryString:i,client:s,joinsNotNullableMap:o,customResultMapper:a}=this;if(!n&&!a)return Dc.startActiveSpan("drizzle.driver.execute",()=>this.queryWithCache(i,r,async()=>await s.unsafe(i,r)));const c=await Dc.startActiveSpan("drizzle.driver.execute",()=>(t?.setAttributes({"drizzle.query.text":i,"drizzle.query.params":JSON.stringify(r)}),this.queryWithCache(i,r,async()=>await s.unsafe(i,r).values())));return Dc.startActiveSpan("drizzle.mapResponse",()=>a?a(c):c.map(e=>function(e,t,r){const n={},i=e.reduce((e,{path:i,field:s},o)=>{let a;a=is(s,Column)?s:is(s,SQL)?s.decoder:s.sql.decoder;let c=e;for(const[e,d]of i.entries())if(e<i.length-1)d in c||(c[d]={}),c=c[d];else{const e=t[o],l=c[d]=null===e?null:a.mapFromDriverValue(e);if(r&&is(s,Column)&&2===i.length){const e=i[0];e in n?"string"==typeof n[e]&&n[e]!==getTableName(s.table)&&(n[e]=!1):n[e]=null===l&&getTableName(s.table)}}return e},{});if(r&&Object.keys(n).length>0)for(const[e,t]of Object.entries(n))"string"!=typeof t||r[t]||(i[e]=null);return i}(n,e,o)))})}all(e={}){return Dc.startActiveSpan("drizzle.execute",async t=>{const r=fillPlaceholders(this.params,e);return t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.logger.logQuery(this.queryString,r),Dc.startActiveSpan("drizzle.driver.execute",()=>(t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.queryWithCache(this.queryString,r,async()=>this.client.unsafe(this.queryString,r))))})}isResponseInArrayMode(){return this._isResponseInArrayMode}}class PostgresJsSession extends PgSession{constructor(e,t,r,n={}){super(t),this.client=e,this.schema=r,this.options=n,this.logger=n.logger??new NoopLogger,this.cache=n.cache??new NoopCache}static[Uc]="PostgresJsSession";logger;cache;prepareQuery(e,t,r,n,i,s,o){return new PostgresJsPreparedQuery(this.client,e.sql,e.params,this.logger,this.cache,s,o,t,n,i)}query(e,t){return this.logger.logQuery(e,t),this.client.unsafe(e,t).values()}queryObjects(e,t){return this.client.unsafe(e,t)}transaction(e,t){return this.client.begin(async r=>{const n=new PostgresJsSession(r,this.dialect,this.schema,this.options),i=new PostgresJsTransaction(this.dialect,n,this.schema);return t&&await i.setTransaction(t),e(i)})}}class PostgresJsTransaction extends PgTransaction{constructor(e,t,r,n=0){super(e,t,r,n),this.session=t}static[Uc]="PostgresJsTransaction";transaction(e){return this.session.client.savepoint(t=>{const r=new PostgresJsSession(t,this.dialect,this.schema,this.session.options),n=new PostgresJsTransaction(this.dialect,r,this.schema);return e(n)})}}class PostgresJsDatabase extends PgDatabase{static[Uc]="PostgresJsDatabase"}function construct(e,t={}){const transparentParser=e=>e;for(const t of["1184","1082","1083","1114","1182","1185","1115","1231"])e.options.parsers[t]=transparentParser,e.options.serializers[t]=transparentParser;e.options.serializers[114]=transparentParser,e.options.serializers[3802]=transparentParser;const r=new PgDialect({casing:t.casing});let n,i;if(!0===t.logger?n=new DefaultLogger:!1!==t.logger&&(n=t.logger),t.schema){const e=function(e,t){1===Object.keys(e).length&&"default"in e&&!is(e.default,Table)&&(e=e.default);const r={},n={},i={};for(const[s,o]of Object.entries(e))if(is(o,Table)){const e=getTableUniqueName(o),t=n[e];r[e]=s,i[s]={tsName:s,dbName:o[Table.Symbol.Name],schema:o[Table.Symbol.Schema],columns:o[Table.Symbol.Columns],relations:t?.relations??{},primaryKey:t?.primaryKey??[]};for(const e of Object.values(o[Table.Symbol.Columns]))e.primary&&i[s].primaryKey.push(e);const a=o[Table.Symbol.ExtraConfigBuilder]?.(o[Table.Symbol.ExtraConfigColumns]);if(a)for(const e of Object.values(a))is(e,PrimaryKeyBuilder)&&i[s].primaryKey.push(...e.columns)}else if(is(o,Relations)){const e=getTableUniqueName(o.table),s=r[e],a=o.config(t(o.table));let c;for(const[t,r]of Object.entries(a))s?i[s].relations[t]=r:(e in n||(n[e]={relations:{},primaryKey:c}),n[e].relations[t]=r)}return{tables:i,tableNamesMap:r}}(t.schema,createTableRelationsHelpers);i={fullSchema:t.schema,schema:e.tables,tableNamesMap:e.tableNamesMap}}const s=new PostgresJsSession(e,r,i,{logger:n,cache:t.cache}),o=new PostgresJsDatabase(r,s,i);return o.$client=e,o.$cache=t.cache,o.$cache&&(o.$cache.invalidate=t.cache?.onMutate),o}function drizzle(...e){if("string"==typeof e[0]){return construct(Postgres(e[0]),e[1])}if(function(e){if("object"!=typeof e||null===e)return!1;if("Object"!==e.constructor.name)return!1;if("logger"in e){const t=typeof e.logger;return"boolean"===t||"object"===t&&"function"==typeof e.logger.logQuery||"undefined"===t}if("schema"in e){const t=typeof e.schema;return"object"===t||"undefined"===t}if("casing"in e){const t=typeof e.casing;return"string"===t||"undefined"===t}if("mode"in e)return"default"===e.mode&&"planetscale"===e.mode&&void 0===e.mode;if("connection"in e){const t=typeof e.connection;return"string"===t||"object"===t||"undefined"===t}if("client"in e){const t=typeof e.client;return"object"===t||"function"===t||"undefined"===t}return 0===Object.keys(e).length}(e[0])){const{connection:t,client:r,...n}=e[0];if(r)return construct(r,n);if("object"==typeof t&&void 0!==t.url){const{url:e,...r}=t;return construct(Postgres(e,r),n)}return construct(Postgres(t),n)}return construct(e[0],e[1])}(drizzle||(drizzle={})).mock=function(e){return construct({options:{parsers:{},serializers:{}}},e)};const Gd=pgTable("user",{id:text("id").primaryKey(),name:text("name").notNull(),email:text("email").notNull().unique(),emailVerified:boolean("email_verified").$defaultFn(()=>!1).notNull(),image:text("image"),createdAt:timestamp("created_at").$defaultFn(()=>new Date).notNull(),updatedAt:timestamp("updated_at").$defaultFn(()=>new Date).notNull()}),Yd=pgTable("session",{id:text("id").primaryKey(),expiresAt:timestamp("expires_at").notNull(),token:text("token").notNull().unique(),createdAt:timestamp("created_at").notNull(),updatedAt:timestamp("updated_at").notNull(),ipAddress:text("ip_address"),userAgent:text("user_agent"),userId:text("user_id").notNull().references(()=>Gd.id,{onDelete:"cascade"})}),Xd=pgTable("account",{id:text("id").primaryKey(),accountId:text("account_id").notNull(),providerId:text("provider_id").notNull(),userId:text("user_id").notNull().references(()=>Gd.id,{onDelete:"cascade"}),accessToken:text("access_token"),refreshToken:text("refresh_token"),idToken:text("id_token"),accessTokenExpiresAt:timestamp("access_token_expires_at"),refreshTokenExpiresAt:timestamp("refresh_token_expires_at"),scope:text("scope"),password:text("password"),createdAt:timestamp("created_at").notNull(),updatedAt:timestamp("updated_at").notNull()}),el=pgTable("verification",{id:text("id").primaryKey(),identifier:text("identifier").notNull(),value:text("value").notNull(),expiresAt:timestamp("expires_at").notNull(),createdAt:timestamp("created_at").$defaultFn(()=>new Date),updatedAt:timestamp("updated_at").$defaultFn(()=>new Date)}),tl=Object.freeze(Object.defineProperty({__proto__:null,account:Xd,session:Yd,user:Gd,verification:el},Symbol.toStringTag,{value:"Module"})),db=(e=r.env.DB_CONNECTION_STRING)=>drizzle(Postgres(e||""),{schema:tl});const _Auth=({isDev:e,baseURL:t,auth:{secret:r,social:n},db:{connectionString:i}})=>betterAuth({baseURL:`${t}/auth`,trustedOrigins:[t],secret:r,database:drizzleAdapter(db(i),{provider:"pg",schema:tl}),plugins:[genericOAuth({config:[{providerId:"kakao",clientId:n.kakao.clientId,clientSecret:n.kakao.clientSecret,redirectURI:`${t}/api/auth/callback/kakao`,authorizationUrl:"https://kauth.kakao.com/oauth/authorize",tokenUrl:"https://kauth.kakao.com/oauth/token",userInfoUrl:"https://kapi.kakao.com/v2/user/me",discoveryUrl:"https://kauth.kakao.com/.well-known/openid-configuration",getUserInfo:async e=>{if(!e.accessToken)throw new Error("No access token on try to get user info from kakao");return async function(e){var t,r,n,i,s,o;try{const a=await fetch("https://kapi.kakao.com/v2/user/me",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-type":"application/x-www-form-urlencoded;charset=utf-8"}});if(!a.ok)throw new Error("Failed to fetch user data");const c=await a.json();return{id:c.id,email:null==(t=c.kakao_account)?void 0:t.email,emailVerified:null==(r=c.kakao_account)?void 0:r.is_email_verified,name:null==(i=null==(n=c.kakao_account)?void 0:n.profile)?void 0:i.nickname,image:null==(o=null==(s=c.kakao_account)?void 0:s.profile)?void 0:o.profile_image_url,createdAt:c.connected_at,updatedAt:c.connected_at,_raw:c}}catch(e){throw console.error("Error fetching Kakao user data:",e),e}}(e.accessToken)},scopes:["profile_nickname","profile_image","account_email"],pkce:!0,responseType:"code"}]})],socialProviders:{google:{redirectURI:`${t}/api/auth/callback/google`,...n.google}},session:{expiresIn:5184e3,updateAge:604800},advanced:{cookiePrefix:"app-auth-session"},logger:{level:e?"debug":"info"}}),rl=o(e=>(()=>{const e=s();return _Auth(e)})().handler(a(e))),nl=Object.freeze(Object.defineProperty({__proto__:null,default:rl},Symbol.toStringTag,{value:"Module"}));export{hc as C,DefaultQueryCompiler as D,nl as _,mc as a,gc as b,cc as s};
//# sourceMappingURL=_...all_.mjs.map
